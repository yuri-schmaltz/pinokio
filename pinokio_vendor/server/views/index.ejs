<html>

<head>
  <title>Pinokio</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="/xterm.min.css" rel="stylesheet" />
  <link href="/css/fontawesome.min.css" rel="stylesheet">
  <link href="/css/solid.min.css" rel="stylesheet">
  <link href="/css/regular.min.css" rel="stylesheet">
  <link href="/css/brands.min.css" rel="stylesheet">
  <link href="/markdown.css" rel="stylesheet" />
  <link href="/noty.css" rel="stylesheet" />
  <link href="/filepond.min.css" rel="stylesheet" />
  <link href="/filepond-plugin-image-preview.min.css" rel="stylesheet" />
  <link href="/filepond-plugin-image-edit.min.css" rel="stylesheet" />
  <link href="/style.css" rel="stylesheet" />
  <link href="/urldropdown.css" rel="stylesheet" />
  <% if (agent==="electron" ) { %>
    <link href="/electron.css" rel="stylesheet" />
    <% } %>
      <style>
        .bubble {
          position: relative;
          background: rgba(0, 0, 0, 0.1);
          color: #333;
          border-radius: 10px;
          padding: 10px 15px;
          font-size: 14px;
          flex-grow: 1;
          line-height: 1.4;
          margin: 0 10px;
          font-weight: bold;
        }

        /* Left-side tail */
        .bubble::before {
          content: "";
          position: absolute;
          top: 10px;
          /* Vertical alignment of the tail */
          left: -20px;
          /* Positioning outside the bubble */
          border-width: 10px;
          border-style: solid;
          border-color: transparent rgba(0, 0, 0, 0.1) transparent transparent;
        }

        body.dark .bubble {
          background: rgba(0, 0, 0, 0.4);
          color: white;
        }

        body.dark .bubble:before {
          border-color: transparent rgba(0, 0, 0, 0.4) transparent transparent;
        }

        .line2 {
          display: flex;
          align-items: center;
          cursor: pointer;
          background: rgba(0, 0, 100, 0.04);
        }

        .line2 a {
          text-decoration: none;
          color: black;
        }

        .status {
          padding: 10px;
          margin: 10px;
          border-radius: 10px;
        }

        .status.offline {
          background: silver;
        }

        .status.online {
          background: yellowgreen;
        }

        .switch {
          padding: 10px;
          margin: 10px 0;
        }

        .switch[data-online=true] {
          color: yellowgreen;
        }

        .button {
          padding: 10px;
        }

        .on,
        .off {
          display: flex;
          align-items: center;
        }

        header .runner {
          padding: 10px 0 0;
        }

        .proxy {
          padding: 0 10px;
          text-align: right;
        }

        .proxy a {
          text-decoration: none;
          display: inline-block;
          padding: 5px 10px;
          border-radius: 2px;
          background: black;
          color: white;
        }

        .browser-options-btns {
          display: flex;
          padding-top: 5px;
        }

        .browser-options-row {
          /*
  border-top: 1px solid rgba(0,0,0,0.1);
  border-bottom: 1px solid rgba(0,0,0,0.1);
  */
          display: flex;
          padding: 10px;
          align-items: flex-start;
        }

        .browser-options-row h3 {
          margin: 0;
          font-size: 14px;
          margin-bottom: 3px;
        }

        .browser-options-row .btn.disabled {
          opacity: 0.7;
        }

        .browser-options-row .btn {
          font-weight: bold;
          width: 100px;
          text-align: center;
          display: block;
          margin-right: 10px;
          flex-shrink: 0;
          padding: 5px;
        }

        .badge {
          font-size: 12px;
          padding: 5px 10px;
          background: rgba(0, 0, 100, 0.1);
          border-radius: 5px;
          display: inline-block;
          margin-top: 5px;
        }

        a.badge {
          color: rgba(127, 91, 243, 0.9);
          text-decoration: none;
          cursor: pointer;
        }

        .badge a {
          color: rgba(127, 91, 243, 0.9);
          text-decoration: none;
        }

        body.dark .btn {
          color: white;
        }

        body.dark .badge {
          background: rgba(255, 255, 255, 0.1);
        }

        /*
body.dark .browser-options-row {
  border-top: 1px solid rgba(255,255,255,0.05);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
*/
        body.dark .context-menu-wrapper {
          background: rgba(0, 0, 0, 0.9) !important;
          color: white !important;
          border: 1px solid rgba(255, 255, 255, 0.1);
          box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        }

        .context-menu-wrapper {
          background: whitesmoke !important;
          border-radius: 10px;
          overflow: hidden;
        }

        .menu-btns {
          position: relative;
        }

        .context-menu {
          position: absolute;
          right: auto;
          margin: 0;
          padding: 0;
          z-index: 10;
          border: none;
          outline: none;
          background: transparent;
        }

        .context-menu:popover-open {
          border: none;
          outline: none;
        }

        .context-menu .btn:hover {
          color: cornflowerblue !important;
        }

        .context-menu .btn {
          background: none !important;
          border: none !important;
          display: block;
          width: 80px;
          padding: 6px 10px !important;
          text-align: left;
          color: black;
          margin: 0 !important;
        }

        body.dark .btn {
          background: rgba(255, 255, 255, 0.05) !important;
        }

        .app-btns .btn {
          border-radius: 4px;
          padding: 8px 10px;
          width: 70px;
          /*
  padding: 6px 10px;
  */
          text-align: center;
        }

        body.dark .context-menu .btn {
          color: white;
          background: none !important;
        }

        body.dark .open-menu,
        body.dark .browse {
          border: none !important;
          /*
  background: black !important;
  */
          color: white !important;
        }

        .open-menu:hover,
        .browse:hover,
        body.dark .open-menu:hover,
        body.dark .browse:hover {
          color: rgba(127, 91, 243, 0.9) !important;
        }

        .open-menu,
        .browse {
          /*
  width: 80px;
  */
          border-radius: 0 !important;
          background: rgba(0, 0, 0, 0.04) !important;
          color: black !important;
          /*
  border: 1px solid rgba(0, 0, 0, 0.3);
  */
        }

        .open-menu.selected {
          border: none !important;
          /*
  background: none !important;
  */
        }

        .open-menu.selected span {
          display: none;
        }

        main {
          display: flex;
        }

        .submenu .tab {
          padding: 0;
        }

        .submenu .tab {
          border-left: 10px solid transparent;
        }

        aside {
          width: 200px;
          display: block;
          flex-shrink: 0;
        }

        body.dark aside .tab:hover,
        aside .tab:hover {
          color: rgba(127, 91, 243, 0.9) !important;
          opacity: 1;
        }

        aside .tab i {
          width: 20px;
          text-align: center;
          display: block;
        }

        body.dark aside .tab {
          color: white;
        }

        aside .tab.hidden {
          padding: 0;
        }

        aside .tab {
          display: flex;
          align-items: center;
          gap: 5px;
          color: black;
          text-decoration: none;
          padding: 10px;
          font-size: 12px;
          opacity: 0.5;
          border-left: 10px solid transparent;
        }

        body.dark aside .tab.selected {

          color: white;
          /*
  border-left: 10px solid white;
  */
        }

        aside .tab.selected {
          /*
  border-left: 10px solid black;
  */
          font-weight: bold;
          opacity: 1;
        }

        #suggestion {
          padding: 20px;
          display: flex;
          align-items: center;
        }

        #suggestion img {
          width: 50px;
          height: 50px;
        }

        #suggestion h4 {
          margin: 0;
        }

        /*
#suggestion .prompt {
  padding: 10px 15px;
  margin: 10px 0;
  border-left: 10px solid rgba(0,0,0,0.1);
}
*/
        body.dark aside .current.selected {
          /*
  border-left: 10px solid white;
  */
        }

        /*
.container {
  margin-left: 20px;
}
*/
        /*
@media only screen and (max-width: 800px) {
  body {
    display: flex !important;
    flex-direction: row !important;
  }
}
*/
        @media only screen and (max-width: 600px) {
          aside {
            width: unset;
            flex-shrink: unset;
          }

          aside {
            padding: 0 10px;
          }

          aside .tab.submenu {
            padding: 10px;
          }

          aside .tab i {
            width: 100%;
          }

          aside .tab .caption {
            display: none;
          }

          aside .tab {
            margin: 0;
            padding: 10px;
            border-left: none;
          }

          aside .btn-tab {
            flex-direction: column;
            padding: 10px 0;
          }

          aside .btn-tab .btn {
            display: flex;
            justify-content: center;
          }

          aside .btn-tab .btn .caption {
            display: none;
          }

          header .flexible {
            min-width: unset;
          }
        }

        @media only screen and (max-width: 480px) {
          .btn2 {
            padding: 5px;
            font-size: 11px;
          }

          .nav-btns {
            flex-grow: 1;
            justify-content: center;
            padding: 0;
          }
        }

        /* Machine Menu Modal Styles */
        #machine-menu {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 300px;
          max-height: 80vh;
          overflow-y: auto;
          border: 1px solid rgba(0, 0, 0, 0.1);
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
          margin: 0;
          border-radius: 10px;
          background: white;
          padding: 10px;
        }

        body.dark #machine-menu {
          background: #222;
          border-color: #444;
          color: white;
        }

        /* Ensure links inside the menu look good */
        #machine-menu .tab {
          display: flex;
          align-items: center;
          padding: 12px;
          text-decoration: none;
          color: inherit;
          border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        #machine-menu .tab:last-child {
          border-bottom: none;
        }

        #machine-menu .tab i {
          width: 24px;
          margin-right: 10px;
          text-align: center;
        }
      </style>
      <script src="/window_storage.js"></script>
      <script src="/hotkeys.min.js"></script>
      <script src="/sweetalert2.js"></script>
      <script src="/noty.js"></script>
      <script src="/notyq.js"></script>
      <script src="/xterm.js"></script>
      <script src="/xterm-addon-fit.js"></script>
      <script src="/xterm-addon-web-links.js"></script>
      <script src="/xterm-theme.js"></script>
      <script src="/Socket.js"></script>
      <script src="/install.js"></script>
      <script src="/common.js"></script>
      <script src="/nav.js"></script>
      <script src="/fuse.js"></script>
      <script src="/report.js"></script>
      <script src="/popper.min.js"></script>
      <script src="/tippy-bundle.umd.min.js"></script>
      <script src="/filepond-plugin-file-validate-type.min.js"></script>
      <script src="/filepond-plugin-image-exif-orientation.min.js"></script>
      <script src="/filepond-plugin-image-preview.min.js"></script>
      <script src="/filepond-plugin-image-edit.min.js"></script>
      <script src="/filepond-plugin-image-crop.min.js"></script>
      <script src="/filepond-plugin-image-resize.min.js"></script>
      <script src="/filepond-plugin-image-transform.min.js"></script>
      <script src="/filepond.min.js"></script>
      <script src="/fscreator.js"></script>
      <script src="/fseditor.js"></script>
      <script src="/urldropdown.js"></script>
</head>

<body class='<%=theme%>' data-agent="<%=agent%>">
  <% if (error) { %>
    <nav class='error-message'>
      <div>
        <%=error%>
      </div>
      <div class='flexible'></div>
      <a class='btn' target="_blank" href="<%=install%>">Download</a>
    </nav>
    <% } %>
      <!--
<header class='grabbable'>
-->
      <header class='navheader grabbable'>
        <h1 <% if (ishome) { %>class="home-header"<% } %>>
            <span class="sr-only">
              <%= ishome ? "Pinokio Home" : "Folder View" %>
            </span>
            <% if (ishome) { %>
              <!-- <a class='home' href="/home"><img class='icon' src="/pinokio-black.png"></a> -->

              <button class='btn2' id='back' data-tippy-content="back" aria-label="Go Back">
                <div><i class="fa-solid fa-chevron-left" aria-hidden="true"></i></div>
              </button>
              <button class='btn2' id='forward' data-tippy-content="forward" aria-label="Go Forward">
                <div><i class="fa-solid fa-chevron-right" aria-hidden="true"></i></div>
              </button>
              <button class='btn2' id='refresh-page' data-tippy-content="refresh" aria-label="Refresh Page">
                <div><i class="fa-solid fa-rotate-right" aria-hidden="true"></i></div>
              </button>

              <button class='btn2 mobile-link-button' id='mobile-link-button' data-tippy-content="enter url"
                aria-label="Enter URL"><i class="fa-solid fa-link"></i></button>
              <div class='mobile-flexible'></div>
              <form class='urlbar'>
                <div class='url-input-container'>
                  <input type='url' placeholder='enter any local url to open in pinokio'>
                  <div class='url-dropdown' id='url-dropdown'></div>
                </div>
              </form>

              <!-- <button class='btn2' id='new-window' data-tippy-content="open a new window" title='open a new window'
              data-agent="<%=agent%>" aria-label="New Window">
              <div><i class="fa-solid fa-plus" aria-hidden="true"></i></div>
            </button> -->
              <% } %>

                <%# UX-13: Hide duplicate header nav buttons on Home screen (they are already in the Hero section) %>
                  <% if (!ishome) { %>
                    <% paths.forEach((path)=> { %>
                      <% if (path.action) { %>
                        <button type="button" class='path nav-button' id="<%=path.id%>"
                          onclick="<%=path.action%>"><%-path.name%></button>
                        <% } else if (path.path) { %>
                          <a class='path' href="<%=path.path%>"><%-path.name%></a>
                          <% } %>
                            <% }) %>
                              <% } %>
                                <button class='btn2 hidden' id='close-window' data-tippy-content='close this section'
                                  aria-label="Close section">
                                  <div><i class="fa-solid fa-xmark"></i></div>
                                </button>
        </h1>
        <% if (!ishome) { %>
          <div class='runner'>
            <button class='btn' id='open-fs' data-filepath="<%=filepath%>"><i class="fa-solid fa-eye"></i> View
              Folder</button>
          </div>
          <% } %>
            <% if (display.includes("dependencies") && config) { %>
              <div class='dependencies'>
                <h2>Prerequisites</h2>
                <div class='item'>Download and install the following dependencies first</div>
                <div class='requirements'>
                  <% config.dependencies.forEach((dep)=> { %>
                    <% if (dep.downloaded) { %>
                      <div class='item'><i class="fa-solid fa-check"></i> <a class='downloaded'
                          href="<%=dep.downloaded%>" target="_blank">
                          <%=dep.uri%>
                        </a>
                        <div class='flexible'></div>
                      </div>
                      <% } else { %>
                        <div class='item'><a class='btn' href="/?mode=download&uri=<%= encodeURIComponent(dep.uri) %>"
                            target="_blank"><i class="fa-solid fa-download"></i> Download</a>
                          <%=dep.uri%>
                            <div class='flexible'></div>
                        </div>
                        <% } %>
                          <% }) %>
                </div>
              </div>
              <% } %>
      </header>
      <main class="fade-in">
        <div id='terminal' class='hidden pinokio-glass-terminal'></div>
        <div class='container'>
          <% if (ishome) { %>
            <form class='search'>
              <div class='app-btns'>
                <button class='btn' id='machine-btn' popovertarget="machine-menu" popovertargetaction="toggle">
                  <i class="fa-solid fa-server"></i> Machine
                </button>
                <a class='btn create-new' href="/create/page"><i class="fa-solid fa-plus"></i> Create</a>
                <a class='btn' id='explore' href="/discover_native"><i class="fa-solid fa-globe"></i> Discover</a>
              </div>
              <% if (display.includes("form")) { %>
                <input type='search' class="flexible" placeholder='Search apps'>
                <% } %>
            </form>
            <% } %>
              <% if (ishome) { %>
                <!--
  <div id='suggestion' class='hidden'>
    <img src="/pinokio-black.png"/>
    <div class='bubble prompt'></div>
    <button id='create-ai' class='btn'>Create</button>
  </div>
  -->
                <% if (running.length> 0) { %>
                  <div class='running-apps'>
                    <% running.forEach((item, index)=> { %>
                      <a target="<%=item.target || '_self'%>" href="<%=item.browser_url%>"
                        data-description="<%=item.description%>" data-index="<%=item.index%>" data-name="<%=item.name%>"
                        data-title="<%=item.name%>" data-uri="<%=item.uri%>" data-icon="<%=item.icon%>"
                        data-path="<%=item.path%>" data-iconpath="<%=item.iconpath ? item.iconpath : ''%>"
                        class='line align-top item-card-hover'>
                        <h3>
                          <div class='item-icon'>
                            <% if (item.icon) { %>
                              <img src="<%=item.icon%>" alt="<%=item.name%> icon"
                                onerror="this.src='/pinokio-black.png'" />
                              <% } else { %>
                                <i class="fa-regular fa-folder"></i>
                                <% } %>
                          </div>
                          <div class='col'>
                            <div class='title'>
                              <i class="fa-solid fa-circle"></i>
                              <span>
                                <%=item.name%>
                              </span>
                            </div>
                            <div class='uri'>
                              <%=item.filepath%>
                            </div>
                            <div class='description'>
                              <%=item.description%>
                            </div>
                            <div class='menu-btns'>
                              <button class='btn browse' data-src="<%=item.dev_url%>">
                                <i class="fa-solid fa-code"></i> Dev
                              </button>
                              <button class='btn browse' data-src="<%=item.review_url%>">
                                <i class="fa-regular fa-message"></i> Forum
                              </button>
                              <button class='btn browse' data-src="<%=item.view_url%>">
                                <i class="fa-regular fa-eye"></i> View
                              </button>
                              <button class='btn open-menu' type='button'
                                popovertarget="context-menu-running-<%=index%>" popovertargetaction="toggle"
                                aria-haspopup="menu">
                                <i class="fa-solid fa-bars"></i><span> Menu</span>
                              </button>
                              <div id='context-menu-running-<%=index%>' class='context-menu' popover>
                                <div class='context-menu-wrapper'>
                                  <button class='btn' data-filepath="<%=item.filepath%>">
                                    <i class="fa-solid fa-folder-open"></i> Open</button>
                                  </button>
                                  <button class='btn copy-menu'>
                                    <i class='fa-solid fa-copy'></i> Copy
                                  </button>
                                  <button class='btn move-menu'
                                    data-disable="To move the folder, the app should not be running.">
                                    <i class="fa-solid fa-right-to-bracket"></i> Move
                                  </button>
                                  <button class='btn edit-menu'>
                                    <i class='fa-solid fa-pen-to-square'></i> Edit
                                  </button>
                                  <button class='btn del' data-src="<%=item.url%>"
                                    data-disable="To delete the folder, the app should not be running.">
                                    <i class="fa-solid fa-trash-can"></i> Delete
                                  </button>
                                </div>
                              </div>
                              <% if (item.running_scripts) { %>
                                <% item.running_scripts.forEach((s)=> { %>
                                  <% if (s.id) { %>
                                    <button class='btn shutdown' data-id="<%=s.id%>"
                                      data-type="<%=s.type ? s.type : ''%>">
                                      <i class="fa-solid fa-stop"></i> Stop <%=s.name%>&nbsp;
                                        <i class='fa-solid fa-spin fa-circle-notch'></i>
                                    </button>
                                    <% } else { %>
                                      <button class='btn shutdown' data-src="<%=s.path%>">
                                        <i class="fa-solid fa-stop"></i> Stop <%=s.name%>&nbsp;
                                          <i class='fa-solid fa-spin fa-circle-notch'></i>
                                      </button>
                                      <% } %>
                                        <% }) %>
                                          <% } %>
                            </div>
                            <% if (item.shortcuts && item.shortcuts.length> 0) { %>
                              <div class='btns'>
                                <% item.shortcuts.forEach((btn)=> { %>
                                  <% if (btn.btn) { %>
                                    <button data-action="<%=btn.action ? JSON.stringify(btn.action) : ''%>"
                                      class='btn menu-btn'><%-btn.btn%></button>
                                    <% } %>
                                      <% }) %>
                              </div>
                              <% } %>
                          </div>
                          <!--
            <div class='spinner'>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
            -->
                        </h3>
                      </a>
                      <% }) %>
                  </div>
                  <% } else if (notRunning.length===0) { %>
                    <div class="empty-state">
                      <i class="fa-solid fa-box-open" aria-hidden="true"></i>
                      <h3>No apps running or installed</h3>
                      <p>Get started by discovering new scripts or creating your own.</p>
                      <a class='btn btn-primary' href="/home?mode=explore">
                        <i class="fa-solid fa-globe"></i> Discover Apps
                      </a>
                    </div>
                    <% } %>
                      <% if (notRunning.length> 0) { %>
                        <div class='not-running-apps'>
                          <!--
      <div class='header-label'>Not Running</div>
      -->
                          <% notRunning.forEach((item, index)=> { %>
                            <a target="<%=item.target || '_self'%>" href="<%=item.browser_url%>"
                              data-description="<%=item.description%>" data-index="<%=item.index%>"
                              data-name="<%=item.name%>" data-title="<%=item.name%>" data-uri="<%=item.uri%>"
                              data-icon="<%=item.icon%>" data-path="<%=item.path%>"
                              data-iconpath="<%=item.iconpath ? item.iconpath : ''%>" class='line align-top'>
                              <h3>
                                <div class='item-icon'>
                                  <% if (item.icon) { %>
                                    <img src="<%=item.icon%>" alt="<%=item.name%> icon"
                                      onerror="this.src='/pinokio-black.png'" />
                                    <% } else { %>
                                      <i class="fa-regular fa-folder"></i>
                                      <% } %>
                                </div>
                                <div class='col'>
                                  <div class='title'>
                                    <i class="fa-solid fa-circle"></i>
                                    <span>
                                      <%=item.name%>
                                    </span>
                                  </div>
                                  <div class='uri'>
                                    <%=item.filepath%>
                                  </div>
                                  <div class='description'>
                                    <%=item.description%>
                                  </div>
                                  <div class='menu-btns'>
                                    <button class='btn browse' data-src="<%=item.dev_url%>">
                                      <i class="fa-solid fa-code"></i> Dev
                                    </button>
                                    <button class='btn browse' data-src="<%=item.review_url%>">
                                      <i class="fa-regular fa-message"></i> Forum
                                    </button>
                                    <button class='btn browse' data-src="<%=item.view_url%>">
                                      <i class="fa-regular fa-eye"></i> View
                                    </button>
                                    <button class='btn open-menu' type='button'
                                      popovertarget="context-menu-not-running-<%=index%>" popovertargetaction="toggle"
                                      aria-haspopup="menu">
                                      <i class="fa-solid fa-bars"></i><span> Menu</span>
                                    </button>
                                    <div id='context-menu-not-running-<%=index%>' class='context-menu' popover>
                                      <div class='context-menu-wrapper'>
                                        <button class='btn' data-filepath="<%=item.filepath%>">
                                          <i class="fa-solid fa-folder-open"></i> Open</button>
                                        </button>
                                        <button class='btn copy-menu'>
                                          <i class='fa-solid fa-copy'></i> Copy
                                        </button>
                                        <button class='btn move-menu'>
                                          <i class="fa-solid fa-right-to-bracket"></i> Move
                                        </button>
                                        <button class='btn edit-menu'>
                                          <i class='fa-solid fa-pen-to-square'></i> Edit
                                        </button>
                                        <button class='btn del' data-src="<%=item.url%>">
                                          <i class="fa-solid fa-trash-can"></i> Delete
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                  <div class='fiexible'></div>
                                  <% if (item.shortcuts && item.shortcuts.length> 0) { %>
                                    <div class='btns'>
                                      <% item.shortcuts.forEach((btn)=> { %>
                                        <% if (btn.btn) { %>
                                          <button data-action="<%=btn.action ? JSON.stringify(btn.action) : ''%>"
                                            class='btn menu-btn'><%-btn.btn%></button>
                                          <% } %>
                                            <% }) %>
                                    </div>
                                    <% } %>
                                </div>
                                <!--
            <div class='spinner'>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
            -->
                              </h3>
                            </a>
                            <% }) %>
                        </div>
                        <% } %>

                          <% } else { %>
                            <% items.forEach((item, index)=> { %>
                              <a target="<%=item.target || '_self'%>" data-description="<%=item.description%>"
                                data-index="<%=index%>" data-name="<%=item.name%>" data-uri="<%=item.uri%>"
                                class='line thick' href="<%=item.url%>">
                                <h3>
                                  <% if (item.icon) { %>
                                    <i class="<%=item.icon%>"></i>
                                    <% } else { %>
                                      <i class="fa-regular fa-folder"></i>
                                      <% } %>
                                        <%=item.name%>
                                </h3>
                                <div class='description'>
                                  <%=item.description%>
                                </div>
                              </a>
                              <% }) %>
                                <% } %>
                                  <% if (readme) { %>
                                    <div class='readme markdown-body'>
                                      <div class='content'><%-readme%></div>
                                    </div>
                                    <% } %>
                                      <% if (display.includes("onboarding")) { %>
                                        <!--
<div class='container'>
  <div class='content'>
    <h2>Quickstart</h2>
    <div>Install llama</div>
    <br>
    <button class='btn' id='llama'>Install</button>
  </div>
</div>
-->
                                        <% } %>
        </div>
        <aside>
          <div class='btn-tab'>
            <button class='btn' id='create-launcher-button'><i class="fa-solid fa-plus"></i>
              <div class='caption'>Create</div>
            </button>
            <a class='btn' id='explore' href="/home?mode=explore"><i class="fa-solid fa-globe"></i>
              <div class='caption'>Discover</div>
            </a>
            <button class='btn' id='machine-btn' popovertarget="machine-menu" popovertargetaction="toggle"><i
                class="fa-solid fa-server"></i>
              <div class='caption'>My Machine</div>
            </button>
          </div>

          <div id='machine-menu' class='context-menu' popover>
            <div class='context-menu-wrapper'>
              <a href="/home" class='tab selected'><i class='fas fa-laptop-code'></i>
                <div class='caption'>This machine</div>
              </a>
              <a href="/network" class='tab'><i class="fa-solid fa-wifi"></i>
                <div class='caption'>Local network</div>
              </a>
              <% if (list.length> 0) { %>
                <% let brands={ win32: "windows" , darwin: "apple" , linux: "Linux" } %>
                  <% list.forEach(({ host, name, platform, processes }, index)=> { %>
                    <a href="/net/<%=name%>" class='submenu tab'><i class="fa-brands fa-<%=brands[platform]%>"></i>
                      <div class='caption'>
                        <%=name%> (<%=current_host===host ? 'this machine' : host%>)
                      </div>
                    </a>
                    <% }) %>
                      <% } %>
                        <a href="/connect" class='tab'><i class="fa-solid fa-plug"></i>
                          <div class='caption'>Login</div>
                        </a>
                        <a class='tab' href="<%=portal%>" target="_blank"><i class="fa-solid fa-question"></i>
                          <div class='caption'>Help</div>
                        </a>
                        <a class='tab' id='genlog' href="/logs"><i class="fa-solid fa-laptop-code"></i>
                          <div class='caption'>Logs</div>
                        </a>
                        <a class='tab' href="/checkpoints"><i class="fa-solid fa-clock-rotate-left"></i>
                          <div class='caption'>Checkpoints</div>
                        </a>
                        <a class='tab' href="/screenshots"><i class="fa-solid fa-camera"></i>
                          <div class='caption'>Screenshots</div>
                        </a>
                        <a class='tab' href="/tools"><i class="fa-solid fa-toolbox"></i>
                          <div class='caption'>Installed Tools</div>
                        </a>
                        <a class='tab' href="/agents"><i class="fa-solid fa-robot"></i>
                          <div class='caption'>Agents</div>
                        </a>
                        <a class='tab' href="/home?mode=settings"><i class="fa-solid fa-gear"></i>
                          <div class='caption'>Settings</div>
                        </a>
                        <%- include('partials/peer_access_points', { peer_access_points, peer_url, peer_qr }) %>
            </div>
          </div>
        </aside>
      </main>
      <script>
        let paths = location.pathname.split("/").filter(x => x)
        var term
        const n = new N()
        let socket = new Socket()
        window.PinokioHomeGuardNavigate = null;
<% if (ishome) { %>
          document.addEventListener("DOMContentLoaded", () => {
            // Run wait_ready for every /home navigation so we only leave when requirements are satisfied
            const guardNavigate = (href, options = {}) => {
              const url = new URL(href, location.href);
              wait_ready(url).then(({ closeModal, ready }) => {
                if (ready) {
                  if (closeModal) {
                    closeModal()
                  }
                  options?.replace ? location.replace(url) : location.assign(url);
                } else {
                  const callbackUrl = url
                    ? (url.pathname + url.search + url.hash)
                    : (window.location.pathname + window.location.search + window.location.hash);
                  const callback = encodeURIComponent(callbackUrl);
                  window.location.href = `/setup/dev?callback=${callback}`;
                }
              });
            };
            // Capture same-window anchor clicks and reroute them through the guard
            document.addEventListener("click", (event) => {
              // Ignore clicks the page already handled or anything besides a plain left-click
              if (event.defaultPrevented || event.button !== 0) return;
              // Let modifier-assisted shortcuts (open in new tab, etc.) behave normally
              if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
              // Only guard actual anchor navigations
              const anchor = event.target.closest("a[href]");
              if (!anchor) return;
              // Skip downloads so they aren’t blocked by readiness polling
              if (anchor.hasAttribute("download")) return;
              // Don’t intercept links that explicitly open in another browsing context
              const targetAttr = anchor.getAttribute("target");
              if (targetAttr && targetAttr !== "_self") return;
              // Ignore hash jumps, javascript: URLs, and empty hrefs
              const rawHref = anchor.getAttribute("href") || "";
              if (!rawHref || rawHref.startsWith("#") || /^javascript:/i.test(rawHref)) return;
              // Prevent cross-origin navigations from being delayed—they don’t hit Pinokio anyway
              const url = new URL(anchor.href, location.href);
              if (url.origin !== location.origin) return;
              event.preventDefault();
              guardNavigate(url.toString());
            });
            window.PinokioHomeGuardNavigate = guardNavigate;
          });
<% } %>
const pull = async () => {
          if (!term) {
    <% if (theme === "dark") { %>
              term = await createTerm(xtermTheme.FrontEndDelight)
                <% } else { %>
                  term = await createTerm(xtermTheme.Tomorrow)
                    <% } %>
  }
          socket.close()
          await new Promise((resolve, reject) => {
            let cwd
            let chunks = location.pathname.split("/").filter((x) => { return x })
            if (chunks.length > 0) {
              //cwd = chunks.slice(1).join("/")
              cwd = "~/" + chunks.join("/")
            } else {
              cwd = "."
            }
            socket.run({
              method: "shell.run",
              params: {
                message: `git pull`,
                //        path: "<%=uri%>",//cwd
                path: cwd
              }
            }, (packet) => {
              if (packet.type === 'stream') {
                term.write(packet.data.raw)
              } else if (packet.type === "result") {
                resolve()
              } else if (packet.type === "error") {
                n.Noty({
                  text: packet.data
                })
              }
            })
          })
            <% if (config && config.update) { %>
              n.Noty({
                text: "Success! An update script exists. Click to visit and run the update script!",
                type: "success",
                callbacks: {
                  onClose: () => {
                    location.href = "<%=config.update%>"
                  }
                }
              })
              <% } else { %>
                n.Noty({
                  text: "Success! Click to refresh.",
                  type: "success",
                  callbacks: {
                    onClose: () => {
                      location.href = location.href
                    }
                  }
                })
                <% } %>
}
<% if (display.includes("onboarding")) { %>
//document.querySelector("#llama").addEventListener("click", async (e) => {
//  if (!term) term = createTerm()
//  await install("llama", "https://github.com/malfunctionize/lla", term, socket)
//})
<% } %>
<% if (display.includes("form")) { %>
          let list = []
          document.querySelectorAll(".line").forEach((el, index) => {
            list.push({
              index: parseInt(el.getAttribute("data-index")),
              name: el.getAttribute("data-name"),
              description: el.getAttribute("data-description"),
              uri: el.getAttribute("data-uri")
            })
          })
          const search = (items, value) => {
            let filtered = []
            for (let i = 0; i < items.length; i++) {
              let item = items[i]
              let re = new RegExp(value, "i")
              if (re.test(item.name)) {
                filtered.push({ item })
              } else if (re.test(item.description)) {
                filtered.push({ item })
              } else if (re.test(item.uri)) {
                filtered.push({ item })
              }
            }
            return filtered
          }
          //const fuse = new Fuse(list, {
          //  threshold: 0.3,
          //  keys: [{
          //    name: "name",
          //    weight: 5,
          //  }, {
          //    name: "description",
          //    weight: 1,
          //  }],
          //  includeScore: true,
          //  includeMatches: true
          //})


          let selectedIndex = -1
          let selectedBtnIndex = 0
          let filteredCount = list.length
          let filteredBtnsCount = 0

          const renderSearch = () => {
            let target = document.querySelector("form input[type=search]")
            let result
            if (target.value.trim().length === 0) {
              result = list.map((i, index) => {
                return { item: i }
              })
            } else {
              result = search(list, target.value)
            }
            let all = document.querySelectorAll(".line")
            for (let el of all) {
              el.classList.add("hidden")
              el.classList.remove("selected")
            }

            filteredCount = result.length
            for (let i = 0; i < result.length; i++) {
              let selector = result[i]
              //let el = document.querySelector(".line[data-name='" + selector.item.name + "']")
              let el = document.querySelector(".line[data-index='" + selector.item.index + "']")
              el.classList.remove("hidden")
              if (i === selectedIndex) {
                el.classList.add("selected")
                let btns = el.querySelectorAll(".btns a")
                filteredBtnsCount = btns.length
                btns.forEach((_el, j) => {
                  if (selectedBtnIndex === j) {
                    _el.classList.add("selected")
                  } else {
                    _el.classList.remove("selected")
                  }
                })
              } else {
                el.classList.remove("selected")
                let btns = el.querySelectorAll(".btns a")
                btns.forEach((_el, j) => {
                  _el.classList.remove("selected")
                })
              }
            }

            //  suggest(target.value)

          }
          //const suggest = (str) => {
          //  // suggestion
          //  if (str.length > 0) {
          //    document.querySelector("#suggestion").classList.remove("hidden")
          //  } else {
          //    document.querySelector("#suggestion").classList.add("hidden")
          //  }
          //  document.querySelector("#suggestion .prompt").innerHTML = str
          //}

          renderSearch()


          document.querySelector("form input[type=search]").addEventListener("input", (e) => {
            selectedIndex = 0
            selectedBtnIndex = 0
            renderSearch()
            /*
              if (e.target.value.trim().length === 0) {
                let all = document.querySelectorAll(".line")
                for(let el of all) {
                  el.classList.remove("hidden")
                }
              } else {
                let all = document.querySelectorAll(".line")
                for(let el of all) {
                  el.classList.add("hidden")
                }
            
                //let result = fuse.search(e.target.value)
                let result = search(list, e.target.value)
            //    result.sort((x, y) => {
            //      return y.score - x.score
            //    })
                let i = 0
                //for(let selector of result) {
                for(let i=0; i<result.length; i++) {
                  let selector = result[i]
                  let el = document.querySelector(".line[data-name='" + selector.item.name + "']")
                  el.classList.remove("hidden")
                  if (i === 0) {
                    el.classList.add("selected")
                  }
                }
              }
              */
          })
          document.querySelector("form input[type=search]").focus()
            <% } %>


//  if (el) {
//    let url = el.getAttribute("data-url")
//    if (url) {
//      let target = el.getAttribute("data-target")
//      if (target && target.length > 0) {
//        let agent = el.getAttribute("data-agent")
//        if (agent && agent.length > 0) {
//          window.open(url, target, agent)
//        } else {
//          window.open(url, target)
//        }
//      } else {
//        location.href = url
//      }
//    }
//  }
//document.querySelector(".runner").addEventListener("click", async (e) => {
//  let el = e.target.closest(".btn")
//  if (!el) {
//    if (el.classList.contains("btn")) {
//      el = e.target
//    }
//  }
//
//  if (el) {
//    let url = el.getAttribute("data-url")
//    if (url) {
//      let target = el.getAttribute("data-target")
//      if (target && target.length > 0) {
//        let agent = el.getAttribute("data-agent")
//        if (agent && agent.length > 0) {
//          window.open(url, target, agent)
//        } else {
//          window.open(url, target)
//        }
//      } else {
//        location.href = url
//      }
//    }
//  }
//})
<% if (display.includes("install")) { %>
          document.querySelector("#install").addEventListener("click", async (e) => {
            const targetUrl = e.target.getAttribute("data-url");
            if (window.PinokioHomeGuardNavigate) {
              window.PinokioHomeGuardNavigate(targetUrl);
            } else {
              location.href = targetUrl;
            }
          })
          <% } %>
            //Reporter()
            /*
            <% if (display.includes("dependencies")) { %>
            document.querySelector(".requirements").addEventListener("click", (e) => {
              e.preventDefault()
              e.stopPropagation()
              let el = e.target.closest(".opener")
              if (!el) {
                if (e.target.classList.contains("opener")) {
                  el = e.target
                }
              }
              if (el) {
                window.open(el.getAttribute("data-href"), "_blank", "app")
              }
            })
            <% } %>
            */
            let params = new URLSearchParams(location.search)
        let selected = params.get("selected")
        if (selected) {
          document.querySelector("form input[type=search]").value = selected
          document.querySelector("form input[type=search]").dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
        }
        if (document.querySelector("form input[type=search]")) {
          document.querySelector("form input[type=search]").addEventListener("input", (e) => {
            let p
            if (e.target.value && e.target.value.trim().length > 0) {
              p = location.pathname + "?selected=" + e.target.value
            } else {
              p = location.pathname
            }
            window.history.pushState({ path: p }, '', p);
          })
        }
<% if (ishome) { %>
// if launch_complete is true => already finished launching so no need to refresh
// if launch_complete is false => not finished launching. wait until it's complete, and then refresh
// autolaunch display update
<% if (!launch_complete) { %>
//  let interval = setInterval(async () => {
//    let res = await fetch("/pinokio/info").then((res) => {
//      return res.json()
//    })
//    if (res.launch_complete) {
//      console.log("launched")
//      clearInterval(interval)
//      location.href = location.href
//    } else {
//      console.log("not yet launched")
//    }
//  }, 1000)
<% } %>
            document.addEventListener("keydown", (e) => {
              e = e || window.event;
              if (e.key === "ArrowUp") {
                console.log("up arrow pressed");
                selectedIndex = Math.max(selectedIndex - 1, 0)
                selectedBtnIndex = 0
                renderSearch()
                let selected = document.querySelector(".line.selected")
                selected.scrollIntoView(false)
                // 
              } else if (e.key === "ArrowDown") {
                console.log("before selectedIndex", selectedIndex)
                selectedIndex = Math.min(filteredCount - 1, selectedIndex + 1)
                selectedBtnIndex = 0
                console.log("after selectedIndex", selectedIndex)
                renderSearch()
                console.log("down arrow pressed");
                let selected = document.querySelector(".line.selected")
                selected.scrollIntoView(false)
              } else if (e.key === "ArrowLeft") {
                selectedBtnIndex = Math.max(selectedBtnIndex - 1, 0)
                console.log("left arrow pressed");
                console.log("selectedBtnIndex", selectedBtnIndex)
                renderSearch()
              } else if (e.key === "ArrowRight") {
                console.log("right arrow pressed");
                selectedBtnIndex = Math.min(filteredBtnsCount - 1, selectedBtnIndex + 1)
                console.log("selectedBtnIndex", selectedBtnIndex)
                renderSearch()
              } else if (e.key === "Enter") {
                //let selected = document.querySelector(".line.selected:not(.hidden) .btns a.selected")
                //let selected = document.querySelector(".line.selected:not(.hidden) .title a")
                let selected = document.querySelector(".line.selected:not(.hidden)")
                console.log("selected", selected)
                if (selected) {
                  e.preventDefault()
                  e.stopPropagation()
                  selected.click()
                }
              }
            });
          const supportsNativePopovers = typeof document.createElement('div').showPopover === 'function'
          if (!supportsNativePopovers) {
            document.querySelectorAll('.context-menu[popover]').forEach((menu) => {
              menu.style.display = 'none'
            })
          }
          const getMenuDimensions = (menu) => {
            let width = parseFloat(menu.dataset.cachedWidth)
            let height = parseFloat(menu.dataset.cachedHeight)
            if (!width || !height) {
              const prev = {
                visibility: menu.style.visibility,
                display: menu.style.display,
                position: menu.style.position,
                top: menu.style.top,
                left: menu.style.left,
              }
              menu.style.visibility = 'hidden'
              menu.style.display = 'block'
              menu.style.position = 'fixed'
              menu.style.top = '0'
              menu.style.left = '0'
              width = menu.offsetWidth
              height = menu.offsetHeight
              if (width > 0) {
                menu.dataset.cachedWidth = width
              }
              if (height > 0) {
                menu.dataset.cachedHeight = height
              }
              menu.style.visibility = prev.visibility
              menu.style.display = prev.display
              menu.style.position = prev.position
              menu.style.top = prev.top
              menu.style.left = prev.left
            }
            return {
              width: width || 0,
              height: height || 0
            }
          }
          document.addEventListener("click", async (e) => {
            if (e.target.classList.contains("shutdown")) {
              target = e.target
            } else {
              target = e.target.closest(".shutdown")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()
              let src = target.getAttribute("data-src")
              let id = target.getAttribute('data-id')
              let type = target.getAttribute('data-type')
              console.log({ id, src, type })

              let params = {}
              if (id) params.id = id
              if (src) params.uri = "~/" + src

              if (type === "shell") {
                socket.run({
                  method: "kernel.bin.shell_kill",
                  params: { id }
                }, (packet) => {
                  console.log("packet", packet)
                  if (packet.type === "result") {
                    socket.close()
                    target.querySelector("i.fa-stop").className = "fa-solid fa-check"
                    target.querySelector("i.fa-spin").classList.add("hidden")
                    n.Noty({
                      text: `stopped`,
                      silent: true
                    })
                    setTimeout(() => {
                      location.href = location.href
                    }, 500)
                  }
                })
              } else {
                socket.run({
                  method: "kernel.api.stop",
                  params,
                }, (packet) => {
                  console.log("packet", packet)
                  if (packet.type === "result") {
                    socket.close()
                    target.querySelector("i.fa-stop").className = "fa-solid fa-check"
                    target.querySelector("i.fa-spin").classList.add("hidden")
                    n.Noty({
                      text: `stopped ${src}`,
                      silent: true
                    })
                    setTimeout(() => {
                      location.href = location.href
                    }, 500)
                  }
                })
              }


              return
            }
            if (e.target.classList.contains("open-menu")) {
              target = e.target
            } else {
              target = e.target.closest(".open-menu")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()
              let popoverId = target.getAttribute('popovertarget')
              let contextMenu
              if (popoverId) {
                contextMenu = document.getElementById(popoverId)
              }
              if (!contextMenu) {
                contextMenu = target.closest(".col")?.querySelector(".context-menu")
              }
              if (contextMenu) {
                const hasNativePopover = supportsNativePopovers && typeof contextMenu.showPopover === 'function'
                const isOpen = hasNativePopover ? contextMenu.matches(':popover-open') : contextMenu.dataset.open === 'true'
                if (isOpen) {
                  if (hasNativePopover) {
                    contextMenu.hidePopover()
                  } else {
                    contextMenu.style.display = 'none'
                    contextMenu.dataset.open = 'false'
                  }
                  return
                }
                if (hasNativePopover) {
                  document.querySelectorAll('.context-menu[popover]').forEach((menuEl) => {
                    if (menuEl !== contextMenu && menuEl.matches(':popover-open') && typeof menuEl.hidePopover === 'function') {
                      menuEl.hidePopover()
                    }
                  })
                } else {
                  document.querySelectorAll('.context-menu[data-open="true"]').forEach((menuEl) => {
                    if (menuEl !== contextMenu) {
                      menuEl.style.display = 'none'
                      menuEl.dataset.open = 'false'
                    }
                  })
                }
                const buttonRect = target.getBoundingClientRect()
                const menuRect = getMenuDimensions(contextMenu)
                const viewportPadding = 12
                let left = Math.min(buttonRect.left, window.innerWidth - menuRect.width - viewportPadding)
                left = Math.max(viewportPadding, left)
                let top = buttonRect.bottom + 6
                if (top + menuRect.height + viewportPadding > window.innerHeight) {
                  top = buttonRect.top - menuRect.height - 6
                }
                const maxTop = Math.max(viewportPadding, window.innerHeight - menuRect.height - viewportPadding)
                top = Math.min(Math.max(viewportPadding, top), maxTop)
                if (hasNativePopover) {
                  contextMenu.style.position = 'fixed'
                  contextMenu.style.left = left + 'px'
                  contextMenu.style.top = top + 'px'
                  contextMenu.style.right = 'auto'
                  contextMenu.style.bottom = 'auto'
                  contextMenu.togglePopover()
                } else {
                  const btnContainer = target.closest('.menu-btns')
                  if (!btnContainer) {
                    return
                  }
                  const containerRect = btnContainer.getBoundingClientRect()
                  contextMenu.style.left = Math.max(0, left - containerRect.left) + 'px'
                  contextMenu.style.top = top - containerRect.top + 'px'
                  contextMenu.style.right = 'auto'
                  contextMenu.style.bottom = 'auto'
                  contextMenu.style.display = 'block'
                  contextMenu.dataset.open = 'true'
                }
              }
              return
            }
            if (e.target.classList.contains("move-menu")) {
              target = e.target
            } else {
              target = e.target.closest(".move-menu")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()

              let disable_message = target.getAttribute('data-disable')
              if (disable_message && disable_message.length > 0) {
                await UI.alert(disable_message)
                return
              }

              let line = target.closest(".line")
              let title = line.getAttribute("data-title")
              let icon = line.getAttribute("data-icon")
              let iconpath = line.getAttribute("data-iconpath")
              let path = line.getAttribute("data-path")
              let description = line.getAttribute("data-description")
              await FSEditor({
                title,
                description,
                old_path: path,
                icon,
                iconpath,
                move: true,
                edit: true,
                redirect: (new_path) => {
                  return location.href
                }
              })
              return
            }

            if (e.target.classList.contains("copy-menu")) {
              target = e.target
            } else {
              target = e.target.closest(".copy-menu")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()
              let line = target.closest(".line")
              let title = line.getAttribute("data-title")
              let icon = line.getAttribute("data-icon")
              let iconpath = line.getAttribute("data-iconpath")
              let path = line.getAttribute("data-path")
              let description = line.getAttribute("data-description")
              await FSEditor({
                title,
                description,
                old_path: path,
                icon,
                iconpath,
                copy: true,
                edit: true,
                redirect: (new_path) => {
                  return location.href
                }
              })
              return
            }

            if (e.target.classList.contains("edit-menu")) {
              target = e.target
            } else {
              target = e.target.closest(".edit-menu")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()
              let line = target.closest(".line")
              let title = line.getAttribute("data-title")
              let icon = line.getAttribute("data-icon")
              let iconpath = line.getAttribute("data-iconpath")
              let path = line.getAttribute("data-path")
              let description = line.getAttribute("data-description")
              await FSEditor({
                title,
                description,
                old_path: path,
                icon,
                iconpath,
                edit: true,
                redirect: (new_path) => {
                  return location.href
                }
              })
              return
            }




            if (e.target.classList.contains("browse")) {
              target = e.target
            } else {
              target = e.target.closest(".browse")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()
              let src = target.getAttribute("data-src")
              if (window.PinokioHomeGuardNavigate) {
                window.PinokioHomeGuardNavigate(src)
              } else {
                location.href = src
              }
              return
            }


            // delete
            if (e.target.classList.contains("del")) {
              target = e.target
            } else {
              target = e.target.closest(".del")
            }
            if (target) {
              e.preventDefault()
              e.stopPropagation()

              let disable_message = target.getAttribute('data-disable')
              if (disable_message && disable_message.length > 0) {
                await UI.alert(disable_message)
                return
              }

              let confirmed = await UI.confirm("Are you sure you want to delete the folder? All files in the folder will be gone.")
              if (confirmed) {
                let itemEl = target.closest(".line[data-uri]")
                let name = itemEl.getAttribute("data-uri")
                console.log("delete", name)
                Swal.fire({
                  html: '<i class="fa-solid fa-circle-notch fa-spin"></i> Deleting',
                  customClass: {
                    container: "loader-container",
                    popup: "loader-popup",
                    htmlContainer: "loader-dialog",
                    footer: "hidden",
                    actions: "hidden"
                  }
                });
                let res = await fetch("/pinokio/delete", {
                  method: "post",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({ name })
                }).then((res) => {
                  return res.json()
                })
                console.log("res", res)
                Swal.close()
                if (res) {
                  debugger
                  if (res.success) {
                    location.href = "/home"
                  } else if (res.error) {
                    await UI.error(res.error)
                  }
                }
              } else {
              }
              return
            }



            if (document.querySelector(".container")) {
              document.querySelector(".container").addEventListener("click", async (e) => {
                //let el = e.target.closest(".menu-btn")
                //if (!el) {
                //  if (el.classList.contains("menu-btn")) {
                //    el = e.target
                //  }
                //}

                let el
                if (e.target.classList.contains("menu-btn")) {
                  el = e.target
                } else {
                  if (e.target.closest(".menu-btn")) {
                    el = e.target
                  }
                }

                console.log("EL", el)

                if (el) {
                  e.preventDefault()
                  e.stopPropagation()
                  let actionStr = el.getAttribute("data-action")
                  if (actionStr) {
                    let action = JSON.parse(actionStr)
                    console.log("action", action)
                    if (action.method === "stop" && action.uri) {
                      socket.run({
                        method: "kernel.api.stop",
                        params: {
                          uri: action.uri//"~" + location.pathname
                        }
                      }, (packet) => {
                        console.log("packet", packet)
                        if (packet.type === "result") {
                          socket.close()
                          location.href = location.href
                        }
                      })
                      return
                    }
                  }

                }
              })
            }




            /*
              target = (e.target.classList.contains(".btn") ? e.target : e.target.closest(".btn"))
              if (target) {
                target.classList.add("clicked")   
                document.querySelectorAll(".line .btns .btn").forEach((e) => {
                  e.classList.remove("selected")
                })
                target.classList.add("selected")
                target.closest(".line").classList.add("selected")
                return
              }
              */


          })
            <% if (proxy) { %>
  if (document.querySelector("#wifi-qr")) {
                document.querySelector("#wifi-qr").addEventListener("click", async (e) => {
                  await Swal.fire({
                    title: "Local Share",
                    customClass: {
                      popup: "min-popup",
                      title: "min-title"
                    },
                    showConfirmButton: false,
                    html: `<div class='min-modal'>
        <div>Access Pinokio from</div>
        <div>any local network device</div>
        <div><img src="<%=qr%>"></div>
    <a href="<%=proxy.proxy%>" target="_blank"><%=proxy.proxy%></a>
    </div>`
                  })
                })
              }
              if (document.querySelector("#wifi-stop")) {
                document.querySelector("#wifi-stop").addEventListener("click", async (e) => {
                  let res = await fetch("/unpublish", {
                    method: "post",
                    headers: {
                      "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                      type: "local"
                    })
                  }).then((res) => {
                    return res.json()
                  })
                  console.log(res)
                  location.href = location.href
                })
              }
<% } %>
<% if (cloudflare_pub) { %>
  if (document.querySelector("#cloudflare-qr")) {
              document.querySelector("#cloudflare-qr").addEventListener("click", async (e) => {
                await Swal.fire({
                  title: "Public Share",
                  customClass: {
                    popup: "min-popup",
                    title: "min-title"
                  },
                  showConfirmButton: false,
                  html: `<div class='min-modal'>
        <div>Access Pinokio from anywhere</div>
        <div>(powered by cloudflare tunnel)</div>
        <div><img src="<%=qr_cloudflare%>"></div>
    <a href="<%=cloudflare_pub%>" target="_blank"><%=cloudflare_pub%></a>
    </div>`
                })
              })
            }
            if (document.querySelector("#cloudflare-stop")) {
              document.querySelector("#cloudflare-stop").addEventListener("click", async (e) => {
                let res = await fetch("/unpublish", {
                  method: "post",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    type: "cloudflare"
                  })
                }).then((res) => {
                  return res.json()
                })
                console.log(res)
                location.href = location.href
              })
            }
<% } %>
if (document.querySelector("#wifi")) {
            document.querySelector("#wifi").addEventListener("click", async (e) => {
              document.querySelector("#wifi").classList.add("hidden")
              document.querySelector("#wifi-starting").classList.remove("hidden")
              let res = await fetch("/publish", {
                method: "post",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  type: "local"
                })
              }).then((res) => {
                return res.json()
              })
              console.log(res)
              location.href = location.href
            })
          }
          if (document.querySelector("#cloudflare")) {
            document.querySelector("#cloudflare").addEventListener("click", async (e) => {
              document.querySelector("#cloudflare").classList.add("hidden")
              document.querySelector("#cloudflare-starting").classList.remove("hidden")
              let res = await fetch("/publish", {
                method: "post",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  type: "cloudflare"
                })
              }).then((res) => {
                return res.json()
              })
              console.log(res)
              location.href = location.href
            })
          }
<% } %>

          // Initialize URL Dropdown with empty behavior
          document.addEventListener('DOMContentLoaded', function () {
            initUrlDropdown({
              clearBehavior: 'empty'
            });
          });

      </script>
      <script src="/opener.js"></script>
      <script src="/sweetalert2.js"></script>
      <script src="/ui_service.js"></script>
</body>

</html>