<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="/xterm.min.css" rel="stylesheet" />
  <link href="/css/fontawesome.min.css" rel="stylesheet">
  <link href="/css/solid.min.css" rel="stylesheet">
  <link href="/css/regular.min.css" rel="stylesheet">
  <link href="/css/brands.min.css" rel="stylesheet">
  <link href="/markdown.css" rel="stylesheet" />
  <link href="/noty.css" rel="stylesheet" />
  <link href="/style.css" rel="stylesheet" />
  <link href="/urldropdown.css" rel="stylesheet" />
  <% if (agent==="electron" ) { %>
    <link href="/electron.css" rel="stylesheet" />
    <% } %>
      <style>
        main {
          display: flex;
        }

        aside {
          width: 200px;
          display: block;
          flex-shrink: 0;
        }

        aside .tab i {
          width: 20px;
          text-align: center;
        }

        body.dark aside .tab {
          color: white;
        }

        body.dark aside .tab:hover,
        aside .tab:hover {
          color: rgba(127, 91, 243, 0.9) !important;
          opacity: 1;
        }

        aside .tab {
          display: flex;
          align-items: center;
          gap: 5px;
          color: black;
          text-decoration: none;
          padding: 10px;
          font-size: 12px;
          opacity: 0.5;
          border-left: 10px solid transparent;
        }

        body.dark aside .tab.selected {
          color: white;
        }

        aside .tab.selected {
          font-weight: bold;
          opacity: 1;
        }

        @media only screen and (max-width: 600px) {
          aside {
            width: unset;
            flex-shrink: unset;
          }

          aside {
            padding: 0 10px;
          }

          aside .tab.submenu {
            padding: 10px;
          }

          aside .tab i {
            width: 100%;
          }

          aside .tab .caption {
            display: none;
          }

          aside .tab {
            margin: 0;
            padding: 10px;
            border-left: none;
          }

          aside .btn-tab {
            flex-direction: column;
            padding: 10px 0;
          }

          aside .btn-tab .btn {
            display: flex;
            justify-content: center;
          }

          aside .btn-tab .btn .caption {
            display: none;
          }

          header .flexible {
            min-width: unset;
          }
        }

        @media only screen and (max-width: 480px) {
          .btn2 {
            padding: 5px;
            font-size: 11px;
          }

          .nav-btns {
            flex-grow: 1;
            justify-content: center;
            padding: 0;
          }
        }

        .backups-container {
          padding: 20px;
        }

        .backups-container h2 {
          font-size: 24px;
          margin-bottom: 15px;
        }

        .backup-meta {
          font-size: 12px;
          opacity: 0.75;
        }

        body.dark .swal2-popup.backup-modal-shell,
        .swal2-popup.backup-modal-shell {
          border: none;
          background: transparent;
          box-shadow: none;
          padding: 0;
          width: auto;
        }

        .backup-modal-wrapper {
          display: flex;
          justify-content: center;
        }

        .backup-modal-content {
          text-align: left;
          width: min(640px, calc(100vw - 48px));
          gap: 14px;
          position: relative;
          max-height: calc(100vh - 160px);
          max-height: calc(100dvh - 160px);
          min-height: 0;
        }

        .backup-modal-header h3 {
          margin: 0 0 4px 0;
          font-size: 22px;
          font-weight: 700;
        }

        .backup-modal-description {
          margin: 0 0 6px 0;
          font-size: 14px;
          color: rgba(71, 85, 105, 0.78);
        }

        body.dark .backup-modal-description {
          color: rgba(203, 213, 225, 0.88);
        }

        .backup-modal.snapshot-options {
          display: flex;
          flex-direction: column;
          gap: 10px;
          flex: 1 1 auto;
          min-height: 0;
          overflow-y: auto;
          padding: 2px 6px 6px 2px;
          overscroll-behavior: contain;
        }

        .line.backup-row {
          cursor: pointer;
          transition: background 0.15s ease, box-shadow 0.15s ease;
        }

        .line.backup-row:hover {
          background: rgba(127, 91, 243, 0.05);
          box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
        }

        .snapshot-option {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          font-size: 14px;
          cursor: pointer;
          margin: 0;
        }

        .snapshot-card {
          flex: 1;
          border: 1px solid rgba(15, 23, 42, 0.12);
          border-radius: 6px;
          padding: 12px;
          background: rgba(248, 250, 255, 0.9);
          /*
  box-shadow: 0 5px 12px rgba(15, 23, 42, 0.1);
  */
        }

        .snapshot-card.snapshot-card--with-repos {
          align-items: flex-start;
        }

        body.dark .snapshot-card {
          background: rgba(15, 23, 42, 0.86);
          border-color: rgba(148, 163, 184, 0.2);
        }

        .snapshot-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 8px;
          margin-bottom: 6px;
        }

        .snapshot-card.snapshot-card--with-repos .snapshot-header {
          grid-column: 1 / 3;
        }

        .snapshot-title {
          font-weight: 700;
          font-size: 15px;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .snapshot-meta {
          font-size: 12px;
          opacity: 0.75;
        }

        .snapshot-card.snapshot-card--with-repos .snapshot-meta {
          grid-column: 1 / 3;
          margin-bottom: 4px;
        }

        .snapshot-actions {
          display: flex;
          justify-content: flex-end;
          margin-top: 10px;
          gap: 10px;
          flex-wrap: wrap;
          align-items: center;
        }

        .snapshot-header .snapshot-actions {
          margin-top: 0;
        }

        .snapshot-actions .snapshot-install {
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
        }

        .snapshot-actions .snapshot-delete {
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 600;
        }

        .url-modal-button.danger {
          background: rgba(239, 68, 68, 0.12);
          border: 1px solid rgba(239, 68, 68, 0.4);
          color: rgba(185, 28, 28, 0.95);
        }

        .url-modal-button.danger:hover {
          background: rgba(239, 68, 68, 0.2);
          box-shadow: 0 12px 28px rgba(239, 68, 68, 0.16);
        }

        body.dark .url-modal-button.danger {
          background: rgba(239, 68, 68, 0.16);
          border-color: rgba(248, 113, 113, 0.5);
          color: rgba(254, 202, 202, 0.95);
        }

        .snapshot-option input[type="radio"] {
          margin-top: 6px;
        }

        .repo-list {
          margin-top: 10px;
        }

        .snapshot-card.snapshot-card--with-repos .repo-list {
          border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        body.dark .repo-line {
          border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .repo-line {
          display: flex;
          flex-direction: column;
          gap: 2px;
          align-items: flex-start;
          font-size: 14px;
          padding: 8px 0;
          border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .repo-line:last-child {
          border-bottom: none;
        }

        .repo-line-main {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .repo-path {
          font-weight: 700;
        }

        .repo-commit code {
          background: rgba(0, 0, 0, 0.05);
          padding: 3px 6px;
          border-radius: 4px;
          font-size: 12px;
        }

        body.dark .repo-message {
          color: silver;
        }

        .repo-message {
          color: #333;
        }

        .repo-person {
          font-style: italic;
          opacity: 0.75;
        }

        .installed-list {
          margin-top: 8px;
          font-size: 12px;
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          align-items: center;
        }

        .snapshot-card.snapshot-card--with-repos .installed-list {
          grid-column: 2 / 3;
        }

        .installed-list span {
          font-weight: 700;
        }

        .installed-link {
          color: rgba(127, 91, 243, 0.95);
          text-decoration: none;
        }

        .installed-link:hover {
          text-decoration: underline;
        }

        .backup-modal.folder-row {
          margin-top: 10px;
        }

        .backup-modal label {
          display: block;
          font-weight: 600;
          margin-bottom: 5px;
        }

        .backup-modal input[type="text"] {
          width: 100%;
          padding: 12px 14px;
          border: 1px solid rgba(15, 23, 42, 0.12);
          border-radius: 12px;
          box-sizing: border-box;
        }

        body.dark .backup-modal input[type="text"] {
          border-color: rgba(148, 163, 184, 0.3);
          background: rgba(148, 163, 184, 0.14);
          color: rgba(226, 232, 240, 0.95);
        }

        .backup-modal.hidden,
        .backup-loading.hidden {
          display: none;
        }

        .folder-hint {
          font-size: 12px;
          color: #c0392b;
          margin-top: 6px;
        }

        .backup-loading {
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          background: rgba(15, 23, 42, 0.06);
          border-radius: 18px;
          backdrop-filter: blur(2px);
          z-index: 10;
        }

        body.dark .backup-loading {
          background: rgba(15, 23, 42, 0.2);
        }

        .backup-loading.hidden {
          display: none;
        }

        .backup-loading .spinner {
          width: 18px;
          height: 18px;
          border: 3px solid rgba(15, 23, 42, 0.15);
          border-top-color: rgba(127, 91, 243, 0.95);
          border-radius: 50%;
          animation: backup-spin 0.8s linear infinite;
        }

        @keyframes backup-spin {
          to {
            transform: rotate(360deg);
          }
        }

        .backup-loading .backup-loading-text {
          font-weight: 600;
          color: rgba(15, 23, 42, 0.9);
        }

        body.dark .backup-loading .backup-loading-text {
          color: rgba(226, 232, 240, 0.95);
        }
      </style>
      <script src="/window_storage.js"></script>
      <script src="/hotkeys.min.js"></script>
      <script src="/sweetalert2.js"></script>
      <script src="/noty.js"></script>
      <script src="/notyq.js"></script>
      <script src="/xterm.js"></script>
      <script src="/xterm-addon-fit.js"></script>
      <script src="/xterm-addon-web-links.js"></script>
      <script src="/xterm-theme.js"></script>
      <script src="/Socket.js"></script>
      <script src="/common.js"></script>
      <script src="/opener.js"></script>
      <script src="/nav.js"></script>
      <script src="/urldropdown.js"></script>
      <script src="/ui_service.js"></script>
      <script src="/report.js"></script>
      <script>
        window.backupItems = <% - JSON.stringify(items || []) %>;
        window.backupAutoInstall = <% - JSON.stringify(autoInstall || null) %>;
        window.backupImportError = <% - JSON.stringify(importError || null) %>;
        window.registryBetaEnabled = <% - JSON.stringify(!!registryBetaEnabled) %>;
        document.addEventListener("DOMContentLoaded", () => {
          const items = Array.isArray(window.backupItems) ? window.backupItems : []
          const autoInstall = window.backupAutoInstall && typeof window.backupAutoInstall === "object" ? window.backupAutoInstall : null
          const importError = typeof window.backupImportError === "string" && window.backupImportError.trim() ? window.backupImportError.trim() : null
          const registryBetaEnabled = window.registryBetaEnabled === true

          const escapeHtml = (value) => {
            const str = value == null ? '' : String(value)
            return str.replace(/[&<>"']/g, (ch) => {
              switch (ch) {
                case '&': return '&amp;'
                case '<': return '&lt;'
                case '>': return '&gt;'
                case '"': return '&quot;'
                case "'": return '&#39;'
                default: return ch
              }
            })
          }
          const escapeAttr = (value) => escapeHtml(value)

          const guessFolderName = (remoteUrl) => {
            if (!remoteUrl || typeof remoteUrl !== "string") return "project"
            let str = remoteUrl.replace(/\.git$/i, '')
            const atIdx = str.lastIndexOf('@')
            if (atIdx !== -1) {
              str = str.slice(atIdx + 1)
            }
            const parts = str.split(/[/:\\]/).filter(Boolean)
            const last = parts.length ? parts[parts.length - 1] : "project"
            const safe = last.replace(/[^a-zA-Z0-9._-]/g, '-')
            return safe || "project"
          }

          const formatPerson = (person) => {
            if (!person) return null
            const name = person.name || ""
            let date = null
            if (Number.isFinite(person.timestamp)) {
              try {
                date = new Date(person.timestamp * 1000).toLocaleString()
              } catch (_) { }
            }
            const label = name.trim()
            if (label && date) return `${label} · ${date}`
            if (label) return label
            if (date) return date
            return null
          }

          const renderSnapshotOption = (snap, isLatest, installedNames) => {
            if (isLatest) {
              return `
        <div class="snapshot-option">
          <div class="snapshot-card snapshot-card--latest" data-snapshot-id="latest">
            <div class="snapshot-header">
              <div class="snapshot-title"><i class="fa-solid fa-clock-rotate-left"></i> Latest</div>
              <div class="snapshot-actions">
                <button type="button" class="url-modal-button confirm snapshot-install" data-snapshot-id="latest">Install</button>
              </div>
            </div>
            <div class="snapshot-meta">Clone the current default branch HEAD.</div>
          </div>
        </div>
      `
            }
            const repos = Array.isArray(snap.repos) ? snap.repos : []
            const repoList = repos.map((repo) => {
              const hash = escapeHtml(repo.commit ? repo.commit.slice(0, 8) : "unknown")
              const message = escapeHtml(repo.message ? repo.message.split('\n')[0].trim() : "(no message recorded)")
              const person = formatPerson(repo.author || repo.committer)
              const personLabel = person ? escapeHtml(person) : null
              const pathLabel = escapeHtml(repo.path || '.')
              return `
	        <div class="repo-line">
	          <div class="repo-line-main">
	            <div class="repo-path">${pathLabel}</div>
	            <div class="repo-commit"><code>${hash}</code></div>
	          </div>
	          <div class="repo-message">${message}</div>
	          ${personLabel ? `<div class="repo-person">${personLabel}</div>` : ''}
	        </div>
        `
            }).join("")
            const label = "Checkpoint"
            const snapTimestamp = snap && snap.id != null ? Number(snap.id) : Number.NaN
            const whenRaw = Number.isFinite(snapTimestamp) && snapTimestamp > 0 ? new Date(snapTimestamp).toLocaleString() : ""
            const when = whenRaw ? escapeHtml(whenRaw) : ""
            const plat = snap && snap.platform ? escapeHtml(String(snap.platform)) : ""
            const arch = snap && snap.arch ? escapeHtml(String(snap.arch)) : ""
            const gpu = snap && snap.gpu ? escapeHtml(String(snap.gpu)) : ""
            const ramVal = snap && typeof snap.ram === "number" ? snap.ram : null
            const vramVal = snap && typeof snap.vram === "number" ? snap.vram : null
            const envParts = []
            if (plat) envParts.push(plat)
            if (arch) envParts.push(arch)
            if (gpu) envParts.push(gpu)
            if (ramVal != null && ramVal > 0) envParts.push(`${ramVal} GB RAM`)
            if (vramVal != null && vramVal > 0) envParts.push(`${vramVal} GB VRAM`)
            const envText = envParts.join(" · ")
            const metaParts = []
            metaParts.push(`${repos.length} repo${repos.length === 1 ? '' : 's'}`)
            if (when) metaParts.push(when)
            const metaText = metaParts.join(" · ")
            const syncStatus = snap && snap.sync && snap.sync.status ? String(snap.sync.status) : null
            const publishMarkup = registryBetaEnabled
              ? (syncStatus === "published"
                ? `<span class="badge">Cloud saved</span>`
                : `<button type="button" class="url-modal-button confirm snapshot-publish" data-snapshot-id="${snap.id}">Save to Cloud</button>`)
              : ""
            const installed = Array.isArray(installedNames) ? installedNames : []
            const installedMarkup = installed.length
              ? `<div class="installed-list"><span>Installed:</span> ${installed.map((name) => `<a href="/p/${encodeURIComponent(name)}" class="installed-link">/p/${escapeHtml(name)}</a>`).join(", ")}</div>`
              : ""
            return `
        <div class="snapshot-option">
          <div class="snapshot-card snapshot-card--with-repos" data-snapshot-id="${snap.id}">
            <div class="snapshot-header">
              <div class="snapshot-title"><i class="fa-regular fa-clock"></i> ${label}</div>
              <div class="snapshot-actions">
                ${publishMarkup}
                <button type="button" class="url-modal-button danger snapshot-delete" data-snapshot-id="${snap.id}">Delete</button>
                <button type="button" class="url-modal-button confirm snapshot-install" data-snapshot-id="${snap.id}">Install</button>
              </div>
            </div>
	            <div class="snapshot-meta">
	              ${envText ? `${envText} · ` : ""}${metaText}
	            </div>
            <div class="repo-list">${repoList}</div>
            ${installedMarkup}
          </div>
        </div>
      `
          }

          const openInstallModal = (item, opts = {}) => {
            const conflictNames = new Set((item.folders || []).map((f) => f.name))
            const installedBySnapshot = item.installedBySnapshot || {}
            const defaultFolder = (item.folders && item.folders[0] && item.folders[0].name) || guessFolderName(item.remoteUrl)
            const suggestName = (base) => {
              const clean = base && base.trim() ? base.trim() : defaultFolder
              if (!conflictNames.has(clean)) return clean
              let n = 2
              let candidate = `${clean}-${n}`
              while (conflictNames.has(candidate) && n < 100) {
                n += 1
                candidate = `${clean}-${n}`
              }
              return candidate
            }
            const snapshots = [renderSnapshotOption(null, true, (item.folders || []).map((f) => f.name))].concat(
              (item.snapshots || []).map((snap) => renderSnapshotOption(snap, false, installedBySnapshot[snap.id]))
            )
            const html = `
      <div class="backup-modal-wrapper">
        <div class="url-modal-content backup-modal-content" role="dialog" aria-modal="true" aria-labelledby="backup-modal-title" aria-describedby="backup-modal-description">
          <div class="backup-loading hidden" id="backup-loading">
            <div class="spinner"></div>
            <div class="backup-loading-text">Installing…</div>
          </div>
          <button type="button" class="url-modal-close" aria-label="Close">&times;</button>
          <div class="backup-modal-header">
            <h3 id="backup-modal-title">Install</h3>
            <p class="backup-modal-description" id="backup-modal-description">Pick a version and, if needed, a new folder name.</p>
          </div>
          <div class="backup-modal snapshot-options">${snapshots.join("")}</div>
          <div class="backup-modal folder-row hidden" id="folder-row">
            <label for="folder-name">New folder name</label>
            <input id="folder-name" type="text" value="${escapeAttr(defaultFolder)}" autocomplete="off" />
            <div class="folder-hint" id="folder-hint"></div>
          </div>
        </div>
      </div>
    `
            Swal.fire({
              html,
              showConfirmButton: false,
              showCancelButton: false,
              customClass: {
                popup: 'backup-modal-shell'
              },
              didOpen: () => {
                const container = Swal.getHtmlContainer()
                if (!container) return
                const folderRow = container.querySelector("#folder-row")
                const folderInput = container.querySelector("#folder-name")
                const hint = container.querySelector("#folder-hint")
                const closeBtn = container.querySelector('.url-modal-close')
                const installButtons = Array.from(container.querySelectorAll(".snapshot-install"))
                const deleteButtons = Array.from(container.querySelectorAll(".snapshot-delete"))
                const publishButtons = Array.from(container.querySelectorAll(".snapshot-publish"))
                const actionButtons = installButtons.concat(deleteButtons, publishButtons)
                const loadingOverlay = container.querySelector("#backup-loading")
                const loadingText = loadingOverlay ? loadingOverlay.querySelector(".backup-loading-text") : null
                const defaultLoadingText = loadingText ? loadingText.textContent : ""

                const setLoading = (isLoading, message) => {
                  if (loadingOverlay) {
                    loadingOverlay.classList.toggle("hidden", !isLoading)
                    if (loadingText) {
                      loadingText.textContent = isLoading ? (message || defaultLoadingText) : defaultLoadingText
                    }
                  }
                  actionButtons.forEach((btn) => {
                    btn.disabled = isLoading
                  })
                  if (closeBtn) closeBtn.disabled = isLoading
                }
                const openRenameModal = (baseName, message) => {
                  const suggested = escapeAttr(suggestName(baseName))
                  return new Promise((resolve) => {
                    const overlay = document.createElement("div")
                    overlay.className = "modal-overlay url-modal-overlay backup-rename-overlay is-visible"
                    overlay.innerHTML = `
              <div class="url-modal-content backup-modal-content" role="dialog" aria-modal="true" aria-labelledby="backup-rename-title">
                <button type="button" class="url-modal-close" aria-label="Close">&times;</button>
                <div class="backup-modal-header">
                  <h3 id="backup-rename-title">Choose a new folder</h3>
                  <p class="backup-modal-description">${escapeHtml(message || "Pick a different folder name for this install.")}</p>
                </div>
                <div class="backup-modal folder-row" style="margin-top: 0;">
                  <label for="rename-folder-name">Folder name</label>
                  <input id="rename-folder-name" type="text" value="${suggested}" autocomplete="off" />
                  <div class="folder-hint" id="rename-folder-hint"></div>
                </div>
                <div class="url-modal-actions">
                  <button type="button" class="url-modal-button cancel" data-action="cancel">Cancel</button>
                  <button type="button" class="url-modal-button confirm" data-action="confirm">Use name</button>
                </div>
              </div>
            `
                    document.body.appendChild(overlay)
                    const input = overlay.querySelector("#rename-folder-name")
                    const hintEl = overlay.querySelector("#rename-folder-hint")
                    const cancelBtn = overlay.querySelector('[data-action="cancel"]')
                    const confirmBtn = overlay.querySelector('[data-action="confirm"]')
                    const closeBtn = overlay.querySelector('.url-modal-close')
                    const cleanup = (value) => {
                      overlay.remove()
                      resolve(value)
                    }
                    const validate = () => {
                      const val = input.value.trim()
                      if (!val) {
                        hintEl.textContent = "Folder name required."
                        return null
                      }
                      if (val.includes('/') || val.includes('\\')) {
                        hintEl.textContent = "Folder name cannot contain slashes."
                        return null
                      }
                      hintEl.textContent = ""
                      return val
                    }
                    confirmBtn.addEventListener("click", () => {
                      const val = validate()
                      if (val) cleanup(val)
                    })
                    cancelBtn.addEventListener("click", () => cleanup(null))
                    closeBtn.addEventListener("click", () => cleanup(null))
                    input.addEventListener("keydown", (e) => {
                      if (e.key === "Enter") {
                        e.preventDefault()
                        confirmBtn.click()
                      }
                      if (e.key === "Escape") {
                        e.preventDefault()
                        cleanup(null)
                      }
                    })
                    setTimeout(() => {
                      input.focus()
                      input.select()
                    }, 0)
                  })
                }

                const handleInstall = async (snapshotId, forcedName) => {
                  let name = forcedName || (folderInput ? folderInput.value.trim() : '') || defaultFolder
                  const alreadyInstalled = snapshotId !== 'latest' ? (installedBySnapshot[snapshotId] || []) : []
                  const nameConflict = conflictNames.has(name)
                  const sameFolder = snapshotId !== 'latest' && alreadyInstalled.includes(name)
                  if (!name || name.includes('/') || name.includes('\\') || nameConflict || sameFolder) {
                    const reason = nameConflict
                      ? "Folder exists. Pick a different name."
                      : sameFolder
                        ? `Snapshot already installed in: ${alreadyInstalled.join(", ")}. Choose a different folder.`
                        : "Folder name required."
                    const rename = await openRenameModal(name || defaultFolder, reason)
                    if (!rename) return
                    name = rename
                  }
                  const installBtn = installButtons.find((b) => b.dataset.snapshotId === String(snapshotId))
                  if (installBtn) {
                    installBtn.disabled = true
                    installBtn.textContent = "Installing..."
                  }
                  setLoading(true, "Installing...")
                  try {
                    const res = await fetch("/checkpoints/install", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                      },
                      body: JSON.stringify({
                        remote: item.remoteUrl,
                        snapshotId,
                        folder: name
                      })
                    })
                    const payload = res && res.ok ? await res.json() : null
                    if (payload && payload.ok && payload.redirect) {
                      window.location = payload.redirect
                    } else {
                      if (payload && payload.code === "exists") {
                        const rename = await openRenameModal(name, "Folder exists. Pick a different name.")
                        if (rename) {
                          await handleInstall(snapshotId, rename)
                        }
                        return
                      }
                      const msg = payload && payload.error ? payload.error : "Install failed"
                      Swal.fire({ icon: "error", title: "Error", text: msg })
                    }
                  } catch (error) {
                    Swal.fire({ icon: "error", title: "Error", text: error && error.message ? error.message : "Install failed" })
                  } finally {
                    if (installBtn) {
                      installBtn.disabled = false
                      installBtn.textContent = "Install"
                    }
                    setLoading(false)
                  }
                }

                const updateItemRow = (currentItem) => {
                  if (!currentItem || !currentItem.remoteKey) return
                  const row = document.querySelector(`.backup-row[data-remote-key="${currentItem.remoteKey}"]`)
                  if (!row) return
                  const snapshots = Array.isArray(currentItem.snapshots) ? currentItem.snapshots : []
                  const badgeRow = row.querySelector(".description.backup-meta")
                  if (badgeRow) {
                    const badges = badgeRow.querySelectorAll(".badge")
                    if (badges.length > 1) {
                      const count = snapshots.length
                      badges[1].textContent = count
                        ? `${count} snapshot${count === 1 ? '' : 's'}`
                        : "No snapshots yet"
                    }
                  }
                  const latestRow = Array.from(row.querySelectorAll(".description.backup-meta"))
                    .find((el) => el.querySelector(".fa-regular.fa-clock"))
                  if (latestRow) {
                    if (!snapshots.length) {
                      latestRow.remove()
                    } else {
                      const span = latestRow.querySelector("span")
                      if (span) span.textContent = `Latest checkpoint: ${new Date(Number(snapshots[0].id)).toLocaleString()}`
                    }
                  }
                }

                const handleDelete = async (snapshotId, btn) => {
                  let closeAfterDelete = false
                  const idStr = snapshotId != null ? String(snapshotId).trim() : ""
                  if (!idStr || idStr === "latest") return
                  const installed = installedBySnapshot[idStr] || []
                  const snapInfo = Array.isArray(item.snapshots)
                    ? item.snapshots.find((snap) => snap && String(snap.id) === idStr)
                    : null
                  const confirmLines = [
                    "Delete this checkpoint locally?",
                    "This removes the local snapshot file and manifest entry."
                  ]
                  if (installed.length) {
                    confirmLines.push(`Installed in: ${installed.join(", ")}`)
                  }
                  if (snapInfo && snapInfo.sync && snapInfo.sync.status === "published") {
                    confirmLines.push("Cloud copy will remain in the registry.")
                  }
                  const confirmed = await UI.confirm(confirmLines.join("\n"))
                  if (!confirmed) return
                  if (btn) {
                    btn.disabled = true
                    btn.textContent = "Deleting..."
                  }
                  setLoading(true, "Deleting...")
                  try {
                    const res = await fetch("/checkpoints/delete", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                      },
                      body: JSON.stringify({
                        remote: item.remoteUrl,
                        snapshotId: idStr
                      })
                    })
                    const payload = res && res.ok ? await res.json() : null
                    if (payload && payload.ok) {
                      const option = btn ? btn.closest(".snapshot-option") : null
                      if (option) option.remove()
                      if (Array.isArray(item.snapshots)) {
                        item.snapshots = item.snapshots.filter((snap) => String(snap.id) !== idStr)
                      } else {
                        item.snapshots = []
                      }
                      if (installedBySnapshot && Object.prototype.hasOwnProperty.call(installedBySnapshot, idStr)) {
                        delete installedBySnapshot[idStr]
                      }
                      const remaining = Array.isArray(item.snapshots) ? item.snapshots.length : 0
                      if (remaining === 0) {
                        const row = document.querySelector(`.backup-row[data-remote-key="${item.remoteKey}"]`)
                        if (row) row.remove()
                        const idx = items.findIndex((entry) => entry && entry.remoteKey === item.remoteKey)
                        if (idx >= 0) items.splice(idx, 1)
                        closeAfterDelete = true
                      } else {
                        updateItemRow(item)
                      }
                    } else {
                      const msg = payload && payload.error ? payload.error : "Delete failed"
                      Swal.fire({ icon: "error", title: "Error", text: msg })
                    }
                  } catch (error) {
                    Swal.fire({ icon: "error", title: "Error", text: error && error.message ? error.message : "Delete failed" })
                  } finally {
                    if (btn) {
                      btn.disabled = false
                      btn.textContent = "Delete"
                    }
                    setLoading(false)
                    if (closeAfterDelete) {
                      try { Swal.close() } catch (_) { }
                    }
                  }
                }

                installButtons.forEach((btn) => {
                  btn.addEventListener("click", () => {
                    const snapshotId = btn.getAttribute("data-snapshot-id") || 'latest'
                    handleInstall(snapshotId)
                  })
                })

                deleteButtons.forEach((btn) => {
                  btn.addEventListener("click", () => {
                    const snapshotId = btn.getAttribute("data-snapshot-id") || ''
                    handleDelete(snapshotId, btn)
                  })
                })

                const highlightSnapshotId = opts && opts.highlightSnapshotId != null ? String(opts.highlightSnapshotId) : null
                setTimeout(() => {
                  let focusBtn = null
                  if (highlightSnapshotId) {
                    const card = container.querySelector(`.snapshot-card[data-snapshot-id="${highlightSnapshotId}"]`)
                    if (card) {
                      try {
                        card.scrollIntoView({ behavior: "smooth", block: "center" })
                      } catch (_) { }
                      try {
                        card.style.boxShadow = "0 0 0 2px rgba(127, 91, 243, 0.9)"
                      } catch (_) { }
                      focusBtn = card.querySelector(".snapshot-install")
                    }
                  }
                  if (!focusBtn && installButtons.length) {
                    focusBtn = installButtons[0]
                  }
                  if (focusBtn) {
                    try { focusBtn.focus() } catch (_) { }
                  }
                }, 0)

                const waitForRegistryLink = async () => {
                  const startedAt = Date.now()
                  while (Date.now() - startedAt < 120000) {
                    try {
                      const s = await fetch("/api/registry/status", { method: "GET", headers: { "Accept": "application/json" } })
                      if (s.ok) {
                        const data = await s.json()
                        if (data && data.linked) return true
                      }
                    } catch (_) { }
                    await new Promise((r) => setTimeout(r, 2000))
                  }
                  return false
                }
                const publishSnapshot = async (snapshotId, allowConnect = true) => {
                  const btn = publishButtons.find((b) => b.dataset.snapshotId === String(snapshotId))
                  const original = btn ? btn.textContent : "Save to Cloud"
                  if (btn) {
                    btn.disabled = true
                    btn.textContent = "Saving..."
                  }
                  try {
                    const qs = new URLSearchParams()
                    qs.set("snapshotId", String(snapshotId))
                    const res = await fetch(`/checkpoints/publish?${qs.toString()}`, { method: "POST", headers: { "Accept": "application/json" } })
                    const payload = res && res.ok ? await res.json() : null
                    if (payload && payload.publish && payload.publish.ok) {
                      const publishUrl = payload && payload.publish && payload.publish.url ? String(payload.publish.url) : ""
                      const linkHtml = publishUrl
                        ? `<a href="${escapeHtml(publishUrl)}" target="_blank" rel="noopener">View published checkpoint</a>`
                        : ""
                      Swal.fire({
                        icon: "success",
                        title: "Saved to Cloud",
                        html: linkHtml || undefined,
                        showConfirmButton: true,
                        confirmButtonText: "Close"
                      }).then(() => {
                        window.location.reload()
                      })
                      return
                    }
                    if (allowConnect && payload && payload.publish && payload.publish.code === "not_linked") {
                      const suggestedConnectUrl = payload.publish.connectUrl ? String(payload.publish.connectUrl) : ""
                      const connectUrl = await new Promise((resolve) => {
                        let settled = false
                        const cleanup = (value) => {
                          if (settled) return
                          settled = true
                          try { Swal.close() } catch (_) { }
                          resolve(value)
                        }
                        const html = `
		                  <div class="backup-modal-wrapper">
		                    <div class="url-modal-content backup-modal-content" role="dialog" aria-modal="true" aria-labelledby="registry-connect-title" aria-describedby="registry-connect-description">
		                      <button type="button" class="url-modal-close" aria-label="Close">&times;</button>
		                      <div class="backup-modal-header">
		                        <h3 id="registry-connect-title">Connect to Registry</h3>
		                        <p class="backup-modal-description" id="registry-connect-description">Enter your registry connect URL to link Pinokio, then we’ll retry the cloud save.</p>
		                      </div>
		                      <div class="backup-modal folder-row" style="margin-top: 0;">
		                        <label for="registry-connect-url">Registry URL</label>
		                        <input id="registry-connect-url" class="url-modal-input" type="url" value="${escapeAttr(suggestedConnectUrl)}" placeholder="https://your-registry/connect/pinokio" autocomplete="off" />
		                        <div class="folder-hint" id="registry-connect-hint"></div>
		                      </div>
		                      <div class="url-modal-actions">
		                        <button type="button" class="url-modal-button cancel" data-action="cancel">Cancel</button>
		                        <button type="button" class="url-modal-button confirm" data-action="confirm">Open connect page</button>
		                      </div>
		                    </div>
		                  </div>
		                `
                        Swal.fire({
                          html,
                          showConfirmButton: false,
                          showCancelButton: false,
                          allowOutsideClick: true,
                          customClass: { popup: 'backup-modal-shell' },
                          didOpen: () => {
                            const container = Swal.getHtmlContainer()
                            if (!container) return
                            const input = container.querySelector("#registry-connect-url")
                            const hint = container.querySelector("#registry-connect-hint")
                            const closeBtn = container.querySelector(".url-modal-close")
                            const cancelBtn = container.querySelector('[data-action="cancel"]')
                            const confirmBtn = container.querySelector('[data-action="confirm"]')
                            const validate = () => {
                              const val = input && input.value != null ? String(input.value).trim() : ""
                              if (!val) {
                                if (hint) hint.textContent = "Registry URL required."
                                return null
                              }
                              if (hint) hint.textContent = ""
                              return val
                            }
                            if (input) {
                              try { input.focus() } catch (_) { }
                              input.addEventListener("keydown", (e) => {
                                if (e.key === "Enter") {
                                  e.preventDefault()
                                  const val = validate()
                                  if (val) cleanup(val)
                                }
                              })
                            }
                            if (confirmBtn) {
                              confirmBtn.addEventListener("click", () => {
                                const val = validate()
                                if (val) cleanup(val)
                              })
                            }
                            if (cancelBtn) cancelBtn.addEventListener("click", () => cleanup(null))
                            if (closeBtn) closeBtn.addEventListener("click", () => cleanup(null))
                          }
                        }).then(() => cleanup(null))
                      })

                      if (!connectUrl) return
                      try {
                        window.open(connectUrl, "pinokio-registry-connect")
                      } catch (_) {
                        window.location.href = connectUrl
                        return
                      }
                      const linked = await waitForRegistryLink()
                      if (linked) {
                        await publishSnapshot(snapshotId, false)
                        return
                      }
                      Swal.fire({ icon: "error", title: "Not connected", text: "Could not confirm the registry connection." })
                      return
                    }
                    const msg = payload && payload.publish && payload.publish.error ? payload.publish.error : "Cloud save failed"
                    Swal.fire({ icon: "error", title: "Error", text: msg })
                  } catch (error) {
                    Swal.fire({ icon: "error", title: "Error", text: error && error.message ? error.message : "Cloud save failed" })
                  } finally {
                    if (btn) {
                      btn.disabled = false
                      btn.textContent = original
                    }
                  }
                }

                publishButtons.forEach((btn) => {
                  btn.addEventListener("click", () => {
                    const snapshotId = btn.getAttribute("data-snapshot-id") || ''
                    if (snapshotId) publishSnapshot(snapshotId)
                  })
                })

                const handleCancel = () => Swal.close()
                closeBtn && closeBtn.addEventListener("click", handleCancel)
              }
            })
          }

          document.querySelectorAll(".backup-row").forEach((row) => {
            row.addEventListener("click", () => {
              const key = row.getAttribute("data-remote-key")
              const item = items.find((i) => i.remoteKey === key)
              if (item) {
                openInstallModal(item)
              }
            })
          })

          if (importError) {
            Swal.fire({ icon: "error", title: "Import failed", text: importError })
          } else if (autoInstall && autoInstall.remoteKey) {
            const item = items.find((i) => i.remoteKey === autoInstall.remoteKey)
            if (item) {
              openInstallModal(item, { highlightSnapshotId: autoInstall.snapshotId })
            }
          }
        })
      </script>
</head>

<body class='<%=theme%>' data-agent="<%=agent%>">
  <header class='navheader grabbable'>
    <h1>
      <span class="sr-only">Checkpoints</span>
      <a class='home' href="/home" aria-label="Pinokio Home"><img class='icon' src="/pinokio-black.png"
          alt="Pinokio"></a>
    </h1>
  </header>
  <main class="fade-in">
    <div class='container'>
      <div class='content backups-container'>
        <h2>Checkpoints</h2>
        <p class="subtitle">Local version history for workspaces on this machine.</p>
        <div style="margin: 10px 0 20px 0;">
          <% if (checkpointsDir) { %>
            <button type="button" class="btn" data-filepath="<%= checkpointsDir %>">
              <i class="fa-solid fa-folder-open"></i> Open checkpoints folder
            </button>
            <% } %>
        </div>
        <% if (items && items.length> 0) { %>
          <% items.forEach((item)=> { %>
            <div class='line align-top backup-row item-card-hover' data-remote-key="<%=item.remoteKey%>">
              <h3>
                <div class='item-icon'>
                  <% if (item.icon) { %>
                    <img src="<%= item.icon %>"
                      onerror="this.onerror=null; this.style.opacity=0.4; this.src='/pinokio-black.png'">
                    <% } else { %>
                      <img src="/pinokio-black.png" style="opacity:0.4;"
                        onerror="this.onerror=null; this.src='/pinokio-black.png'">
                      <% } %>
                </div>
                <div class='col'>
                  <div class='title'>
                    <i class="fa-solid fa-circle"></i>
                    <span>
                      <%= item.title || item.displayName %>
                    </span>
                  </div>
                  <div class='uri'>
                    <%= item.remoteUrl %>
                  </div>
                  <% if (item.description) { %>
                    <div class='description'>
                      <%= item.description %>
                    </div>
                    <% } %>
                      <div class='description backup-meta'>
                        <span class="badge">
                          <%= (item.folders && item.folders.length) ? item.folders.length + ' local folder' +
                            (item.folders.length===1 ? '' : 's' ) : 'No local folders' %>
                        </span>
                        <span class="badge">
                          <%= (item.snapshots && item.snapshots.length) ? item.snapshots.length + ' snapshot' +
                            (item.snapshots.length===1 ? '' : 's' ) : 'No snapshots yet' %>
                        </span>
                      </div>
                      <% if (item.folders && item.folders.length> 0) { %>
                        <div class="description backup-meta">
                          <i class="fa-solid fa-folder-open"></i>
                          <span>Local: <%= item.folders.map((f)=> f.name).join(", ") %></span>
                        </div>
                        <% } %>
                          <% if (item.snapshots && item.snapshots.length> 0) { %>
                            <% const latest=item.snapshots[0]; %>
                              <div class="description backup-meta">
                                <i class="fa-regular fa-clock"></i>
                                <span>Latest checkpoint: <%= new Date(Number(latest.id)).toLocaleString() %></span>
                              </div>
                              <% } %>
                </div>
              </h3>
            </div>
            <% }) %>
              <% } else { %>
                <p>No history yet.</p>
                <% } %>
      </div>
    </div>
    <aside>
      <div class='btn-tab'>
        <button type='button' class='btn' id='create-launcher-button'><i class="fa-solid fa-plus"></i>
          <div class='caption'>Create</div>
        </button>
        <a class='btn' id='explore' href="/home?mode=explore"><i class="fa-solid fa-globe"></i>
          <div class='caption'>Discover</div>
        </a>
      </div>
      <a href="/home" class='tab'><i class='fas fa-laptop-code'></i>
        <div class='caption'>This machine</div>
      </a>
      <a href="/network" class='tab'><i class="fa-solid fa-wifi"></i>
        <div class='caption'>Local network</div>
      </a>
      <% if (list && list.length> 0) { %>
        <% let brands={ win32: "windows" , darwin: "apple" , linux: "Linux" } %>
          <% list.forEach(({ host, name, platform })=> { %>
            <a href="/net/<%=name%>" class='submenu tab'><i class="fa-brands fa-<%=brands[platform]%>"></i>
              <div class='caption'>
                <%=name%> (<%=current_host===host ? 'this machine' : host%>)
              </div>
            </a>
            <% }) %>
              <% } %>
                <a href="/connect" class='tab'><i class="fa-solid fa-plug"></i>
                  <div class='caption'>Login</div>
                </a>
                <a class='tab' href="<%=portal%>" target="_blank"><i class="fa-solid fa-question"></i>
                  <div class='caption'>Help</div>
                </a>
                <a class='tab' id='genlog' href="/logs"><i class="fa-solid fa-laptop-code"></i>
                  <div class='caption'>Logs</div>
                </a>
                <a class='tab selected' href="/checkpoints"><i class="fa-solid fa-clock-rotate-left"></i>
                  <div class='caption'>Checkpoints</div>
                </a>
                <a class='tab' href="/screenshots"><i class="fa-solid fa-camera"></i>
                  <div class='caption'>Screenshots</div>
                </a>
                <a class='tab' href="/tools"><i class="fa-solid fa-toolbox"></i>
                  <div class='caption'>Installed Tools</div>
                </a>
                <a class='tab' href="/agents"><i class="fa-solid fa-robot"></i>
                  <div class='caption'>Agents</div>
                </a>
                <a class='tab' href="/home?mode=settings"><i class="fa-solid fa-gear"></i>
                  <div class='caption'>Settings</div>
                </a>
                <%- include('partials/peer_access_points', { peer_access_points, peer_url, peer_qr }) %>
    </aside>
  </main>
</body>

</html>