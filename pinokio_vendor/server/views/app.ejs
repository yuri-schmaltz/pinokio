<html>

<head>
  <title>
    <%=config.title%>
  </title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="/css/fontawesome.min.css" rel="stylesheet">
  <link href="/css/solid.min.css" rel="stylesheet">
  <link href="/css/regular.min.css" rel="stylesheet">
  <link href="/css/brands.min.css" rel="stylesheet">
  <link href="/markdown.css" rel="stylesheet" />
  <link href="/noty.css" rel="stylesheet" />
  <link href="/filepond.min.css" rel="stylesheet" />
  <link href="/filepond-plugin-image-preview.min.css" rel="stylesheet" />
  <link href="/filepond-plugin-image-edit.min.css" rel="stylesheet" />
  <link href="/style.css" rel="stylesheet" />
  <link href="/urldropdown.css" rel="stylesheet" />
  <script src="/modalinput.js"></script>
  <script src="/pinokio-touch.js"></script>
  <% if (agent==="electron" ) { %>
    <link href="/electron.css" rel="stylesheet" />
    <% } %>
      <style>
        body.dark #devtab.selected {
          border: none;
          background: rgb(27, 28, 29) !important;
        }

        .config-info {
          display: flex;
          align-items: center;
          font-size: 12px;
          font-weight: bold;
        }


        #editortab {
          color: #7f5bf3;
        }

        body.dark #layout-toggle {
          color: white;
        }

        #layout-toggle {
          padding: 6px 10px;
          border: none;
          background: none;
          cursor: pointer;
          font-size: 16px;
        }

        #layout-toggle:hover,
        #layout-toggle:hover i {
          color: rgba(127, 91, 243, 0.95);
        }

        #devtab {
          align-items: center;
          justify-content: center;
          display: flex;
          padding: 5px 10px;
          box-sizing: border-box;
          min-width: 0;
          flex-shrink: 0;
          border-radius: var(--sidebar-tab-radius);
          color: var(--pinokio-sidebar-tab-active-color);
          background: none;
          border-bottom-left-radius: 0;
          border-bottom-right-radius: 0;
          border-bottom: none;
        }

        #devtab .loader {
          padding: 10px;
        }

        #devtab .tab {
          padding: 0;
        }

        #devtab img {
          /*
  width: 50px;
  height: 50px;
  margin-right: 10px;
  */
          margin-right: 10px;
          width: 20px;
          height: 20px;
        }

        .menu-container {
          overflow: auto;
        }

        body.dark .mode-display {
          background: rgba(255, 255, 255, 0.04);
          color: rgba(255, 255, 255, 0.7);
        }

        .mode-display {
          padding: 5px 10px;
          background: rgba(0, 0, 0, 0.04);
          /*
  text-align: center;
  color: royalblue;
  */
          color: rgba(0, 0, 0, 0.7);
          font-size: 12px;
          font-weight: bold;
        }

        .online {
          width: 10px;
          height: 10px;
          background: yellowgreen;
          border-radius: 10px;
        }

        #menu {
          display: flex;
        }

        #menu i {
          display: block;
        }

        #menu img {
          display: none;
          height: 30px;
          object-fit: contain;
          /*
  border-radius: 20px
  */
        }

        #menu.margin {
          /*
  padding: 5px;
  */
        }

        #menu.margin i {
          display: none;
        }

        #menu.margin img {
          display: block;
        }

        html,
        body {
          width: 100%;
          height: 100%;
          margin: 0;
        }

        body {
          display: flex;
          flex-direction: column;
        }

        .menu {
          overflow: auto;
        }

        /*
body.dark .m {
  border-top: 1px solid rgba(255,255,255,0.04);
}
.m {
  border-top: 1px solid rgba(0,0,0,0.04);
}
*/
        .container {
          position: relative;
          display: flex;
          flex-direction: column;
          flex-grow: 1;
        }

        .appcanvas.vertical {
          flex-direction: row;
          --appcanvas-sidebar-width: 150px;
        }

        .appcanvas.vertical>aside .header-item {
          border-radius: 0;
        }

        .appcanvas.vertical #devtab {
          border-radius: 0;
        }

        .appcanvas.vertical img.meta-icon {
          /*
  padding: 10px;
  display: block;
  margin: 0 auto;
  width: 50px;
  height: 50px;
  */
        }

        .appcanvas.vertical aside {
          flex-direction: row;
        }

        .appcanvas.vertical>aside .submenu {
          display: block;
        }

        .appcanvas.vertical>aside .m {
          display: block;
        }

        .appcanvas.vertical .menu-container {
          overflow: auto;
          display: block;
          width: var(--appcanvas-sidebar-width);
        }

        .appcanvas.vertical .config-info {
          margin-bottom: 10px;
        }

        .appcanvas {
          display: flex;
          flex-direction: column;
          flex-grow: 1;
          min-height: 0;
          overflow: hidden;
          /*
  border-top: 1px solid rgba(0,0,0,0.04);
  */
        }

        /*
body.dark .appcanvas {
  border-top: 1px solid rgba(255,255,255,0.04);
}
*/
        body.dark .appcanvas_filler {
          background: rgba(255, 255, 255, 0.07) !important;
          border: none;
        }

        .appcanvas_filler {
          display: none;
          height: 5px;
          background: #F1F1F1 !important;
        }

        .appcanvas-resizer {
          display: none;
        }

        .appcanvas.vertical .appcanvas-resizer {
          display: flex;
          flex: 0 0 0px;
          align-items: stretch;
          justify-content: center;
          cursor: col-resize;
          touch-action: none;
        }

        .appcanvas.vertical .appcanvas-resizer:hover::before {
          background: rgba(0, 0, 0, 0.15);
        }

        .appcanvas.vertical .appcanvas-resizer::before {
          content: '';
          width: 5px;
          border-radius: 999px;
          margin: 3px 0;
        }

        body.dark .appcanvas.vertical .appcanvas-resizer:hover::before {
          background: rgba(255, 255, 255, 0.3);
        }

        .appcanvas.vertical>aside .header-item {
          max-width: none;
        }

        .appcanvas>.container {
          /*
  order: 1;
  */
          min-height: 0;
          flex-grow: 1;
          display: flex;
          flex-direction: column;
        }

        body.dark .appcanvas>aside {
          background: rgba(255, 255, 255, 0.04);
        }

        .appcanvas>aside {
          background: rgba(0, 0, 0, 0.04);
          order: 0;
          position: relative;
          display: flex;
          flex-direction: column;
          box-sizing: border-box;
          flex-shrink: 0;
          /*
  background: var(--pinokio-sidebar-tabbar-bg);
  border-bottom: 1px solid var(--pinokio-sidebar-tabbar-border);
  */
          /*
  padding: 0 12px;
  */
          gap: 6px;
          overflow: hidden;
          --sidebar-tab-radius: 8px 8px 0 0;
          --sidebar-tab-selected-translate: 0;
          --sidebar-tab-outline: var(--pinokio-sidebar-tabbar-border);
        }

        .appcanvas>aside.appcanvas-aside-animating {
          will-change: height, opacity;
        }

        .appcanvas>aside.appcanvas-aside-collapsed {
          height: 0 !important;
          opacity: 0;
          pointer-events: none;
          padding-top: 0;
          padding-bottom: 0;
          margin-top: 0;
          margin-bottom: 0;
        }

        /*
body.dark .appcanvas > aside {
  background: var(--pinokio-sidebar-tabbar-bg);
  border-bottom: 1px solid var(--pinokio-sidebar-tabbar-border);
}
*/

        .appcanvas>aside .menu-container {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 6px;
          padding: 0;
          overflow-x: auto;
          overflow-y: hidden;
          scrollbar-width: thin;
          /*
  border-bottom: 1px solid var(--sidebar-tab-outline);
  */
        }

        .appcanvas>aside .menu-container::-webkit-scrollbar {
          height: 6px;
        }

        .appcanvas>aside .menu-container::-webkit-scrollbar-thumb {
          background-color: rgba(148, 163, 184, 0.5);
          border-radius: 3px;
        }

        body.dark .appcanvas>aside .menu-container::-webkit-scrollbar-thumb {
          background-color: rgba(148, 163, 184, 0.35);
        }

        .appcanvas>aside .m {
          display: flex;
          flex-direction: row;
          align-items: stretch;
          gap: 6px;
          min-width: 0;
        }

        .appcanvas>aside .header-item {
          /*
  flex: 1 1 220px;
  */
          max-width: 240px;
          min-width: 120px;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 4px 8px;
          border-radius: var(--sidebar-tab-radius);
          border: 1px solid transparent;
          background: transparent;
          color: var(--pinokio-sidebar-tab-muted);
          line-height: 1.2;
          overflow: hidden;
          transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .appcanvas>aside .submenu {
          margin-left: 0;
        }

        .appcanvas>aside .m.menu .nested-menu {
          position: static;
        }

        .appcanvas>aside .m.menu .nested-menu>.submenu {
          margin: 0;
          padding: 8px 0;
          border-radius: 0;
          /*
  border-radius: 12px;
  */
          border: 1px solid var(--pinokio-sidebar-tabbar-border);
          background: var(--pinokio-sidebar-tab-active-bg);
          box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
          display: flex;
          flex-direction: column;
          gap: 2px;
          min-width: 220px;
          max-height: min(60vh, 420px);
          overflow-y: auto;
          z-index: 90;
        }

        body.dark .appcanvas>aside .m.menu .nested-menu>.submenu {
          background: rgba(15, 23, 42, 0.98);
          border-color: rgba(59, 130, 246, 0.22);
          box-shadow: 0 26px 50px rgba(2, 8, 23, 0.6);
        }

        .appcanvas>aside .m.menu .nested-menu>.submenu.hidden {
          display: none !important;
        }

        .appcanvas>aside .m.menu .nested-menu.is-open>.reveal {
          background: var(--pinokio-sidebar-tab-active-bg);
          color: var(--pinokio-sidebar-tab-active-color);
          border-color: var(--sidebar-tab-outline);
          box-shadow: 0 4px 12px var(--pinokio-sidebar-tab-shadow);
        }

        body.dark .appcanvas>aside .m.menu .nested-menu.is-open>.reveal {
          background: rgba(15, 23, 42, 0.98);
          color: var(--pinokio-sidebar-tab-active-color);
          border-color: rgba(59, 130, 246, 0.28);
        }

        .appcanvas>aside .m.menu .nested-menu>.submenu .header-item,
        .appcanvas>aside .m.menu .nested-menu>.submenu .frame-link {
          flex: none;
          width: 100%;
          max-width: none;
          min-width: 0;
          padding: 7px 16px;
          border-radius: 0;
          /*
  border-radius: 8px;
  */
          border: 1px solid transparent;
          background: transparent !important;
          color: var(--pinokio-sidebar-tab-muted);
          gap: 10px;
          overflow: hidden;
          box-sizing: border-box;
        }

        .appcanvas>aside .m.menu .nested-menu>.submenu .header-item .tab,
        .appcanvas>aside .m.menu .nested-menu>.submenu .frame-link .tab {
          gap: 8px;
        }

        .appcanvas>aside .m.menu .nested-menu>.submenu .header-item:hover,
        .appcanvas>aside .m.menu .nested-menu>.submenu .frame-link:hover {
          background: var(--pinokio-sidebar-tab-hover) !important;
          color: var(--pinokio-sidebar-tab-active-color);
        }

        body.dark .appcanvas>aside .m.menu .nested-menu>.submenu .header-item,
        body.dark .appcanvas>aside .m.menu .nested-menu>.submenu .frame-link {
          color: rgba(226, 232, 240, 0.9);
        }

        body.dark .appcanvas>aside .m.menu .nested-menu>.submenu .header-item:hover,
        body.dark .appcanvas>aside .m.menu .nested-menu>.submenu .frame-link:hover {
          color: #f8fafc;
        }

        .appcanvas>aside .m.menu .nested-menu>.submenu .loader {
          margin-left: auto;
        }

        .appcanvas>aside .m.menu .nested-menu .submenu .nested-menu>.reveal .loader {
          width: 18px;
          min-width: 18px;
          height: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
        }

        .appcanvas>aside .m.menu .nested-menu .submenu .nested-menu>.reveal .loader i.fa-angle-down,
        .appcanvas>aside .m.menu .nested-menu .submenu .nested-menu>.reveal .loader i.fa-angle-up {
          display: none;
        }

        .appcanvas>aside .m.menu .nested-menu .submenu .nested-menu>.reveal .loader::before {
          content: "\f105";
          font-family: "Font Awesome 6 Free";
          font-weight: 900;
          font-size: 13px;
          color: currentColor;
          transition: transform 0.18s ease;
        }

        .appcanvas>aside .m.menu .nested-menu .submenu .nested-menu.is-open>.reveal .loader::before {
          transform: rotate(90deg);
        }

        .appcanvas>aside .header-top {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 0 0;
          background: none !important;
          border: none;
        }

        body.dark .appcanvas>aside .header-item.btn:not(.selected) {
          background: none;
        }

        .appcanvas>aside .header-item .tab {
          display: flex;
          align-items: center;
          /*
  gap: 6px;
  */
          flex: 1;
          min-width: 0;
        }

        .appcanvas>aside .header-item .tab .tab-metric {
          display: inline-flex;
          align-items: baseline;
          gap: 6px;
          font-size: 11px;
          white-space: nowrap;
          flex: 0 0 auto;
          padding-left: 6px;
        }

        .appcanvas>aside .header-item .tab .tab-metric__label {
          text-transform: uppercase;
          letter-spacing: 0.06em;
          font-size: 10px;
          opacity: 0.7;
        }

        .appcanvas>aside .header-item .tab .tab-metric__value {
          font-weight: 600;
          font-size: 11px;
        }

        .appcanvas>aside .header-item .tab .tab-metric .disk-usage {
          flex: 0 0 auto;
          min-width: 0;
          text-align: right;
        }

        .appcanvas>aside .header-item:hover {
          background: var(--pinokio-sidebar-tab-hover);
          color: var(--pinokio-sidebar-tab-active-color);
        }

        body.dark .appcanvas>aside .header-item.selected {
          background: rgb(27, 28, 29) !important;
          border: none;
          box-shadow: rgba(67, 71, 85, 0.27) 0px 0px 0.25em, rgba(90, 125, 188, 0.05) 0px 0.25em 1em;
        }

        .appcanvas>aside .header-item.selected {
          font-weight: bold;
          /*
  color: rgba(127, 91, 243, 0.9);
  border-color: var(--pinokio-sidebar-tab-active-bg);
  */
          color: var(--pinokio-sidebar-tab-active-color);
          /*
  border-color: var(--sidebar-tab-outline);
  */
          box-shadow: 0 4px 12px var(--pinokio-sidebar-tab-shadow);
          background: white !important;
          border-bottom: none;
          z-index: 1;
        }

        header.navheader.minimized+.appcanvas>aside .menu-container {
          padding: 8px 0 0;
        }

        main {
          flex-grow: 1;
          min-height: 0;
          /*
  height: 100%;
  */
        }

        main iframe[name^=http] {
          background: white;
        }

        main iframe[name^=file-browse] {
          background: white;
        }

        main iframe {
          width: 100%;
          height: 100%;
          border: none;
        }

        /*
.header-item.indent {
  padding-left: 23px !important;
}
*/
        .header-item {
          /*
  display: block;
  */
          display: flex;
          font-size: 12px;
          text-decoration: none;
          align-items: center;
          border-radius: 0;
          cursor: pointer;
        }

        .header-item.selected {}

        .header-item .btn2 {
          margin: 0;
          border: none;
          /*
  color: var(--light-color);
  */
        }

        body.dark .header-item .btn2 {
          /*
  color: var(--darkt-color);
  */
        }

        .bar .btn2 i {
          display: block;
          margin-right: 5px;
        }

        .header-item>* {
          display: block;
        }

        .header-item img {
          /*
  width: 60px;
  */
          height: 80px;
          width: 80px;
          /*
  border-radius: 10px;
  */
          object-fit: contain;
          display: inline-block;
          /*
  border-radius: 30px;
  */
        }

        body.dark .header-item.btn {
          /*
  color: white;
  */
          color: var(--dark-color);
        }

        .header-item.btn {
          /*
  padding: 5px 8px;
  */
          padding: 7px;
          background: none !important;
          color: var(--light-color);
          align-items: flex-start;
        }

        .logo {
          font-size: 20px;
          padding: 20px;
        }

        body .logo {
          color: var(--light-color);
        }

        body.dark .logo {
          color: var(--dark-btn-color);
          /*
  color: white;
  */
        }

        body #new-window {
          color: var(--light-color);
        }

        body.dark #new-window {
          color: var(--dark-btn-color);
          /*
  color: white;
  */
        }

        /*
.dark .app-info {
  background: rgba(255,255,255,0.04);
}
*/
        /*
.app-info-card img {
  margin: 10px;
}
*/
        .app-info {

          /*
  display: flex;
  */
          box-sizing: border-box;
          text-align: center;
          ;
          align-items: center;
          /*
  background: rgba(0,0,0,0.04);
  */
        }

        .folderbuttons {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 0px;
        }

        .header-btns {
          padding: 0 !important;
        }

        body.dark .header-btns {
          border-top: 1px solid rgba(255, 255, 255, 0.04);
        }

        .app-info-edit {
          text-decoration: none;
          color: black;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /*
.dark .app-info-edit {
  border-top: 1px solid rgba(255,255,255,0.2);
  border-bottom: 1px solid rgba(255,255,255,0.2);
}
*/
        .dark .app-info-edit:hover {
          background: rgba(0, 0, 0, 0.2);
        }

        .app-info-edit:hover {
          background: rgba(0, 0, 0, 0.05);
        }

        .app-info-edit i {
          display: block;
        }

        .app-info-edit,
        .app-info-copy {
          font-weight: normal;

          /*
  border-radius: 20px;
  */
          font-size: 12px;
          padding: 15px 5px;
          /*
  margin: 10px 20px 0;
  */
        }

        .app-info-card {
          /*
  padding: 10px !important;
  */
          padding: 10px;
          display: flex;
          text-align: left;
        }

        .app-info .btn {
          width: 100%;
          box-sizing: border-box;
        }

        body.dark .app-info .mode-section {
          background: rgba(0, 0, 0, 0.4);
        }

        .app-info .mode-section {
          background: rgba(0, 0, 0, 0.06);
          padding: 10px;
          box-sizing: border-box;
          width: 100%;
          text-align: left;
        }

        .app-info .mode-section .desc {
          font-weight: normal;
          opacity: 0.7;
          margin-bottom: 10px;
        }

        .app-info .mode-section h3 {
          font-size: 18px;
          line-height: 26px;
          margin: 0;
        }

        body.dark .app-info .mode-section .btn {
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-info .mode-section .btn {
          text-align: center;
        }

        .app-info-card>* {
          /*
  padding: 5px;
  */
          color: var(--light-color);
          text-decoration: none;
          box-sizing: border-box;
        }

        body.dark .app-info-card>* {
          color: var(--dark-color);
        }

        .app-info-container {
          /*
  padding: 10px 5px;
  */
          padding-left: 5px;
          min-width: 0;
          text-overflow: ellipsis;
        }

        .app-info-title {
          width: 100%;
          font-weight: bold;
          font-size: 16px;
          word-break: break-word;
          /*
  padding: 15px 0;
  */
        }

        .app-info-description.collapsed {
          display: -webkit-box;
          -webkit-line-clamp: 3;
          -webkit-box-orient: vertical;

          display: box;
          /* For the future */
          line-clamp: 3;
          /* For future spec */
          box-orient: vertical;

          overflow: hidden;
        }

        .app-info-description {
          margin-top: 5px;
          word-wrap: break-word;
          width: 100%;
          opacity: 0.7;
        }

        .footer {
          /*
  display: flex;
  */
          display: grid;
          grid-template-columns: repeat(4, 1fr);
        }

        .footer>* {
          padding: 10px !important;
          display: block;
          box-sizing: border-box;
          font-size: 12px !important;
          text-align: center;
        }

        .footer i {
          margin: 0 !important;
          padding: 5px;
        }

        .footer a {
          font-size: 14px;
        }

        body .footer {
          border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        body.dark .footer {
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        body.dark .header-item.cursor {
          background: rgba(0, 0, 0, 0.2) !important;
        }

        .header-item.cursor {
          background: rgba(0, 0, 100, 0.03) !important;
          /*
  border-left: 5px solid gold;
  */
        }

        .frame-link {
          cursor: pointer;
        }

        body .frame-link.selected {
          background: white !important;
        }

        .frame-link.selected .del {
          color: white;
        }

        body.dark .frame-link.selected {
          background: rgba(255, 255, 255, 0.07) !important;
        }

        .frame-link .loader {
          /*
  padding: 5px;
  */
        }

        .loader {
          flex-shrink: 0;
        }

        .loader .btn:hover {
          color: rgba(127, 91, 243, 0.9);
          border-color: rgba(127, 91, 243, 0.9);
        }

        .loader .btn {
          padding: 4px 8px;
          /*
  padding: 4px 8px;
  border: 1px solid rgba(255,255,255,0.3);
  */
        }

        .frame-link .tab {
          flex-grow: 1;
          /*
  width: 100%;
  */
          min-width: 0;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
          /*
  margin-right: 10px;
  */
        }

        .frame-link .tab .flexible {
          min-width: 5px;
        }

        .frame-link .tab .display {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        body.dark .grid-btns {
          border-top: 1px solid rgba(255, 255, 255, 0.04);
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .grid-btns {
          border-top: 1px solid rgba(0, 0, 0, 0.04);
          border-bottom: 1px solid rgba(0, 0, 0, 0.04);
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-template-rows: repeat(2, 1fr);
          /*
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(1, 1fr);
  */
          box-sizing: border-box;
        }

        .grid-btns .btn2 {
          padding: 10px 10px;
          color: var(--light-color);
          border-radius: 0;
          cursor: pointer;
          font-size: 11px;
        }

        body.dark .grid-btns .btn2 {
          /*
  color: white;
  */
          color: var(--dark-btn-color);
        }

        .footer {
          width: 100%;
        }

        .tab {
          flex-grow: 1;
          display: flex;
          align-items: center;
          padding-right: 10px;
        }

        .tab.has-preview {
          flex-direction: row;
          align-items: center;
          gap: 8px;
        }

        .tab.has-preview .tab-main {
          display: flex;
          align-items: center;
          width: 100%;
          flex: 1 1 auto;
          min-width: 0;
        }

        .tab.has-preview .tab-main .tab-details {
          display: flex;
          flex-direction: column;
          flex: 1 1 auto;
          min-width: 0;
        }

        .tab.has-preview .tab-preview {
          color: rgba(0, 0, 0, 0.6);
          min-width: 0;
          width: auto;
          /*
  margin-top: 4px;
  */
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .tab.has-preview .tab-updated {
          color: rgba(0, 0, 0, 0.45);
          margin-top: 2px;
          min-width: 0;
          width: auto;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .tab.has-preview .tab-updated.is-live {
          color: rgba(0, 128, 0, 0.75);
        }

        .tab.has-preview .tab-updated .indicator {
          display: inline-flex;
          align-items: center;
          gap: 4px;
        }

        .tab.has-preview .tab-updated .dot {
          display: inline-block;
          width: 6px;
          height: 6px;
          border-radius: 50%;
          background: currentColor;
          opacity: 0.35;
          animation: none;
        }

        .tab.has-preview .tab-updated.is-live .dot {
          opacity: 1;
          animation: pulse 1.4s ease-in-out infinite;
        }

        .tab.has-preview .tab-updated .label {
          display: inline-block;
        }

        @keyframes pulse {
          0% {
            opacity: 0.4;
            transform: scale(0.9);
          }

          50% {
            opacity: 1;
            transform: scale(1);
          }

          100% {
            opacity: 0.4;
            transform: scale(0.9);
          }
        }

        body.dark .tab.has-preview .tab-preview {
          color: rgba(255, 255, 255, 0.7);
        }

        body.dark .tab.has-preview .tab-updated {
          color: rgba(255, 255, 255, 0.55);
        }

        body.dark .tab.has-preview .tab-updated.is-live {
          color: rgba(120, 255, 120, 0.85);
        }

        .label i {
          margin-right: 10px;
        }

        .tab i {
          margin-right: 6px;
          font-size: 14px;
          padding: 2px;
          border-radius: 4px;
        }

        body.dark aside .btn {
          background: rgba(255, 255, 255, 0.05);
        }

        .fa-circle {
          display: none;
          color: yellowgreen;
          padding: 4px 0;
          /*
  margin-right: 10px;
  margin: 5px 10px 0 4px;
  */
        }

        .dynamic .submenu .tab i {
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 15px;
          width: 20px;
          height: 20px;
          padding: 0;
        }

        /*
body.dark .dynamic .submenu {
  border-left: 5px solid white;
}
*/
        .dynamic .submenu {
          display: flex;
          margin-left: 0px;
          height: 100%;
          /*
  border-left: 5px solid black;
  */
        }

        .menu-item-image {
          width: 20px !important;
          height: 20px !important;
          margin-right: 6px;
          background: white;
          /*
  padding: 2px;
  */
          border-radius: 2px;
        }

        .temp-menu {
          /*
  border-top: 1px solid rgba(0,0,0,0.1);
  */
        }

        .temp-menu .del i {
          margin: 0;
        }

        #delete {
          color: brown;
        }

        body .footer {}

        body.dark nav {
          /*
  border-bottom: 1px solid rgba(255,255,255,0.04);
  */
          border-top: 1px solid rgba(255, 255, 255, 0.04);
        }

        /*
.container:hover nav {
  display: block;
}
*/
        nav {
          /*
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.4s ease-out;
  display: none;
  */

          background: white;
          /*
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  */
          /*
  padding: 5px;
  */
          padding: 0;
          cursor: grab !important;
          -webkit-app-region: drag !important;
          /*
  border-bottom: 1px solid rgba(0,0,0,0.04);
  */
          border-top: 1px solid rgba(0, 0, 0, 0.04);
          box-sizing: border-box;
        }

        body.dark nav .btn2 {
          border-right: 1px solid rgba(255, 255, 255, 0.04);
        }

        nav .btn2 {
          padding: 15px;
          font-size: 12px;
          /*
  width: 70px;
  */
          box-sizing: border-box;
          border-right: 1px solid rgba(0, 0, 0, 0.04);
          border-radius: 0;
          text-transform: lowercase;
          flex-shrink: 0;

          display: flex;
          /*
  flex-direction: column;
  */
          justify-content: center;
          align-items: center;
        }

        nav .logo {
          font-size: 14px;
          padding: 10px;
        }

        .error-message .btn i {
          margin-right: 10px;
        }

        .error-message .btn {
          margin-top: 20px;
          align-items: center;
          display: flex;
          letter-spacing: 0px;
          background: black;
          color: yellow;
          font-size: 20px;
          padding: 10px 30px;
        }

        .error-message>div {
          width: 500px;
        }

        .error-message {
          width: 100%;
          /*
  background: rgba(127, 91, 243, 0.9) !important;
  */
          color: white;
          display: flex;
          justify-content: center;
          align-items: center;
          /*
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  background: yellow !important;
  flex-grow: 1;
  padding: 0 50px;
  font-size: 40px;
  line-height: 40px;
  color: black;
  letter-spacing: -2px;
  */
        }

        body.dark #location {
          color: white;
          background: rgba(255, 255, 255, 0.03);
        }

        #location {
          background: rgba(0, 0, 0, 0.04);
          padding: 10px;
          margin: 0 0 0 10px;
          font-size: 12px;
          font-family: verdana;
          box-sizing: border-box;
          flex-grow: 1;
          border: none;
          outline: none;
        }

        body.dark #open-location {
          background: rgba(255, 255, 255, 0.03);
          color: white;
        }

        #open-location {
          border: none;
          color: black;
          background: rgba(0, 0, 0, 0.04);
          padding: 10px;
          margin-right: 10px;
          font-size: 14px;
        }

        .bar {
          -webkit-app-region: no-drag !important;
          cursor: auto;
          display: flex;
          align-items: stretch;
          width: 100%;
          flex-wrap: wrap;
        }

        body.dark .header-item.cursor.header-top {
          background: none !important;
        }

        .header-item.cursor.header-top {
          background: none !important;
        }

        .header-menu {
          position: sticky;
          top: 0;
          background: white;
          border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        body.dark .header-menu {
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
          background: var(--dark-bg);
        }

        .header-item.header-top {
          display: block;
        }

        #new-tab:hover {
          background: rgba(0, 0, 0, 0.06) !important;
          color: rgb(200, 0, 0) !important;
        }

        #new-tab {
          cursor: pointer !important;
          justify-content: center;
          /*
  border-top: 1px solid rgba(0,0,0,0.04);
  */
        }

        body.dark #new-tab {
          /*
  border-top: 1px solid rgba(255,255,255,0.04);
  */
        }

        /*
body.dark .submenu {
  border-left: 1px solid rgba(255,255,255,0.3);
}
*/
        .submenu {
          /*
  border-left: 1px solid black;
  */
          margin-left: 15px;
          box-sizing: border-box;
        }

        #menu-mobile {
          display: none;
        }

        .tabmenu .label {
          padding: 10px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
          text-transform: uppercase;
          font-size: 12px;
          font-weight: bold;
        }

        body.dark .disk-usage {
          border-right: 1px solid rgba(255, 255, 255, 0.1);
          color: white;
        }

        .disk-usage {
          display: block;
          cursor: pointer;
          border-right: 1px solid rgba(0, 0, 0, 0.1);
          font-weight: bold;
          color: black;
          padding: 5px 10px;
          border-radius: 4px;
        }

        .disk-usage i {
          margin-right: 5px;
          font-size: 16px !important;
        }


        .custom-label {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          pointer-events: none;
          /* Let clicks fall through to FilePond */
          font-size: 14px;
          color: rgba(0, 0, 0, 0.5);
          z-index: 5;
        }

        .filler {
          display: none;
        }

        body .app-icon img {
          height: 35px;
          border-radius: 35px;
          cursor: pointer;
        }

        body .app-icon {
          display: none;
          margin-right: 10px;
        }

        .top-menu {
          padding: 10px;
          text-align: center;
        }

        .top-menu .btn2 {
          padding: 3px 10px;
          border-radius: 3px;
        }

        body.dark .top-menu .btn2.selected {
          background: white;
          color: black;
        }

        .top-menu .btn2.selected {
          background: black;
          color: white;
        }

        .bottombar {
          display: flex;
          justify-content: flex-end;
          padding: 5px;
        }

        #browserview-container {
          flex-grow: 1;
          position: relative;
        }

        body.dark #fs-status {
          border: none;
          background: rgb(27, 28, 29) !important;
        }

        #fs-status {
          padding: 5px;
          background: white !important;
          margin-bottom: 1px;
          gap: 4px;
          box-sizing: border-box;
          /*
  margin: 0 10px;
  padding: 5px;
  */
          display: flex;
          align-items: center;
          /*
  border-radius: 6px;
  */
          justify-content: flex-start;
          flex-wrap: wrap;
          /*
  border-bottom: 1px solid rgba(0,0,0,0.04);
  */
        }

        #fs-changes-btn {
          margin-left: auto;
        }

        .fs-status-btn {
          text-decoration: none;
          background: transparent;
          border: none;
          padding: 4px 8px;
          cursor: pointer;
          border-radius: 4px;
          display: flex !important;
          align-items: center;
          gap: 4px;
          font-size: 12px;
          line-height: 1.2;
          color: #24292f;
          transition: background 0.2s;
          min-width: 0;
          flex-shrink: 0;
          position: relative;
        }

        .fs-status-label {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 4px;
          text-align: center;
          font-size: 12px;
        }

        .fs-status-label i {
          font-size: 12px;
          margin-right: 2px;
        }

        .fs-status-btn .loader {
          display: flex;
          align-items: center;
          gap: 2px;
          font-size: 10px;
        }

        #fs-status .fs-status-btn .disk-usage {
          flex-grow: 0;
          font-size: 10px;
          text-align: center;
          min-width: 0;
        }

        .fs-status-btn.fs-status-btn--disabled,
        .fs-status-btn:disabled {
          opacity: 0.45;
          cursor: default;
          pointer-events: none;
        }

        .fs-status-dropdown {
          position: relative;
        }

        .fs-dropdown-menu {
          position: absolute;
          top: calc(100% + 6px);
          left: 0;
          display: flex;
          flex-direction: column;
          min-width: 180px;
          padding: 6px 0;
          border-radius: 6px;
          border: 1px solid rgba(0, 0, 0, 0.1);
          background: white;
          box-shadow: 0 10px 40px rgba(15, 23, 42, 0.15);
          z-index: 20;
        }

        .fs-status-dropdown.git-fork .fs-dropdown-menu,
        .fs-status-dropdown.git-publish .fs-dropdown-menu {
          left: 0;
          right: auto;
          width: min(420px, calc(100vw - 24px));
          max-width: min(420px, calc(100vw - 24px));
          white-space: normal;
        }

        body.dark .fs-dropdown-menu {
          background: rgba(30, 41, 59, 0.96);
          border: 1px solid rgba(148, 163, 184, 0.35);
          box-shadow: 0 12px 40px rgba(15, 23, 42, 0.5);
        }

        #fs-status .submenu {
          margin-left: 0;
        }

        .fs-dropdown-item {
          width: 100%;
          background: transparent;
          border: 0;
          padding: 8px 14px;
          font-size: 13px;
          display: flex;
          align-items: center;
          gap: 8px;
          text-align: left;
          color: #1f2937;
          cursor: pointer;
        }

        .fs-dropdown-item.frame-link {
          text-decoration: none;
        }

        .fs-dropdown-item:hover {
          background: rgba(15, 23, 42, 0.06);
        }

        #fs-status .fs-dropdown-menu .frame-link {
          min-width: 0;
          padding: 8px 14px;
          border-radius: 0;
          background: transparent !important;
          display: flex;
          align-items: center;
          gap: 8px;
          color: #1f2937;
          text-decoration: none;
        }

        #fs-status .fs-dropdown-menu .frame-link .tab {
          padding: 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        #fs-status .fs-dropdown-menu .frame-link:hover {
          background: rgba(15, 23, 42, 0.06);
        }

        body.dark .fs-dropdown-item {
          color: white;
        }

        body.dark .fs-dropdown-item:hover {
          background: rgba(148, 163, 184, 0.15);
        }

        body.dark #fs-status .fs-dropdown-menu .frame-link {
          color: white;
        }

        body.dark #fs-status .fs-dropdown-menu .frame-link:hover {
          background: rgba(148, 163, 184, 0.15);
        }


        #fs-changes-menu .fs-dropdown-empty {
          padding: 8px 14px;
          font-size: 12px;
          color: rgba(31, 41, 55, 0.66);
        }

        #fs-changes-menu {
          left: 0;
          right: auto;
          width: max-content;
          max-width: min(460px, calc(100vw - 32px));
          max-height: min(70vh, 420px);
          overflow: auto;
        }

        #fs-changes-menu .fs-dropdown-item {
          align-items: flex-start;
          white-space: normal;
        }

        body.dark #fs-changes-menu .fs-dropdown-empty {
          color: rgba(226, 232, 240, 0.7);
        }

        #fs-changes-menu .git-changes-item-label {
          display: flex;
          align-items: center;
          gap: 6px;
          min-width: 0;
          white-space: normal;
          word-break: break-word;
        }

        #fs-changes-menu .git-changes-item-count {
          margin-left: auto;
          font-size: 12px;
          font-weight: 600;
          color: #1f2937;
        }

        #fs-changes-menu .git-changes-item-count.git-changes-item-count--dirty {
          color: #2563eb;
        }

        #fs-changes-menu .git-changes-item-count.git-changes-item-count--clean {
          font-weight: 500;
          color: rgba(31, 41, 55, 0.6);
        }

        #fs-changes-menu .git-changes-item.git-changes-item--active {
          background: rgba(37, 99, 235, 0.08);
        }

        body.dark #fs-changes-menu .git-changes-item-count {
          color: #e2e8f0;
        }

        body.dark #fs-changes-menu .git-changes-item-count.git-changes-item-count--dirty {
          color: #60a5fa;
        }

        body.dark #fs-changes-menu .git-changes-item-count.git-changes-item-count--clean {
          color: rgba(148, 163, 184, 0.6);
        }

        body.dark #fs-changes-menu .git-changes-item.git-changes-item--active {
          background: rgba(96, 165, 250, 0.15);
        }

        #fs-status .app-info {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 0;
          flex: 0 1 auto;
        }

        #fs-status .app-info-card {
          padding: 0;
          align-items: center;
          gap: 10px;
        }

        #fs-status .app-info-card img {
          width: 25px;
          height: 25px;
          border-radius: 4px;
          object-fit: cover;
        }

        #fs-status .app-info-container {
          padding: 0;
          display: flex;
          flex-direction: column;
          gap: 2px;
          min-width: 0;
          max-width: clamp(140px, 26vw, 280px);
        }

        #fs-status .app-info-title {
          font-size: 14px;
          line-height: 1.2;
          font-weight: 600;
        }

        #fs-status .app-info-description {
          margin: 0;
          font-size: 12px;
          line-height: 1.3;
          opacity: 0.7;
        }

        #fs-status .app-info-description.collapsed {
          -webkit-line-clamp: 2;
          line-clamp: 2;
        }

        body.dark .fs-status-btn {
          color: white;
        }

        .fs-status-btn:hover {
          background: rgba(0, 0, 0, 0.08);
        }

        body.dark .fs-status-btn:hover {
          background: rgba(255, 255, 255, 0.08);
        }

        .fs-status-btn .badge:empty {
          display: none;
        }

        .fs-status-btn .badge {
          background: #dc3545;
          color: white;
          padding: 2px 5px;
          border-radius: 2px;
          font-size: 11px;
          font-weight: 600;
          text-align: center;
          /*
  position: absolute;
  top: 0;
  right: 0;
  transform:translate(25%, -50%);
  */
          display: inline-flex;
          align-items: center;
          justify-content: center;
          pointer-events: none;
        }

        /* Remote selection modal styles */
        .swal2-html-container select,
        .swal2-html-container input[type="text"] {
          font-family: inherit;
        }

        body.dark .swal2-html-container select,
        body.dark .swal2-html-container input[type="text"] {
          background: rgba(255, 255, 255, 0.1);
          color: white;
          border-color: rgba(255, 255, 255, 0.3);
        }

        body.dark .swal2-html-container option {
          background: #2d3748;
          color: white;
        }

        /* Checkbox styling for dark mode */
        body.dark .swal2-html-container input[type="checkbox"] {
          accent-color: #4a90e2;
        }

        body.dark .swal2-html-container label {
          color: white;
        }

        :root {
          --pinokio-modal-bg: #ffffff;
          --pinokio-modal-text: #0f172a;
          --pinokio-modal-title-color: #0f172a;
          --pinokio-modal-subtitle-color: rgba(71, 85, 105, 0.75);
          --pinokio-modal-body-bg: rgba(241, 245, 249, 0.9);
          --pinokio-modal-body-border: rgba(203, 213, 225, 0.7);
          --pinokio-modal-body-iframe-bg: #ffffff;
          --pinokio-modal-label-color: rgba(71, 85, 105, 0.95);
          --pinokio-modal-input-bg: #ffffff;
          --pinokio-modal-input-border: rgba(148, 163, 184, 0.5);
          --pinokio-modal-input-text: #0f172a;
          --pinokio-modal-input-focus-border: rgba(59, 130, 246, 0.6);
          --pinokio-modal-input-focus-shadow: rgba(59, 130, 246, 0.2);
          --pinokio-modal-checkbox-color: rgba(71, 85, 105, 0.9);
          --pinokio-pill-bg: rgba(59, 130, 246, 0.1);
          --pinokio-pill-text: #1e293b;
          --pinokio-history-empty-color: rgba(71, 85, 105, 0.75);
          --pinokio-modal-body-diff-bg: rgba(241, 245, 249, 0.92);
          --pinokio-diff-sidebar-bg: linear-gradient(180deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.85));
          --pinokio-diff-sidebar-border: rgba(203, 213, 225, 0.8);
          --pinokio-diff-sidebar-text: #1f2937;
          --pinokio-diff-sidebar-meta: rgba(71, 85, 105, 0.75);
          --pinokio-diff-sidebar-hover-bg: rgba(59, 130, 246, 0.12);
          --pinokio-diff-sidebar-hover-border: rgba(59, 130, 246, 0.45);
          --pinokio-diff-sidebar-active-bg: rgba(59, 130, 246, 0.18);
          --pinokio-diff-sidebar-active-color: #0f172a;
          --pinokio-diff-sidebar-active-border: rgba(59, 130, 246, 0.6);
          --pinokio-diff-viewer-bg: #ffffff;
          --pinokio-diff-viewer-text: #0f172a;
          --pinokio-diff-empty-color: rgba(71, 85, 105, 0.75);
          --pinokio-diff-gutter-bg: rgba(226, 232, 240, 0.8);
          --pinokio-diff-gutter-border: rgba(148, 163, 184, 0.45);
          --pinokio-diff-gutter-text: rgba(71, 85, 105, 0.75);
          --pinokio-custom-commit-overlay-bg: rgba(15, 23, 42, 0.35);
          --pinokio-custom-commit-modal-bg: #ffffff;
          --pinokio-custom-commit-modal-text: #0f172a;
          --pinokio-custom-commit-border: rgba(203, 213, 225, 0.7);
          --pinokio-custom-commit-header-bg: rgba(241, 245, 249, 0.9);
          --pinokio-custom-commit-close-color: rgba(71, 85, 105, 0.75);
          --pinokio-custom-commit-close-hover-bg: rgba(148, 163, 184, 0.18);
          --pinokio-custom-commit-close-hover-color: #0f172a;
          --pinokio-custom-commit-action-bg: rgba(59, 130, 246, 0.12);
          --pinokio-custom-commit-action-border: rgba(59, 130, 246, 0.35);
          --pinokio-custom-commit-action-color: #1d4ed8;
          --pinokio-custom-commit-action-hover: rgba(59, 130, 246, 0.18);
          --pinokio-commit-item-bg: rgba(226, 232, 240, 0.6);
          --pinokio-commit-item-hover-bg: rgba(59, 130, 246, 0.12);
          --pinokio-commit-item-text: #0f172a;
          --pinokio-commit-avatar-bg: rgba(59, 130, 246, 0.18);
          --pinokio-commit-avatar-color: #1d4ed8;
          --pinokio-commit-meta-color: rgba(71, 85, 105, 0.75);
          --pinokio-commit-hash-bg: rgba(191, 219, 254, 0.6);
          --pinokio-commit-hash-color: #1d4ed8;
          --pinokio-diff-code-text: #1f2937;
          --pinokio-diff-code-add-bg: rgba(34, 197, 94, 0.18);
          --pinokio-diff-code-add-border: rgba(34, 197, 94, 0.5);
          --pinokio-diff-code-add-color: #166534;
          --pinokio-diff-code-del-bg: rgba(239, 68, 68, 0.18);
          --pinokio-diff-code-del-border: rgba(239, 68, 68, 0.5);
          --pinokio-diff-code-del-color: #b91c1c;
          --pinokio-diff-code-context-bg: rgba(241, 245, 249, 0.95);
          --pinokio-diff-code-context-border: rgba(203, 213, 225, 0.65);
          --pinokio-modern-shadow: 0 32px 80px rgba(15, 23, 42, 0.25);
          --pinokio-modern-close-color: rgba(71, 85, 105, 0.65);
          --pinokio-modern-close-hover-bg: rgba(148, 163, 184, 0.18);
          --pinokio-modern-close-hover-color: #0f172a;
          --pinokio-modern-cancel-bg: rgba(148, 163, 184, 0.16);
          --pinokio-modern-cancel-color: #0f172a;
          --pinokio-modern-cancel-hover-bg: rgba(148, 163, 184, 0.24);
          --pinokio-modal-icon-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(59, 130, 246, 0.03));
          --pinokio-modal-icon-color: #2563eb;
          --pinokio-modal-body-text-color: rgba(30, 41, 59, 0.9);
          --pinokio-sidebar-tabbar-bg: rgba(248, 250, 252, 0.92);
          --pinokio-sidebar-tabbar-border: rgba(203, 213, 225, 0.7);
          --pinokio-sidebar-tab-hover: rgba(59, 130, 246, 0.12);
          --pinokio-sidebar-tab-active-bg: #ffffff;
          --pinokio-sidebar-tab-active-color: #0f172a;
          --pinokio-sidebar-tab-muted: rgba(71, 85, 105, 0.85);
          --pinokio-sidebar-tab-shadow: rgba(15, 23, 42, 0.08);
        }

        body.dark {
          --pinokio-modal-bg: #0f172a;
          --pinokio-modal-text: #e2e8f0;
          --pinokio-modal-title-color: #f8fafc;
          --pinokio-modal-subtitle-color: rgba(148, 163, 184, 0.85);
          --pinokio-modal-body-bg: rgba(15, 23, 42, 0.6);
          --pinokio-modal-body-border: rgba(59, 130, 246, 0.18);
          --pinokio-modal-body-iframe-bg: #0b1220;
          --pinokio-modal-label-color: rgba(203, 213, 225, 0.9);
          --pinokio-modal-input-bg: rgba(15, 23, 42, 0.85);
          --pinokio-modal-input-border: rgba(148, 163, 184, 0.25);
          --pinokio-modal-input-text: #f8fafc;
          --pinokio-modal-input-focus-border: rgba(96, 165, 250, 0.7);
          --pinokio-modal-input-focus-shadow: rgba(37, 99, 235, 0.25);
          --pinokio-modal-checkbox-color: rgba(203, 213, 225, 0.85);
          --pinokio-pill-bg: rgba(148, 163, 184, 0.15);
          --pinokio-pill-text: rgba(226, 232, 240, 0.85);
          --pinokio-history-empty-color: rgba(148, 163, 184, 0.8);
          --pinokio-modal-body-diff-bg: rgba(9, 12, 24, 0.88);
          --pinokio-diff-sidebar-bg: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.85));
          --pinokio-diff-sidebar-border: rgba(59, 130, 246, 0.18);
          --pinokio-diff-sidebar-text: rgba(226, 232, 240, 0.88);
          --pinokio-diff-sidebar-meta: rgba(148, 163, 184, 0.8);
          --pinokio-diff-sidebar-hover-bg: rgba(59, 130, 246, 0.16);
          --pinokio-diff-sidebar-hover-border: rgba(59, 130, 246, 0.58);
          --pinokio-diff-sidebar-active-bg: rgba(37, 99, 235, 0.22);
          --pinokio-diff-sidebar-active-color: #f8fafc;
          --pinokio-diff-sidebar-active-border: rgba(96, 165, 250, 0.85);
          --pinokio-diff-viewer-bg: rgba(6, 11, 23, 0.96);
          --pinokio-diff-viewer-text: rgba(226, 232, 240, 0.92);
          --pinokio-diff-empty-color: rgba(148, 163, 184, 0.8);
          --pinokio-diff-gutter-bg: rgba(15, 23, 42, 0.6);
          --pinokio-diff-gutter-border: rgba(59, 130, 246, 0.12);
          --pinokio-diff-gutter-text: rgba(148, 163, 184, 0.75);
          --pinokio-custom-commit-overlay-bg: rgba(9, 11, 15, 0.75);
          --pinokio-custom-commit-modal-bg: #0f172a;
          --pinokio-custom-commit-modal-text: #e2e8f0;
          --pinokio-custom-commit-border: rgba(59, 130, 246, 0.18);
          --pinokio-custom-commit-header-bg: rgba(15, 23, 42, 0.75);
          --pinokio-custom-commit-close-color: rgba(226, 232, 240, 0.7);
          --pinokio-custom-commit-close-hover-bg: rgba(148, 163, 184, 0.18);
          --pinokio-custom-commit-close-hover-color: #f8fafc;
          --pinokio-custom-commit-action-bg: rgba(56, 189, 248, 0.12);
          --pinokio-custom-commit-action-border: rgba(56, 189, 248, 0.35);
          --pinokio-custom-commit-action-color: #7dd3fc;
          --pinokio-custom-commit-action-hover: rgba(56, 189, 248, 0.18);
          --pinokio-commit-item-bg: rgba(15, 23, 42, 0.35);
          --pinokio-commit-item-hover-bg: rgba(37, 99, 235, 0.16);
          --pinokio-commit-item-text: #f8fafc;
          --pinokio-commit-avatar-bg: rgba(59, 130, 246, 0.12);
          --pinokio-commit-avatar-color: #93c5fd;
          --pinokio-commit-meta-color: rgba(148, 163, 184, 0.8);
          --pinokio-commit-hash-bg: rgba(96, 165, 250, 0.14);
          --pinokio-commit-hash-color: #bfdbfe;
          --pinokio-diff-code-text: rgba(226, 232, 240, 0.9);
          --pinokio-diff-code-add-bg: rgba(34, 197, 94, 0.12);
          --pinokio-diff-code-add-border: rgba(34, 197, 94, 0.7);
          --pinokio-diff-code-add-color: rgba(224, 242, 232, 0.95);
          --pinokio-diff-code-del-bg: rgba(239, 68, 68, 0.12);
          --pinokio-diff-code-del-border: rgba(239, 68, 68, 0.7);
          --pinokio-diff-code-del-color: rgba(254, 226, 226, 0.95);
          --pinokio-diff-code-context-bg: rgba(30, 41, 59, 0.65);
          --pinokio-diff-code-context-border: rgba(148, 163, 184, 0.25);
          --pinokio-modern-shadow: 0 40px 120px rgba(2, 8, 23, 0.7);
          --pinokio-modern-close-color: rgba(226, 232, 240, 0.6);
          --pinokio-modern-close-hover-bg: rgba(148, 163, 184, 0.12);
          --pinokio-modern-close-hover-color: #f8fafc;
          --pinokio-modern-cancel-bg: rgba(148, 163, 184, 0.14);
          --pinokio-modern-cancel-color: #e2e8f0;
          --pinokio-modern-cancel-hover-bg: rgba(148, 163, 184, 0.22);
          --pinokio-modal-icon-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.05));
          --pinokio-modal-icon-color: #60a5fa;
          --pinokio-modal-body-text-color: rgba(226, 232, 240, 0.92);
          --pinokio-sidebar-tabbar-bg: rgba(15, 23, 42, 0.92);
          --pinokio-sidebar-tabbar-border: rgba(59, 130, 246, 0.18);
          --pinokio-sidebar-tab-hover: rgba(96, 165, 250, 0.18);
          --pinokio-sidebar-tab-active-bg: rgba(15, 23, 42, 0.98);
          --pinokio-sidebar-tab-active-color: #f8fafc;
          --pinokio-sidebar-tab-muted: rgba(148, 163, 184, 0.8);
          --pinokio-sidebar-tab-shadow: rgba(2, 8, 23, 0.55);
        }

        /* Git diff modal styles - using specific prefixed classes to avoid collisions */

        .pinokio-modal-body--diff {
          padding: 0;
          border: 1px solid var(--pinokio-modal-body-border);
          background: var(--pinokio-modal-body-diff-bg);
          height: 520px;
          overflow: hidden;
          display: flex;
          min-height: 0;
        }

        .pinokio-git-diff-main-container {
          display: flex;
          flex: 1;
          height: 100%;
          min-height: 0;
          backdrop-filter: blur(14px);
        }

        .pinokio-git-diff-file-list-panel {
          width: 260px;
          background: var(--pinokio-diff-sidebar-bg);
          border-right: 1px solid var(--pinokio-diff-sidebar-border);
          overflow-y: auto;
        }

        .pinokio-git-diff-file-item-row {
          display: grid;
          grid-template-columns: auto 1fr auto;
          align-items: center;
          gap: 8px;
          width: 100%;
          border: none;
          background: transparent;
          color: var(--pinokio-diff-sidebar-text);
          font-size: 13px;
          padding: 10px 12px;
          text-align: left;
          cursor: pointer;
          border-left: 3px solid transparent;
          transition: background 0.2s ease, border-left-color 0.2s ease;
          appearance: none;
        }

        .pinokio-git-diff-file-checkbox {
          width: 18px;
          height: 18px;
          cursor: pointer;
          appearance: none;
          border: 1px solid #6b7280;
          border-radius: 4px;
          background: #f6f7fb;
          display: inline-grid;
          place-items: center;
          position: relative;
          margin-right: 2px;
        }

        .pinokio-git-diff-file-checkbox:checked {
          background: #2563eb;
          border-color: #1d4ed8;
        }

        .pinokio-git-diff-file-checkbox:checked::after {
          content: "";
          font-size: 13px;
          color: #fff;
        }

        .pinokio-git-diff-select-all {
          border-bottom: 1px solid var(--pinokio-diff-sidebar-border);
          position: sticky;
          top: 40px;
          background: #f8fafc;
        }

        .pinokio-git-diff-file-item-row .pinokio-git-diff-file {
          font-weight: 600;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .pinokio-git-diff-file-item-row .pinokio-git-diff-status {
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          color: var(--pinokio-diff-sidebar-meta);
        }

        .pinokio-git-diff-file-item-row:hover {
          background: var(--pinokio-diff-sidebar-hover-bg);
          border-left-color: var(--pinokio-diff-sidebar-hover-border);
        }

        .pinokio-git-diff-file-item-row.pinokio-active-file-item {
          background: #eef2ff;
          border-left-color: #2563eb;
          color: var(--pinokio-diff-sidebar-active-color);
        }

        .pinokio-git-diff-file-item-row.pinokio-active-file-item .pinokio-git-diff-status {
          color: #374151;
        }

        .pinokio-git-diff-file-item-row.pinokio-active-file-item .pinokio-git-diff-file-checkbox {
          border-color: #1d4ed8;
        }

        .pinokio-git-diff-file-item-row:focus-visible {
          outline: none;
          border-left-color: var(--pinokio-diff-sidebar-hover-border);
          box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
        }

        .pinokio-git-diff-viewer-panel {
          text-align: left;
          flex: 1;
          background: var(--pinokio-diff-viewer-bg);
          color: var(--pinokio-diff-viewer-text);
          display: flex;
          flex-direction: column;
          overflow: hidden;
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
          font-size: 13px;
          line-height: 1.5;
        }

        .pinokio-git-diff-viewer-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          padding: 8px 12px;
          border-bottom: 1px solid var(--pinokio-diff-sidebar-border);
          background: var(--pinokio-diff-viewer-bg);
          position: sticky;
          top: 0;
          z-index: 1;
        }

        .pinokio-git-diff-viewer-title {
          font-weight: 600;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .pinokio-git-diff-open-file {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 8px 12px;
          border-radius: 8px;
          border: 1px solid #d1d5db;
          background: #f9fafb;
          color: inherit;
          text-decoration: none;
          font-weight: 600;
          font-size: 12px;
          font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        .pinokio-git-diff-open-file:hover {
          background: #eef2ff;
          border-color: #cbd5e1;
        }

        .pinokio-git-diff-bulk-bar {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          padding: 10px 12px;
          border-bottom: 1px solid #e5e7eb;
          background: #f8fafc;
          position: sticky;
          top: 0;
          z-index: 2;
        }

        .pinokio-git-diff-bulk-title {
          font-weight: 600;
          font-size: 13px;
        }

        .pinokio-git-diff-revert-btn {
          width: 100%;
          box-sizing: border-box;
          justify-content: center;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 18px;
          border-radius: 5px;
          border: 1px solid #2563eb !important;
          background: #2563eb !important;
          color: #fff !important;
          cursor: pointer;
          font: inherit;
        }

        .pinokio-git-diff-revert-btn:hover {
          background: #1d4ed8;
        }

        .pinokio-git-diff-revert-btn:disabled {
          background: #e5e7eb !important;
          border-color: #cbd5e1 !important;
          color: #6b7280 !important;
          cursor: not-allowed;
        }

        .pinokio-git-diff-revert-btn,
        .pinokio-save-version-btn {
          font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
          font-weight: 600;
        }

        .pinokio-git-diff-viewer-body {
          padding: 10px;
          overflow: auto;
          flex: 1 1 auto;
          min-height: 0;
        }

        .pinokio-git-diff-empty-state {
          display: grid;
          place-items: center;
          height: 100%;
          color: var(--pinokio-diff-empty-color);
          font-size: 14px;
          text-align: center;
          padding: 20px;
        }

        body.dark .pinokio-git-diff-file-list-panel {
          background: #0f172a;
          border-right-color: #1f2937;
        }

        body.dark .pinokio-git-diff-file-item-row {
          color: #e2e8f0;
        }

        body.dark .pinokio-git-diff-file-item-row:hover {
          background: #111827;
          border-left-color: #3b82f6;
        }

        body.dark .pinokio-git-diff-file-item-row.pinokio-active-file-item {
          background: rgba(59, 130, 246, 0.15);
          border-left-color: #60a5fa;
        }

        body.dark .pinokio-git-diff-file-item-row.pinokio-active-file-item .pinokio-git-diff-status {
          color: #cbd5e1;
        }

        body.dark .pinokio-git-diff-file-checkbox {
          border-color: #475569;
          background: #0b1220;
        }

        body.dark .pinokio-git-diff-file-checkbox:checked {
          background: #3b82f6;
          border-color: #2563eb;
        }

        body.dark .pinokio-git-diff-select-all {
          background: #0f172a;
          border-bottom-color: #1f2937;
        }

        body.dark .pinokio-git-diff-bulk-bar {
          background: #0f172a;
          border-bottom-color: #1f2937;
        }

        body.dark .pinokio-git-diff-open-file {
          border-color: #334155;
          background: #0b1220;
          color: #e2e8f0;
        }

        body.dark .pinokio-git-diff-open-file:hover {
          background: #1e293b;
          border-color: #475569;
        }

        body.dark .pinokio-git-diff-viewer-panel,
        body.dark .pinokio-git-diff-viewer-header {
          background: #0b1220;
          color: #e2e8f0;
        }

        body.dark .pinokio-git-diff-viewer-header {
          border-bottom-color: #1f2937;
        }

        .pinokio-no-changes-popup.swal2-popup {
          background: var(--pinokio-modal-bg) !important;
          border-radius: 20px !important;
          padding: 36px 40px !important;
          color: var(--pinokio-modal-text) !important;
          width: auto !important;
          max-width: 420px !important;
          box-shadow: var(--pinokio-modern-shadow) !important;
        }

        .pinokio-no-changes-popup .pinokio-no-changes-icon {
          width: 56px;
          height: 56px;
          border-radius: 18px;
          background: var(--pinokio-modal-icon-bg);
          display: grid;
          place-items: center;
          color: var(--pinokio-modal-icon-color);
          font-size: 22px;
          margin: 0 auto 18px auto;
        }

        .pinokio-no-changes-popup .pinokio-no-changes-title {
          font-size: 20px;
          font-weight: 600;
          text-align: center;
          margin-bottom: 8px;
        }

        .pinokio-no-changes-popup .pinokio-no-changes-body {
          font-size: 14px;
          color: var(--pinokio-modal-subtitle-color);
          text-align: center;
          margin: 0 auto 6px auto;
          max-width: 280px;
          line-height: 1.6;
        }

        .pinokio-no-changes-popup .pinokio-no-changes-hint {
          font-size: 12px;
          color: var(--pinokio-commit-meta-color);
          text-align: center;
          margin-top: 4px;
        }

        .pinokio-no-changes-confirm.swal2-confirm {
          background: #3a82ff !important;
          border-radius: 999px !important;
          padding: 10px 26px !important;
          font-weight: 600 !important;
          box-shadow: none !important;
        }

        .pinokio-no-changes-confirm.swal2-confirm:hover {
          background: #2d6ae0 !important;
        }

        .pinokio-github-login-modal.swal2-popup {
          max-width: 420px !important;
          width: calc(100vw - 48px) !important;
        }

        .pinokio-github-login {
          padding: 36px 40px 32px 40px;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          gap: 14px;
        }

        .pinokio-github-login__icon {
          width: 64px;
          height: 64px;
          border-radius: 18px;
          display: grid;
          place-items: center;
          background: var(--pinokio-modal-icon-bg);
          color: var(--pinokio-modal-icon-color);
          font-size: 28px;
        }

        .pinokio-github-login__title {
          font-size: 20px;
          font-weight: 600;
          color: var(--pinokio-modal-text);
        }

        .pinokio-github-login__body {
          font-size: 14px;
          line-height: 1.6;
          color: var(--pinokio-modal-subtitle-color);
          max-width: 280px;
        }

        .pinokio-modern-modal.swal2-popup {
          background: var(--pinokio-modal-bg) !important;
          color: var(--pinokio-modal-text) !important;
          border-radius: 10px !important;
          padding: 0 !important;
          box-shadow: var(--pinokio-modern-shadow) !important;
          overflow: hidden !important;
        }

        .pinokio-modern-html {
          margin: 0 !important;
          padding: 0 !important;
        }

        .pinokio-modern-close {
          color: var(--pinokio-modern-close-color) !important;
          width: 36px !important;
          height: 36px !important;
          border-radius: 12px !important;
          font-size: 20px !important;
          top: 22px !important;
          right: 22px !important;
          transition: background 0.2s ease, color 0.2s ease !important;
        }

        .pinokio-modern-close:hover {
          background: var(--pinokio-modern-close-hover-bg) !important;
          color: var(--pinokio-modern-close-hover-color) !important;
        }

        .pinokio-modern-confirm.swal2-confirm {
          background: #3a82ff !important;
          color: #fff !important;
          border-radius: 999px !important;
          border: none !important;
          padding: 10px 26px !important;
          font-weight: 600 !important;
          box-shadow: none !important;
        }

        .pinokio-modern-confirm.swal2-confirm:hover {
          background: #2d6ae0 !important;
        }

        .pinokio-modern-cancel.swal2-cancel {
          background: var(--pinokio-modern-cancel-bg) !important;
          color: var(--pinokio-modern-cancel-color) !important;
          border-radius: 999px !important;
          border: none !important;
          padding: 10px 22px !important;
          font-weight: 500 !important;
          margin-right: 12px !important;
        }

        .pinokio-modern-cancel.swal2-cancel:hover {
          background: var(--pinokio-modern-cancel-hover-bg) !important;
        }

        .pinokio-modal-surface {
          text-align: left;
          padding: 15px;
          display: flex;
          flex-direction: column;
          gap: 24px;
          color: var(--pinokio-modal-text);
        }

        .pinokio-modal-surface--history {
          max-height: 70vh;
        }

        .pinokio-modal-surface--diff {
          max-height: 82vh;
        }

        .pinokio-modal-header {
          display: flex;
          align-items: flex-start;
          gap: 18px;
        }

        .pinokio-modal-icon {
          width: 56px;
          height: 56px;
          border-radius: 18px;
          background: var(--pinokio-modal-icon-bg);
          display: grid;
          place-items: center;
          color: var(--pinokio-modal-icon-color);
          font-size: 22px;
          flex-shrink: 0;
        }

        .pinokio-modal-heading {
          text-align: left !important;
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .pinokio-modal-title {
          font-size: 20px;
          font-weight: 600;
          color: var(--pinokio-modal-title-color);
        }

        .pinokio-modal-subtitle {
          font-size: 13px;
          color: var(--pinokio-modal-subtitle-color);
        }

        .pinokio-modal-tabs {
          display: inline-flex;
          gap: 8px;
          padding: 0 6px;
        }

        .pinokio-modal-tab {
          border: none;
          background: transparent;
          color: var(--pinokio-modal-subtitle-color);
          padding: 8px 12px;
          border-radius: 10px;
          font-weight: 700;
          letter-spacing: 0.01em;
          cursor: pointer;
          transition: background 0.15s ease, color 0.15s ease, transform 0.15s ease;
        }

        .pinokio-modal-tab:hover {
          background: rgba(59, 130, 246, 0.12);
          color: var(--pinokio-modal-title-color);
        }

        .pinokio-modal-tab:focus-visible {
          outline: 2px solid rgba(59, 130, 246, 0.4);
          outline-offset: 2px;
        }

        .pinokio-modal-tab:disabled {
          opacity: 0.55;
          cursor: not-allowed;
          transform: none;
        }

        .pinokio-modal-tab--active {
          background: rgba(59, 130, 246, 0.16);
          color: var(--pinokio-modal-title-color);
          transform: translateY(-1px);
        }

        .pinokio-history-meta {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
        }

        .pinokio-history-latest-banner {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 20px;
          margin: 12px 20px 0;
          background: rgba(59, 130, 246, 0.08);
          border: 1px solid rgba(59, 130, 246, 0.18);
          border-radius: 10px;
          color: var(--pinokio-modal-title-color);
        }

        .pinokio-history-latest-text {
          font-size: 13px;
          font-weight: 600;
        }

        .pinokio-history-latest-btn {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          background: rgba(59, 130, 246, 0.18);
          border: 1px solid rgba(59, 130, 246, 0.35);
          color: #1d4ed8;
          padding: 6px 14px;
          border-radius: 6px;
          font-weight: 600;
          font-size: 13px;
          cursor: pointer;
          transition: background 0.15s ease, border 0.15s ease, transform 0.15s ease;
        }

        .pinokio-history-latest-btn:hover {
          background: rgba(59, 130, 246, 0.24);
          transform: translateY(-1px);
        }

        .pinokio-history-latest-btn:focus-visible {
          outline: 2px solid rgba(59, 130, 246, 0.45);
          outline-offset: 3px;
        }

        .pinokio-history-latest-banner--disabled {
          opacity: 0.6;
        }

        .pinokio-history-latest-banner--disabled .pinokio-history-latest-btn {
          pointer-events: none;
          cursor: not-allowed;
        }

        .pinokio-history-actions {
          display: inline-flex;
          align-items: center;
          gap: 10px;
        }

        .pinokio-history-branch-select.pinokio-modal-input {
          width: auto;
          min-width: 160px;
          padding: 6px 10px;
          font-size: 13px;
        }

        .pinokio-pill {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          background: var(--pinokio-pill-bg);
          color: var(--pinokio-pill-text);
          font-size: 12px;
          padding: 6px 12px;
          border-radius: 999px;
        }

        .pinokio-pill i {
          font-size: 12px;
        }

        .pinokio-modal-body {
          background: var(--pinokio-modal-body-bg);
          color: var(--pinokio-modal-body-text-color);
          padding: 10px;
          font-size: 14px;
        }

        .pinokio-modal-body--history {
          max-height: 420px;
          overflow-y: auto;
        }

        .pinokio-modal-footer {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          gap: 12px;
        }

        .pinokio-modal-footer--commit {
          padding-top: 12px;
        }

        .pinokio-modal-footer--create {
          padding-top: 12px;
        }

        .pinokio-modal-footer.pinokio-modal-footer--publish {
          display: none;
          padding-top: 12px;
        }

        .pinokio-modal-footer.pinokio-modal-footer--publish.is-visible {
          display: flex;
        }

        .pinokio-publish-close-btn {
          padding: 10px 22px;
          border-radius: 999px;
          border: none;
          background: rgba(127, 91, 243, 0.9) !important;
          color: #fff;
          font-weight: 600;
          cursor: pointer;
        }

        .pinokio-publish-close-btn:hover {
          background: rgba(127, 91, 243, 1) !important;
        }

        .pinokio-modal-secondary-btn {
          padding: 10px 22px;
          border-radius: 999px;
          border: 1px solid rgba(127, 91, 243, 0.35);
          background: transparent;
          color: var(--pinokio-modal-body-text-color);
          font-weight: 600;
          cursor: pointer;
        }

        .pinokio-modal-secondary-btn:hover {
          border-color: rgba(127, 91, 243, 0.6);
          color: #fff;
        }

        .pinokio-modal-body--fork {
          display: flex;
          flex-direction: column;
          gap: 16px;
          padding: 0;
        }

        .pinokio-fork-modal {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .pinokio-fork-help {
          margin: 0;
          font-size: 0.875rem;
          color: rgba(255, 255, 255, 0.75);
        }

        .pinokio-fork-item {
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 10px;
          padding: 14px 16px;
          display: flex;
          flex-direction: column;
          gap: 10px;
          background: rgba(15, 18, 24, 0.65);
        }

        .pinokio-fork-item[data-disabled='true'] {
          opacity: 0.55;
        }

        .pinokio-fork-item-header {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .pinokio-fork-item-header label {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 8px;
          cursor: pointer;
        }

        .pinokio-fork-item-title {
          font-weight: 600;
          font-size: 0.95rem;
        }

        .pinokio-fork-item-url {
          font-size: 0.85rem;
          color: rgba(255, 255, 255, 0.65);
          word-break: break-word;
        }

        .pinokio-fork-item-url.empty {
          font-style: italic;
        }

        .pinokio-history-inline-head {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          margin-bottom: 10px;
        }

        .pinokio-history-inline-actions {
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }

        .pinokio-history-inline-btn {
          border: 1px solid rgba(59, 130, 246, 0.35);
          background: transparent;
          color: var(--pinokio-modal-title-color);
          padding: 7px 12px;
          border-radius: 9px;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.15s ease, border 0.15s ease, transform 0.15s ease;
        }

        .pinokio-history-inline-btn:hover {
          background: rgba(59, 130, 246, 0.16);
          border-color: rgba(59, 130, 246, 0.5);
          transform: translateY(-1px);
        }

        .pinokio-history-inline-btn:focus-visible {
          outline: 2px solid rgba(59, 130, 246, 0.45);
          outline-offset: 2px;
        }

        .pinokio-fork-name-input {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .pinokio-fork-name-input label {
          font-size: 0.8rem;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.04em;
          color: rgba(255, 255, 255, 0.7);
        }

        .pinokio-modal-input.pinokio-modal-input--error {
          border-color: #ff6b6b;
          box-shadow: 0 0 0 1px rgba(255, 107, 107, 0.25);
        }

        .pinokio-fork-checkbox-row {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.85rem;
          border: 1px solid silver;
        }

        .pinokio-fork-checkbox-row label {
          cursor: pointer;
        }

        .pinokio-fork-org-input {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .pinokio-fork-org-input.hidden {
          display: none !important;
        }

        .pinokio-fork-org-input label {
          font-size: 0.8rem;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.04em;
          color: rgba(255, 255, 255, 0.7);
        }

        .pinokio-fork-org-hint {
          margin: 0;
          font-size: 0.75rem;
          color: rgba(255, 255, 255, 0.55);
        }

        .pinokio-fork-dropdown-item,
        .pinokio-publish-dropdown-item {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
          text-align: left;
        }

        .pinokio-fork-dropdown-title,
        .pinokio-publish-dropdown-title {
          font-weight: 600;
          font-size: 0.9rem;
        }

        body.dark .pinokio-fork-dropdown-remote,
        body.dark .pinokio-publish-dropdown-remote {
          color: rgba(255, 255, 255, 0.6);
        }

        .pinokio-fork-dropdown-remote,
        .pinokio-publish-dropdown-remote {
          font-size: 0.75rem;
          word-break: break-word;
          white-space: normal;
          overflow-wrap: anywhere;
        }

        .pinokio-fork-dropdown-remote.empty,
        .pinokio-publish-dropdown-remote.empty {
          font-style: italic;
          color: rgba(255, 255, 255, 0.45);
        }

        .pinokio-modal-icon--warning {
          background: rgba(255, 189, 68, 0.16);
          color: #ffbd44;
        }


        .fs-dropdown-item--disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .pinokio-git-history-list {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .pinokio-modal-body--iframe {
          height: 420px;
          padding: 0;
          overflow: hidden;
        }

        .pinokio-modal-body--iframe iframe {
          width: 100%;
          height: 100%;
          border: none;
          background: var(--pinokio-modal-body-iframe-bg);
        }

        .pinokio-modal-form {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .pinokio-modal-label {
          display: block;
          font-size: 13px;
          color: var(--pinokio-modal-label-color);
          margin-bottom: 6px;
          font-weight: 500;
        }

        .pinokio-modal-input {
          width: 100%;
          padding: 10px 14px;
          border-radius: 5px;
          border: 1px solid var(--pinokio-modal-input-border);
          background: var(--pinokio-modal-input-bg);
          color: var(--pinokio-modal-input-text);
          font-size: 14px;
          outline: none;
          transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .pinokio-modal-input:focus {
          border-color: var(--pinokio-modal-input-focus-border);
          box-shadow: 0 0 0 3px var(--pinokio-modal-input-focus-shadow);
        }

        .pinokio-modal-checkbox-row {
          display: flex;
          align-items: center;
          gap: 5px;
          font-size: 13px;
          color: var(--pinokio-modal-checkbox-color);
        }

        .pinokio-modal-checkbox-row input[type="checkbox"] {
          width: 16px;
          height: 16px;
          accent-color: #3a82ff;
          border-radius: 5px;
          border: 1px solid silver;
        }

        .pinokio-commit-message-container {
          display: flex;
          align-items: stretch;
          gap: 12px;
          width: 100%;
        }

        .pinokio-commit-message-input {
          flex: 1;
          min-height: 44px;
        }

        .pinokio-save-version-btn {
          padding: 12px 18px;
          min-height: 44px;
          border-radius: 10px;
          border: 1px solid #2563eb !important;
          background: #2563eb !important;
          color: #fff !important;
          font-weight: 600;
          cursor: pointer;
        }

        .pinokio-save-version-btn:hover {
          background: #1d4ed8;
        }

        .pinokio-save-version-btn:active {
          transform: translateY(0);
        }

        .pinokio-save-version-btn:disabled {
          background: #e5e7eb;
          border-color: #cbd5e1;
          color: #6b7280;
          cursor: not-allowed;
        }

        .pinokio-history-empty {
          display: grid;
          place-items: center;
          min-height: 200px;
          color: var(--pinokio-history-empty-color);
          font-size: 14px;
        }

        .pinokio-custom-commit-overlay {
          position: fixed;
          inset: 0;
          background: var(--pinokio-custom-commit-overlay-bg);
          backdrop-filter: blur(8px);
          z-index: 20000000;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 30px;
          box-sizing: border-box;
        }

        .pinokio-custom-commit-modal {
          background: var(--pinokio-custom-commit-modal-bg);
          color: var(--pinokio-custom-commit-modal-text);
          border-radius: 22px;
          box-shadow: var(--pinokio-modern-shadow);
          width: min(960px, 95vw);
          height: 80vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          border: 1px solid var(--pinokio-custom-commit-border);
        }

        .pinokio-custom-commit-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 24px 30px;
          border-bottom: 1px solid var(--pinokio-custom-commit-border);
          background: var(--pinokio-custom-commit-header-bg);
        }

        .pinokio-custom-commit-header h3 {
          margin: 0;
          font-size: 20px;
          font-weight: 600;
          color: var(--pinokio-modal-title-color);
        }

        .pinokio-custom-commit-close {
          background: none;
          border: none;
          font-size: 26px;
          cursor: pointer;
          padding: 6px 10px;
          border-radius: 12px;
          color: var(--pinokio-custom-commit-close-color);
          transition: background 0.2s ease, color 0.2s ease;
        }

        .pinokio-custom-commit-close:hover {
          background: var(--pinokio-custom-commit-close-hover-bg);
          color: var(--pinokio-custom-commit-close-hover-color);
        }

        .pinokio-custom-commit-content {
          flex: 1;
          overflow: hidden;
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .pinokio-git-commit-actions {
          display: flex;
          justify-content: flex-end;
        }

        .pinokio-git-commit-switch-btn {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          background: var(--pinokio-custom-commit-action-bg);
          border: 1px solid var(--pinokio-custom-commit-action-border);
          color: var(--pinokio-custom-commit-action-color);
          padding: 6px 14px;
          border-radius: 6px;
          font-weight: 600;
          font-size: 13px;
          cursor: pointer;
          transition: background 0.15s ease, border 0.15s ease, transform 0.15s ease;
        }

        .pinokio-git-commit-switch-btn:hover {
          background: var(--pinokio-custom-commit-action-hover);
          transform: translateY(-1px);
        }

        .pinokio-git-commit-switch-btn:focus-visible {
          outline: 2px solid var(--pinokio-custom-commit-action-color);
          outline-offset: 3px;
        }

        .pinokio-custom-terminal-overlay {
          position: fixed;
          inset: 0;
          background: rgba(9, 11, 15, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 999999;
        }

        .pinokio-custom-terminal-modal {
          width: min(900px, 92vw);
          height: min(620px, 88vh);
          background: var(--pinokio-modal-surface-bg, #101522);
          color: var(--pinokio-modal-title-color);
          border-radius: 18px;
          box-shadow: 0 24px 60px rgba(15, 23, 42, 0.55);
          display: flex;
          flex-direction: column;
          overflow: hidden;
          border: 1px solid rgba(76, 137, 251, 0.2);
        }

        .pinokio-custom-terminal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 16px 20px;
          background: rgba(30, 41, 59, 0.8);
          border-bottom: 1px solid rgba(76, 137, 251, 0.25);
        }

        .pinokio-custom-terminal-header h3 {
          margin: 0;
          font-size: 15px;
          font-weight: 600;
        }

        .pinokio-custom-terminal-close {
          background: none;
          border: none;
          font-size: 26px;
          cursor: pointer;
          padding: 6px 10px;
          border-radius: 12px;
          color: rgba(226, 232, 240, 0.7);
          transition: background 0.2s ease, color 0.2s ease;
        }

        .pinokio-custom-terminal-close:hover {
          background: rgba(148, 163, 184, 0.18);
          color: #f8fafc;
        }

        .pinokio-custom-terminal-body {
          flex: 1;
          background: #0b1120;
        }

        .pinokio-custom-terminal-body iframe {
          width: 100%;
          height: 100%;
          border: none;
        }

        .pinokio-git-commit-item {
          display: flex;
          gap: 14px;
          align-items: flex-start;
          border: none;
          background: var(--pinokio-commit-item-bg);
          padding: 5px !important;
          transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease;
          width: 100%;
          cursor: pointer;
          text-align: left;
          outline: none;
          color: var(--pinokio-commit-item-text);
        }

        .pinokio-git-commit-item:hover {
          background: var(--pinokio-commit-item-hover-bg);
          transform: translateY(-1px);
        }

        .pinokio-git-commit-item:focus-visible {
          border-color: rgba(96, 165, 250, 0.55);
          box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
        }

        .pinokio-git-commit-avatar {
          width: 40px;
          height: 40px;
          border-radius: 12px;
          background: var(--pinokio-commit-avatar-bg);
          color: var(--pinokio-commit-avatar-color);
          display: grid;
          place-items: center;
          font-size: 16px;
          flex-shrink: 0;
        }

        .pinokio-git-commit-content {
          flex: 1;
          min-width: 0;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }

        .pinokio-git-commit-message {
          font-size: 15px;
          font-weight: 600;
          color: var(--pinokio-modal-title-color);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .pinokio-git-commit-meta {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          font-size: 12px;
          color: var(--pinokio-commit-meta-color);
        }

        .pinokio-git-commit-author {
          font-weight: 600;
        }

        .pinokio-git-commit-hash {
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
          background: var(--pinokio-commit-hash-bg);
          color: var(--pinokio-commit-hash-color);
          padding: 2px 8px;
          border-radius: 999px;
        }

        .pinokio-diff-code-line {
          padding: 0;
          white-space: pre-wrap;
          border-left: 3px solid transparent;
          display: grid;
          grid-template-columns: 70px 1fr;
          width: 100%;
          box-sizing: border-box;
          margin: 0;
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
          font-size: 12px;
          line-height: 1.5;
          color: var(--pinokio-diff-code-text);
          background: transparent;
        }

        .pinokio-diff-code-line-addition {
          background: var(--pinokio-diff-code-add-bg);
          border-left-color: var(--pinokio-diff-code-add-border);
          color: var(--pinokio-diff-code-add-color);
        }

        .pinokio-diff-code-line-deletion {
          background: var(--pinokio-diff-code-del-bg);
          border-left-color: var(--pinokio-diff-code-del-border);
          color: var(--pinokio-diff-code-del-color);
        }

        .pinokio-diff-code-line-context {
          background: var(--pinokio-diff-code-context-bg);
          border-left-color: var(--pinokio-diff-code-context-border);
        }

        .pinokio-diff-code-line-numbers {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 4px;
          align-items: center;
          justify-items: end;
          width: 100%;
          padding: 6px 12px;
          box-sizing: border-box;
          color: var(--pinokio-diff-gutter-text);
          user-select: none;
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
          font-size: 12px;
          line-height: 1.5;
          background: var(--pinokio-diff-gutter-bg);
          border-right: 1px solid var(--pinokio-diff-gutter-border);
        }

        .pinokio-diff-code-line-content {
          box-sizing: border-box;
          display: block;
          width: 100%;
          padding: 6px 14px;
          white-space: pre-wrap;
          overflow-wrap: break-word;
          word-break: break-word;
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
          font-size: 12px;
          line-height: 1.5;
          color: inherit;
        }

        .pinokio-diff-line-number {
          min-width: 0;
          text-align: right;
          opacity: 0.85;
        }

        .pinokio-diff-line-number--old:empty,
        .pinokio-diff-line-number--new:empty {
          opacity: 0.4;
        }



        /*
@media only screen and (max-width: 1000px) {
  .url-bar {
    display: none;
  }
  .filler {
    display: block;
  }
}
*/

        /*
@media only screen and (max-width: 480px) {
*/
        /*
@media only screen and (max-width: 600px) {
  nav .btn2 {
    width: auto !important;
    min-width: 40px;
    border-right: none;
    flex-direction: column;
  }
  .app-info {
    display: flex;
    padding: 10px;
  }
  .app-info img {
    width: 60px;
    height: 60px;
  }

  .header-item {
    font-size: 16px;
  }
  aside.active {
    width: 100%;
    z-index: 10000000;
  }
  aside:not(.active) {
    display: none;
  }
  .container {
    display: none;
  }
  .container.active {
    display: block;
    position: absolute;
    z-index: 10000000;
    width: 100%;
    height: 100%;
  }
  #menu {
    display: none;
  }
  #menu-mobile {
    display: flex;
  }
}
*/
        @media only screen and (max-width: 768px) {
          body {
            display: flex !important;
            flex-direction: row !important;
            align-items: stretch;
          }

          body aside {
            display: none;
          }

          header.navheader {
            position: relative;
            top: auto;
            left: auto;
            height: auto;
            min-height: 0;
            /*
    width: 55px;
    min-width: 55px;
    max-width: 55px;
    */
            display: flex;
            flex-direction: column;
            align-self: stretch;
            overflow: auto;
            flex-shrink: 0;
            backdrop-filter: none;
          }

          header.navheader h1 {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            height: auto;
            overflow: auto;
            flex-wrap: nowrap;
          }

          /* Keep minimized header horizontal and compact on small screens */
          header.navheader.minimized,
          header.navheader.minimized h1 {
            display: inline-flex;
            flex-direction: row;
          }

          header.navheader.minimized h1 .btn2 {
            width: auto;
          }

          .appcanvas {
            margin-left: 0;
            flex: 1 1 auto;
            min-width: 0;
          }

          header.navheader.minimized+.appcanvas {
            margin-left: 0;
          }

          main,
          iframe.mainframe {
            padding-left: 0;
            margin-left: 0;
            width: auto;
            flex: 1 1 auto;
            min-width: 0;
          }

          .appcanvas>aside .menu-container {
            padding: 8px 0 0;
          }
        }

        @media only screen and (max-width: 800px) {
          .mode-selector .btn2 {
            width: unset;
          }

          .mode-selector .btn2 .caption {
            display: none;
          }

          #fs-status .fs-status-label {
            font-size: 0;
            gap: 0;
            line-height: 0;
          }

          /*
  #fs-status .fs-status-label i {
    font-size: 1rem;
  }
  */
          #fs-push-btn,
          #fs-fork-btn {
            min-width: 0;
          }

          #fs-push-btn .fs-status-label,
          #fs-fork-btn .fs-status-label {
            font-size: 0;
          }

          #fs-push-btn .fs-status-label i,
          #fs-fork-btn .fs-status-label i {
            font-size: 1rem;
          }

          #fs-status .fs-status-btn .disk-usage {
            display: none;
          }

          #fs-status .git-changes .badge {
            display: inline-flex;
          }
        }

        /*
@media only screen and (max-width: 800px) {
  body {
    flex-direction: row !important;
  }
  aside {
    display: none;
  }
}
*/
        .meta-icon {
          width: 25px;
          height: 25px;
          margin-right: 10px;
        }
      </style>
      <link href="/app.css" rel="stylesheet" />
      <link href="/tab-link-popover.css" rel="stylesheet" />
      <script src="/window_storage.js"></script>
      <script src="/timeago.min.js"></script>
      <script src="/hotkeys.min.js"></script>
      <script src="/sweetalert2.js"></script>
      <script src="/nav.js"></script>
      <script src="/common.js"></script>
      <script src="/opener.js"></script>
      <script src="/report.js"></script>
      <script src="/normalize.js"></script>
      <script src="/Socket.js"></script>
      <script src="/noty.js"></script>
      <script src="/notyq.js"></script>
      <script src="/filepond-plugin-file-validate-type.min.js"></script>
      <script src="/filepond-plugin-image-exif-orientation.min.js"></script>
      <script src="/filepond-plugin-image-preview.min.js"></script>
      <script src="/filepond-plugin-image-edit.min.js"></script>
      <script src="/filepond-plugin-image-crop.min.js"></script>
      <script src="/filepond-plugin-image-resize.min.js"></script>
      <script src="/filepond-plugin-image-transform.min.js"></script>
      <script src="/filepond.min.js"></script>
      <script src="/fseditor.js"></script>
      <script src="/popper.min.js"></script>
      <script src="/tippy-bundle.umd.min.js"></script>
      <script src="/tab-link-popover.js"></script>
      <script>

      </script>
</head>

<body class='<%=theme%>' data-platform="<%=platform%>" data-agent="<%=agent%>">
  <header class='navheader grabbable'>
    <h1>
      <button class='btn2' id='back' data-tippy-content="back">
        <div><i class="fa-solid fa-chevron-left"></i></div>
      </button>
      <button class='btn2' id='forward' data-tippy-content="forward">
        <div><i class="fa-solid fa-chevron-right"></i></div>
      </button>
      <button class='btn2' id='refresh-page' data-tippy-content="refresh">
        <div><i class="fa-solid fa-rotate-right"></i></div>
      </button>
      <div class='sep'></div>
      <div class='mode-selector'>
        <a class="btn2 <%=type === 'run' ? 'selected' : ''%>" href="<%=run_tab%>">
          <div><i class="fa-solid fa-circle-play"></i></div>
          <div class='caption'>Run</div>
        </a>
        <a class="btn2 <%=type === 'browse' ? 'selected' : ''%>" href="<%=dev_tab%>">
          <div><i class="fa-solid fa-code"></i></div>
          <div class='caption'>Dev</div>
        </a>
        <a class="btn2 <%=type === 'files' ? 'selected' : ''%>" href="<%=files_tab%>">
          <div><i class="fa-solid fa-file-lines"></i></div>
          <div class='caption'>Files</div>
        </a>
        <a class="btn2 <%=type === 'review' ? 'selected' : ''%>" href="<%=review_tab%>">
          <div><i class="fa-regular fa-message"></i></div>
          <div class='caption'>Forum</div>
        </a>
      </div>
      <a class='btn2' href="/columns" data-tippy-content="split into 2 columns">
        <div><i class="fa-solid fa-table-columns"></i></div>
      </a>
      <a class='btn2' href="/rows" data-tippy-content="split into 2 rows">
        <div><i class="fa-solid fa-table-columns fa-rotate-270"></i></div>
      </a>
      <button class='btn2' id='new-window' data-tippy-content="open a new window" title='open a new window'
        data-agent="<%=agent%>">
        <div><i class="fa-solid fa-plus"></i></div>
      </button>
      <button class='btn2 hidden' id='close-window' data-tippy-content='close this section'>
        <div><i class="fa-solid fa-xmark"></i></div>
      </button>
    </h1>
  </header>
  <div class='appcanvas'>
    <% if (error) { %>
      <div class='error-message'>
        <div>
          <h1><i class="fa-solid fa-triangle-exclamation"></i> Error</h1>
          <div>
            <%=error%>
          </div>
        </div>
      </div>
      <% } else { %>
        <% if (type !=='files' ) { %>
          <aside class='active'>
            <div class='menu-container'>
              <div class='config-info'>
                <button type='button' id='layout-toggle'>
                  <i class="fa-solid fa-bars"></i>
                </button>
                <% if (config.icon) { %>
                  <img class='meta-icon' src="<%=config.icon%>" />
                  <% } %>
                    <% if (config.title) { %>
                      <div>
                        <%=config.title%>
                      </div>
                      <% } %>
              </div>
              <span class="disk-usage tab-metric__value" data-path="/" data-filepath="<%=path%>">--</span>
              <div class='m n system' data-type="n">
                <%if (type==='browse' ) { %>
                  <a id='devtab' data-mode="refresh" target="<%=dev_link%>" href="<%=dev_link%>"
                    class="btn frame-link selected" data-index="10">
                    <div class="tab">
                      <i class="fa-solid fa-bars"></i> Launchers
                    </div>
                  </a>

                  <div class="dynamic <%=type==='run' ? '' : 'selected'%>">
                    <div class='submenu'>
                      <% if (plugin_menu) { %>
                        <%- include('./partials/dynamic', { dynamic: plugin_menu, }) %>
                          <% } %>
                    </div>
                  </div>
                  <% } %>
              </div>
              <%if (type==='run' ) { %>
                <div class='m h menu' data-type='h'>
                  <% if (config.menu) { %>
                    <%- include('./partials/menu', { menu: config.menu, }) %>
                      <% } %>
                        <a id='settings-tab' data-mode="refresh" target="env-settings" href="/env/api/<%=name%>"
                          class="btn header-item frame-link" data-index="settings" data-static="retain">
                          <div class='tab'>
                            <i class="fa-solid fa-gear"></i>
                            <div class='display'>Settings</div>
                            <div class='flexible'></div>
                          </div>
                        </a>
                        <button type='button' id='ask-ai-tab' class="btn header-item" data-static="ask-ai"
                          data-workspace="<%=name%>" data-ask-ai-trigger="true">
                          <div class='tab'>
                            <i class="fa-solid fa-robot"></i>
                            <div class='display'>Ask AI</div>
                            <div class='flexible'></div>
                          </div>
                        </button>
                </div>
                <% } %>
                  <div class='m s temp-menu' data-type='s'>
                    <%tabs.forEach((tab, i)=> { %>
                      <a target="s<%=i%>" href="<%=tab%>" class="btn header-item frame-link" data-index="<%=i%>">
                        <div class='tab'>
                          <i class="fa-solid fa-link"></i>
                          <div class='display'>
                            <%=tab%>
                          </div>
                          <div class='flexible'></div><button class='btn2 del'><i
                              class="fa-solid fa-xmark"></i></button>
                        </div>
                      </a>
                      <%})%>
                  </div>
            </div>
          </aside>
          <div class='appcanvas-resizer' id="appcanvas-resizer" role="separator" aria-orientation="vertical"
            aria-valuemin="140" aria-valuemax="560" aria-valuenow="150" tabindex="0"
            aria-label="Resize navigation sidebar"></div>
          <% } %>
            <% if (type==="run" ) { %>
              <div class='appcanvas_filler'></div>
              <% } %>
                <div class='container'>
                  <% if (type==="browse" ) { %>
                    <div id='fs-status' data-workspace="<%=name%>" data-create-uri="<%=git_create_url%>"
                      data-history-uri="<%=git_history_url%>" data-status-uri="<%=git_status_url%>"
                      data-uri="<%=git_monitor_url%>" data-push-uri="<%=git_push_url%>"
                      data-fork-uri="<%=git_fork_url%>">
                      <!--
        <div class='fs-status-dropdown nested-menu git blue'>
          <button type='button' class='fs-status-btn frame-link reveal'>
            <span class='fs-status-label'>
              <i class="fa-brands fa-git-alt"></i>
              Git
            </span>
          </button>
          <div class='fs-dropdown-menu submenu hidden' id='git-repos'>
          </div>
        </div>
        -->
                      <div class='fs-status-dropdown fs-open-explorer'>
                        <button class='fs-status-btn' data-filepath="<%=path%>" type='button'>
                          <span class='fs-status-label'>
                            <i class="fa-solid fa-folder-open"></i>
                            <span class='fs-status-title'>Open in File Explorer</span>
                          </span>
                        </button>
                      </div>
                      <div class='fs-status-dropdown fs-logs'>
                        <button class='fs-status-btn' type='button'>
                          <span class='fs-status-label'>
                            <i class="fa-solid fa-laptop-code"></i>
                            <span class='fs-status-title'>Logs</span>
                          </span>
                        </button>
                      </div>
                      <div class='fs-status-dropdown git-changes'>
                        <button id='fs-changes-btn' class='fs-status-btn revealer' data-group='#fs-changes-menu'
                          type='button'>
                          <span class='fs-status-label'><i class="fa-solid fa-code-compare"></i> Changes</span>
                          <div class='badge'></div>
                        </button>
                        <div class='fs-dropdown-menu submenu hidden' id='fs-changes-menu'></div>
                      </div>
                      <div class='fs-status-dropdown git-fork'>
                        <button id='fs-fork-btn' class='fs-status-btn revealer' data-group='#fs-fork-menu'
                          type='button'>
                          <span class='fs-status-label'>
                            <i class="fa-solid fa-code-branch"></i>
                            <span class='fs-status-title'>Fork</span>
                          </span>
                        </button>
                        <div class='fs-dropdown-menu submenu hidden' id='fs-fork-menu'></div>
                      </div>
                      <div class='fs-status-dropdown git-publish'>
                        <button id='fs-push-btn' class='fs-status-btn revealer' data-group='#fs-push-menu'
                          type='button'>
                          <span class='fs-status-label'>
                            <i class="fa-brands fa-github"></i>
                            <span class='fs-status-title'>Publish</span>
                          </span>
                        </button>
                        <div class='fs-dropdown-menu submenu hidden' id='fs-push-menu'></div>
                      </div>
                    </div>
                    <% } else if (type==='files' ) { %>
                      <div id='fs-status' data-workspace="<%=name%>" data-create-uri="<%=git_create_url%>"
                        data-history-uri="<%=git_history_url%>" data-status-uri="<%=git_status_url%>"
                        data-uri="<%=git_monitor_url%>" data-push-uri="<%=git_push_url%>"
                        data-fork-uri="<%=git_fork_url%>">
                        <!--
        <div class='fs-status-dropdown nested-menu git blue'>
          <button type='button' class='fs-status-btn frame-link reveal'>
            <span class='fs-status-label'>
              <i class="fa-brands fa-git-alt"></i>
              Git
            </span>
          </button>
          <div class='fs-dropdown-menu submenu hidden' id='git-repos'>
          </div>
        </div>
        -->
                        <span class="disk-usage tab-metric__value" data-path="/" data-filepath="<%=path%>">--</span>
                        <div class='fs-status-dropdown fs-open-explorer'>
                          <button class='fs-status-btn' data-filepath="<%=path%>" type='button'>
                            <span class='fs-status-label'>
                              <i class="fa-solid fa-folder-open"></i>
                              <span class='fs-status-title'>Open in File Explorer</span>
                            </span>
                          </button>
                        </div>
                        <div class='fs-status-dropdown fs-logs'>
                          <button class='fs-status-btn' type='button'>
                            <span class='fs-status-label'>
                              <i class="fa-solid fa-laptop-code"></i>
                              <span class='fs-status-title'>Logs</span>
                            </span>
                          </button>
                        </div>
                        <div class='fs-status-dropdown git-changes'>
                          <button id='fs-changes-btn' class='fs-status-btn revealer' data-group='#fs-changes-menu'
                            type='button'>
                            <span class='fs-status-label'><i class="fa-solid fa-code-compare"></i> Changes</span>
                            <div class='badge'></div>
                          </button>
                          <div class='fs-dropdown-menu submenu hidden' id='fs-changes-menu'></div>
                        </div>
                        <div class='fs-status-dropdown git-fork'>
                          <button id='fs-fork-btn' class='fs-status-btn revealer' data-group='#fs-fork-menu'
                            type='button'>
                            <span class='fs-status-label'>
                              <i class="fa-solid fa-code-branch"></i>
                              <span class='fs-status-title'>Fork</span>
                            </span>
                          </button>
                          <div class='fs-dropdown-menu submenu hidden' id='fs-fork-menu'></div>
                        </div>
                        <div class='fs-status-dropdown git-publish'>
                          <button id='fs-push-btn' class='fs-status-btn revealer' data-group='#fs-push-menu'
                            type='button'>
                            <span class='fs-status-label'>
                              <i class="fa-brands fa-github"></i>
                              <span class='fs-status-title'>Publish</span>
                            </span>
                          </button>
                          <div class='fs-dropdown-menu submenu hidden' id='fs-push-menu'></div>
                        </div>
                        <div class='flexible'></div>
                      </div>
                      <% } %>
                        <main class='browserview'>
                          <% if (type==='files' ) { %>
                            <iframe class='selected' src="<%=editor_tab%>"></iframe>
                            <% } %>
                        </main>

                </div>
  </div>
  <script>
    let started_script
    let loaded = {}
    let cursorIndex = 0;
    let interacted = false
    let global_selector
    let pendingSelectionRetry = null
    const scheduleSelectionRetry = (delay = 100) => {
      if (pendingSelectionRetry !== null) {
        return
      }
      pendingSelectionRetry = setTimeout(() => {
        pendingSelectionRetry = null
        renderSelection({ force: true })
      }, delay)
    }
    const pluginLaunchActive = (() => {
      try {
        const params = new URLSearchParams(window.location.search)
        return params.has('plugin')
      } catch (_) {
        return false
      }
    })()
    let ignorePersistedSelection = pluginLaunchActive
    let lastForegroundSignature = null
    const iframe_onerror = (iframe) => {
      if (iframe && iframe.dataset && iframe.dataset.forceVisible === 'true') {
        return
      }
      let originalSrc = iframe.src
      iframe.onload = function () {
        try {
          // Try to access the iframe's document
          const iframeDoc = iframe.contentDocument || (iframe.contentWindow ? iframe.contentWindow.document : null)
          const currentSrc = iframe.src
          // Check if it's a chrome error page or empty
          if (currentSrc !== originalSrc &&
            (currentSrc.includes('chrome-error://') ||
              currentSrc === 'about:blank' ||
              currentSrc.includes('data:'))) {
            Swal.fire({
              html: `<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...`,
              customClass: {
                container: "loader-container",
                popup: "loader-popup",
                htmlContainer: "loader-dialog",
                footer: "hidden",
                actions: "hidden"
              }
            });
            setTimeout(() => {
              iframe.src = iframe.src
            }, 3000)
          }
        } catch (e) {
          // Cross-origin restriction - assume it loaded successfully
          // if no error was thrown during the initial load
          console.warn('Iframe load warning', e)
        }
      }
    }
    const create_iframe = (name, href) => {
      document.querySelectorAll(".menu-container .selected").forEach((el) => {
        el.classList.remove("selected")
      })
      document.querySelectorAll("main.browserview iframe").forEach((el) => {
        el.classList.add("hidden")
      })
      let frame = document.createElement("iframe")
      frame.name = name
      frame.src = href
      frame.classList.add("selected")
      iframe_onerror(frame)
      frame.setAttribute(
        "allow",
        "clipboard-read *; clipboard-write *; accelerometer *; ambient-light-sensor *; autoplay *; battery *; camera *; display-capture *; gamepad *; geolocation *; gyroscope *; hid *; identity-credentials-get *; microphone *; midi *; otp-credentials *; serial *;"
      )
      document.querySelector("main").appendChild(frame)
      loaded[name] = true
    }
    document.addEventListener("click", (e) => {
      interacted = true
    })
      <% if (type !== "run" && !config.title) { %>
  /*
  tippy('#edit-toggle', {
    arrow: true,
    showOnCreate: true,
    theme: "pointer",
    placement: "top",
    content: "Click here to edit metadata"
  });
  */
  <% } %>
  <% if (type === "run" && config.meta_required) { %>

/*
  setTimeout(() => {
    tippy('#switch-dev', {
      arrow: true,
      showOnCreate: true,
      theme: "pointer",
      placement: "bottom-end",
      content: "Switch to dev mode to make changes to the app"
    });
  }, 500)
  */
  <% } %>
  const n = new N()
    const escapeTargetSelector = (value) => {
      if (typeof value !== "string") {
        return ""
      }
      if (window.CSS && typeof window.CSS.escape === "function") {
        return window.CSS.escape(value)
      }
      return value.replace(/([ #;?%&,.+*~':"!^$\\\[\]()=>|\/])/g, '\\$1')
    }
    const previewClass = "tab-preview"
    const tabMainClass = "tab-main"
    const tabDetailsClass = "tab-details"
    const updatedClass = "tab-updated"
    const tabStateStore = new Map()
    const TAB_STATE_STORAGE_KEY = "tab-state-store"
    const getWindowStorage = () => {
      if (typeof windowStorage === "undefined" || !windowStorage) {
        return null
      }
      return windowStorage
    }
    const frameContextKey = () => {
      const frameName = window.frameElement?.name || ""
      if (!frameName) {
        return ""
      }
      const datasetSrc = window.frameElement?.dataset?.src
      if (typeof datasetSrc === 'string' && datasetSrc.length > 0) {
        return `${frameName}:${datasetSrc}`
      }
      try {
        const srcUrl = window.frameElement?.src ? new URL(window.frameElement.src, window.location.origin) : null
        if (srcUrl) {
          return `${frameName}:${srcUrl.pathname}${srcUrl.search}${srcUrl.hash}`
        }
      } catch (_) { }
      return frameName
    }
    const selectionStorageKey = () => {
      const base = frameContextKey()
      if (!base) {
        return ""
      }
      return `${base}:selector`
    }
    const selectionUrlStorageKey = () => {
      const base = frameContextKey()
      if (!base) {
        return ""
      }
      return `${base}:url`
    }
    const SELECTION_SELECTOR_ATTRS = [
      'target',
      'data-target-full',
      'href',
      'data-shell',
      'data-script',
      'data-action',
      'data-run',
      'data-command',
      'data-filepath'
    ]
    const buildFrameLinkSelector = (node) => {
      if (!node || !node.classList || !node.classList.contains('frame-link')) {
        return null
      }
      for (const attr of SELECTION_SELECTOR_ATTRS) {
        const raw = node.getAttribute(attr)
        if (typeof raw === 'string' && raw.length > 0) {
          return `.frame-link[${attr}='${escapeTargetSelector(raw)}']`
        }
      }
      return null
    }
    const findLinkByAbsoluteHref = (href) => {
      if (!href) {
        return null
      }
      return Array.from(document.querySelectorAll('.frame-link')).find((el) => {
        try {
          return el.href === href
        } catch (_) {
          return false
        }
      }) || null
    }
    const persistFrameLinkSelection = (node) => {
      const storage = getWindowStorage()
      if (!storage || !node || !node.classList || !node.classList.contains('frame-link')) {
        return
      }
      const payload = {
        selector: buildFrameLinkSelector(node),
        hrefAttr: node.getAttribute('href') || null,
        href: (() => {
          try {
            return node.href || null
          } catch (_) {
            return null
          }
        })(),
        target: node.getAttribute('target') || null,
        pagePath: (() => {
          try {
            return window.location?.pathname || null
          } catch (_) {
            return null
          }
        })()
      }
      try {
        const key = selectionStorageKey()
        if (!key) {
          return
        }
        storage.setItem(key, JSON.stringify(payload))
      } catch (_) { }
    }
    const restorePersistedFrameLink = (providedPayload = null) => {
      const storage = getWindowStorage()
      const key = selectionStorageKey()
      const currentPath = (() => {
        try {
          return window.location?.pathname || ""
        } catch (_) {
          return ""
        }
      })()
      let payload = providedPayload
      if (!payload) {
        if (!storage || !key) {
          return null
        }
        const raw = storage.getItem(key)
        if (!raw) {
          return null
        }
        try {
          payload = JSON.parse(raw)
        } catch (_) {
          payload = { selector: raw }
        }
      }
      if (!payload) {
        return null
      }
      if (typeof payload === 'object' && payload !== null && typeof payload.pagePath === 'string') {
        if (currentPath && payload.pagePath !== currentPath) {
          return null
        }
      }
      if (typeof payload === 'string') {
        payload = { selector: payload }
      }
      if (payload && typeof payload.selector === 'string' && /\[data-index=/.test(payload.selector)) {
        payload.selector = null
      }
      if (payload && Object.prototype.hasOwnProperty.call(payload, 'dataIndex')) {
        delete payload.dataIndex
      }
      const trySelector = (selector) => {
        if (!selector || typeof selector !== 'string') {
          return null
        }
        try {
          return document.querySelector(selector)
        } catch (_) {
          return null
        }
      }
      let node = trySelector(payload.selector)
      if (!node && payload.hrefAttr) {
        node = trySelector(`.frame-link[href='${escapeTargetSelector(payload.hrefAttr)}']`)
      }
      if (!node && payload.target) {
        node = trySelector(`.frame-link[target='${escapeTargetSelector(payload.target)}']`)
      }
      if (!node && payload.href) {
        node = findLinkByAbsoluteHref(payload.href)
      }
      return node
    }
    const persistTabStateStore = () => {
      const storage = getWindowStorage()
      if (!storage) {
        return
      }
      if (tabStateStore.size === 0) {
        storage.removeItem(TAB_STATE_STORAGE_KEY)
        return
      }
      const entries = Array.from(tabStateStore.entries()).map(([frameName, state]) => {
        return [frameName, {
          previewText: typeof state.previewText === "string" ? state.previewText : "",
          hasContent: Boolean(state.hasContent),
          timestamp: Number.isFinite(state.timestamp) ? state.timestamp : undefined,
          previewInitialized: Boolean(state.previewInitialized)
        }]
      })
      try {
        storage.setItem(TAB_STATE_STORAGE_KEY, JSON.stringify(entries))
      } catch (_) { }
    }
    const hydrateTabStateStore = () => {
      const storage = getWindowStorage()
      if (!storage) {
        return
      }
      const raw = storage.getItem(TAB_STATE_STORAGE_KEY)
      if (!raw) {
        return
      }
      let parsed
      try {
        parsed = JSON.parse(raw)
      } catch (_) {
        return
      }
      if (!Array.isArray(parsed)) {
        return
      }
      parsed.forEach((entry) => {
        if (!Array.isArray(entry) || entry.length !== 2) {
          return
        }
        const [frameName, state] = entry
        if (typeof frameName !== "string" || !frameName) {
          return
        }
        if (!state || typeof state !== "object") {
          return
        }
        tabStateStore.set(frameName, {
          previewText: typeof state.previewText === "string" ? state.previewText : "",
          hasContent: Boolean(state.hasContent),
          timestamp: Number.isFinite(state.timestamp) ? state.timestamp : undefined,
          previewInitialized: Boolean(state.previewInitialized)
        })
      })
    }
    hydrateTabStateStore()
    const getOrCreateTabState = (frameName) => {
      if (!frameName) {
        return null
      }
      let state = tabStateStore.get(frameName)
      if (!state) {
        state = {
          previewText: "",
          hasContent: false,
          timestamp: undefined,
          previewInitialized: false
        }
        tabStateStore.set(frameName, state)
      }
      return state
    }
    const cleanupTabState = (frameName) => {
      const state = tabStateStore.get(frameName)
      if (!state) {
        return
      }
      const hasPreviewValue = state.previewInitialized && state.hasContent && typeof state.previewText === "string" && state.previewText.length > 0
      const hasTimestampValue = typeof state.timestamp === "number"
      if (!hasPreviewValue && !hasTimestampValue) {
        tabStateStore.delete(frameName)
      }
    }
    const recordTabPreviewState = (frameName, previewText, hasContent, timestamp) => {
      const state = getOrCreateTabState(frameName)
      if (!state) {
        return
      }
      state.previewText = previewText
      state.hasContent = Boolean(hasContent)
      state.previewInitialized = true
      state.timestamp = typeof timestamp === "number" ? timestamp : undefined
      cleanupTabState(frameName)
      persistTabStateStore()
    }
    const recordTabTimestampState = (frameName, timestamp) => {
      if (typeof timestamp !== "number") {
        return
      }
      const state = getOrCreateTabState(frameName)
      if (!state) {
        return
      }
      state.timestamp = timestamp
      cleanupTabState(frameName)
      persistTabStateStore()
    }
    const stripSessionParam = (value) => {
      if (!value || typeof value !== "string" || value.indexOf("session=") === -1) {
        return value
      }
      const questionIndex = value.indexOf("?")
      if (questionIndex >= 0) {
        const base = value.slice(0, questionIndex)
        const params = value.slice(questionIndex + 1).split("&").filter(Boolean).filter((param) => {
          return !param.startsWith("session=")
        })
        if (params.length === 0) {
          return base
        }
        return `${base}?${params.join("&")}`
      }
      const segments = value.split("&")
      const baseSegment = segments.shift()
      const filtered = segments.filter((param) => {
        return !param.startsWith("session=")
      })
      if (filtered.length === 0) {
        return baseSegment
      }
      return `${baseSegment}&${filtered.join("&")}`
    }
    const extractSessionId = (value) => {
      if (!value || typeof value !== "string") {
        return ""
      }
      const queryIndex = value.indexOf("?")
      let search = ""
      if (queryIndex >= 0) {
        search = value.slice(queryIndex + 1)
      } else {
        const ampIndex = value.indexOf("&")
        if (ampIndex >= 0) {
          search = value.slice(ampIndex + 1)
        }
      }
      if (!search) {
        return ""
      }
      const params = search.split("&").filter(Boolean)
      for (const param of params) {
        if (param.startsWith("session=")) {
          return param.slice("session=".length)
        }
      }
      return ""
    }
    const targetsMatch = (a, b) => {
      if (!a || !b) {
        return false
      }
      if (a === b) {
        return true
      }
      const sessionA = extractSessionId(a)
      const sessionB = extractSessionId(b)
      if (sessionA && sessionB && sessionA === sessionB) {
        return true
      }
      return false
    }
    const getTabLink = (frameName) => {
      if (!frameName) {
        return null
      }
      const escapedName = escapeTargetSelector(frameName)
      const selector = `.frame-link[target="${escapedName}"]`
      const link = document.querySelector(selector)
      if (link && link.tagName === "A" && link.closest(".dynamic .submenu")) {
        return link
      }
      const normalized = stripSessionParam(frameName)
      if (normalized && normalized !== frameName) {
        const normalizedSelector = `.frame-link[target="${escapeTargetSelector(normalized)}"]`
        const fallback = document.querySelector(normalizedSelector)
        if (fallback && fallback.tagName === "A" && fallback.closest(".dynamic .submenu")) {
          return fallback
        }
      }
      return null
    }
    const isNotificationCapableLink = (link) => {
      // Links that can spin up an iframe or stream output should request notifications
      if (!link || !(link instanceof HTMLElement)) {
        return false;
      }
      if (link.dataset.canNotify === 'always') {
        return true;
      }
      if (link.dataset.canNotify === 'never') {
        return false;
      }
      if (link.getAttribute('target') === '_blank') {
        return false;
      }
      if (link.dataset.mode === 'refresh') {
        return link.dataset.enableNotify === 'true';
      }
      if (link.dataset.shell || link.dataset.script || link.dataset.command || link.dataset.run || link.dataset.action || link.dataset.targetFull || link.dataset.canNotify === 'true') {
        return true;
      }
      return false;
    };

    const ensureTabStructure = (tab) => {
      let tabMain = tab.querySelector(`.${tabMainClass}`)
      if (!tabMain) {
        tabMain = document.createElement("div")
        tabMain.className = tabMainClass
        while (tab.firstChild) {
          tabMain.appendChild(tab.firstChild)
        }
        tab.appendChild(tabMain)
      }
      Array.from(tabMain.childNodes).forEach((node) => {
        if (node.nodeType === Node.TEXT_NODE) {
          node.remove()
        }
      })
      let details = tabMain.querySelector(`.${tabDetailsClass}`)
      if (!details) {
        details = document.createElement("div")
        details.className = tabDetailsClass
        tabMain.appendChild(details)
      }
      let previewEl = tab.querySelector(`.${previewClass}`)
      if (!previewEl) {
        previewEl = document.createElement("div")
        previewEl.className = previewClass
      }
      if (previewEl.parentElement !== details) {
        details.appendChild(previewEl)
      }
      let updatedEl = tab.querySelector(`.${updatedClass}`)
      if (!updatedEl) {
        updatedEl = document.createElement("div")
        updatedEl.className = updatedClass
      }
      if (updatedEl.parentElement !== details) {
        details.appendChild(updatedEl)
      }
      if (!updatedEl.querySelector('.indicator')) {
        const indicator = document.createElement('span')
        indicator.className = 'indicator'
        indicator.innerHTML = `<span class="dot"></span><span class="label"></span>`
        updatedEl.appendChild(indicator)
      }
      tab.classList.add("has-preview")

      const link = tab.closest('.frame-link')
      if (link) {
        if (isNotificationCapableLink(link)) {
          link.setAttribute('data-can-notify', 'true')
        } else {
          link.setAttribute('data-can-notify', 'false')
        }
      }
      return { tabMain, previewEl, updatedEl, details }
    }
    const resetTabStructure = (tab) => {
      const tabMain = tab.querySelector(`.${tabMainClass}`)
      const previewEl = tab.querySelector(`.${previewClass}`)
      const updatedEl = tab.querySelector(`.${updatedClass}`)
      const details = tab.querySelector(`.${tabDetailsClass}`)
      if (tabMain) {
        Array.from(tabMain.childNodes).forEach((child) => {
          if (child.nodeType === Node.ELEMENT_NODE && child.classList.contains(tabDetailsClass)) {
            return
          }
          tab.insertBefore(child, tabMain)
        })
        tab.removeChild(tabMain)
      }
      if (details) {
        details.remove()
      }
      if (previewEl) {
        previewEl.remove()
      }
      if (updatedEl) {
        updatedEl.remove()
      }
      tab.classList.remove("has-preview")
    }
    const formatRelativeTime = (timestamp) => {
      const value = Number(timestamp)
      if (!Number.isFinite(value)) {
        return ""
      }
      const diffMs = Date.now() - value
      if (!Number.isFinite(diffMs)) {
        return ""
      }
      const diffSeconds = Math.max(0, Math.floor(diffMs / 1000))
      if (diffSeconds < 5) {
        return "just now"
      }
      if (diffSeconds < 60) {
        return `${diffSeconds} sec${diffSeconds === 1 ? "" : "s"} ago`
      }
      const diffMinutes = Math.floor(diffSeconds / 60)
      if (diffMinutes < 60) {
        return `${diffMinutes} min${diffMinutes === 1 ? "" : "s"} ago`
      }
      const diffHours = Math.floor(diffMinutes / 60)
      if (diffHours < 24) {
        return `${diffHours} hr${diffHours === 1 ? "" : "s"} ago`
      }
      const diffDays = Math.floor(diffHours / 24)
      return `${diffDays} day${diffDays === 1 ? "" : "s"} ago`
    }
    const updateTabPreview = (frameName, previewText, hasContent, timestamp) => {
      const link = getTabLink(frameName)
      if (!link) {
        recordTabPreviewState(frameName, previewText, hasContent, timestamp)
        return
      }
      const tab = link.querySelector(".tab")
      if (!tab) {
        recordTabPreviewState(frameName, previewText, hasContent, timestamp)
        return
      }
      const { previewEl, updatedEl } = ensureTabStructure(tab)
      const label = updatedEl.querySelector('.indicator .label')
      const dot = updatedEl.querySelector('.indicator .dot')
      previewEl.textContent = hasContent ? previewText : ""
      if (typeof timestamp === "number") {
        const relative = formatRelativeTime(timestamp)
        updatedEl.dataset.timestamp = String(timestamp)
        const isLive = (Date.now() - timestamp) < 3000
        updatedEl.classList.toggle('is-live', isLive)
        if (label) {
          label.textContent = isLive ? `${relative}  live` : `idle  ${relative}`
        }
        ensureTimestampInterval()
      } else {
        label.textContent = ""
        updatedEl.removeAttribute('data-timestamp')
        updatedEl.classList.remove('is-live')
      }
      recordTabPreviewState(frameName, previewText, hasContent, timestamp)
    }
    const updateTabTimestamp = (frameName, timestamp) => {
      if (typeof timestamp !== "number") {
        return
      }
      const link = getTabLink(frameName)
      if (!link) {
        recordTabTimestampState(frameName, timestamp)
        return
      }
      const tab = link.querySelector(".tab")
      if (!tab) {
        recordTabTimestampState(frameName, timestamp)
        return
      }
      const structures = ensureTabStructure(tab)
      let updatedEl = structures.updatedEl
      const label = updatedEl.querySelector('.indicator .label')
      const dot = updatedEl.querySelector('.indicator .dot')
      const relative = formatRelativeTime(timestamp)
      updatedEl.dataset.timestamp = String(timestamp)
      const isLive = (Date.now() - timestamp) < 3000
      updatedEl.classList.toggle('is-live', isLive)
      if (label) {
        label.textContent = isLive ? `${relative}  live` : `idle  ${relative}`
      }
      ensureTimestampInterval()
      recordTabTimestampState(frameName, timestamp)
    }
    const restoreTabState = (frameName) => {
      const state = tabStateStore.get(frameName)
      if (!state) {
        return
      }
      if (state.previewInitialized) {
        updateTabPreview(frameName, state.previewText, state.hasContent, state.timestamp)
        return
      }
      if (typeof state.timestamp === "number") {
        updateTabTimestamp(frameName, state.timestamp)
      }
    }
    const restoreAllTabStates = () => {
      tabStateStore.forEach((_, frameName) => {
        restoreTabState(frameName)
      })
    }
    const collectMenuSelectionSignatures = (container) => {
      if (!container) {
        return []
      }
      return Array.from(container.querySelectorAll('.frame-link.selected')).map((node) => {
        const tab = node.querySelector('.tab')
        const owningMenu = node.closest('[data-type]')
        return {
          target: node.getAttribute('target') || '',
          href: node.getAttribute('href') || '',
          dataIndex: node.dataset.index || '',
          dataMode: node.getAttribute('data-mode') || '',
          dataTargetFull: node.dataset.targetFull || '',
          dataShell: node.dataset.shell || '',
          dataScript: node.dataset.script || '',
          dataAction: node.getAttribute('data-action') || '',
          dataRun: node.getAttribute('data-run') || '',
          dataCommand: node.getAttribute('data-command') || '',
          dataFilepath: node.getAttribute('data-filepath') || '',
          menuType: owningMenu ? owningMenu.getAttribute('data-type') || owningMenu.dataset.type || '' : '',
          textValue: tab ? tab.textContent.trim() : ''
        }
      })
    }
    const matchMenuNode = (node, signature) => {
      if (!node || !node.classList || !node.classList.contains('frame-link')) {
        return false
      }
      if (signature.target && node.getAttribute('target') === signature.target) {
        return true
      }
      if (signature.dataTargetFull && node.dataset.targetFull === signature.dataTargetFull) {
        return true
      }
      if (signature.dataShell && node.dataset.shell === signature.dataShell) {
        return true
      }
      if (signature.dataScript && node.dataset.script === signature.dataScript) {
        return true
      }
      if (signature.dataAction && node.getAttribute('data-action') === signature.dataAction) {
        return true
      }
      if (signature.dataRun && node.getAttribute('data-run') === signature.dataRun) {
        return true
      }
      if (signature.dataCommand && node.getAttribute('data-command') === signature.dataCommand) {
        return true
      }
      if (signature.dataFilepath && node.getAttribute('data-filepath') === signature.dataFilepath) {
        return true
      }
      if (signature.href && node.getAttribute('href') === signature.href) {
        return true
      }
      if (signature.dataIndex) {
        const sameIndex = node.dataset.index === signature.dataIndex
        if (sameIndex) {
          const nodeMenu = node.closest('[data-type]')
          const nodeMenuType = nodeMenu ? nodeMenu.getAttribute('data-type') || nodeMenu.dataset.type || '' : ''
          if (!signature.menuType || signature.menuType === nodeMenuType) {
            if (!signature.dataMode || node.getAttribute('data-mode') === signature.dataMode) {
              return true
            }
          }
        }
      }
      const tab = node.querySelector('.tab')
      if (signature.textValue && tab && tab.textContent.trim() === signature.textValue) {
        return true
      }
      return false
    }
    // Rebuild a navigation container while keeping any active selection intact.
    const rerenderMenuSection = (container, html) => {
      const targetContainer = typeof container === 'string' ? document.querySelector(container) : container
      if (!targetContainer) {
        return
      }
      const staticNodes = Array.from(targetContainer.children || []).filter((node) => {
        return node && node.dataset && node.dataset.static
      })
      const template = document.createElement('template')
      template.innerHTML = html || ''
      const fragment = template.content
      const signatures = collectMenuSelectionSignatures(targetContainer)
      if (signatures.length > 0) {
        const candidates = Array.from(fragment.querySelectorAll('.frame-link'))
        signatures.forEach((signature) => {
          const match = candidates.find((node) => matchMenuNode(node, signature))
          if (match) {
            match.classList.add('selected')
          }
        })
      }
      const nodes = Array.from(fragment.childNodes)
      targetContainer.replaceChildren(...nodes)
      if (staticNodes.length > 0) {
        staticNodes.forEach((node) => {
          if (!node) {
            return
          }
          if (node.parentElement === targetContainer) {
            return
          }
          if (node.dataset && node.dataset.static) {
            const duplicates = Array.from(targetContainer.children || []).filter((candidate) => {
              if (candidate === node) {
                return false
              }
              return candidate.dataset && candidate.dataset.static === node.dataset.static
            })
            duplicates.forEach((duplicate) => {
              duplicate.remove()
            })
          }
          targetContainer.appendChild(node)
        })
      }
    }
    let timestampIntervalId = null
    const ensureTimestampInterval = () => {
      if (timestampIntervalId !== null) {
        return
      }
      timestampIntervalId = setInterval(() => {
        const nodes = document.querySelectorAll(`.${updatedClass}[data-timestamp]`)
        if (!nodes || nodes.length === 0) {
          clearInterval(timestampIntervalId)
          timestampIntervalId = null
          return
        }
        const now = Date.now()
        nodes.forEach((node) => {
          const value = Number(node.dataset.timestamp)
          if (!Number.isFinite(value)) {
            return
          }
          const label = node.querySelector('.indicator .label')
          const relative = formatRelativeTime(value)
          const isLive = (now - value) < 3000
          node.classList.toggle('is-live', isLive)
          if (label) {
            label.textContent = isLive ? `${relative}  live` : `idle  ${relative}`
          }
        })
      }, 1000)
    }
    const resolveFrameName = (frameHint, sourceWindow) => {
      if (frameHint && typeof frameHint === "string") {
        return frameHint
      }
      if (!sourceWindow) {
        return null
      }
      const frames = Array.from(document.querySelectorAll("main.browserview iframe"))
      for (const frame of frames) {
        if (frame.contentWindow === sourceWindow) {
          return frame.name || null
        }
      }
      return null
    }
    const getTarget = (href) => {
      let u
      if (href.startsWith("http")) {
        return href
      } else if (href.startsWith("/")) {
        u = new URL("http://localhost" + href)
        u.search = ""
        return u.pathname
      } else {
        u = new URL("http://localhost/" + href)
        u.search = ""
        return u.pathname
      }
    }
    const subUrlOf = (s, f) => {

      let subsetUrl = (s.startsWith("http") ? s : "http://localhost" + s)
      let fullUrl = (f.startsWith("http") ? f : "http://localhost" + f)

      const subsetParsed = new URL(subsetUrl)
      const fullParsed = new URL(fullUrl)

      if (subsetParsed.pathname !== fullParsed.pathname) {
        return false;
      }

      // Check if all search parameters in the subset URL are present in the full URL
      for (const [key, val] of subsetParsed.searchParams) {

        if (!fullParsed.searchParams.has(key)) {
          return false
        }
        if (fullParsed.searchParams.get(key) !== val) {
          return false
        }
      }

      return true;
    }
    const renderCursor = () => {
      document.querySelectorAll(".selectable").forEach((el) => {
        el.classList.remove("cursor")
      })
      const target = document.querySelector(".selectable[data-index='" + cursorIndex + "']")
      target.classList.add("cursor")
    }
    const nav = (type) => {
      let targetFrame = document.querySelector("iframe:not(.hidden)")
      if (type === "back") {
        //    targetFrame.contentWindow.history.back()
        targetFrame.contentWindow.postMessage({
          action: "back"
        }, "*")
      } else if (type === "forward") {
        //    targetFrame.contentWindow.history.forward()
        targetFrame.contentWindow.postMessage({
          action: "forward"
        }, "*")
      }



      //  if (location.hash && location.hash.length > 0) {
      ////    let id = getTarget(location.hash.slice(1))
      ////    let target = document.querySelector("aside [target='" + id + "']")
      //    let id = location.hash.slice(1)
      //    let type = id[0]
      //    let index = id.slice(1)
      //    let target = document.querySelector(`aside .${type} [data-index='${index}']`)
      //    let targetFrame = document.querySelector(`iframe[name='${target.target}']`)
      //    console.log({ target, targetFrame })
      //    if (type === "back") {
      //      targetFrame.contentWindow.history.back()
      //    } else if (type === "forward") {
      //      targetFrame.contentWindow.history.forward()
      //    }
      //    /*
      //    targetFrame.contentWindow.postMessage({
      //      action: type
      //    }, "*")
      //    */
      //  }
    }

    let timeout_id
    const renderSelection = async ({ event: eventParam = null, target: explicitTarget = null, force = false } = {}) => {
      const storage = getWindowStorage()
      const selectionKey = selectionStorageKey()
      const currentPath = (() => {
        try {
          return window.location?.pathname || ""
        } catch (_) {
          return ""
        }
      })()
      let persistedSelectionRaw = selectionKey && storage ? storage.getItem(selectionKey) : null
      const devRouteActive = /\/dev(?:$|\/)/.test(currentPath || "")
      let persistedSelectionPayload = null
      if (persistedSelectionRaw) {
        try {
          const parsed = JSON.parse(persistedSelectionRaw)
          if (parsed && typeof parsed === "object") {
            if (typeof parsed.pagePath === "string") {
              if (!currentPath || parsed.pagePath === currentPath) {
                persistedSelectionPayload = parsed
              }
            } else if (!devRouteActive) {
              persistedSelectionPayload = parsed
            }
          }
        } catch (_) {
          if (!devRouteActive) {
            persistedSelectionPayload = { selector: persistedSelectionRaw }
          }
        }
      }
      if (!persistedSelectionPayload) {
        persistedSelectionRaw = null
      }
      const originalHasPersistedSelection = Boolean(persistedSelectionPayload)
      const skipPersistedSelection = ignorePersistedSelection
      let hasPersistedSelection = skipPersistedSelection ? false : originalHasPersistedSelection
      if (skipPersistedSelection) {
        persistedSelectionRaw = null
        persistedSelectionPayload = null
      }

      const triggeredByUser = Boolean(eventParam || explicitTarget)
      let resolvedByGlobalSelector = false

      let target = explicitTarget
      let preselected = null
      let defaultSelectionNode = null
      const getDefaultSelection = () => {
        if (defaultSelectionNode === null) {
          defaultSelectionNode = document.querySelector('[data-default]')
        }
        return defaultSelectionNode
      }

      if (!target && eventParam) {
        target = eventParam.target?.closest(".frame-link") || null
      }

      if (!target && global_selector) {
        const candidate = document.querySelector(global_selector)
        if (candidate) {
          target = candidate
          global_selector = null
          resolvedByGlobalSelector = true
        } else {
          scheduleSelectionRetry()
          return
        }
      }

      if (!target && !skipPersistedSelection) {
        preselected = document.querySelector('#devtab.frame-link.selected') || document.querySelector('.frame-link.selected')
      }

      if (!target && persistedSelectionPayload) {
        target = restorePersistedFrameLink(persistedSelectionPayload)
        if (!target && originalHasPersistedSelection) {
          scheduleSelectionRetry()
          return
        }
      }

      if (!target && !skipPersistedSelection) {
        const urlKey = selectionUrlStorageKey()
        const storedUrl = urlKey && storage ? storage.getItem(urlKey) : null
        if (storedUrl) {
          target = document.querySelector(`[href='${escapeTargetSelector(storedUrl)}']`) || findLinkByAbsoluteHref(storedUrl)
        }
      }

      const devTab = document.querySelector('#devtab.frame-link')
      if (!triggeredByUser && !resolvedByGlobalSelector && !target && devRouteActive && devTab) {
        const defaultCandidate = getDefaultSelection()
        if (pluginLaunchActive && defaultCandidate) {
          target = defaultCandidate
        } else {
          target = devTab
        }
      }

      if (!target && preselected) {
        target = preselected
      }

    <% if (autoselect && env.PINOKIO_SCRIPT_DEFAULT && env.PINOKIO_SCRIPT_DEFAULT.toString().toLowerCase() === "true") { %>
      if (!target && !hasPersistedSelection) {
          const defaultSelection = getDefaultSelection()
          if (defaultSelection && defaultSelection.href) {
            const selectionProtocol = new URL(defaultSelection.href).protocol
            const pageProtocol = new URL(location.href).protocol
            if (selectionProtocol !== pageProtocol) {
              if (!timeout_id) {
                Swal.fire({
                  html: `<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...`,
                  customClass: {
                    container: "loader-container",
                    popup: "loader-popup",
                    htmlContainer: "loader-dialog",
                    footer: "hidden",
                    actions: "hidden"
                  }
                });
                timeout_id = setTimeout(() => {
                  location.href = location.href
                }, 3000)
              }
              return
            }
          }
          if (defaultSelection) {
            target = defaultSelection
          }
        }
    <% } %>

    if (!target && preselected) {
        target = preselected
      }

      if (!target) {
        document.querySelector(".container").classList.remove("active")
        document.querySelector("aside").classList.add("active")
        return
      }

      document.querySelector(".container").classList.add("active")
      document.querySelector("aside").classList.remove("active")


      // Instantiate a frame with the selected target's href
      let url = target.href

      if (!url) {
        return
      }
      //    document.querySelector("#open-browser").href = url
      //    document.querySelector("#clone-tab").setAttribute("data-href", url)

      //document.querySelector("#location").value = url

      //    document.querySelector("#open-location").setAttribute('href', target.href)
      //    if (target.pathname.startsWith("/run")) {
      //      document.querySelector("#location").value = target.pathname.slice(4)
      //    } else if (target.pathname.startsWith("/api")) {
      //      document.querySelector("#location").value = target.pathname
      //    } else {
      //      document.querySelector("#location").value = target.href
      //    }


      // select the selected target element (tab)
      document.querySelectorAll(".frame-link").forEach((el) => {
        el.classList.remove("selected")
      })
      target.classList.add("selected")
      if (skipPersistedSelection && target.hasAttribute('data-default')) {
        ignorePersistedSelection = false
      }
      persistFrameLinkSelection(target)

        // save target.href
        <% if (type !== "run") { %>
          let _url = new URL(target.href)
          const urlKey = selectionUrlStorageKey()
          if (urlKey) {
            windowStorage.setItem(urlKey, _url.pathname + _url.search + _url.hash)
          }
    <% } %>

        // hide all frames
        document.querySelectorAll("main.browserview iframe").forEach((el) => {
          el.classList.add("hidden")
        })



      // Look for the frame
      // 1. if it's hard (".h")
      //    look for the url that matches
      // 2. if it's soft (".s")
      //    find using the name attribute
      let targetFrame;
      if (target.closest(".h")) {
        let hardFrames = document.querySelectorAll(".browserview iframe[name^='@']")
        let port = new URL(target.href).port || 80
        for (let frame of hardFrames) {
          // Types of links in the tab
          //if (String(port) === "<%=port%>") {
          if (String(port) === String(location.port) || /https:\/\/.+\.localhost/.test(origin)) {
            // 1. running from <%=port%> => find a frame whose base URL matches the tab's base URL
            // Pinokio links
            let targetPath = new URL(target.href).pathname
            let framePath = new URL(frame.src).pathname
            if (targetPath === framePath) {
              let beforeName = frame.name
              frame.name = target.target
              targetFrame = frame
              break
            }
          } else {
            // 2. rest => find the frame whose src exactly matches the tab's url
            if (target.href === frame.src) {
              frame.name = target.target
              targetFrame = frame
              break
            }
          }
          // find the frame whose path matches 
        }
      } else if (target.closest(".s")) {
        targetFrame = document.querySelector(`iframe[name='${target.target}']`)
      } else if (target.closest(".n")) {
        targetFrame = document.querySelector(`iframe[name='${target.target}']`)
      }

      /*
      // Load the link in the frame

      1. if the frame was found:
        - if "refresh": true => refresh
        - otherwise,
          - if the target frame has been already loaded, don't do anything
            - frame: start.json?mode=abc, link: start.json?mode=abc => don't touch
              - link === frame
            - frame: start.json?mode=abc, link: start.json?mode=def => should load
              - link !== frame && !frame.includes(link)
            - frame: start.json?mode=abc, link: start.json => don't touch
              - link !== frame && frame.includes(link)



            if the link is different

          - if the target frame has not been loaded, refresh
      2. if the frame was NOT found => create one

      */

      if (targetFrame) {
        targetFrame.classList.remove("hidden")
        let mode = target.getAttribute("data-mode")
        if (mode === "refresh") {
          if (targetFrame.src !== target.href) {
            targetFrame.src = target.href
          }
        } else {
          if (eventParam) {
            if (target.closest(".h")) {
              eventParam.preventDefault()
              eventParam.stopPropagation()
              let sub = subUrlOf(target.href, targetFrame.src)
              if (!sub) {
                if (targetFrame.src !== target.href) {
                  targetFrame.src = target.href
                }
              }
            } else if (target.closest(".s")) {
              // load unconditionally => .s doesn't change
              eventParam.preventDefault()
              eventParam.stopPropagation()
            } else if (target.closest(".n")) {
              // load unconditionally => .n doesn't change
              eventParam.preventDefault()
              eventParam.stopPropagation()
            }
          } else {
            if (force) {
              if (targetFrame.src !== target.href) {
                targetFrame.src = target.href
              }
            }
          }
          let frameHref
          try {
            frameHref = targetFrame.contentWindow?.location?.href || targetFrame.src
          } catch (_) {
            frameHref = targetFrame.src
          }
          const signature = `${targetFrame.name || ''}::${frameHref || ''}`
          if (force || signature !== lastForegroundSignature) {
            targetFrame.contentWindow.postMessage({
              action: "foreground"
            }, "*")
            lastForegroundSignature = signature
          }
        }
      } else {
        let frame = document.createElement("iframe")
        frame.name = target.target
        frame.src = target.href
        iframe_onerror(frame)
        frame.setAttribute(
          "allow",
          "clipboard-read *; clipboard-write *; accelerometer *; ambient-light-sensor *; autoplay *; battery *; camera *; display-capture *; gamepad *; geolocation *; gyroscope *; hid *; identity-credentials-get *; microphone *; midi *; otp-credentials *; serial *;"
        )
        document.querySelector("main").appendChild(frame)
        loaded[target.target] = true
        lastForegroundSignature = null
      }

      //      if (targetFrame) {
      //        targetFrame.classList.remove("hidden")
      //
      //        // if the iframe already exists, do not 
      //        if (loaded[target.target]){
      //
      //          // Force refresh option
      //          //
      //          //  menu := [{
      //          //    text,
      //          //    icon,
      //          //    mode: "refresh"     => refresh regardless of any condition
      //          //  }]
      //          let mode = target.getAttribute("data-mode")
      //          if (mode === "refresh") {
      //            targetFrame.src = target.href
      //          } else {
      //            console.log("# 4")
      //            if (e) {
      //              // if triggered by a click event,
      //              // 1. if it's a hard link (".h")
      //              //  - ignore if the pathname is the same
      //              //  - reload if 
      //              console.log("# 5", { src: targetFrame.src, href: target.href, target: target.target })
      //              // triggered with a click
      //              // do not reload iframe if the href and the src is the same
      //              if (target.closest(".h")) {
      //  //              if (targetFrame.src.includes(target.target)) {
      //                if (targetFrame.src.includes(target.href)) {
      //    //            if (targetFrame.src === target.href) {
      //                  e.preventDefault()
      //                  e.stopPropagation()
      //                }
      //              } else if (target.closest(".s")) {
      //                e.preventDefault()
      //                e.stopPropagation()
      //              }
      //            } else {
      //              // if not triggered by event
      //              // refresh ONLY if programmatically forced refresh 
      //              console.log("# 6")
      //              if (force) {
      //                console.log("# 7")
      //                targetFrame.src = target.href
      //              }
      //            }
      //          }
      //
      //        } else {
      //          console.log("# 8")
      //          //targetFrame.contentWindow.addEventListener("load", () => {
      //            if (e) {
      //              console.log("# 9")
      //              // coming from a click => don't need to set the src
      //            } else {
      //              console.log("# 10")
      //              // load without click
      //              if (targetFrame.src !== target.href) {
      //                console.log("# 11")
      //                targetFrame.src = target.href
      //              }
      //            }
      //            loaded[target.target] = true
      //          //});
      //        }
      //      } else {
      //        console.log("# 12")
      //        let frame = document.createElement("iframe")
      //        frame.name = target.target
      //        frame.src = target.href
      //        frame.setAttribute(
      //          "allow", 
      //          "clipboard-read *; clipboard-write *; accelerometer *; ambient-light-sensor *; autoplay *; battery *; camera *; display-capture *; gamepad *; geolocation *; gyroscope *; hid *; identity-credentials-get *; microphone *; midi *; otp-credentials *; serial *;"
      //        )
      //        document.querySelector("main").appendChild(frame)
      //        loaded[target.target] = true
      //      }
    }


    // Need to strip the plugin= query param when redirected from "ask ai", otherwise it will keep selecting the specified plugin even after closing
    let pluginQueryStripped = false
    const stripPluginQueryOnce = () => {
      if (pluginQueryStripped) return
      const url = new URL(window.location.href)
      if (!/\/dev(?:$|\/)/.test(url.pathname)) return
      if (!url.searchParams.has("plugin")) return
      url.searchParams.delete("plugin")
      const qs = url.searchParams.toString()
      const newUrl = `${url.origin}${url.pathname}${qs ? "?" + qs : ""}${url.hash}`
      if (window.location.href !== newUrl) {
        history.replaceState({}, "", newUrl)
      }
      const dynBase = "<%-dynamic%>".split("?")[0]
      const updatedDynamic = qs ? `${dynBase}?${qs}` : dynBase
      window.__pinokioDynamicUrl = updatedDynamic
      pluginQueryStripped = true
    }
    renderSelection().then(() => {
      stripPluginQueryOnce()
    })
      //renderCursor()
      //Reporter()
      <% if (agent === "electron") { %>
        document.querySelector("#back").addEventListener("click", (e) => {
          nav("back")
        })
        document.querySelector("#forward").addEventListener("click", (e) => {
          nav("forward")
        })
          <% } %>


  const syncTabs = async () => {
      let tabs = []
      document.querySelectorAll(".temp-menu .frame-link").forEach((el) => {
        tabs.push(el.href)
      })


      // persist
      await fetch("/pinokio/tabs", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name: "<%=name%>",
          tabs
        })
      })
    }
    const addTab = async (url, options = {}) => {
      const label = typeof options.label === 'string' && options.label.trim().length > 0 ? options.label.trim() : null
      let item = document.createElement("a")
      //let id = "ts" + Date.now()
      let index = document.querySelectorAll("aside .s .frame-link").length

      let id = "s" + index
      //  let id = url
      item.target = id
      item.href = url
      item.setAttribute("data-index", index)
      item.className = "btn header-item frame-link"
      const displayText = label || url
      item.innerHTML = `<div class='tab'><i class="fa-solid fa-link"></i><div class='display'>${escapeHtml(displayText)}</div><div class='flexible'></div><button class='btn2 del'><i class="fa-solid fa-xmark"></i></button></div>`

      document.querySelector(".temp-menu").appendChild(item)

      let frame = document.createElement("iframe")
      frame.name = id
      frame.src = item.href
      iframe_onerror(frame)
      frame.setAttribute(
        "allow",
        "clipboard-read *; clipboard-write *; accelerometer *; ambient-light-sensor *; autoplay *; battery *; camera *; display-capture *; gamepad *; geolocation *; gyroscope *; hid *; identity-credentials-get *; microphone *; midi *; otp-credentials *; serial *;"
      )
      document.querySelector("main").appendChild(frame)

      await syncTabs()


      return {
        tab: item,
        frame
      }

    }




    if (document.querySelector("#menu-mobile")) {
      document.querySelector("#menu-mobile").addEventListener("click", async (e) => {
        refresh(false, { nodelay: true })
      })
    }
    if (document.querySelector("#menu")) {
      document.querySelector("#menu").addEventListener("click", async (e) => {
        document.querySelector("aside").classList.toggle("hidden")
        document.querySelector("#menu").classList.toggle("margin")
      })
    }

    function next_path(url, newName) {
      // Match /p/:name optionally followed by /dev
      const pattern = /\/p\/[^\/]+(\/dev)(\?|#)?$/;

      if (pattern.test(url)) {
        return url.replace(/\/p\/[^\/]+/, `/p/${newName}`);
      }

      return url; // No match
    }


    if (document.querySelector("#move")) {
      document.querySelector("#move").addEventListener("click", async (e) => {
        e.preventDefault()
        e.stopPropagation()
        await FSEditor({
          title: `<%=config.title%>`,
          description: `<%=config.description%>`,
          old_path: `<%=name%>`,
          icon: `<%=config.icon%>`,
        <% if (config.iconpath) { %>
          iconpath: `<%-JSON.stringify(config.iconpath).slice(1, -1)%>`,
        <% } %>
          move: true,
            edit: true,
              redirect: (new_path) => {
                let u = next_path(location.href, new_path)
                debugger
                return u
              }
      })
    })
  }
    if (document.querySelector("#edit")) {
      document.querySelector("#edit").addEventListener("click", async (e) => {
        e.preventDefault()
        e.stopPropagation()
        await FSEditor({
          title: `<%=config.title%>`,
          description: `<%=config.description%>`,
          old_path: `<%=name%>`,
          icon: `<%=config.icon%>`,
        <% if (config.iconpath) { %>
          iconpath: `<%-JSON.stringify(config.iconpath).slice(1, -1)%>`,
        <% } %>
          edit: true,
            redirect: (new_path) => {
              let u = next_path(location.href, new_path)
              return u
            }
      })
    })
  }
    if (document.querySelector("#copy")) {
      document.querySelector("#copy").addEventListener("click", async (e) => {
        e.preventDefault()
        e.stopPropagation()
        await FSEditor({
          title: `<%=config.title%>`,
          description: `<%=config.description%>`,
          old_path: `<%=name%>`,
          icon: `<%=config.icon%>`,
        <% if (config.iconpath) { %>
          iconpath: `<%-JSON.stringify(config.iconpath).slice(1, -1)%>`,
        <% } %>
          copy: true,
            edit: true,
              redirect: (new_path) => {
                console.log({ new_path })
                let u = next_path(location.href, new_path)
                return u
              }
      })
      /*
      e.preventDefault()
      e.stopPropagation()
      let folder = prompt("Enter a folder name to copy to")
      if (folder.includes(' ')) {
        alert("Please use a folder name without a space")
        return
      }
      Swal.fire({
        html: `<i class="fa-solid fa-circle-notch fa-spin"></i> Copying from <%=name%> to ${folder}`,
        customClass: {
          container: "loader-container",
          popup: "loader-popup",
          htmlContainer: "loader-dialog",
          footer: "hidden",
          actions: "hidden"
        }
      });
      let res = await fetch("/copy", {
        method: "post",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          src: "<%=name%>",
          dest: folder
        })
      }).then((res) => {
        return res.json()
      })
      Swal.close()
      if (res.error) {
        alert(res.error)
      } else {
        console.log(res)
        location.href = res.success
      }
      */
    })
  }
    document.querySelectorAll(".app-info-description").forEach((el) => {
      el.addEventListener("click", (e) => {
        e.preventDefault()
        e.stopPropagation()
        e.currentTarget.classList.toggle("collapsed")
      })
    })
    if (document.querySelector("#delete")) {
      document.querySelector("#delete").addEventListener("click", async (e) => {
        e.preventDefault()
        e.stopPropagation()
        const confirmed = confirm("Are you sure you wish to delete the app?")
        if (confirmed) {
          let name = document.querySelector("#delete").getAttribute("data-name")
          console.log("delete", name)
          Swal.fire({
            html: '<i class="fa-solid fa-circle-notch fa-spin"></i> Deleting',
            customClass: {
              container: "loader-container",
              popup: "loader-popup",
              htmlContainer: "loader-dialog",
              footer: "hidden",
              actions: "hidden"
            }
          });
          let res = await fetch("/pinokio/delete", {
            method: "post",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ name })
          }).then((res) => {
            return res.json()
          })
          console.log("res", res)
          Swal.close()
          if (res) {
            if (res.success) {
              location.href = "/home"
            } else if (res.error) {
              alert(res.error)
            }
          }
        } else {
        }
      })
    }
    const setDropdownState = (toggle, isOpen) => {
      if (!toggle) {
        return
      }
      const down = toggle.querySelector(".loader .fa-angle-down")
      const up = toggle.querySelector(".loader .fa-angle-up")
      if (down && up) {
        down.classList.toggle("hidden", isOpen)
        up.classList.toggle("hidden", !isOpen)
      }
    }

    const nestedMenuSelector = ".appcanvas > aside .m.menu .nested-menu"

    const getDirectChild = (parent, selector) => {
      if (!parent) {
        return null
      }
      return Array.from(parent.children).find((child) => child.matches && child.matches(selector)) || null
    }

    const getSubmenu = (menu) => getDirectChild(menu, ".submenu")
    const getToggle = (menu) => getDirectChild(menu, ".reveal")

    const resetSubmenuPosition = (submenu) => {
      if (!submenu) {
        return
      }
      submenu.style.removeProperty("left")
      submenu.style.removeProperty("top")
      submenu.style.removeProperty("position")
      submenu.style.removeProperty("visibility")
      submenu.style.removeProperty("z-index")
    }

    const getMenuDepth = (menu) => {
      let depth = 0
      let current = menu ? menu.parentElement : null
      while (current) {
        if (current.classList && current.classList.contains("submenu")) {
          depth += 1
        }
        current = current.parentElement
      }
      return depth
    }

    const positionSubmenu = (submenu, toggle) => {
      if (!submenu || !toggle) {
        return
      }
      const menu = toggle.closest(nestedMenuSelector)
      const depth = getMenuDepth(menu)
      const padding = 12
      submenu.style.visibility = "hidden"
      submenu.style.position = "fixed"
      submenu.style.left = "0px"
      submenu.style.top = "0px"
      submenu.style.zIndex = String(90 + depth * 2)

      const bounds = submenu.getBoundingClientRect()
      const anchor = toggle.getBoundingClientRect()
      const nested = depth > 0

      let left = nested ? anchor.right - 6 : anchor.left
      if (left + bounds.width > window.innerWidth - padding) {
        left = nested ? anchor.left - bounds.width + 6 : window.innerWidth - bounds.width - padding
      }
      if (left < padding) {
        left = padding
      }

      let top = nested ? anchor.top : anchor.bottom + 6
      if (top + bounds.height > window.innerHeight - padding) {
        top = Math.max(window.innerHeight - bounds.height - padding, padding)
      }
      if (top < padding) {
        top = padding
      }

      submenu.style.left = `${Math.round(left)}px`
      submenu.style.top = `${Math.round(top)}px`
      submenu.style.visibility = ""
    }

    const closeNestedMenu = (menu) => {
      if (!menu) {
        return
      }
      const submenu = getSubmenu(menu)
      if (!submenu) {
        return
      }

      const descendants = Array.from(submenu.querySelectorAll(".nested-menu.is-open"))
      descendants.forEach((child) => closeNestedMenu(child))

      if (!submenu.classList.contains("hidden")) {
        submenu.classList.add("hidden")
      }
      resetSubmenuPosition(submenu)
      menu.classList.remove("is-open")
      setDropdownState(getToggle(menu), false)
    }

    const closeNestedSiblings = (menu) => {
      if (!menu || !menu.parentElement) {
        return
      }
      Array.from(menu.parentElement.children).forEach((sibling) => {
        if (sibling !== menu && sibling.classList && sibling.classList.contains("nested-menu")) {
          closeNestedMenu(sibling)
        }
      })
    }

    const closeAllNestedMenus = (exception) => {
      const skip = exception ? exception.closest ? exception.closest(nestedMenuSelector) : exception : null
      document.querySelectorAll(`${nestedMenuSelector}.is-open`).forEach((menu) => {
        if (skip && (menu === skip || menu.contains(skip))) {
          return
        }
        closeNestedMenu(menu)
      })
    }

    const openNestedMenu = (menu, toggle) => {
      if (!menu) {
        return
      }
      const submenu = getSubmenu(menu)
      if (!submenu) {
        return
      }
      closeNestedSiblings(menu)
      submenu.classList.remove("hidden")
      positionSubmenu(submenu, toggle)
      submenu.scrollTop = 0
      menu.classList.add("is-open")
      setDropdownState(toggle, true)
      updateNestedMenuPositions()
    }

    const toggleNestedMenu = (toggle) => {
      if (!toggle) {
        return
      }
      const menu = toggle.closest(nestedMenuSelector)
      if (!menu) {
        return
      }
      const submenu = getSubmenu(menu)
      if (!submenu) {
        return
      }
      const shouldOpen = submenu.classList.contains("hidden")
      if (shouldOpen) {
        closeAllNestedMenus(menu)
        openNestedMenu(menu, toggle)
      } else {
        closeNestedMenu(menu)
      }
    }

    const updateNestedMenuPositions = () => {
      document.querySelectorAll(`${nestedMenuSelector}.is-open`).forEach((menu) => {
        const submenu = getSubmenu(menu)
        const toggle = getToggle(menu)
        if (submenu && toggle && !submenu.classList.contains("hidden")) {
          positionSubmenu(submenu, toggle)
        }
      })
    }
    const closeStatusDropdowns = (except) => {
      const exceptMenu = typeof except === "string" ? document.querySelector(except) : except
      document.querySelectorAll("#fs-status .fs-dropdown-menu").forEach((menu) => {
        if (exceptMenu && menu === exceptMenu) {
          return
        }
        if (!menu.classList.contains("hidden")) {
          menu.classList.add("hidden")
          setDropdownState(menu.previousElementSibling, false)
        }
      })
    }
    const handleMenuClick = async (e) => {
      let target

      // 0. handle dropdowns
      target = e.target.classList.contains("revealer") ? e.target : e.target.closest(".revealer")

      if (target) {
        if (target.classList.contains('fs-status-btn--disabled') || target.disabled) {
          e.preventDefault()
          e.stopPropagation()
          return
        }
        if (target.id === 'fs-changes-btn' || target.id === 'fs-push-btn' || target.id === 'fs-fork-btn') {
          check_git(true)
        }
        e.preventDefault()
        e.stopPropagation()
        const group = target.getAttribute("data-group")
        if (!group) {
          closeStatusDropdowns()
          return
        }
        const menu = document.querySelector(group)
        if (!menu) {
          closeStatusDropdowns()
          return
        }
        closeStatusDropdowns(menu)
        const isHidden = menu.classList.toggle("hidden")
        setDropdownState(target, !isHidden)
        return
      }

      if (e.target.closest(".frame-link")) {
        hideTabLinkPopover({ immediate: true })
      }

      // 1. handle delete
      if (e.target.classList.contains("del")) {
        target = e.target
      } else {
        target = e.target.closest(".del")
      }

      if (target) {
        e.preventDefault()
        e.stopPropagation()
        hideTabLinkPopover({ immediate: true })
        // Delete
        // delete link
        let el = target.closest(".frame-link")
        console.log("target", el.target)
        let iframe = document.querySelector("iframe[name='" + el.target + "']")
        console.log("iframe", iframe)
        if (iframe) {
          // delete iframe
          iframe.remove()
        }
        el.remove()
        // update tabs
        await syncTabs()
        return
      }


      // 2. handle shutdown
      if (e.target.classList.contains("shutdown")) {
        target = e.target
      } else {
        target = e.target.closest(".shutdown")
      }
      if (target) {
        e.preventDefault()
        e.stopPropagation()
        let shell = target.closest("[data-shell]")
        if (shell) {
          let shell_id = shell.getAttribute("data-shell")
          n.Noty({
            text: `stopping shell`,
            silent: true,
            timeout: 2000
          })
          let socket = new Socket()
          socket.run({
            method: "kernel.bin.shell_kill",
            params: {
              id: shell_id
            }
          }, (packet) => {
            console.log("packet", packet)
            if (packet.type === "result") {
              socket.close()
              n.Noty({
                timeout: 2000,
                text: `stopped`,
                silent: true
              })
              console.log("Refresh 4")
              refresh(true)
            }
          })
        } else {
          let script = target.closest("[data-script]")
          if (script) {
            let script_id = script.getAttribute("data-script")
            try {
              target.querySelector("i").className = "fa-solid fa-check"
            } catch (e) {
            }
            n.Noty({
              text: `stopping script`,
              silent: true,
              timeout: 2000
            })

            let socket = new Socket()
            socket.run({
              method: "kernel.api.stop",
              params: {
                id: script_id
              }
            }, (packet) => {
              if (packet.type === "result") {
                console.log("is result")
                socket.close()
                n.Noty({
                  timeout: 2000,
                  text: `stopped`,
                  silent: true
                })
                console.log("Refresh 4")
                refresh(true)
              }
            })
          } else {
            let link = target.closest("[href]")
            if (link) {
              let src = new URL(link.href).pathname
              try {
                target.querySelector("i").className = "fa-solid fa-check"
              } catch (e) {
              }
              n.Noty({
                text: `stopping ${src}`,
                silent: true,
                timeout: 2000
              })
              console.log("src", src)

              let socket = new Socket()
              socket.run({
                method: "kernel.api.stop",
                params: {
                  uri: "~" + src
                }
              }, (packet) => {
                if (packet.type === "result") {
                  socket.close()
                  n.Noty({
                    timeout: 2000,
                    text: `stopped`,
                    silent: true
                  })
                  console.log("Refresh 4")
                  refresh(true)
                }
              })
            }
          }
        }

        return
      }



      // 3. handle select
      if (e.target.classList.contains("frame-link")) {
        target = e.target
      } else {
        target = e.target.closest(".frame-link")
      }



      if (target) {

        // if data-confirm exists, ask for confirmation
        // if not, then just go forward
        let confirmText = target.getAttribute("data-confirm")
        if (confirmText && confirmText.length > 0) {
          const confirmed = confirm(confirmText)
          if (!confirmed) {
            e.preventDefault()
            e.stopPropagation()
            return
          }
        }

        const dropdownMenu = target.closest(".fs-dropdown-menu")
        if (dropdownMenu) {
          dropdownMenu.classList.add("hidden")
          const dropdownToggle = dropdownMenu.previousElementSibling
          setDropdownState(dropdownToggle, false)
        }

        if (target.classList.contains("reveal")) {
          e.preventDefault()
          e.stopPropagation()
          const fsDropdown = target.closest("#fs-status .fs-status-dropdown")
          if (fsDropdown) {
            const menu = fsDropdown.querySelector(".fs-dropdown-menu")
            if (menu) {
              closeStatusDropdowns(menu)
              const isHidden = menu.classList.toggle("hidden")
              setDropdownState(target, !isHidden)
            }
            return
          }
          const nestedMenu = target.closest(".nested-menu")
          const inDynamicMenu = nestedMenu ? nestedMenu.closest(".dynamic") : null
            <% if (type === 'run') { %>
          if (inDynamicMenu) {
                if (location.pathname.endsWith("/")) {
                  location.pathname = location.pathname + "dev"
                } else {
                  location.pathname = location.pathname + "/dev"
                }
                return
              }
        <% } else { %>
          if (inDynamicMenu) {
              inDynamicMenu.classList.add("selected")
              const submenu = nestedMenu ? nestedMenu.querySelector(".submenu") : null
              if (submenu) {
                const isHidden = submenu.classList.toggle("hidden")
                setDropdownState(target, !isHidden)
              }
              return
            }
        <% } %>

        if (target.closest(".m.menu")) {
            toggleNestedMenu(target)
          } else {
            const submenu = nestedMenu ? nestedMenu.querySelector(".submenu") : null
            if (submenu) {
              const isHidden = submenu.classList.toggle("hidden")
              setDropdownState(target, !isHidden)
            }
          }
          return
        }

        closeAllNestedMenus()

        if (target.getAttribute("data-action")) {
          let actionStr = target.getAttribute("data-action")
          let action = JSON.parse(actionStr)
          if (action.method === "stop" && action.uri) {
            let socket = new Socket()
            socket.run({
              method: "kernel.api.stop",
              params: {
                uri: action.uri//"~" + location.pathname
              }
            }, (packet) => {
              if (packet.type === "result") {
                socket.close()
                //              location.href = location.href
              }
            })
          }
        } else if (target.getAttribute("data-filepath")) {
          return
        } else if (target.target === "_blank") {
          // nothing
        } else {
          document.querySelectorAll(".frame-link").forEach((el) => {
            el.classList.remove("selected")
          })
          target.classList.add("selected")

          renderSelection({ event: e })
        }
      }
    }

    const isTouchLikeEvent = window.PinokioTouch.isTouchLikeEvent
    const handleTouchSelection = (event) => {
      if (!isTouchLikeEvent(event)) {
        return
      }
      const link = event.target?.closest?.(".frame-link") || null
      if (!link) {
        return
      }
      if (link.classList.contains("reveal") || link.hasAttribute("data-action") || link.hasAttribute("data-filepath") || link.hasAttribute("data-confirm")) {
        return
      }
      if (event.target?.closest?.(".del") || event.target?.closest?.(".shutdown")) {
        return
      }
      renderSelection({ explicitTarget: link })
    }
    const navContainers = [document.querySelector("aside"), document.querySelector("#fs-status")]
    navContainers.forEach((container) => {
      if (container) {
        container.addEventListener("click", handleMenuClick)
        window.PinokioTouch.bindPointer(container, handleTouchSelection, {
          pointer: true,
          touch: { passive: true, capture: true }
        })
      }
    })

    const layoutToggleButton = document.getElementById("layout-toggle")
    if (layoutToggleButton) {
      const layoutToggleIcon = layoutToggleButton.querySelector("i.fa-bars")
      const appcanvas = document.querySelector(".appcanvas")
      const sidebarResizer = document.getElementById("appcanvas-resizer")
      const sidebarContainer = document.querySelector(".appcanvas > aside .menu-container")

      if (appcanvas && typeof localStorage !== "undefined") {
        const storedLayout = localStorage.getItem("pinokioLayoutVertical")
        if (storedLayout === "1") {
          appcanvas.classList.add("vertical")
          if (layoutToggleIcon) {
            layoutToggleIcon.classList.add("fa-rotate-90")
          }
        }
      }

      layoutToggleButton.addEventListener("click", () => {
        if (!appcanvas) {
          return
        }
        const isVertical = appcanvas.classList.toggle("vertical")
        if (layoutToggleIcon) {
          if (isVertical) {
            layoutToggleIcon.classList.add("fa-rotate-90")
          } else {
            layoutToggleIcon.classList.remove("fa-rotate-90")
          }
        }
        if (typeof localStorage !== "undefined") {
          localStorage.setItem("pinokioLayoutVertical", isVertical ? "1" : "0")
        }
      })

      if (appcanvas && sidebarResizer && sidebarContainer) {
        const SIDEBAR_MIN_WIDTH = 140
        const SIDEBAR_MAX_WIDTH = 560
        const workspaceName = "<%= typeof name === 'string' ? name : '' %>"
        const sidebarWidthStorageKey = workspaceName
          ? `pinokio-app-sidebar-width:${workspaceName}`
          : "pinokio-app-sidebar-width"

        let sidebarWidth = null
        let isResizing = false
        let pointerId = null
        let resizeState = null
        let handlePointerMove = null
        let handlePointerUp = null

        const clampSidebarWidth = (value) => {
          const numeric = typeof value === "number" ? value : parseInt(value, 10)
          if (Number.isNaN(numeric)) {
            return SIDEBAR_MIN_WIDTH
          }
          return Math.min(Math.max(numeric, SIDEBAR_MIN_WIDTH), SIDEBAR_MAX_WIDTH)
        }

        const readSidebarWidth = () => {
          try {
            const stored = window.localStorage.getItem(sidebarWidthStorageKey)
            if (!stored) {
              return null
            }
            const parsed = parseInt(stored, 10)
            if (Number.isNaN(parsed)) {
              return null
            }
            return parsed
          } catch (_) {
            return null
          }
        }

        const persistSidebarWidth = (width) => {
          try {
            window.localStorage.setItem(sidebarWidthStorageKey, String(width))
          } catch (_) { }
        }

        const applySidebarWidth = (value, persist) => {
          const width = clampSidebarWidth(value)
          sidebarWidth = width
          appcanvas.style.setProperty("--appcanvas-sidebar-width", `${width}px`)
          sidebarResizer.setAttribute("aria-valuenow", String(width))
          if (persist) {
            persistSidebarWidth(width)
          }
        }

        const initSidebarWidth = () => {
          const stored = readSidebarWidth()
          const base = typeof stored === "number"
            ? stored
            : parseInt(getComputedStyle(appcanvas).getPropertyValue("--appcanvas-sidebar-width"), 10) || 150
          applySidebarWidth(base, false)
        }

        const finishResizing = () => {
          if (!isResizing) {
            return
          }
          isResizing = false
          if (pointerId != null && sidebarResizer) {
            try {
              sidebarResizer.releasePointerCapture(pointerId)
            } catch (_) { }
          }
          pointerId = null
          resizeState = null
          window.removeEventListener("pointermove", handlePointerMove)
          window.removeEventListener("pointerup", handlePointerUp)
          if (sidebarWidth != null) {
            persistSidebarWidth(sidebarWidth)
          }
        }

        const bindResizeListeners = () => {
          if (!handlePointerMove) {
            handlePointerMove = (event) => {
              if (!isResizing || !appcanvas.classList.contains("vertical")) {
                return
              }
              if (pointerId != null && event.pointerId !== pointerId) {
                return
              }
              event.preventDefault()
              const state = resizeState || {}
              const baseLeft = typeof state.left === "number"
                ? state.left
                : sidebarContainer.getBoundingClientRect().left
              const offset = typeof state.offset === "number" ? state.offset : 0
              const nextWidth = event.clientX - baseLeft - offset
              applySidebarWidth(nextWidth, false)
            }
          }
          if (!handlePointerUp) {
            handlePointerUp = (event) => {
              if (pointerId != null && event.pointerId !== pointerId) {
                return
              }
              finishResizing()
            }
          }
          window.addEventListener("pointermove", handlePointerMove)
          window.addEventListener("pointerup", handlePointerUp, { once: true })
        }

        sidebarResizer.addEventListener("pointerdown", (event) => {
          if (!appcanvas.classList.contains("vertical")) {
            return
          }
          if (event.button !== 0 && event.pointerType !== "touch") {
            return
          }
          event.preventDefault()
          isResizing = true
          pointerId = event.pointerId
          try {
            sidebarResizer.setPointerCapture(event.pointerId)
          } catch (_) { }
          const rect = sidebarContainer.getBoundingClientRect()
          resizeState = {
            left: rect.left,
            offset: event.clientX - (rect.left + rect.width)
          }
          bindResizeListeners()
        })

        initSidebarWidth()
      }
    }
    setupTabLinkHover()
    document.addEventListener("click", (event) => {
      if (event.target.closest("#fs-status .fs-dropdown-menu") || event.target.closest("#fs-status .fs-status-btn")) {
        return
      }
      closeStatusDropdowns()
      if (!event.target.closest(nestedMenuSelector)) {
        closeAllNestedMenus()
      }
    })

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeStatusDropdowns()
        closeAllNestedMenus()
      }
    })

    window.addEventListener("resize", () => {
      updateNestedMenuPositions()
    })

    const nestedMenuScrollContainers = [
      document.querySelector(".container"),
      document.querySelector(".container .content"),
      document.querySelector("main"),
      document.querySelector(".appcanvas > aside .menu-container")
    ].filter(Boolean)

    nestedMenuScrollContainers.forEach((node) => {
      node.addEventListener("scroll", () => {
        updateNestedMenuPositions()
      }, { passive: true })
    })

    window.addEventListener("scroll", () => {
      updateNestedMenuPositions()
    }, { passive: true })
    const refresh_du = (path) => {
      let url = path ? `/du/<%=name%>/${path}` : `/du/<%=name%>`
      let selector = `.disk-usage[data-path='/${path || ""}']`
      let el = document.querySelector(selector)
      if (el) {
        fetch(url).then((res) => {
          return res.json()
        }).then((res) => {
          if (res.du > 0) {
            let val
            //let k = 1024
            let k = 1000
            if (res.du > k * k * k) {
              // GB
              val = `${Math.floor(res.du / k / k / k * 100) / 100} GB`
            } else if (res.du > k * k) {
              // MB
              val = `${Math.floor(res.du / k / k * 100) / 100} MB`
            } else {
              // KB
              val = `${Math.floor(res.du / k * 100) / 100} KB`
            }
            el.innerHTML = `<i class="fa-solid fa-database"></i> ${val}`
          } else {
          }
        })
      }
    }

    let dynamic_loaded = false

    const try_dynamic = async () => {
      let rendered
      let status
      const dynamicUrl = window.__pinokioDynamicUrl || "<%-dynamic%>"
      const dynamic = await fetch(dynamicUrl).then((res) => {
        status = res.status
        return res.text()
      })
      if (status == 500) {
        ModalInput({
          description: dynamic,
          confirm: "OK",
          customClass: {
            popup: "full-popup",
            title: "full-title"
          }
        })
        return
      }
      if (dynamic && dynamic.length > 0) {
        const submenu = document.querySelector(".dynamic .submenu")
        if (submenu) {
          rerenderMenuSection(submenu, dynamic)
          restoreAllTabStates()
        }
        let default_selection = document.querySelector(".dynamic .submenu [data-default]")
        if (default_selection) {
          default_selection.click()
        }
        rendered = true
      } else {
        rendered = false
      }
      if (rendered) {
        //      if (dynamic_loaded) {
        //        // already loaded, don't touch the UI
        //      } else {
        //        // first time being loaded
        //        dynamic_loaded = true
        //        if (document.querySelector(".dynamic .reveal")) {
        //          console.log("click")
        //
        ////          document.querySelector(".dynamic .reveal").click()
        //        }
        //      }
      } else {
        setTimeout(() => {
          try_dynamic()
        }, 1000)
      }
    }
    const refresh = async (silent, options) => {

      if (options && options.nodelay) {
      } else {
        await new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve()
          }, 1000)
        })
      }
    <% if (type === 'run') { %>
        let status
        const html = await fetch("<%=sidebar%>").then((res) => {
          status = res.status
          return res.text()
        })
        if (status == 500) {
          ModalInput({
            description: html,
            confirm: "OK",
            customClass: {
              popup: "full-popup",
              title: "full-title"
            }
          })
          return
        }
        const menuContainer = document.querySelector(".menu")
        rerenderMenuSection(menuContainer, html)
        restoreAllTabStates()
          <% } else { %>
            try_dynamic()
            /*
            const repos = await fetch("<%=repos%>").then((res) => {
              return res.text()
            })
            if (document.querySelector("#git-repos")) {
              document.querySelector("#git-repos").innerHTML = repos
            }
            */
            <% } %>


    // render the selected frame only if not silent
    if (!silent) {
        renderSelection()
      }
    }
    let init = document.querySelector("[data-init]")
    if (init) {
      init.click()
    }
    window.addEventListener('message', (event) => {
      // only process the event it's coming from pinokio
      let origin = event.origin
      if (origin) {
        let port = new URL(origin).port || 80
        if (String(port) === String(location.port) || /https:\/\/.*pinokio\..*(localhost|co)/.test(origin)) {
          //if (String(port) === "<%=port%>" || /https:\/\/pinokio\..*localhost/.test(origin)) {
          //if (String(port) === "<%=port%>") {
          if (event.data) {
            if (event.data.action) {
              if (event.data.action.type === "newtab") {
                addTab(event.data.action.url)
              } else if (event.data.action.type === "title") {
              } else if (event.data.action.type === "location") {
                let url = event.data.action.url
                //document.querySelector("#location").value = url
                let pathname = new URL(url).pathname
                if (pathname.startsWith("/run")) {
                  document.querySelector("#location").value = pathname.slice(4)
                } else {
                  document.querySelector("#location").value = pathname
                }
              }
            } else if (event.data.launch) {
              const rawName = event.data.launch.name
              const escapedSelector = escapeTargetSelector(rawName)
              if (escapedSelector) {
                global_selector = `.frame-link[target="${escapedSelector}"]`
              } else {
                global_selector = null
              }
              const frameExists = Array.from(document.querySelectorAll("main.browserview iframe")).some((frame) => {
                return frame.name === rawName
              })
              if (!frameExists) {
                create_iframe(rawName, event.data.launch.href)
              }
              refresh()
            } else if (event.data.type === "shell-session-id") {
              const frameName = resolveFrameName(event.data.frame, event.source)
              if (frameName && event.data.shellId) {
                const link = getTabLink(frameName)
                if (link) {
                  link.setAttribute("data-shell", event.data.shellId)
                  link.dataset.shell = event.data.shellId
                }
              }
              return
            } else if (event.data.type === "terminal-input") {
              const frameName = resolveFrameName(event.data.frame, event.source)
              const hasContent = typeof event.data.hasContent === "boolean" ? event.data.hasContent : Boolean(event.data.line && event.data.line.length > 0)
              updateTabPreview(frameName, event.data.line || "", hasContent, Date.now())
              return
            } else if (event.data.type) {
              if (event.data.type === 'stream') {
                const frameName = resolveFrameName(null, event.source)
                updateTabTimestamp(frameName, Date.now())
              } else if (event.data.type === 'result') {
                refresh()
                refresh_du()
                refresh_du("logs")
              } else {
              <% if (type === 'run') { %>
              if (event.data.type === 'start' || event.data.type === "disconnect" || (event.data.type === 'event' && event.data.data === 'stop')) {
                    ignorePersistedSelection = true
                  }
              <% } %>
                  refresh()
              }
            }
          } else {
            refresh()
          }
        }
      }


    });
    refresh_du()
    refresh_du("logs")
    renderSelection({ force: true })
      <% if (type === "browse" || type === "files") { %>
    const repoStatusCache = new Map()
        let lastRepoList = []
        let currentChanges = []
        let gitCommitUrl = null
        let activeRepoKey = null
        let gitStatusRequest = null
        let gitStatusRequestForce = false

        const fsStatusEl = document.querySelector('#fs-status')
        const changesDropdownContainer = document.querySelector('#fs-status .git-changes')
        const changesMenu = document.getElementById('fs-changes-menu')
        const changesBtn = document.getElementById('fs-changes-btn')
        const badgeElement = changesBtn ? changesBtn.querySelector('.badge') : null
        const forkBtn = document.getElementById('fs-fork-btn')
        const forkDropdownContainer = document.querySelector('#fs-status .git-fork')
        const forkMenu = document.getElementById('fs-fork-menu')
        const pushBtn = document.getElementById('fs-push-btn')
        const publishMenu = document.getElementById('fs-push-menu')

        let latestGitIntegration = null

        const readDataAttr = (node, attr) => {
          if (!node) {
            return null
          }
          const value = node.getAttribute(attr)
          if (!value || value === 'null' || value === 'undefined') {
            return null
          }
          return value
        }

        const statusUri = readDataAttr(fsStatusEl, 'data-status-uri')
        const monitorUri = readDataAttr(fsStatusEl, 'data-uri')
        const workspaceName = readDataAttr(fsStatusEl, 'data-workspace')
        const historyUri = readDataAttr(fsStatusEl, 'data-history-uri')
        const defaultPushUri = readDataAttr(fsStatusEl, 'data-push-uri')
        const defaultForkUri = readDataAttr(fsStatusEl, 'data-fork-uri')
        const buildStatusUrl = (forceRefresh = false) => {
          if (!statusUri) {
            return null
          }
          if (!forceRefresh) {
            return statusUri
          }
          return statusUri.includes('?') ? `${statusUri}&force=1` : `${statusUri}?force=1`
        }

        const buildWorkspaceLogsUrl = () => {
          if (workspaceName && workspaceName.length > 0) {
            return `/logs?workspace=${encodeURIComponent(workspaceName)}`
          }
          return '/logs'
        }

        const focusOrCreateLogsTab = async () => {
          const relativeUrl = buildWorkspaceLogsUrl()
          const absoluteUrl = new URL(relativeUrl, window.location.origin).toString()
          const existingLink = Array.from(document.querySelectorAll('.temp-menu .frame-link')).find((link) => {
            return link.href === absoluteUrl
          })
          if (existingLink) {
            const display = existingLink.querySelector('.display')
            if (display) {
              display.textContent = 'Logs'
            }
            existingLink.click()
            return
          }
          const { tab } = await addTab(relativeUrl, { label: 'Logs' })
          requestAnimationFrame(() => {
            tab.click()
          })
        }

        document.querySelectorAll('#fs-status .fs-logs .fs-status-btn').forEach((button) => {
          button.addEventListener('click', async (event) => {
            event.preventDefault()
            event.stopPropagation()
            await focusOrCreateLogsTab()
          })
        })

        const encodeRepoPath = (value) => {
          if (typeof value !== 'string' || value.length === 0) {
            return ''
          }
          return value.split('/').map(encodeURIComponent).join('/')
        }

        const buildHistoryUrl = (param) => {
          if (!param) {
            return null
          }
          return `/info/git/HEAD/${encodeRepoPath(param)}`
        }

        const resolveHistoryUrl = (repoParam, repoData, explicitUrl = null) => {
          let url = explicitUrl || (repoData && repoData.git_history_url) || historyUri || null
          if (!url && repoParam) {
            url = buildHistoryUrl(repoParam)
          } else if (repoParam && typeof url === 'string' && url.startsWith('/info/git/HEAD/')) {
            url = buildHistoryUrl(repoParam)
          }
          return url
        }

        function escapeHtml(value) {
          if (value === null || value === undefined) {
            return ''
          }
          return String(value).replace(/[&<>"']/g, (match) => {
            switch (match) {
              case '&':
                return '&amp;'
              case '<':
                return '&lt;'
              case '>':
                return '&gt;'
              case '"':
                return '&quot;'
              case '\'':
                return '&#39;'
              default:
                return match
            }
          })
        }

        const isUntrackedStatus = (status) => {
          const s = (status || '').toLowerCase()
          return s.includes('new') || s.includes('add') || s.includes('untracked')
        }

        const escapePathForShell = (value) => {
          if (typeof value !== 'string') return ''
          // Escape quotes and dollars/backticks to reduce shell injection risk
          const escaped = value.replace(/(["`$\\])/g, '\\$1')
          return `"${escaped}"`
        }

        const buildPathArgs = (paths) => {
          if (!Array.isArray(paths) || paths.length === 0) {
            return ''
          }
          return paths
            .filter(Boolean)
            .map((p) => escapePathForShell(String(p)))
            .join(' ')
        }



        function parseRemoteSlug(remoteUrl) {
          if (!remoteUrl || typeof remoteUrl !== 'string') {
            return { owner: null, name: null, full: null }
          }
          const trimmed = remoteUrl.trim()
          if (!trimmed) {
            return { owner: null, name: null, full: null }
          }
          const withoutGit = trimmed.replace(/\.git$/i, '')

          const parsePathSegments = (pathValue) => {
            if (!pathValue) {
              return []
            }
            const cleaned = pathValue.replace(/^\/+/, '')
            return cleaned.split('/').filter(Boolean)
          }

          let pathSegment = ''
          if (withoutGit.startsWith('git@')) {
            const colonSplit = withoutGit.split(':')
            pathSegment = colonSplit.length > 1 ? colonSplit.slice(1).join(':') : ''
          } else {
            try {
              const prefixed = withoutGit.includes('://') ? withoutGit : `https://${withoutGit}`
              const url = new URL(prefixed)
              pathSegment = url.pathname
            } catch (error) {
              pathSegment = withoutGit
            }
          }

          const segments = parsePathSegments(pathSegment)
          if (segments.length >= 2) {
            const owner = segments[segments.length - 2]
            const name = segments[segments.length - 1]
            return { owner, name, full: `${owner}/${name}` }
          }

          if (segments.length === 1) {
            const name = segments[0]
            return { owner: null, name, full: name }
          }

          return { owner: null, name: null, full: null }
        }

        function buildRemoteWebUrl(remoteUrl) {
          if (!remoteUrl || typeof remoteUrl !== 'string') {
            return null
          }
          const trimmed = remoteUrl.trim()
          if (!trimmed) {
            return null
          }
          if (/^https?:\/\//i.test(trimmed)) {
            return trimmed
          }
          const slug = parseRemoteSlug(trimmed)
          if (slug && slug.full) {
            return `https://github.com/${slug.full}`
          }
          if (trimmed.startsWith('git@')) {
            const sshSlug = parseRemoteSlug(trimmed.replace(/^git@/, '').replace(/:/, '/'))
            if (sshSlug && sshSlug.full) {
              return `https://github.com/${sshSlug.full}`
            }
          }
          return trimmed
        }

        function deriveForkDefaultName(repo) {
          if (!repo) {
            return workspaceName || 'fork'
          }
          const remoteSlug = parseRemoteSlug(repo.url || '')
          if (remoteSlug && remoteSlug.name) {
            return remoteSlug.name
          }
          if (typeof repo.name === 'string' && repo.name.length > 0) {
            const segments = repo.name.split('/').filter(Boolean)
            if (segments.length > 0) {
              return segments[segments.length - 1]
            }
          }
          if (typeof repo.repoParam === 'string' && repo.repoParam.length > 0) {
            const repoSegments = repo.repoParam.split('/').filter(Boolean)
            if (repoSegments.length > 0) {
              return repoSegments[repoSegments.length - 1]
            }
          }
          return workspaceName || 'fork'
        }

        function hasRemoteConfigured(repo) {
          return Boolean(repo && typeof repo.url === 'string' && repo.url.trim().length > 0)
        }

        function resolveForkUri(repo) {
          if (repo && typeof repo.git_fork_url === 'string' && repo.git_fork_url.length > 0) {
            return repo.git_fork_url
          }
          return defaultForkUri || null
        }

        function resolvePushUri(repo) {
          if (repo && typeof repo.git_push_url === 'string' && repo.git_push_url.length > 0) {
            return repo.git_push_url
          }
          return defaultPushUri || null
        }

        function updateForkButton() {
          if (!forkBtn) {
            return
          }
          const labelEl = forkBtn.querySelector('.fs-status-title')
          const repos = Array.isArray(lastRepoList) && lastRepoList.length > 0 ? lastRepoList.slice() : Array.from(repoStatusCache.values())
          const forkTargets = Array.isArray(repos)
            ? repos.filter((repo) => hasRemoteConfigured(repo) && resolveForkUri(repo))
            : []

          const detachHandlers = () => {
            forkBtn.removeEventListener('click', handlePushLogin)
            forkBtn.removeEventListener('click', requireGitLogin)
          }

          const enableDropdown = () => {
            forkBtn.classList.add('revealer')
            forkBtn.setAttribute('data-group', '#fs-fork-menu')
          }

          const disableDropdown = () => {
            forkBtn.classList.remove('revealer')
            forkBtn.removeAttribute('data-group')
            const forkMenuEl = document.querySelector('#fs-fork-menu')
            if (forkMenuEl && !forkMenuEl.classList.contains('hidden')) {
              forkMenuEl.classList.add('hidden')
            }
            setDropdownState(forkBtn, false)
          }

          detachHandlers()

          const isConnected = Boolean(latestGitIntegration && latestGitIntegration.connected)

          renderForkDropdown(repos, {
            emptyMessage: isConnected
              ? 'No remotes available to fork'
              : 'Connect GitHub to enable forking',
          })

          if (!isConnected) {
            disableDropdown()
            if (labelEl) {
              labelEl.textContent = 'Fork'
            }
            forkBtn.disabled = false
            forkBtn.classList.remove('fs-status-btn--disabled')
            forkBtn.setAttribute('title', 'Log in to GitHub to fork this workspace')
            forkBtn.addEventListener('click', requireGitLogin)
            return
          }

          if (labelEl) {
            labelEl.textContent = 'Fork'
          }

          forkBtn.disabled = false
          forkBtn.classList.remove('fs-status-btn--disabled')
          enableDropdown()

          if (!Array.isArray(repos) || repos.length === 0) {
            forkBtn.setAttribute('title', 'No Git repositories detected')
            return
          }

          if (forkTargets.length === 0) {
            forkBtn.setAttribute('title', 'No remotes available to fork')
            return
          }

          forkBtn.removeAttribute('title')
        }

        const updateCombinedBadge = (total) => {
          if (!badgeElement) {
            return
          }
          badgeElement.textContent = total > 0 ? String(total) : ''
        }

        const updateChangesButtonState = (hasRepos) => {
          if (!changesBtn) {
            return
          }
          if (hasRepos) {
            changesBtn.disabled = false
            changesBtn.classList.remove('fs-status-btn--disabled')
          } else {
            changesBtn.disabled = true
            changesBtn.classList.add('fs-status-btn--disabled')
          }
        }

        const setChangesMenuMessage = (message) => {
          if (!changesMenu) {
            return
          }
          const messageEl = document.createElement('div')
          messageEl.className = 'fs-dropdown-empty'
          messageEl.textContent = message
          changesMenu.innerHTML = ''
          changesMenu.append(messageEl)
        }

        const setForkMenuMessage = (message) => {
          if (!forkMenu) {
            return
          }
          const messageEl = document.createElement('div')
          messageEl.className = 'fs-dropdown-empty'
          messageEl.textContent = message
          forkMenu.innerHTML = ''
          forkMenu.append(messageEl)
        }

        const setPublishMenuMessage = (message) => {
          if (!publishMenu) {
            return
          }
          const messageEl = document.createElement('div')
          messageEl.className = 'fs-dropdown-empty'
          messageEl.textContent = message
          publishMenu.innerHTML = ''
          publishMenu.append(messageEl)
        }

        const reloadOnModalClose = (promise, predicate) => {
          if (!promise || typeof promise.then !== 'function') {
            return promise
          }
          promise.then((result) => {
            let shouldReload = true
            if (typeof predicate === 'function') {
              shouldReload = predicate(result)
            }
            if (shouldReload) {
              setTimeout(() => window.location.reload(), 350)
            }
          })
          return promise
        }

        const renderForkDropdown = (repos, options = {}) => {
          if (!forkMenu) {
            return
          }

          const opts = typeof options === 'object' && options !== null ? options : {}
          const list = Array.isArray(repos) ? repos : []

          forkMenu.innerHTML = ''

          if (list.length === 0) {
            setForkMenuMessage(opts.emptyMessage || 'No repositories available')
            return
          }

          const fragment = document.createDocumentFragment()

          list.forEach((repo) => {
            const key = repo && typeof repo.repoParam === 'string' ? repo.repoParam : ''
            const name = repo && repo.name ? repo.name : (key || 'Repository')
            const remoteUrl = repo && repo.url ? repo.url : ''
            const forkUri = resolveForkUri(repo)
            const hasRemote = hasRemoteConfigured(repo)

            const item = document.createElement('button')
            item.type = 'button'
            item.className = 'fs-dropdown-item pinokio-fork-dropdown-item'
            item.dataset.repo = key

            const remoteClass = remoteUrl
              ? 'pinokio-fork-dropdown-remote'
              : 'pinokio-fork-dropdown-remote empty'
            const remoteDisplay = remoteUrl ? escapeHtml(remoteUrl) : 'No remote detected'

            item.innerHTML = `
          <div class="pinokio-fork-dropdown-title">${escapeHtml(name)}</div>
          <div class="${remoteClass}">${remoteDisplay}</div>
        `

            if (!hasRemote || !forkUri) {
              item.disabled = true
              item.classList.add('fs-dropdown-item--disabled')
            } else {
              item.addEventListener('click', (event) => {
                event.preventDefault()
                event.stopPropagation()
                closeStatusDropdowns()
                showForkModalForRepo(key)
              })
            }

            fragment.appendChild(item)
          })

          forkMenu.appendChild(fragment)
        }

        const fetchPublishPreflightState = async (repoParam) => {
          if (!repoParam) {
            return { ok: false, reason: 'missing-repo' }
          }
          const encodedParam = encodeRepoPath(repoParam)
          const infoUrl = `/info/git/HEAD/${encodedParam}`
          try {
            const response = await fetch(infoUrl, { cache: 'no-store' })
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`)
            }
            const payload = await response.json()
            const repoExists = typeof payload.gitDirExists === 'boolean' ? payload.gitDirExists : true
            const hasHead = typeof payload.hasHead === 'boolean'
              ? payload.hasHead
              : (Array.isArray(payload.log) && payload.log.length > 0)
            let reason = null
            if (!repoExists) {
              reason = 'missing-git'
            } else if (!hasHead) {
              reason = 'missing-commit'
            }
            return {
              ok: !reason,
              reason,
              repoExists,
              hasHead,
              payload,
            }
          } catch (error) {
            console.error('publish preflight error:', error)
            return { ok: false, reason: 'network', error }
          }
        }

        async function getRepoData(repoParam) {
          if (!repoParam) {
            return null
          }
          let repoData = repoStatusCache.get(repoParam) || null
          if (!repoData && typeof check_git === 'function') {
            await check_git(true)
            repoData = repoStatusCache.get(repoParam) || null
          }
          return repoData
        }

        async function refreshRepoData(repoParam) {
          if (!repoParam) {
            return null
          }
          if (typeof check_git === 'function') {
            await check_git(true)
          }
          return repoStatusCache.get(repoParam) || null
        }

        const getRepoChangeCount = (repo) => {
          if (!repo) {
            return 0
          }
          if (typeof repo.changeCount === 'number') {
            return repo.changeCount
          }
          if (Array.isArray(repo.changes)) {
            return repo.changes.length
          }
          return 0
        }

        async function ensureRemoteForPublish({ repoParam, repoName }) {
          const label = repoName || repoParam || 'Repository'
          let repoCandidate = await getRepoData(repoParam)
          if (!hasRemoteConfigured(repoCandidate)) {
            repoCandidate = await refreshRepoData(repoParam)
          }
          if (hasRemoteConfigured(repoCandidate)) {
            return { remoteReady: true, shouldOpenPublish: true }
          }

          const creationResult = await showCreateModal({ skipReload: true, repoParam, repoName })
          const action = creationResult && creationResult.action ? creationResult.action : null
          if (!creationResult || creationResult.completed === false || action === 'cancel') {
            return { remoteReady: false, shouldOpenPublish: false }
          }

          if (typeof check_git === 'function') {
            await check_git(true)
          }
          const refreshedRepo = await getRepoData(repoParam)
          if (hasRemoteConfigured(refreshedRepo)) {
            return { remoteReady: true, shouldOpenPublish: true }
          }

          Swal.fire({
            icon: 'info',
            title: `${escapeHtml(label)} still needs a Git remote`,
            text: 'Add a remote (for example, origin) and try publishing again.'
          })
          return { remoteReady: false, shouldOpenPublish: false }
        }

        const buildPublishPreflightCopy = (repoName, reason) => {
          const name = repoName && repoName.trim().length > 0 ? repoName.trim() : 'Repository'
          if (reason === 'missing-git') {
            return {
              title: `${name} isn't a Git repository yet`,
              message: 'Initialize git in this folder and save a version before publishing.',
              actionLabel: 'Review files'
            }
          }
          if (reason === 'missing-commit') {
            return {
              title: `Create your first commit for ${name}`,
              message: 'Save a version on the main branch before publishing to GitHub.',
              actionLabel: 'Review files'
            }
          }
          return {
            title: 'Unable to publish',
            message: 'Resolve the repository issues before retrying.',
            actionLabel: 'Review files'
          }
        }

        const promptCommitBeforePublish = async ({ repoParam, repoName }) => {
          const repoData = await getRepoData(repoParam)
          const changeCount = getRepoChangeCount(repoData)
          if (changeCount <= 0) {
            return { proceed: true, action: 'skip', changeCount }
          }

          const displayName = repoName || (repoData && repoData.name) || repoParam || 'Repository'
          const safeName = escapeHtml(displayName)
          const result = await Swal.fire({
            html: `
          <div class="pinokio-modal-surface">
            <div class="pinokio-modal-header">
              <div class="pinokio-modal-icon"><i class="fa-solid fa-code-commit"></i></div>
              <div class="pinokio-modal-heading">
                <div class="pinokio-modal-title">Commit changes before publishing?</div>
                <div class="pinokio-modal-subtitle">${safeName} has ${changeCount} uncommitted change${changeCount === 1 ? '' : 's'}.</div>
              </div>
            </div>
          </div>
        `,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              confirmButton: 'pinokio-modern-confirm',
              cancelButton: 'pinokio-modern-cancel',
              closeButton: 'pinokio-modern-close'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(520px, 92vw)',
            showCloseButton: true,
            showCancelButton: true,
            showConfirmButton: true,
            buttonsStyling: false,
            allowOutsideClick: false,
            allowEscapeKey: false,
            reverseButtons: true,
            confirmButtonText: 'Review & Commit',
            cancelButtonText: 'Continue without committing',
            focusConfirm: false
          })

          if (result.isConfirmed) {
            try {
              await showGitDiffModal({ repoParam, repoName: displayName, forceRefresh: true })
            } catch (error) {
              console.error('Failed to open commit modal before publish:', error)
            }
            if (typeof check_git === 'function') {
              await check_git(true)
            }
            return { proceed: true, action: 'commit', changeCount }
          }
          if (result.dismiss === Swal.DismissReason.cancel) {
            return { proceed: true, action: 'skip', changeCount }
          }
          return { proceed: false, action: 'dismiss', changeCount }
        }

        const showPublishPreflightModal = ({ title, message, actionLabel, onAction }) => {
          const safeTitle = escapeHtml(title || 'Repository is not ready to publish')
          const safeMessage = escapeHtml(message || 'Resolve the issue and try again.')
          const safeLabel = escapeHtml(actionLabel || 'Review files')
          const html = `
        <div class="pinokio-modal-surface">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon pinokio-modal-icon--warning"><i class="fa-solid fa-circle-exclamation"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">${safeTitle}</div>
              <div class="pinokio-modal-subtitle">${safeMessage}</div>
            </div>
          </div>
        </div>
      `

          Swal.fire({
            html,
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(440px, 92vw)',
            showConfirmButton: true,
            showCancelButton: false,
            showCloseButton: true,
            buttonsStyling: false,
            focusConfirm: true,
            confirmButtonText: safeLabel,
            customClass: {
              popup: 'pinokio-modern-modal pinokio-publish-preflight-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close',
              confirmButton: 'pinokio-modern-confirm'
            }
          })
            .then(async (result) => {
              if (result.isConfirmed && typeof onAction === 'function') {
                try {
                  await onAction()
                } catch (error) {
                  console.error('preflight action failed:', error)
                }
              }
            })
        }

        const handlePreflightFailure = ({ preflight, repoParam, repoName }) => {
          if (!preflight) {
            return
          }
          if (preflight.reason === 'network') {
            Swal.fire({
              icon: 'error',
              title: 'Unable to check repository state',
              text: 'Please try again in a moment.'
            })
            return
          }
          const copy = buildPublishPreflightCopy(repoName, preflight.reason)
          showPublishPreflightModal({
            title: copy.title,
            message: copy.message,
            actionLabel: copy.actionLabel,
            onAction: () => launchPublishPreflightDiffFlow({ repoParam, repoName })
          })
        }

        const runPublishFlow = async ({ repoParam, repoName }) => {
          if (typeof check_git === 'function') {
            try {
              await check_git(true)
            } catch (_) { }
          }
          let preflight = await fetchPublishPreflightState(repoParam)
          if (!preflight.ok) {
            handlePreflightFailure({ preflight, repoParam, repoName })
            return
          }

          const commitDecision = await promptCommitBeforePublish({ repoParam, repoName })
          if (!commitDecision || commitDecision.proceed !== true) {
            return
          }

          if (commitDecision.action === 'commit') {
            preflight = await fetchPublishPreflightState(repoParam)
            if (!preflight.ok) {
              handlePreflightFailure({ preflight, repoParam, repoName })
              return
            }
          }

          const remoteOutcome = await ensureRemoteForPublish({ repoParam, repoName })
          const remoteReady = typeof remoteOutcome === 'object'
            ? remoteOutcome.remoteReady
            : Boolean(remoteOutcome)
          const shouldOpenPublish = typeof remoteOutcome === 'object'
            ? remoteOutcome.shouldOpenPublish !== false
            : remoteReady
          if (remoteReady && shouldOpenPublish) {
            showPublishModal({ repoParam, repoName })
          }
        }

        const launchPublishPreflightDiffFlow = async ({ repoParam, repoName }) => {
          try {
            await showGitDiffModal({ repoParam, repoName, forceRefresh: true })
          } catch (error) {
            console.error('Failed to open diff modal for publish preflight:', error)
            return
          }
          try {
            const retryState = await fetchPublishPreflightState(repoParam)
            if (retryState.ok) {
              closeStatusDropdowns()
              await runPublishFlow({ repoParam, repoName })
            }
          } catch (error) {
            console.error('Failed to retry publish after diff:', error)
          }
        }

        const handlePublishDropdownClick = async ({ repoParam, repoName }) => {
          closeStatusDropdowns()
          await runPublishFlow({ repoParam, repoName })
        }

        const renderPublishDropdown = (repos, options = {}) => {
          if (!publishMenu) {
            return
          }

          const opts = typeof options === 'object' && options !== null ? options : {}
          const list = Array.isArray(repos) ? repos : []

          publishMenu.innerHTML = ''

          if (list.length === 0) {
            setPublishMenuMessage(opts.emptyMessage || 'No repositories available')
            return
          }

          const fragment = document.createDocumentFragment()

          list.forEach((repo) => {
            const key = repo && typeof repo.repoParam === 'string' ? repo.repoParam : ''
            const name = repo && repo.name ? repo.name : (key || 'Repository')
            const remoteUrl = repo && repo.url ? repo.url : ''
            const pushUri = resolvePushUri(repo)
            const hasRemote = hasRemoteConfigured(repo)
            const canPublish = hasRemote && Boolean(pushUri)

            const item = document.createElement('button')
            item.type = 'button'
            item.className = 'fs-dropdown-item pinokio-publish-dropdown-item'
            item.dataset.repo = key
            item.dataset.name = name

            let remoteClass
            let remoteDisplay
            if (!canPublish) {
              remoteClass = 'pinokio-publish-dropdown-remote'
              remoteDisplay = 'Create on GitHub'
            } else if (remoteUrl) {
              remoteClass = 'pinokio-publish-dropdown-remote'
              remoteDisplay = escapeHtml(remoteUrl)
            } else {
              remoteClass = 'pinokio-publish-dropdown-remote empty'
              remoteDisplay = 'No remote detected'
            }

            item.innerHTML = `
          <div class="pinokio-publish-dropdown-title">${escapeHtml(name)}</div>
          <div class="${remoteClass}">${remoteDisplay}</div>
        `

            item.addEventListener('click', (event) => {
              event.preventDefault()
              event.stopPropagation()
              handlePublishDropdownClick({ repoParam: key, repoName: name })
            })

            fragment.appendChild(item)
          })

          publishMenu.appendChild(fragment)
        }

        const attachRepoDropdownHandlers = () => {
          if (!changesMenu) {
            return
          }
          const items = changesMenu.querySelectorAll('.git-changes-item')
          items.forEach((item) => {
            item.addEventListener('click', async (event) => {
              event.preventDefault()
              event.stopPropagation()
              const repoKey = item.dataset.repo
              const repoName = item.dataset.name
              if (repoKey) {
                activeRepoKey = repoKey
              }
              items.forEach((node) => {
                if (node === item) {
                  node.classList.add('git-changes-item--active')
                } else {
                  node.classList.remove('git-changes-item--active')
                }
              })
              closeStatusDropdowns()
              try {
                await showGitDiffModal({ repoParam: repoKey, repoName })
              } catch (err) {
                console.error('Failed to open diff modal:', err)
              }
            })
          })
        }

        const renderChangesDropdown = (repos) => {
          if (!changesMenu) {
            return
          }

          if (!Array.isArray(repos) || repos.length === 0) {
            setChangesMenuMessage('No Git repositories detected')
            updateChangesButtonState(false)
            return
          }

          const fragment = document.createDocumentFragment()
          repos.forEach((repo) => {
            const button = document.createElement('button')
            button.type = 'button'
            button.className = 'fs-dropdown-item git-changes-item'
            button.dataset.repo = repo.repoParam
            button.dataset.name = repo.name
            if (repo.main) {
              button.dataset.main = 'true'
            }
            if (repo.repoParam === activeRepoKey) {
              button.classList.add('git-changes-item--active')
            }

            button.innerHTML = `
          <span class="git-changes-item-label">
            <i class="fa-solid fa-code-branch"></i>
            <span>${repo.name}</span>
          </span>
          <span class="git-changes-item-count ${repo.changeCount > 0 ? 'git-changes-item-count--dirty' : 'git-changes-item-count--clean'}">
            ${repo.changeCount > 0 ? repo.changeCount : 'Clean'}
          </span>
        `

            fragment.append(button)
          })

          changesMenu.innerHTML = ''
          changesMenu.append(fragment)
          updateChangesButtonState(true)
          attachRepoDropdownHandlers()
        }

        const updateFromLegacyMonitor = async () => {
          if (!monitorUri) {
            setChangesMenuMessage('Git status data unavailable')
            updateCombinedBadge(0)
            updateChangesButtonState(false)
            return false
          }
          try {
            const response = await fetch(monitorUri)
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`)
            }
            const data = await response.json()
            const repoKey = workspaceName || ''
            const fallbackRepo = {
              name: workspaceName || 'Current workspace',
              main: true,
              repoParam: repoKey,
              changeCount: Array.isArray(data.changes) ? data.changes.length : 0,
              changes: Array.isArray(data.changes) ? data.changes : [],
              git_commit_url: data.git_commit_url || null,
              git_history_url: workspaceName ? `/info/git/HEAD/${encodeRepoPath(workspaceName)}` : readDataAttr(fsStatusEl, 'data-history-uri'),
              git_fork_url: defaultForkUri,
              git_push_url: defaultPushUri,
              url: null,
            }

            repoStatusCache.clear()
            repoStatusCache.set(fallbackRepo.repoParam, fallbackRepo)
            lastRepoList = [fallbackRepo]
            activeRepoKey = fallbackRepo.repoParam
            currentChanges = fallbackRepo.changes
            gitCommitUrl = fallbackRepo.git_commit_url

            renderChangesDropdown(lastRepoList)
            updateCombinedBadge(fallbackRepo.changeCount)
            updatePublishButton()
            updateForkButton()
            return true
          } catch (error) {
            console.error('check_git fallback error:', error)
            setChangesMenuMessage('Unable to load repositories')
            updateCombinedBadge(0)
            updateChangesButtonState(false)
            updateForkButton()
            return false
          }
        }

        const check_git = async (forceRefresh = false) => {
          if (gitStatusRequest) {
            if (forceRefresh && !gitStatusRequestForce) {
              return gitStatusRequest.then(() => check_git(true))
            }
            return gitStatusRequest
          }

          const targetStatusUrl = buildStatusUrl(forceRefresh)
          gitStatusRequestForce = Boolean(forceRefresh)
          gitStatusRequest = (async () => {
            if (repoStatusCache.size === 0) {
              setChangesMenuMessage(statusUri ? 'Loading repositories...' : 'Loading changes...')
              updateChangesButtonState(false)
            }

            if (!targetStatusUrl) {
              await updateFromLegacyMonitor()
              return
            }

            try {
              const response = await fetch(targetStatusUrl)
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`)
              }
              const data = await response.json()
              const repos = Array.isArray(data.repos) ? data.repos : []

              repoStatusCache.clear()
              repos.forEach((repo) => {
                repoStatusCache.set(repo.repoParam, repo)
              })

              const sortedRepos = [...repos].sort((a, b) => {
                if (a.main === b.main) {
                  return a.name.localeCompare(b.name)
                }
                return a.main ? -1 : 1
              })

              lastRepoList = sortedRepos

              const existingActive = activeRepoKey
                ? sortedRepos.find((repo) => repo.repoParam === activeRepoKey)
                : null
              const fallbackRepo = sortedRepos.find((repo) => repo.main) || sortedRepos[0] || null
              const resolvedActive = existingActive || fallbackRepo
              activeRepoKey = resolvedActive ? resolvedActive.repoParam : null
              currentChanges = resolvedActive ? (resolvedActive.changes || []) : []
              gitCommitUrl = resolvedActive ? (resolvedActive.git_commit_url || null) : null

              if (changesDropdownContainer) {
                changesDropdownContainer.style.display = ''
              }

              if (sortedRepos.length === 0) {
                await updateFromLegacyMonitor()
              } else {
                renderChangesDropdown(sortedRepos)
                const total = typeof data.totalChanges === 'number'
                  ? data.totalChanges
                  : sortedRepos.reduce((sum, repo) => sum + (repo.changeCount || 0), 0)
                updateCombinedBadge(total)
                updateChangesButtonState(true)
                updateForkButton()
              }

              updatePublishButton()
            } catch (error) {
              console.error('check_git error:', error)
              await updateFromLegacyMonitor()
            }
          })()

          try {
            await gitStatusRequest
          } finally {
            gitStatusRequest = null
            gitStatusRequestForce = false
          }
        }

        let messageListener = null
        let reopenDiffOnCallback = false

        const showIframeView = (src) => {
          const iframeMarkup = `<iframe src="${src}" frameborder="0"></iframe>`
          const diffBody = document.querySelector('.pinokio-modal-body--diff')
          let iframeContainer = null
          if (diffBody) {
            diffBody.classList.remove('pinokio-modal-body--diff')
            diffBody.classList.add('pinokio-modal-body--iframe')
            diffBody.innerHTML = iframeMarkup
            iframeContainer = diffBody
          } else {
            const activeSwal = Swal.isVisible()
            const fallbackHtml = `
          <div class="pinokio-modal-surface pinokio-modal-surface--iframe">
            <div class="pinokio-modal-body pinokio-modal-body--iframe"></div>
          </div>
        `
            const launchPromise = Swal.fire({
              html: fallbackHtml,
              customClass: {
                popup: 'pinokio-modern-modal',
                htmlContainer: 'pinokio-modern-html',
                closeButton: 'pinokio-modern-close'
              },
              backdrop: 'rgba(9,11,15,0.65)',
              width: 'min(720px, 90vw)',
              showConfirmButton: false,
              showCloseButton: true,
              buttonsStyling: false,
              focusConfirm: false,
            })
            if (!activeSwal) {
              launchPromise.then(() => { })
            }
            const container = Swal.getHtmlContainer()
            if (container) {
              iframeContainer = container.querySelector('.pinokio-modal-body--iframe')
              if (iframeContainer) {
                iframeContainer.innerHTML = iframeMarkup
              }
            }
          }
          const commitFooter = document.querySelector('.pinokio-modal-footer--commit')
          if (commitFooter && commitFooter.parentNode) {
            commitFooter.parentNode.removeChild(commitFooter)
          }

          // Add postMessage listener for iframe communication
          if (messageListener) {
            window.removeEventListener('message', messageListener)
          }

          messageListener = (event) => {

            // Check if event has callback data that starts with "$"
            if (event.data &&
              event.data.callback &&
              typeof event.data.callback === 'string' &&
              event.data.callback.startsWith('$')) {
              if (typeof check_git === 'function') {
                check_git(true)
              }
              if (reopenDiffOnCallback && typeof showGitDiffModal === 'function') {
                reopenDiffOnCallback = false
                showGitDiffModal({ forceRefresh: true })
              } else {
                reopenDiffOnCallback = false
              }

              // Close the modal
              Swal.close()

              // Clean up the listener
              if (messageListener) {
                window.removeEventListener('message', messageListener)
                messageListener = null
              }
            }
          }

          window.addEventListener('message', messageListener)
        }

        const generateCommitMessage = (changes) => {
          if (!changes || changes.length === 0) return "Update files"

          const addedFiles = []
          const modifiedFiles = []
          const deletedFiles = []
          const renamedFiles = []

          changes.forEach(change => {
            const status = change.status.toLowerCase()
            const fileName = change.file

            if (status.includes('new') || status.includes('add')) {
              addedFiles.push(fileName)
            } else if (status.includes('delete') || status.includes('remove')) {
              deletedFiles.push(fileName)
            } else if (status.includes('rename') || status.includes('moved')) {
              renamedFiles.push(fileName)
            } else {
              modifiedFiles.push(fileName)
            }
          })

          const messages = []

          if (addedFiles.length > 0) {
            if (addedFiles.length === 1) {
              messages.push(`Add ${addedFiles[0]}`)
            } else {
              messages.push(`Add ${addedFiles.length} files`)
            }
          }

          if (modifiedFiles.length > 0) {
            if (modifiedFiles.length === 1) {
              messages.push(`Update ${modifiedFiles[0]}`)
            } else {
              messages.push(`Update ${modifiedFiles.length} files`)
            }
          }

          if (deletedFiles.length > 0) {
            if (deletedFiles.length === 1) {
              messages.push(`Delete ${deletedFiles[0]}`)
            } else {
              messages.push(`Delete ${deletedFiles.length} files`)
            }
          }

          if (renamedFiles.length > 0) {
            if (renamedFiles.length === 1) {
              messages.push(`Rename ${renamedFiles[0]}`)
            } else {
              messages.push(`Rename ${renamedFiles.length} files`)
            }
          }

          if (messages.length === 0) {
            return changes.length === 1 ? `Update ${changes[0].file}` : `Update ${changes.length} files`
          }

          return messages.join(', ')
        }

        const showGitDiffModal = async (diffData = null, modalTitle = null, showSaveButton = true) => {
          const diffDataIsObject = diffData && typeof diffData === 'object' && !Array.isArray(diffData)
          let repoParam = diffDataIsObject ? (diffData.repoParam || diffData.repoKey || null) : null
          let repoDisplayName = diffDataIsObject ? (diffData.repoName || diffData.name || null) : null

          if (!repoParam) {
            repoParam = activeRepoKey || null
          }

          if (!repoParam && repoStatusCache.size > 0) {
            const firstEntry = repoStatusCache.values().next().value
            if (firstEntry) {
              repoParam = firstEntry.repoParam
              if (!repoDisplayName) {
                repoDisplayName = firstEntry.name
              }
            }
          }

          if (!repoParam) {
            await check_git(true)
            const fallback = repoStatusCache.values().next().value
            if (fallback) {
              repoParam = fallback.repoParam
              repoDisplayName = repoDisplayName || fallback.name
            }
          }

          if (!repoParam) {
            Swal.fire({
              title: 'No repositories',
              text: 'No Git repositories were detected for this workspace.',
              icon: 'info'
            })
            return
          }

          let repoData = repoStatusCache.get(repoParam)
          if (!repoData) {
            await check_git(true)
            repoData = repoStatusCache.get(repoParam)
          }

          if (!repoDisplayName && repoData) {
            repoDisplayName = repoData.name
          }
          if (!repoDisplayName) {
            repoDisplayName = repoParam
          }

          let changes
          if (diffDataIsObject && Array.isArray(diffData.changes)) {
            changes = diffData.changes
          } else if (repoData && Array.isArray(repoData.changes)) {
            changes = repoData.changes
          } else {
            changes = currentChanges
          }

          let commitUrl
          if (diffDataIsObject && diffData.git_commit_url) {
            commitUrl = diffData.git_commit_url
          } else if (repoData && repoData.git_commit_url) {
            commitUrl = repoData.git_commit_url
          } else {
            commitUrl = gitCommitUrl
          }

          let historyUrl = resolveHistoryUrl(
            repoParam,
            repoData,
            diffDataIsObject ? (diffData.git_history_url || null) : null
          )

          const shouldForceRefresh = Boolean(diffDataIsObject && diffData.forceRefresh)

          if (!changes || changes.length === 0 || shouldForceRefresh) {
            try {
              const response = await fetch(`/gitcommit/HEAD/${encodeRepoPath(repoParam)}`)
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`)
              }
              const freshData = await response.json()
              changes = freshData.changes || []
              commitUrl = freshData.git_commit_url || commitUrl
              const updatedRepo = repoData || { repoParam }
              updatedRepo.changes = changes
              updatedRepo.changeCount = changes.length
              updatedRepo.git_commit_url = freshData.git_commit_url || null
              updatedRepo.name = updatedRepo.name || repoDisplayName || repoParam
              updatedRepo.git_history_url = updatedRepo.git_history_url || (repoData && repoData.git_history_url) || (repoParam ? `/info/git/HEAD/${encodeRepoPath(repoParam)}` : null)
              if (!updatedRepo.git_fork_url) {
                updatedRepo.git_fork_url = repoData && repoData.git_fork_url ? repoData.git_fork_url : resolveForkUri(updatedRepo)
              }
              if (!updatedRepo.git_push_url) {
                updatedRepo.git_push_url = repoData && repoData.git_push_url ? repoData.git_push_url : resolvePushUri(updatedRepo)
              }
              repoStatusCache.set(repoParam, updatedRepo)
              repoData = updatedRepo
              historyUrl = resolveHistoryUrl(repoParam, updatedRepo)
              const listEntry = lastRepoList.find((entry) => entry.repoParam === repoParam)
              if (listEntry) {
                listEntry.changes = changes
                listEntry.changeCount = changes.length
                listEntry.git_commit_url = updatedRepo.git_commit_url
                if (updatedRepo.git_history_url) {
                  listEntry.git_history_url = updatedRepo.git_history_url
                }
                if (!listEntry.git_fork_url && updatedRepo.git_fork_url) {
                  listEntry.git_fork_url = updatedRepo.git_fork_url
                }
                if (!listEntry.git_push_url && updatedRepo.git_push_url) {
                  listEntry.git_push_url = updatedRepo.git_push_url
                }
              }
              const total = Array.from(repoStatusCache.values()).reduce((sum, repo) => sum + (repo.changeCount || 0), 0)
              updateCombinedBadge(total)
              if (lastRepoList.length > 0) {
                renderChangesDropdown(lastRepoList)
              }
            } catch (error) {
              console.error('Failed to fetch repo changes:', error)
            }
          }

          activeRepoKey = repoParam
          currentChanges = changes || []
          gitCommitUrl = commitUrl

          const title = modalTitle || `File Changes${repoDisplayName ? `  ${repoDisplayName}` : ''}`

          if (lastRepoList.length > 0) {
            renderChangesDropdown(lastRepoList)
          }

          if (!changes || changes.length === 0) {
            try {
              await showGitHistoryModal({
                repoParam,
                repoName: repoDisplayName,
                historyUrl,
              })
            } catch (error) {
              console.error('Failed to open history for clean repository:', error)
            }
            return
          }

          const changeSummary = `${changes.length} file${changes.length === 1 ? '' : 's'} changed`
          const statusCounts = { added: 0, modified: 0, deleted: 0, renamed: 0 }
          changes.forEach(change => {
            const status = (change.status || '').toLowerCase()
            if (status.includes('new') || status.includes('add')) statusCounts.added += 1
            else if (status.includes('delete') || status.includes('remove')) statusCounts.deleted += 1
            else if (status.includes('rename') || status.includes('moved')) statusCounts.renamed += 1
            else statusCounts.modified += 1
          })

          const commitSection = showSaveButton ? `
        <div class="pinokio-modal-footer pinokio-modal-footer--commit">
          <div class="pinokio-commit-message-container">
            <input type="text" class="pinokio-modal-input pinokio-commit-message-input" placeholder="Enter commit message..." value="${generateCommitMessage(changes)}">
            <div class="pinokio-commit-actions">
              <button type="button" class="pinokio-save-version-btn">Save selected</button>
            </div>
          </div>
        </div>
      ` : ''

          const historyTabDisabled = historyUrl ? '' : ' disabled'

          const modalHtml = `
        <div class="pinokio-modal-surface pinokio-modal-surface--diff">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon"><i class="fa-solid fa-code-branch"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">${title}</div>
              <div class="pinokio-modal-subtitle">${changeSummary}</div>
            </div>
          </div>
          <div class="pinokio-modal-tabs">
            <button type="button" class="pinokio-modal-tab pinokio-modal-tab--active" data-tab-target="changes">
              <i class="fa-solid fa-code-compare"></i> Changes
            </button>
            <button type="button" class="pinokio-modal-tab"${historyTabDisabled} data-tab-target="history">
              <i class="fa-solid fa-clock-rotate-left"></i> History
            </button>
          </div>
          <div class="pinokio-modal-body pinokio-modal-body--diff" data-tab-panel="changes">
            <div class="pinokio-git-diff-main-container">
              <div class="pinokio-git-diff-file-list-panel">
                <div class="pinokio-git-diff-file-item-row pinokio-git-diff-select-all">
                  <input type="checkbox" class="pinokio-git-diff-file-checkbox" data-select-all checked>
                  <span class="pinokio-git-diff-file">Select all</span>
                  <span></span>
                </div>
                ${changes.map((change, index) => `
                  <div class="pinokio-git-diff-file-item-row" role="button" tabindex="0" data-index="${index}" data-diffpath="${change.diffpath}" data-filepath="${change.file}" data-abspath="${change.path || ''}" data-status="${change.status || ''}">
                    <input type="checkbox" class="pinokio-git-diff-file-checkbox" data-file-checkbox data-index="${index}" checked>
                    <span class="pinokio-git-diff-file">${change.file}</span>
                    <span class="pinokio-git-diff-status">${change.status}</span>
                  </div>
                `).join('')}
              </div>
              <div class="pinokio-git-diff-viewer-panel">
                <div class="pinokio-git-diff-empty-state">Select a file to view its changes</div>
              </div>
            </div>
          </div>
          <div class="pinokio-modal-body pinokio-modal-body--history" data-tab-panel="history" style="display:none">
            <div class="pinokio-git-diff-empty-state">${historyUrl ? 'Loading history' : 'History unavailable'}</div>
          </div>
          ${commitSection}
        </div>
      `

          const swalClass = {
            popup: 'pinokio-modern-modal pinokio-diff-modal',
            htmlContainer: 'pinokio-modern-html',
            closeButton: 'pinokio-modern-close'
          }
          if (showSaveButton) {
            swalClass.confirmButton = 'pinokio-modern-confirm'
            swalClass.cancelButton = 'pinokio-modern-cancel'
          }

          await Swal.fire({
            html: modalHtml,
            customClass: swalClass,
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(960px, 95vw)',
            showCloseButton: true,
            showConfirmButton: false,
            showCancelButton: false,
            buttonsStyling: false,
            focusConfirm: false,
            willClose: () => {
              if (messageListener) {
                window.removeEventListener('message', messageListener)
                messageListener = null
              }
            },
            didOpen: () => {
              const container = Swal.getHtmlContainer()
              if (!container) return
              const fileItems = container.querySelectorAll('.pinokio-git-diff-file-item-row[data-index]')
              const fileCheckboxes = container.querySelectorAll('[data-file-checkbox]')
              const selectAllCheckbox = container.querySelector('[data-select-all]')
              const diffViewer = container.querySelector('.pinokio-git-diff-viewer-panel')
              const tabButtons = container.querySelectorAll('.pinokio-modal-tab')
              const tabPanels = container.querySelectorAll('[data-tab-panel]')
              const historyPanel = container.querySelector('[data-tab-panel="history"]')
              const commitFooter = container.querySelector('.pinokio-modal-footer--commit')
              let historyLoaded = false
              let repoCwd = ''
              try {
                const commitUrlObj = commitUrl ? new URL(commitUrl, window.location.origin) : null
                repoCwd = commitUrlObj ? (commitUrlObj.searchParams.get('cwd') || '') : ''
              } catch (error) {
                repoCwd = ''
              }
              if (diffViewer && repoCwd) {
                diffViewer.setAttribute('data-repo-cwd', repoCwd)
              }

              const saveBtn = container.querySelector('.pinokio-save-version-btn')
              const commitMessageInput = container.querySelector('.pinokio-commit-message-input')
              const getCommitMessage = () => commitMessageInput ? commitMessageInput.value.trim() : ''

              if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                  const commitMessage = getCommitMessage()
                  if (!commitUrl) {
                    Swal.showValidationMessage('No commit URL available')
                    return
                  }
                  const selectedEntries = getSelectedEntries()
                  if (!selectedEntries.length) {
                    Swal.showValidationMessage('No files selected')
                    return
                  }
                  const trackedPaths = []
                  const untrackedPaths = []
                  selectedEntries.forEach((entry) => {
                    if (isUntrackedStatus(entry.status)) {
                      untrackedPaths.push(entry.path)
                    } else {
                      trackedPaths.push(entry.path)
                    }
                  })
                  const trackedArg = buildPathArgs(trackedPaths)
                  const untrackedArg = buildPathArgs(untrackedPaths)
                  if (!trackedArg && !untrackedArg) {
                    Swal.showValidationMessage('No files selected')
                    return
                  }

                  const commitUrlObj = new URL(commitUrl, window.location.origin)
                  const viewerCwd = commitUrlObj.searchParams.get('cwd') || repoCwd || ''
                  if (!viewerCwd) {
                    Swal.showValidationMessage('Repository path unavailable')
                    return
                  }

                  const parts = [`/run/scripts/git/commit_files.json?cwd=${encodeURIComponent(viewerCwd)}`]
                  if (commitMessage) {
                    parts.push(`message=${encodeURIComponent(commitMessage)}`)
                  }
                  if (trackedArg) {
                    parts.push(`paths=${encodeURIComponent(trackedArg)}`)
                  }
                  if (untrackedArg) {
                    parts.push(`untracked_paths=${encodeURIComponent(untrackedArg)}`)
                  }
                  parts.push('callback_target=parent')
                  parts.push('callback=$location.href')
                  const url = parts.join('&')
                  showIframeView(url)
                })
              }

              const fileItemsArray = Array.from(fileItems)
              const checkboxMap = new Map()
              fileCheckboxes.forEach((cb) => {
                const idx = Number(cb.getAttribute('data-index') || '-1')
                checkboxMap.set(idx, cb)
              })
              const selectedIndices = new Set(fileItemsArray.map((btn) => Number(btn.getAttribute('data-index') || '-1')))
              let lastSelectedIndex = null

              const applySelectionClasses = () => {
                fileItemsArray.forEach((btn) => {
                  const idx = Number(btn.getAttribute('data-index') || '-1')
                  const isSelected = selectedIndices.has(idx)
                  btn.classList.toggle('pinokio-active-file-item', isSelected)
                  const cb = checkboxMap.get(idx)
                  if (cb) {
                    cb.checked = isSelected
                  }
                })
                if (selectAllCheckbox) {
                  const total = fileItemsArray.length
                  const selectedCount = selectedIndices.size
                  selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < total
                  selectAllCheckbox.checked = selectedCount === total
                }
                updateBulkBar()
              }

              const getSelectedEntries = () => {
                const entries = []
                fileItemsArray.forEach((btn) => {
                  const idx = Number(btn.getAttribute('data-index') || '-1')
                  if (!selectedIndices.has(idx)) return
                  const status = btn.getAttribute('data-status') || ''
                  const filePath = btn.getAttribute('data-filepath') || ''
                  const absPath = btn.getAttribute('data-abspath') || ''
                  const pathValue = absPath || filePath
                  if (!pathValue) return
                  const entry = { status, filePath, path: pathValue }
                  entries.push(entry)
                })
                return entries
              }

              const fileListPanel = container.querySelector('.pinokio-git-diff-file-list-panel')
              const bulkResetButton = document.createElement('button')
              bulkResetButton.type = 'button'
              bulkResetButton.className = 'pinokio-git-diff-revert-btn pinokio-git-diff-bulk-btn'
              bulkResetButton.disabled = true
              bulkResetButton.innerHTML = `<i class="fa-solid fa-arrow-rotate-left"></i> Reset selected`
              const bulkResetContainer = document.createElement('div')
              bulkResetContainer.className = 'pinokio-git-diff-bulk-bar'
              bulkResetContainer.setAttribute('data-bulk-bar', 'true')
              bulkResetContainer.appendChild(bulkResetButton)
              if (fileListPanel) {
                fileListPanel.insertBefore(bulkResetContainer, fileListPanel.firstChild)
              }

              function updateBulkBar() {
                const selectedEntries = getSelectedEntries()
                const selectionCount = selectedEntries.length
                const trackedPaths = []
                const untrackedPaths = []
                selectedEntries.forEach((entry) => {
                  if (isUntrackedStatus(entry.status)) {
                    untrackedPaths.push(entry.path)
                  } else {
                    trackedPaths.push(entry.path)
                  }
                })
                const trackedArg = buildPathArgs(trackedPaths)
                const untrackedArg = buildPathArgs(untrackedPaths)
                const viewerCwd = (diffViewer && diffViewer.getAttribute('data-repo-cwd')) || repoCwd || ''
                const hasPaths = Boolean(trackedArg || untrackedArg)
                const hasTarget = Boolean(viewerCwd && hasPaths && selectionCount > 0)
                let bulkUrl = null
                if (hasTarget) {
                  const urlParts = [`/run/scripts/git/reset_files.json?cwd=${encodeURIComponent(viewerCwd)}`]
                  if (trackedArg) urlParts.push(`tracked_paths=${encodeURIComponent(trackedArg)}`)
                  if (untrackedArg) urlParts.push(`untracked_paths=${encodeURIComponent(untrackedArg)}`)
                  urlParts.push('callback_target=parent')
                  urlParts.push('callback=$location.href')
                  bulkUrl = urlParts.join('&')
                }
                bulkResetButton.textContent = `Reset selected (${selectionCount})`
                bulkResetButton.disabled = selectionCount === 0
                bulkResetButton.onclick = null
                bulkResetButton.onclick = () => {
                  if (selectionCount === 0) return
                  if (!viewerCwd || !hasPaths || !bulkUrl) {
                    Swal.showValidationMessage('Cannot reset: missing repository context or paths')
                    return
                  }
                  const confirmed = confirm(`Reset ${selectionCount} selected file${selectionCount === 1 ? '' : 's'}?`)
                  if (!confirmed) return
                  reopenDiffOnCallback = true
                  showIframeView(bulkUrl)
                }
              }

              const renderFileDiff = async (item) => {
                const diffpath = item.getAttribute('data-diffpath')
                const filePath = item.getAttribute('data-filepath') || ''
                const titleText = escapeHtml(filePath || 'Selected file')
                const openHref = (repoParam && filePath)
                  ? `/api/${encodeRepoPath(repoParam)}/${filePath.split('/').map(encodeURIComponent).join('/')}?fs=view`
                  : null

                const headerHtml = `
            <div class="pinokio-git-diff-viewer-header">
              <div class="pinokio-git-diff-viewer-title">${titleText}</div>
              ${openHref ? `
                <button type="button" class="pinokio-git-diff-open-file" data-open-repo="${escapeHtml(repoParam || '')}" data-open-relpath="${escapeHtml(filePath || '')}">
                  <i class="fa-solid fa-folder-open"></i>
                  Open in explorer
                </button>
              ` : ''}
            </div>
          `

                diffViewer.innerHTML = `${headerHtml}<div class="pinokio-git-diff-viewer-body"><div class="pinokio-git-diff-empty-state">Loading</div></div>`
                const diffBody = diffViewer.querySelector('.pinokio-git-diff-viewer-body')
                try {
                  const diffRes = await fetch(diffpath)
                  const diffJson = await diffRes.json()
                  renderDiff(diffJson, diffBody)
                  const openBtn = diffViewer.querySelector('.pinokio-git-diff-open-file')
                  if (openBtn) {
                    openBtn.addEventListener('click', async (event) => {
                      event.preventDefault()
                      event.stopPropagation()
                      const repoKey = openBtn.getAttribute('data-open-repo') || repoParam || ''
                      const rel = openBtn.getAttribute('data-open-relpath') || ''
                      if (!repoKey || !rel) return
                      const encodedRepo = encodeRepoPath(repoKey)
                      const encodedRel = rel.split('/').map(encodeURIComponent).join('/')
                      const url = `/api/${encodedRepo}/${encodedRel}?fs=view`
                      try {
                        await fetch(url)
                      } catch (error) {
                        console.error('Failed to open in explorer', error)
                      }
                    })
                  }
                } catch (error) {
                  console.error('Error fetching diff:', error)
                  if (diffBody) {
                    diffBody.innerHTML = '<div class="pinokio-git-diff-empty-state">Error loading diff</div>'
                  }
                }
              }

              fileItemsArray.forEach(item => {
                item.addEventListener('click', async (event) => {
                  const targetIsCheckbox = event.target && event.target.hasAttribute && event.target.hasAttribute('data-file-checkbox')
                  if (!targetIsCheckbox) {
                    event.preventDefault()
                    event.stopPropagation()
                  }
                  const index = Number(item.getAttribute('data-index') || '-1')
                  if (!targetIsCheckbox) {
                    lastSelectedIndex = index
                    await renderFileDiff(item)
                    return
                  }
                  const cb = checkboxMap.get(index)
                  const isChecked = cb ? cb.checked : selectedIndices.has(index)
                  if (isChecked) {
                    selectedIndices.add(index)
                  } else {
                    selectedIndices.delete(index)
                  }
                  lastSelectedIndex = index
                  applySelectionClasses()
                  await renderFileDiff(item)
                })
              })

              fileCheckboxes.forEach((cb) => {
                cb.addEventListener('click', (e) => {
                  e.stopPropagation()
                })
                cb.addEventListener('change', async () => {
                  const idx = Number(cb.getAttribute('data-index') || '-1')
                  if (cb.checked) {
                    selectedIndices.add(idx)
                  } else {
                    selectedIndices.delete(idx)
                  }
                  applySelectionClasses()
                  const item = fileItemsArray.find((btn) => Number(btn.getAttribute('data-index') || '-1') === idx)
                  if (item) {
                    await renderFileDiff(item)
                  }
                })
              })

              if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', () => {
                  if (selectAllCheckbox.checked) {
                    fileItemsArray.forEach((btn) => {
                      const idx = Number(btn.getAttribute('data-index') || '-1')
                      selectedIndices.add(idx)
                    })
                  } else {
                    selectedIndices.clear()
                  }
                  applySelectionClasses()
                  const activeItem = fileItemsArray.find((btn) => btn.classList.contains('pinokio-active-file-item'))
                  if (activeItem) {
                    renderFileDiff(activeItem)
                  }
                })
                selectAllCheckbox.addEventListener('click', (e) => {
                  e.stopPropagation()
                })
              }

              applySelectionClasses()

              const renderHistoryInline = (historyData) => {
                if (!historyPanel) {
                  return
                }
                const commits = Array.isArray(historyData.log) ? historyData.log : []
                const remoteName = historyData.remote || ''
                const currentRef = historyData.ref || 'HEAD'
                const metaBadges = [`<span class="pinokio-pill"><i class="fa-solid fa-code-branch"></i>${escapeHtml(currentRef)}</span>`]
                if (remoteName) {
                  metaBadges.push(`<span class="pinokio-pill"><i class="fa-solid fa-cloud-arrow-up"></i>${escapeHtml(remoteName)}</span>`)
                }
                const commitMarkup = commits.length
                  ? `<div class="pinokio-git-history-list">${commits.map(commit => createCommitItem(commit)).join('')}</div>`
                  : '<div class="pinokio-history-empty">No commits found</div>'

                historyPanel.innerHTML = `
              <div class="pinokio-history-inline-head">
                <div class="pinokio-history-meta">${metaBadges.join('')}</div>
                <div class="pinokio-history-inline-actions">
                  <button type="button" class="pinokio-history-inline-btn" data-open-full-history>
                    <i class="fa-solid fa-up-right-from-square"></i> Open full history
                  </button>
                </div>
              </div>
              ${commitMarkup}
            `

                historyPanel.querySelectorAll('.pinokio-git-commit-item').forEach(item => {
                  item.addEventListener('click', async () => {
                    const commitInfo = item.getAttribute('data-commit-info')
                    if (commitInfo) {
                      await showCommitDiffModal(commitInfo)
                    }
                  })
                })

                const fullHistoryBtn = historyPanel.querySelector('[data-open-full-history]')
                if (fullHistoryBtn) {
                  if (!historyUrl) {
                    fullHistoryBtn.disabled = true
                  } else {
                    fullHistoryBtn.addEventListener('click', () => {
                      Swal.close()
                      showGitHistoryModal({ repoParam, repoName: repoDisplayName, historyUrl })
                    })
                  }
                }
              }

              const loadHistory = async () => {
                if (historyLoaded || !historyPanel) {
                  return
                }
                if (!historyUrl) {
                  historyPanel.innerHTML = '<div class="pinokio-git-diff-empty-state">History unavailable</div>'
                  return
                }
                historyPanel.innerHTML = '<div class="pinokio-git-diff-empty-state">Loading history</div>'
                try {
                  const response = await fetch(historyUrl)
                  if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`)
                  }
                  const data = await response.json()
                  historyLoaded = true
                  renderHistoryInline(data)
                } catch (error) {
                  historyLoaded = false
                  console.error('Error loading inline history:', error)
                  historyPanel.innerHTML = '<div class="pinokio-git-diff-empty-state">Unable to load history</div>'
                }
              }

              const setActiveTab = (tabName) => {
                tabButtons.forEach((btn) => {
                  const isActive = btn.getAttribute('data-tab-target') === tabName
                  btn.classList.toggle('pinokio-modal-tab--active', isActive)
                })
                tabPanels.forEach((panel) => {
                  const isTarget = panel.getAttribute('data-tab-panel') === tabName
                  panel.style.display = isTarget ? '' : 'none'
                })
                if (commitFooter) {
                  commitFooter.style.display = tabName === 'changes' ? '' : 'none'
                }
                if (tabName === 'history') {
                  loadHistory()
                }
              }

              tabButtons.forEach((btn) => {
                if (btn.disabled) {
                  return
                }
                btn.addEventListener('click', () => {
                  const target = btn.getAttribute('data-tab-target') || 'changes'
                  setActiveTab(target)
                })
              })

              setActiveTab('changes')

              if (fileItems.length) {
                const first = fileItems[0]
                const idx = Number(first.getAttribute('data-index') || '-1')
                if (!selectedIndices.has(idx)) {
                  selectedIndices.add(idx)
                  applySelectionClasses()
                }
                renderFileDiff(first).catch(() => { })
              }
            }
          })
        }

        const renderDiff = (diffData, container) => {
          if (!diffData.diff || diffData.diff.length === 0) {
            container.innerHTML = '<div class="pinokio-git-diff-empty-state">No changes to display</div>'
            return
          }

          const formatLineNumber = (value) => (value === null || value === undefined ? '' : String(value))
          const diffHtml = diffData.diff.map(line => {
            const oldNumber = formatLineNumber(line.lineOld)
            const newNumber = formatLineNumber(line.lineNew)
            const lineNumbers = `
          <span class="pinokio-diff-line-number pinokio-diff-line-number--old">${oldNumber}</span>
          <span class="pinokio-diff-line-number pinokio-diff-line-number--new">${newNumber}</span>
        `.trim()

            let cssClass = 'pinokio-diff-code-line'
            if (line.type === 'add') {
              cssClass += ' pinokio-diff-code-line-addition'
            } else if (line.type === 'del') {
              cssClass += ' pinokio-diff-code-line-deletion'
            } else {
              cssClass += ' pinokio-diff-code-line-context'
            }

            const escapedLine = line.line
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')

            return `<div class="${cssClass}">
          <span class="pinokio-diff-code-line-numbers">${lineNumbers}</span>
          <span class="pinokio-diff-code-line-content">${escapedLine}</span>
        </div>`
          }).join('')

          container.innerHTML = diffHtml
        }

        const showGitHistoryModal = async (options = {}) => {
          const opts = options && typeof options === 'object' ? options : {}

          let repoParam = opts.repoParam ?? null
          let repoName = opts.repoName ?? null
          let historyUrl = opts.historyUrl ?? null

          if (!repoParam) {
            repoParam = activeRepoKey || null
          }

          let repoData = repoParam ? repoStatusCache.get(repoParam) : null

          if (!repoName && repoData && repoData.name) {
            repoName = repoData.name
          }

          if (!historyUrl && repoData && repoData.git_history_url) {
            historyUrl = repoData.git_history_url
          }

          historyUrl = resolveHistoryUrl(repoParam, repoData, historyUrl)

          if (!repoName) {
            if (repoParam) {
              repoName = repoParam
            } else if (workspaceName) {
              repoName = workspaceName
            }
          }

          if (!historyUrl) {
            Swal.fire({
              title: 'Error',
              text: 'Git history URL not available.',
              icon: 'error'
            })
            return
          }

          try {
            const response = await fetch(historyUrl)
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }

            const historyData = await response.json()
            displayGitHistory(historyData, { repoName: repoName || null, repoParam: repoParam || null, repoData })
          } catch (error) {
            console.error('Failed to load git history:', error)
            Swal.fire({
              title: 'Error',
              text: `Failed to load git history: ${error.message}`,
              icon: 'error'
            })
          }
        }

        const displayGitHistory = (historyData, options = {}) => {
          const repoName = options && typeof options === 'object' ? options.repoName : null
          const repoData = options && typeof options === 'object' ? options.repoData : null
          const commits = historyData.log || []
          const remote = historyData.remote || ''
          const currentRef = historyData.ref || 'HEAD'
          const branchEntries = Array.isArray(historyData.branches) ? historyData.branches : []
          const isOid = (s) => typeof s === 'string' && /^[0-9a-f]{7,40}$/i.test(s)
          const realBranchEntries = branchEntries.filter((entry) => entry && typeof entry.branch === 'string' && entry.branch.length > 0 && !isOid(entry.branch))
          const selectedBranchName = (historyData && typeof historyData.branch === 'string' && !isOid(historyData.branch)) ? historyData.branch : null

          const commitCountLabel = `${commits.length} commit${commits.length === 1 ? '' : 's'}`
          const lastCommit = commits[0]
          const subtitleParts = [commitCountLabel]
          if (lastCommit && typeof timeago !== 'undefined' && timeago) {
            const lastTs = new Date(lastCommit.commit.author.timestamp * 1000)
            subtitleParts.push(`Updated ${timeago.format(lastTs)}`)
          }
          const subtitleText = subtitleParts.join('  ')

          const metaBadges = [`<span class="pinokio-pill"><i class="fa-solid fa-code-branch"></i>${currentRef}</span>`]
          if (remote) {
            metaBadges.push(`<span class="pinokio-pill"><i class="fa-solid fa-cloud-arrow-up"></i>${remote}</span>`)
          }

          const historyTitle = repoName ? `${repoName} history` : 'Repository history'

          const historyHtml = `
        <div class="pinokio-modal-surface pinokio-modal-surface--history">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">${historyTitle}</div>
              <div class="pinokio-modal-subtitle">${subtitleText}</div>
            </div>
          </div>
          ${metaBadges.length ? `<div class="pinokio-history-meta">${metaBadges.join('')}</div>` : ''}
          <div class="pinokio-history-latest-banner" data-history-latest-banner>
            <div class="pinokio-history-latest-text">
              Currently viewing ${escapeHtml(currentRef)}
            </div>
            <div class="pinokio-history-actions">
              <button type="button" class="pinokio-history-latest-btn" data-history-return-head>
                <i class="fa-solid fa-arrow-rotate-left"></i> Return to newest commit
              </button>
              ${realBranchEntries.length ? `
                <select class="pinokio-modal-input pinokio-history-branch-select" data-history-branch-select aria-label="Select branch">
                  ${realBranchEntries.map(e => `
                    <option value="${escapeHtml(e.branch)}"${selectedBranchName === e.branch ? ' selected' : ''}>${escapeHtml(e.branch)}</option>
                  `).join('')}
                </select>
                <button type="button" class="pinokio-history-latest-btn" data-history-branch-switch>
                  <i class="fa-solid fa-code-branch"></i> Switch
                </button>
              ` : ''}
            </div>
          </div>
          <div class="pinokio-modal-body pinokio-modal-body--history">
            ${commits.length === 0 ?
              '<div class="pinokio-history-empty">No commits found</div>' :
              `<div class="pinokio-git-history-list">${commits.map(commit => createCommitItem(commit)).join('')}</div>`
            }
          </div>
        </div>
      `

          Swal.fire({
            html: historyHtml,
            customClass: {
              popup: 'pinokio-modern-modal pinokio-history-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close'
            },
            showConfirmButton: false,
            showCloseButton: true,
            buttonsStyling: false,
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(840px, 90vw)',
            focusConfirm: false,
            didOpen: () => {
              const commitItems = document.querySelectorAll('.pinokio-git-commit-item[data-commit-info]')
              commitItems.forEach(item => {
                item.addEventListener('click', async () => {
                  const commitInfo = item.getAttribute('data-commit-info')
                  if (commitInfo) {
                    await showCommitDiffModal(commitInfo)
                  }
                })
              })

              const returnBtn = document.querySelector('[data-history-return-head]')
              const banner = document.querySelector('[data-history-latest-banner]')
              const branchSelect = document.querySelector('[data-history-branch-select]')
              const branchSwitchBtn = document.querySelector('[data-history-branch-switch]')
              if (typeof showIframeView === 'function') {
                const repoParam = options && typeof options === 'object' ? options.repoParam : null
                let checkoutCwd = null
                if (historyData && typeof historyData.dir === 'string' && historyData.dir.length > 0) {
                  checkoutCwd = historyData.dir
                } else if (repoParam) {
                  checkoutCwd = repoParam
                }

                const isOid = (s) => typeof s === 'string' && /^[0-9a-f]{7,40}$/i.test(s)
                const branchEntries = Array.isArray(historyData.branches) ? historyData.branches : []
                const realBranches = branchEntries
                  .map((entry) => entry && typeof entry.branch === 'string' ? entry.branch : null)
                  .filter((name) => name && !isOid(name))

                // Wire the branch selector
                if (branchSelect && checkoutCwd) {
                  branchSelect.addEventListener('change', () => {
                    const value = branchSelect.value
                    if (!value) return
                    const url = `/run/scripts/git/checkout.json?cwd=${encodeURIComponent(checkoutCwd)}&commit=${encodeURIComponent(value)}&callback_target=parent&callback=$location.href`
                    openCheckoutTerminal(url)
                  })
                }
                if (branchSwitchBtn && branchSelect && checkoutCwd) {
                  branchSwitchBtn.addEventListener('click', () => {
                    const value = branchSelect.value
                    if (!value) return
                    const url = `/run/scripts/git/checkout.json?cwd=${encodeURIComponent(checkoutCwd)}&commit=${encodeURIComponent(value)}&callback_target=parent&callback=$location.href`
                    openCheckoutTerminal(url)
                  })
                }

                // Fix "Return to newest commit" target selection
                if (returnBtn) {
                  let checkoutTarget = null
                  if (repoData && typeof repoData.branch === 'string' && repoData.branch.length > 0 && !isOid(repoData.branch)) {
                    checkoutTarget = repoData.branch
                  } else if (historyData && typeof historyData.branch === 'string' && historyData.branch.length > 0 && !isOid(historyData.branch)) {
                    checkoutTarget = historyData.branch
                  } else if (realBranches.length > 0) {
                    const prefer = ['main', 'master', 'develop', 'dev']
                    checkoutTarget = prefer.find((n) => realBranches.includes(n)) || realBranches[0]
                  }

                  if (checkoutCwd && checkoutTarget) {
                    const checkoutUrl = `/run/scripts/git/checkout.json?cwd=${encodeURIComponent(checkoutCwd)}&commit=${encodeURIComponent(checkoutTarget)}&callback_target=parent&callback=$location.href`
                    returnBtn.addEventListener('click', () => {
                      openCheckoutTerminal(checkoutUrl)
                    })
                  } else {
                    returnBtn.disabled = true
                    if (banner) {
                      banner.classList.add('pinokio-history-latest-banner--disabled')
                    }
                  }
                }
              } else if (banner) {
                const parent = banner.parentNode
                if (parent) {
                  parent.removeChild(banner)
                }
              }
            }
          })
        }

        const showCommitDiffModal = async (commitInfoUrl) => {
          if (!commitInfoUrl) {
            Swal.fire({
              title: 'Error',
              text: 'Commit information URL not available.',
              icon: 'error'
            })
            return
          }

          try {
            const response = await fetch(commitInfoUrl)
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }

            const diffData = await response.json()
            await showCommitDiffModalQueued(diffData)

          } catch (error) {
            console.error('Failed to load commit diff:', error)
            Swal.fire({
              title: 'Error',
              text: `Failed to load commit changes: ${error.message}`,
              icon: 'error'
            })
          }
        }

        const showCommitDiffModalQueued = async (diffData) => {
          const changes = diffData.changes || []

          if (changes.length === 0) {
            alert('No file changes detected.')
            return
          }

          const commitOid = typeof diffData.oid === 'string' ? diffData.oid : (Array.isArray(changes) && typeof changes[0]?.ref === 'string' ? changes[0].ref : null)
          const commitCheckoutCwd = (() => {
            const url = typeof diffData.git_commit_url === 'string' ? new URL(diffData.git_commit_url, window.location.origin) : null
            if (!url) {
              return null
            }
            const cwdParam = url.searchParams.get('cwd')
            return cwdParam && cwdParam.length > 0 ? cwdParam : null
          })()

          const checkoutUrl = commitOid && commitCheckoutCwd
            ? `/run/scripts/git/checkout.json?cwd=${encodeURIComponent(commitCheckoutCwd)}&commit=${encodeURIComponent(commitOid)}&callback_target=parent&callback=$location.href`
            : null

          // Create custom overlay modal
          const overlay = document.createElement('div')
          overlay.className = 'pinokio-custom-commit-overlay'
          overlay.innerHTML = `
        <div class="pinokio-custom-commit-modal">
          <div class="pinokio-custom-commit-header">
            <h3>Commit Changes</h3>
            <button class="pinokio-custom-commit-close"></button>
          </div>
          <div class="pinokio-custom-commit-content">
              <div class="pinokio-git-diff-main-container">
                <div class="pinokio-git-diff-file-list-panel">
                  ${changes.map((change, index) => `
                  <div class="pinokio-git-diff-file-item-row" role="button" tabindex="0" data-index="${index}" data-diffpath="${change.diffpath}" data-filepath="${change.file}" data-abspath="${change.path || ''}" data-status="${change.status || ''}">
                    <span class="pinokio-git-diff-file">${change.file}</span>
                    <span class="pinokio-git-diff-status">${change.status}</span>
                  </div>
                `).join('')}
                </div>
              <div class="pinokio-git-diff-viewer-panel">
                <div class="pinokio-git-diff-empty-state">Select a file to view its changes</div>
              </div>
            </div>
            ${checkoutUrl ? `
              <div class="pinokio-git-commit-actions">
                <button type="button" class="pinokio-git-commit-switch-btn">
                  <i class="fa-solid fa-clock-rotate-left"></i> Switch to this version
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `

          document.body.appendChild(overlay)

          // Add close handler
          const closeBtn = overlay.querySelector('.pinokio-custom-commit-close')
          let escHandler = null
          const cleanupOverlay = () => {
            if (escHandler) {
              document.removeEventListener('keydown', escHandler)
              escHandler = null
            }
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay)
            }
          }

          closeBtn.addEventListener('click', cleanupOverlay)

          // Close on overlay click
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              cleanupOverlay()
            }
          })

          // Add file click handlers
          const fileItems = overlay.querySelectorAll('.pinokio-git-diff-file-item-row')
          const diffViewer = overlay.querySelector('.pinokio-git-diff-viewer-panel')
          if (diffViewer && commitCheckoutCwd) {
            diffViewer.setAttribute('data-repo-cwd', commitCheckoutCwd)
          }

          fileItems.forEach(item => {
            item.addEventListener('click', async (event) => {
              event.preventDefault()
              event.stopPropagation()
              // Remove active class from all items
              fileItems.forEach(i => i.classList.remove('pinokio-active-file-item'))
              // Add active class to clicked item
              item.classList.add('pinokio-active-file-item')

              const diffpath = item.getAttribute('data-diffpath')
              const filePath = item.getAttribute('data-filepath') || ''
              const titleText = escapeHtml(filePath || 'Selected file')
              const headerHtml = `
            <div class="pinokio-git-diff-viewer-header">
              <div class="pinokio-git-diff-viewer-title">${titleText}</div>
            </div>
          `

              diffViewer.innerHTML = `${headerHtml}<div class="pinokio-git-diff-viewer-body"><div class="pinokio-git-diff-empty-state">Loading...</div></div>`
              const diffBody = diffViewer.querySelector('.pinokio-git-diff-viewer-body')

              try {
                const diffRes = await fetch(diffpath)
                const diffData = await diffRes.json()
                renderDiff(diffData, diffBody)
                const resetBtn = diffViewer.querySelector('.pinokio-git-diff-revert-btn')
                if (resetBtn && revertUrl) {
                  resetBtn.addEventListener('click', () => {
                    const confirmed = confirm('Reset this file to the previous version?')
                    if (confirmed) {
                      showIframeView(revertUrl)
                    }
                  })
                }
              } catch (error) {
                console.error('Error fetching diff:', error)
                if (diffBody) {
                  diffBody.innerHTML = '<div class="pinokio-git-diff-empty-state">Error loading diff</div>'
                }
              }
            })
          })

          if (checkoutUrl) {
            const switchBtn = overlay.querySelector('.pinokio-git-commit-switch-btn')
            if (switchBtn) {
              switchBtn.addEventListener('click', () => {
                cleanupOverlay()
                showIframeView(checkoutUrl)
              })
            }
          }

          // Handle escape key
          escHandler = (e) => {
            if (e.key === 'Escape') {
              cleanupOverlay()
            }
          }
          document.addEventListener('keydown', escHandler)
        }

        const openCheckoutTerminal = (src) => {
          const overlay = document.createElement('div')
          overlay.className = 'pinokio-custom-terminal-overlay'
          overlay.innerHTML = `
        <div class="pinokio-custom-terminal-modal">
          <div class="pinokio-custom-terminal-header">
            <h3>Git Checkout</h3>
            <button class="pinokio-custom-terminal-close"></button>
          </div>
          <div class="pinokio-custom-terminal-body">
            <iframe src="${src}" frameborder="0"></iframe>
          </div>
        </div>
      `

          const cleanup = () => {
            document.removeEventListener('keydown', escHandler)
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay)
            }
          }

          const closeBtn = overlay.querySelector('.pinokio-custom-terminal-close')
          closeBtn.addEventListener('click', cleanup)

          overlay.addEventListener('click', (event) => {
            if (event.target === overlay) {
              cleanup()
            }
          })

          const escHandler = (event) => {
            if (event.key === 'Escape') {
              cleanup()
            }
          }

          document.addEventListener('keydown', escHandler)
          document.body.appendChild(overlay)
        }

        const createCommitItem = (commitData) => {
          const commit = commitData.commit
          const oid = commitData.oid
          const info = commitData.info || ''
          const author = commit.author
          const message = commit.message.trim()
          const shortMessage = message.split('\n')[0]
          const timestamp = new Date(author.timestamp * 1000)
          const timeAgo = (typeof timeago !== 'undefined' && timeago) ? timeago.format(timestamp) : timestamp.toLocaleDateString()

          return `
        <button type="button" class="pinokio-git-commit-item" data-commit-info="${info}">
          <div class="pinokio-git-commit-avatar">
            <i class="fa-solid fa-clock-rotate-left"></i>
          </div>
          <div class="pinokio-git-commit-content">
            <div class="pinokio-git-commit-message" title="${message.replace(/"/g, '&quot;')}">${shortMessage}</div>
            <div class="pinokio-git-commit-meta">
              <span class="pinokio-git-commit-author">${author.name}</span>
              <span class="pinokio-git-commit-time">${timeAgo}</span>
              <span class="pinokio-git-commit-hash" title="${oid}">${oid.substring(0, 7)}</span>
            </div>
          </div>
        </button>
      `
        }

        const createPublishModalLifecycle = () => {
          let disconnectHandler = null
          return {
            didOpen: (popup) => {
              const iframe = popup.querySelector('iframe')
              const footer = popup.querySelector('[data-publish-footer]')
              const closeBtn = popup.querySelector('[data-publish-close]')
              const viewBtn = popup.querySelector('[data-publish-view-remote]')
              const remoteHref = viewBtn ? viewBtn.getAttribute('data-remote-url') : null

              if (closeBtn) {
                closeBtn.addEventListener('click', () => Swal.close())
              }
              if (viewBtn) {
                if (remoteHref) {
                  viewBtn.addEventListener('click', (event) => {
                    event.preventDefault()
                    event.stopPropagation()
                    try {
                      const agent = document.body ? document.body.getAttribute('data-agent') : null
                      if (agent === 'electron') {
                        window.open(remoteHref, '_blank', 'browser')
                      } else {
                        window.open(remoteHref, '_blank')
                      }
                    } catch (error) {
                      console.error('Failed to open remote URL:', error)
                    }
                  })
                } else {
                  viewBtn.disabled = true
                  viewBtn.setAttribute('title', 'Remote URL not available')
                }
              }

              if (iframe) {
                iframe.dataset.forceVisible = 'true'
                iframe.classList.remove('hidden')
                iframe.removeAttribute('hidden')
              }

              disconnectHandler = (event) => {
                if (!iframe || event.source !== iframe.contentWindow) return
                if (!event.data || event.data.type !== 'pinokio:socket-closed') return
                if (!Swal.isVisible()) return
                if (footer && !footer.classList.contains('is-visible')) {
                  footer.classList.add('is-visible')
                }
                if (closeBtn) {
                  closeBtn.focus()
                }
                window.removeEventListener('message', disconnectHandler)
                disconnectHandler = null
              }

              window.addEventListener('message', disconnectHandler)
            },
            willClose: () => {
              if (disconnectHandler) {
                window.removeEventListener('message', disconnectHandler)
                disconnectHandler = null
              }
            }
          }
        }

        const showPublishModal = (target) => {
          let repoParam = null
          let repoLabel = null

          if (typeof target === 'string') {
            repoParam = target
          } else if (target && typeof target === 'object') {
            if (typeof target.repoParam === 'string') {
              repoParam = target.repoParam
            }
            if (typeof target.repoName === 'string' && target.repoName.trim().length > 0) {
              repoLabel = target.repoName.trim()
            }
          }

          if (!repoParam) {
            repoParam = activeRepoKey || null
          }

          let repoData = null
          if (repoParam) {
            repoData = repoStatusCache.get(repoParam) || null
            if (!repoData && lastRepoList.length > 0) {
              const fallbackMatch = lastRepoList.find((repo) => repo.repoParam === repoParam)
              if (fallbackMatch) {
                repoData = fallbackMatch
              }
            }
          }

          if (!repoLabel && repoData && typeof repoData.name === 'string') {
            repoLabel = repoData.name
          }
          if (!repoLabel && repoParam) {
            repoLabel = repoParam
          }
          if (!repoLabel) {
            repoLabel = workspaceName || 'Repository'
          }

          const pushUri = resolvePushUri(repoData)
          if (!pushUri) {
            Swal.fire({
              title: 'Error',
              text: 'Publish URL not available for this repository.',
              icon: 'error'
            })
            return
          }

          const remoteUrl = repoData && typeof repoData.url === 'string' ? repoData.url.trim() : ''
          const remoteWebUrl = buildRemoteWebUrl(remoteUrl)
          const remoteDisplay = remoteUrl ? escapeHtml(remoteUrl) : null
          const subtitle = `${escapeHtml(repoLabel)}  review your latest changes before publishing.`
          const remoteHtml = remoteDisplay ? `<div class="pinokio-fork-item-url">${remoteDisplay}</div>` : ''
          const timestampedUri = pushUri.includes('?')
            ? `${pushUri}&ts=${Date.now()}`
            : `${pushUri}?ts=${Date.now()}`
          const viewRemoteButton = remoteWebUrl
            ? `<button type="button" class="pinokio-modal-secondary-btn" data-publish-view-remote data-remote-url="${escapeHtml(remoteWebUrl)}">View on GitHub</button>`
            : ''

          const modalHtml = `
        <div class="pinokio-modal-surface">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">Publish to GitHub</div>
              <div class="pinokio-modal-subtitle">${subtitle}</div>
              ${remoteHtml}
            </div>
          </div>
          <div class="pinokio-modal-body pinokio-modal-body--iframe">
            <iframe src="${timestampedUri}"></iframe>
          </div>
          <div class="pinokio-modal-footer pinokio-modal-footer--publish" data-publish-footer>
            ${viewRemoteButton}
            <button type="button" class="pinokio-publish-close-btn" data-publish-close>Close</button>
          </div>
        </div>
      `

          const lifecycle = createPublishModalLifecycle()
          const publishModalPromise = Swal.fire({
            html: modalHtml,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(760px, 90vw)',
            showConfirmButton: false,
            showCloseButton: true,
            buttonsStyling: false,
            focusConfirm: false,
            didOpen: lifecycle.didOpen,
            willClose: lifecycle.willClose
          })

          reloadOnModalClose(publishModalPromise)
        }

        const showCreateModal = (options = {}) => {
          return showCreateRepoModal(options)
        }

        const showRemoteSelectionModal = (remotes, pushUri) => {
          const defaultRemote = remotes.find(r => r.remote === 'origin') || remotes[0]

          const remoteOptions = remotes.map(remote =>
            `<option value="${remote.remote}" ${remote.remote === defaultRemote.remote ? 'selected' : ''}>
          ${remote.remote} (${remote.url})
        </option>`
          ).join('')

          const modalHtml = `
        <div class="pinokio-modal-surface">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">Publish to GitHub</div>
              <div class="pinokio-modal-subtitle">Choose a remote and repository name for your push.</div>
            </div>
          </div>
          <div class="pinokio-modal-body">
            <div class="pinokio-modal-form">
              <div>
                <label class="pinokio-modal-label" for="remote-select">Select Remote</label>
                <select id="remote-select" class="pinokio-modal-input">
                  ${remoteOptions}
                </select>
              </div>
              <div>
                <label class="pinokio-modal-label" for="repo-name-input">Repository Name</label>
                <input id="repo-name-input" class="pinokio-modal-input" placeholder="Enter repository name" />
              </div>
            </div>
          </div>
        </div>
      `

          const remoteSelectionPromise = Swal.fire({
            html: modalHtml,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close',
              confirmButton: 'pinokio-modern-confirm',
              cancelButton: 'pinokio-modern-cancel'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(520px, 90vw)',
            buttonsStyling: false,
            showCloseButton: true,
            showConfirmButton: true,
            showCancelButton: true,
            confirmButtonText: 'Publish',
            cancelButtonText: 'Cancel',
            focusConfirm: false,
            preConfirm: () => {
              const selectedRemote = document.getElementById('remote-select').value
              const repoName = document.getElementById('repo-name-input').value.trim()

              if (!repoName) {
                Swal.showValidationMessage('Repository name is required')
                return false
              }

              return { remote: selectedRemote, name: repoName }
            }
          })

          reloadOnModalClose(remoteSelectionPromise, (result) => !result || result.isDismissed)

          remoteSelectionPromise.then((result) => {
            if (result.isConfirmed) {
              const { remote, name } = result.value
              showFinalPublishModal(pushUri, remote, name)
            }
          })
        }

        const showFinalPublishModal = (pushUri, remote, name) => {
          const urlParams = new URLSearchParams()
          urlParams.append('remote', remote)
          urlParams.append('name', name)

          const finalUri = `${pushUri}${pushUri.includes('?') ? '&' : '?'}${urlParams.toString()}`

          const lifecycle = createPublishModalLifecycle()
          const forkShellModalPromise = Swal.fire({
            html: `
          <div class="pinokio-modal-surface">
            <div class="pinokio-modal-header">
              <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
              <div class="pinokio-modal-heading">
                <div class="pinokio-modal-title">Publish to GitHub</div>
                <div class="pinokio-modal-subtitle">Remote: ${remote}  Repository: ${name}</div>
              </div>
            </div>
            <div class="pinokio-modal-body pinokio-modal-body--iframe">
              <iframe src="${finalUri}"></iframe>
            </div>
            <div class="pinokio-modal-footer pinokio-modal-footer--publish" data-publish-footer>
              <button type="button" class="pinokio-publish-close-btn" data-publish-close>Close</button>
            </div>
          </div>
        `,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(760px, 90vw)',
            showConfirmButton: false,
            showCloseButton: true,
            buttonsStyling: false,
            focusConfirm: false,
            didOpen: lifecycle.didOpen,
            willClose: lifecycle.willClose
          })

          reloadOnModalClose(forkShellModalPromise)
        }

        const showCreateRepoModal = (options = {}) => {
          const opts = typeof options === 'object' && options !== null ? options : {}
          const skipReload = Boolean(opts.skipReload)
          const modalHtml = `
        <div class="pinokio-modal-surface">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">Create repository</div>
              <div class="pinokio-modal-subtitle">Set up a new GitHub repository for this project.</div>
            </div>
          </div>
          <div class="pinokio-modal-body">
            <div class="pinokio-modal-form">
              <div>
                <label class="pinokio-modal-label" for="create-repo-name-input">Repository Name</label>
                <input id="create-repo-name-input" class="pinokio-modal-input" placeholder="Enter repository name" />
              </div>
              <div class="pinokio-modal-checkbox-row">
                <input type="checkbox" id="private-checkbox">
                <label for="private-checkbox">Private repository</label>
              </div>
            </div>
          </div>
        </div>
      `

          const createRepoModalPromise = Swal.fire({
            html: modalHtml,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close',
              confirmButton: 'pinokio-modern-confirm',
              cancelButton: 'pinokio-modern-cancel'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(520px, 90vw)',
            buttonsStyling: false,
            showCloseButton: false,
            showConfirmButton: true,
            showCancelButton: true,
            confirmButtonText: 'Create on GitHub',
            cancelButtonText: 'Cancel',
            allowOutsideClick: false,
            allowEscapeKey: false,
            focusConfirm: false,
            preConfirm: () => {
              const repoName = document.getElementById('create-repo-name-input').value.trim()
              const isPrivate = document.getElementById('private-checkbox').checked

              if (!repoName) {
                Swal.showValidationMessage('Repository name is required')
                return false
              }

              return { name: repoName, isPrivate: isPrivate }
            }
          })

          if (!skipReload) {
            reloadOnModalClose(createRepoModalPromise, (result) => !result || result.isDismissed)
          }

          return createRepoModalPromise.then((result) => {
            if (!result || !result.isConfirmed) {
              return { completed: false, action: 'cancel', result }
            }
            const { name, isPrivate } = result.value
            return showCreateRepoIframeModal(name, isPrivate, opts)
          })
        }

        const showCreateRepoIframeModal = (name, isPrivate, options = {}) => {
          const createUri = document.querySelector('#fs-status').getAttribute('data-create-uri')

          if (!createUri) {
            Swal.fire({
              title: 'Error',
              text: 'Create repository URL not available.',
              icon: 'error'
            })
            return Promise.resolve({ completed: false })
          }

          const urlParams = new URLSearchParams()
          urlParams.append('name', name)
          urlParams.append('visibility', isPrivate ? 'private' : 'public')

          const finalUri = `${createUri}${createUri.includes('?') ? '&' : '?'}${urlParams.toString()}`

          return new Promise((resolve) => {
            let resolved = false
            const finalize = (payload) => {
              if (resolved) {
                return
              }
              resolved = true
              resolve(payload)
            }

            Swal.fire({
              html: `
            <div class="pinokio-modal-surface">
              <div class="pinokio-modal-header">
                <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
                <div class="pinokio-modal-heading">
                  <div class="pinokio-modal-title">Create GitHub repository</div>
                  <div class="pinokio-modal-subtitle">${name}  ${isPrivate ? 'Private' : 'Public'}</div>
                </div>
              </div>
              <div class="pinokio-modal-body pinokio-modal-body--iframe">
                <iframe src="${finalUri}"></iframe>
              </div>
              <div class="pinokio-modal-footer pinokio-modal-footer--create">
                <button type="button" class="pinokio-modal-secondary-btn" data-create-cancel>Cancel</button>
                <button type="button" class="pinokio-publish-close-btn" data-create-next>Next</button>
              </div>
            </div>
          `,
              customClass: {
                popup: 'pinokio-modern-modal',
                htmlContainer: 'pinokio-modern-html',
                closeButton: 'pinokio-modern-close'
              },
              backdrop: 'rgba(9,11,15,0.65)',
              width: 'min(760px, 90vw)',
              showConfirmButton: false,
              showCancelButton: false,
              showCloseButton: false,
              buttonsStyling: false,
              allowOutsideClick: false,
              allowEscapeKey: false,
              focusConfirm: false,
              didOpen: (popup) => {
                const nextBtn = popup.querySelector('[data-create-next]')
                const cancelBtn = popup.querySelector('[data-create-cancel]')
                if (nextBtn) {
                  nextBtn.addEventListener('click', () => {
                    finalize({ completed: true, action: 'next', name, isPrivate })
                    Swal.close()
                  })
                }
                if (cancelBtn) {
                  cancelBtn.addEventListener('click', () => {
                    finalize({ completed: false, action: 'cancel', name, isPrivate })
                    Swal.close()
                  })
                }
              },
              willClose: () => {
                finalize({ completed: false, action: 'dismissed', name, isPrivate })
              }
            }).then(() => { })
          })
        }

        async function showForkModalForRepo(repoParam) {
          const key = typeof repoParam === 'string' && repoParam.length > 0 ? repoParam : (activeRepoKey || null)
          if (!key) {
            Swal.fire({
              title: 'No repository selected',
              text: 'Select a repository to fork from the dropdown.',
              icon: 'info'
            })
            return
          }

          let repo = repoStatusCache.get(key)
          if (!repo) {
            await check_git(true)
            repo = repoStatusCache.get(key)
          }

          if (!repo) {
            Swal.fire({
              title: 'Repository unavailable',
              text: 'The selected repository could not be found. Refresh Git status and try again.',
              icon: 'error'
            })
            return
          }

          if (!hasRemoteConfigured(repo)) {
            Swal.fire({
              title: 'Remote required',
              text: 'This repository does not have a remote configured, so it cannot be forked.',
              icon: 'info'
            })
            return
          }

          const forkUri = resolveForkUri(repo)
          if (!forkUri) {
            Swal.fire({
              title: 'Fork script unavailable',
              text: 'Unable to locate the fork script for this repository.',
              icon: 'error'
            })
            return
          }

          const defaultName = deriveForkDefaultName(repo)
          const remoteDisplay = repo.url ? escapeHtml(repo.url) : 'No remote detected'
          const remoteClass = repo.url ? 'pinokio-fork-item-url' : 'pinokio-fork-item-url empty'
          const nameInputId = 'pinokio-fork-name-input'
          const orgToggleId = 'pinokio-fork-org-toggle'
          const orgInputId = 'pinokio-fork-org-input'

          const modalHtml = `
        <div class="pinokio-modal-surface">
          <div class="pinokio-modal-header">
            <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
            <div class="pinokio-modal-heading">
              <div class="pinokio-modal-title">Fork repository</div>
              <div class="pinokio-modal-subtitle">${escapeHtml(repo.name || key)}</div>
            </div>
          </div>
            <div class="pinokio-modal-body">
              <div class="pinokio-fork-modal">
                <div class="pinokio-fork-item" data-disabled="false">
                  <div class="pinokio-fork-item-url ${remoteClass}">${remoteDisplay}</div>
                  <div class="pinokio-fork-name-input">
                  <label for="${nameInputId}">Fork name</label>
                  <input id="${nameInputId}" class="pinokio-modal-input" value="${escapeHtml(defaultName || '')}">
                </div>
                <div class="pinokio-fork-checkbox-row">
                  <input type="checkbox" id="${orgToggleId}" data-fork-org-toggle>
                  <label for="${orgToggleId}">Fork into organization</label>
                </div>
                <div class="pinokio-fork-org-input hidden" data-fork-org-section>
                  <label for="${orgInputId}">Organization</label>
                  <input id="${orgInputId}" class="pinokio-modal-input" placeholder="my-org">
                  <p class="pinokio-fork-org-hint">Provide an organization where you have permission to create repositories.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `

          const forkModalPromise = Swal.fire({
            html: modalHtml,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close',
              confirmButton: 'pinokio-modern-confirm',
              cancelButton: 'pinokio-modern-cancel'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(520px, 90vw)',
            buttonsStyling: false,
            showCloseButton: true,
            showCancelButton: true,
            showConfirmButton: true,
            confirmButtonText: 'Fork on GitHub',
            cancelButtonText: 'Cancel',
            focusConfirm: false,
            didOpen: (popup) => {
              const input = popup.querySelector(`#${nameInputId}`)
              if (input) {
                input.addEventListener('input', () => {
                  input.classList.remove('pinokio-modal-input--error')
                })
                input.focus()
                input.select()
              }
              const orgToggle = popup.querySelector('#' + orgToggleId)
              const orgSection = popup.querySelector('[data-fork-org-section]')
              const orgInput = popup.querySelector('#' + orgInputId)
              const syncOrgSection = () => {
                if (!orgSection) {
                  return
                }
                if (orgToggle && orgToggle.checked) {
                  orgSection.classList.remove('hidden')
                  if (orgInput) {
                    requestAnimationFrame(() => orgInput.focus())
                  }
                } else {
                  orgSection.classList.add('hidden')
                  if (orgInput) {
                    orgInput.classList.remove('pinokio-modal-input--error')
                  }
                }
              }
              if (orgToggle) {
                orgToggle.addEventListener('change', syncOrgSection)
                syncOrgSection()
              }
              if (orgInput) {
                orgInput.addEventListener('input', () => {
                  orgInput.classList.remove('pinokio-modal-input--error')
                })
              }
            },
            preConfirm: () => {
              const input = document.getElementById(nameInputId)
              const forkName = input ? input.value.trim() : ''
              if (!forkName) {
                if (input) {
                  input.classList.add('pinokio-modal-input--error')
                  setTimeout(() => input.focus(), 0)
                }
                Swal.showValidationMessage('Enter a repository name for the fork')
                return false
              }
              const orgToggle = document.getElementById(orgToggleId)
              const orgInput = document.getElementById(orgInputId)
              let orgValue = null
              if (orgToggle && orgToggle.checked) {
                orgValue = orgInput ? orgInput.value.trim() : ''
                if (!orgValue) {
                  if (orgInput) {
                    orgInput.classList.add('pinokio-modal-input--error')
                    setTimeout(() => orgInput.focus(), 0)
                  }
                  Swal.showValidationMessage('Enter the organization name or uncheck the option')
                  return false
                }
              }
              return {
                job: {
                  repoParam: key,
                  repoName: repo.name || key,
                  forkUri,
                  forkName,
                  remoteUrl: repo.url || '',
                  org: orgValue,
                }
              }
            }
          })

          reloadOnModalClose(forkModalPromise, (result) => !result || result.isDismissed)

          forkModalPromise.then((result) => {
            if (result.isConfirmed && result.value && result.value.job) {
              showForkShellModal(result.value.job)
            }
          })
        }

        function showForkShellModal(job) {
          if (!job || !job.forkUri) {
            return
          }

          const lifecycle = createPublishModalLifecycle()
          const forkNameValue = typeof job.forkName === 'string' && job.forkName.trim().length > 0
            ? job.forkName.trim()
            : deriveForkDefaultName({ name: job.repoName, url: job.remoteUrl })
          const queryParts = [`name=${encodeURIComponent(forkNameValue)}`]
          if (job.org) {
            queryParts.push(`org=${encodeURIComponent(job.org)}`)
          }
          queryParts.push(`ts=${Date.now()}`)
          const separator = job.forkUri.includes('?') ? '&' : '?'
          const finalUri = `${job.forkUri}${separator}${queryParts.join('&')}`

          const remoteDisplay = job.remoteUrl ? escapeHtml(job.remoteUrl) : 'No remote detected'
          const titleDisplay = job.repoName ? escapeHtml(job.repoName) : 'Repository'
          const forkDisplay = escapeHtml(forkNameValue)
          const subtitleParts = [titleDisplay, forkDisplay]
          if (job.org) {
            subtitleParts.push(`Org: ${escapeHtml(job.org)}`)
          }
          const subtitleHtml = subtitleParts.join('  ')
          const forkShellModalPromise = Swal.fire({
            html: `
          <div class="pinokio-modal-surface">
            <div class="pinokio-modal-header">
              <div class="pinokio-modal-icon"><i class="fa-brands fa-github"></i></div>
              <div class="pinokio-modal-heading">
                <div class="pinokio-modal-title">Fork on GitHub</div>
                <div class="pinokio-modal-subtitle">${subtitleHtml}</div>
                <div class="pinokio-fork-item-url">${remoteDisplay}</div>
              </div>
            </div>
            <div class="pinokio-modal-body pinokio-modal-body--iframe">
              <iframe src="${finalUri}"></iframe>
            </div>
            <div class="pinokio-modal-footer pinokio-modal-footer--publish" data-publish-footer>
              <button type="button" class="pinokio-publish-close-btn" data-publish-close>Close</button>
            </div>
          </div>
        `,
            customClass: {
              popup: 'pinokio-modern-modal',
              htmlContainer: 'pinokio-modern-html',
              closeButton: 'pinokio-modern-close'
            },
            backdrop: 'rgba(9,11,15,0.65)',
            width: 'min(760px, 94vw)',
            buttonsStyling: false,
            showConfirmButton: false,
            showCloseButton: true,
            focusConfirm: false,
            didOpen: lifecycle.didOpen,
            willClose: lifecycle.willClose
          })

          reloadOnModalClose(forkShellModalPromise)

          forkShellModalPromise.then(() => {
            setTimeout(() => {
              updateForkButton()
              check_git(true)
            }, 250)
          })
        }

        function handlePushLogin() {
          window.location.href = '/github'
        }
        const promptGitLogin = () => {
          Swal.fire({
            html: `
          <div class="pinokio-github-login">
            <div class="pinokio-github-login__icon"><i class="fa-brands fa-github"></i></div>
            <div class="pinokio-github-login__title">Log in to GitHub</div>
            <div class="pinokio-github-login__body">Connect your GitHub account to fork or publish this workspace.</div>
          </div>
        `,
            showCancelButton: true,
            confirmButtonText: 'Log in',
            cancelButtonText: 'Not now',
            reverseButtons: true,
            showCloseButton: true,
            focusConfirm: true,
            customClass: {
              popup: 'pinokio-modern-modal pinokio-github-login-modal',
              htmlContainer: 'pinokio-modern-html',
              confirmButton: 'pinokio-modern-confirm',
              cancelButton: 'pinokio-modern-cancel',
              closeButton: 'pinokio-modern-close'
            }
          }).then((result) => {
            if (result.isConfirmed) {
              handlePushLogin()
            }
          })
        }
        const requireGitLogin = (event) => {
          if (event) {
            event.preventDefault()
            event.stopPropagation()
          }
          promptGitLogin()
        }

        // Function to update publish/create button
        const updatePublishButton = async () => {
          if (!pushBtn) {
            latestGitIntegration = null
            updateForkButton()
            return
          }

          const labelEl = pushBtn.querySelector('.fs-status-title')
          const setLabel = (text) => {
            if (labelEl) {
              labelEl.textContent = text
            }
          }
          const detachHandlers = () => {
            pushBtn.removeEventListener('click', showPublishModal)
            pushBtn.removeEventListener('click', showCreateModal)
            pushBtn.removeEventListener('click', handlePushLogin)
            pushBtn.removeEventListener('click', requireGitLogin)
          }
          const enableDropdown = () => {
            pushBtn.classList.add('revealer')
            pushBtn.setAttribute('data-group', '#fs-push-menu')
          }
          const disableDropdown = () => {
            pushBtn.classList.remove('revealer')
            pushBtn.removeAttribute('data-group')
            const pushMenuEl = document.querySelector('#fs-push-menu')
            if (pushMenuEl && !pushMenuEl.classList.contains('hidden')) {
              pushMenuEl.classList.add('hidden')
            }
            setDropdownState(pushBtn, false)
          }

          const repos = Array.isArray(lastRepoList) && lastRepoList.length > 0 ? lastRepoList.slice() : Array.from(repoStatusCache.values())

          detachHandlers()

          const syncForkButton = () => {
            updateForkButton()
          }

          if (!historyUri) {
            setPublishMenuMessage('Git integration unavailable')
            setLabel('Publish')
            disableDropdown()
            const hasRepos = Array.isArray(repos) && repos.length > 0
            pushBtn.disabled = !hasRepos
            if (pushBtn.disabled) {
              pushBtn.classList.add('fs-status-btn--disabled')
            } else {
              pushBtn.classList.remove('fs-status-btn--disabled')
            }
            pushBtn.setAttribute('title', 'Git integration is not available')
            latestGitIntegration = null
            syncForkButton()
            return
          }

          if (!publishMenu) {
            setLabel('Publish')
            disableDropdown()
          } else if (!publishMenu.hasChildNodes()) {
            setPublishMenuMessage('Loading repositories...')
          }

          try {
            const response = await fetch(historyUri)
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`)
            }
            const data = await response.json()
            latestGitIntegration = data

            const isConnected = Boolean(data && data.connected)
            const emptyMessage = isConnected
              ? 'No Git repositories detected'
              : 'Connect GitHub to publish this workspace'
            renderPublishDropdown(repos, { emptyMessage })

            if (!isConnected) {
              setLabel('Publish')
              pushBtn.disabled = false
              pushBtn.classList.remove('fs-status-btn--disabled')
              pushBtn.setAttribute('title', 'Log in to GitHub to publish this workspace')
              disableDropdown()
              pushBtn.addEventListener('click', requireGitLogin)
              syncForkButton()
              return
            }

            if (!Array.isArray(repos) || repos.length === 0) {
              setLabel('Publish')
              pushBtn.disabled = true
              pushBtn.classList.add('fs-status-btn--disabled')
              pushBtn.setAttribute('title', 'No Git repositories detected')
              disableDropdown()
              syncForkButton()
              return
            }

            pushBtn.disabled = false
            pushBtn.classList.remove('fs-status-btn--disabled')

            setLabel('Publish')
            pushBtn.removeAttribute('title')
            enableDropdown()
            syncForkButton()
          } catch (error) {
            console.error('Error checking remotes:', error)
            setPublishMenuMessage('Git integration unavailable')
            setLabel('Publish')
            pushBtn.disabled = false
            pushBtn.classList.remove('fs-status-btn--disabled')
            pushBtn.setAttribute('title', 'Log in to GitHub to publish this workspace')
            disableDropdown()
            pushBtn.addEventListener('click', requireGitLogin)
            latestGitIntegration = null
            updateForkButton()
          }
        }

        // Initialize the publish/create button
        updatePublishButton()

        // If this page was opened explicitly to publish from the Backups screen,
        // auto-open the publish flow after the button has been initialized.
        try {
          const searchParams = new URLSearchParams(window.location.search || "")
          if (searchParams.get("pinokio.publish") === "1" && pushBtn) {
            setTimeout(() => {
              try {
                pushBtn.click()
                setTimeout(() => {
                  try {
                    const menu = document.getElementById("fs-push-menu")
                    if (!menu) return
                    const items = menu.querySelectorAll(".pinokio-publish-dropdown-item")
                    const target = Array.from(items).find((el) => {
                      const dataName = (el.getAttribute("data-name") || "").trim()
                      return dataName === workspaceName || dataName === (workspaceName + ".git")
                    }) || items[0]
                    if (target) {
                      target.click()
                    }
                  } catch (_) { }
                }, 300)
                try {
                  searchParams.delete("pinokio.publish")
                  const qs = searchParams.toString()
                  const newUrl = window.location.pathname + (qs ? `?${qs}` : "") + window.location.hash
                  window.history.replaceState(null, "", newUrl)
                } catch (_) { }
              } catch (_) { }
            }, 500)
          }
        } catch (_) { }

        check_git()
        setInterval(() => {
          if (typeof check_git === 'function') {
            check_git()
          }
        }, 5000)
          <% } %>

            setInterval(() => {
              try {
                let foreground_frame = document.querySelector("iframe:not(.hidden)")
                let selected_tab = document.querySelector("aside .frame-link.selected")
                let needs_selection
                if (selected_tab) {
                  if (foreground_frame) {
                    const selectedTarget = selected_tab.tagName === "A" ? selected_tab.getAttribute("target") : ""
                    const frameName = foreground_frame.name || ""
                    if (targetsMatch(selectedTarget, frameName)) {
                      // do nothing
                    } else {
                      selected_tab.click()
                    }
                  } else {
                    selected_tab.click()
                  }
                } else {
                  if (foreground_frame) {
                    const frameName = foreground_frame.name || ""
                    const links = Array.from(document.querySelectorAll("aside .frame-link"))
                    const match = links.find((link) => {
                      if (link.tagName !== "A") {
                        return false
                      }
                      const linkTarget = link.getAttribute("target") || ""
                      return targetsMatch(linkTarget, frameName)
                    })
                    if (match) {
                      match.click()
                    }
                  }
                }
              } catch (e) {
              }
            }, 1000)

  </script>
  <% } %>
    <script>
          (() => {
            const aside = document.querySelector(".appcanvas > aside")
            if (!aside) {
              return
            }

            const collapsedClass = "appcanvas-aside-collapsed"
            const animatingClass = "appcanvas-aside-animating"
            const collapseDuration = 420
            const collapseEasing = "cubic-bezier(0.22, 1, 0.36, 1)"
            const expandEasing = "cubic-bezier(0.18, 0.85, 0.4, 1)"

            let transitionHandler = null
            let queuedFrame = null

            const clearAnimation = () => {
              if (transitionHandler) {
                aside.removeEventListener("transitionend", transitionHandler)
                transitionHandler = null
              }
              if (queuedFrame !== null) {
                cancelAnimationFrame(queuedFrame)
                queuedFrame = null
              }
              aside.classList.remove(animatingClass)
              aside.style.transition = ""
              aside.style.height = ""
              aside.style.opacity = ""
            }

            const finish = (minimized) => {
              aside.classList.toggle(collapsedClass, minimized)
              aside.classList.remove(animatingClass)
              aside.style.transition = ""
              aside.style.height = ""
              aside.style.opacity = ""
              aside.dataset.asideState = minimized ? "collapsed" : "expanded"
            }

            const collapse = (immediate) => {
              if (aside.dataset.asideState === "collapsed" && !immediate) {
                return
              }
              clearAnimation()
              if (immediate) {
                finish(true)
                return
              }
              const startHeight = aside.getBoundingClientRect().height
              if (startHeight <= 0.5) {
                finish(true)
                return
              }

              aside.classList.add(animatingClass)
              aside.style.height = `${startHeight}px`
              aside.style.opacity = getComputedStyle(aside).opacity || "1"
              aside.dataset.asideState = "animating"

              queuedFrame = requestAnimationFrame(() => {
                queuedFrame = null
                aside.style.transition = `height ${collapseDuration}ms ${collapseEasing}, opacity ${collapseDuration - 120}ms ease`
                aside.style.height = "0px"
                aside.style.opacity = "0"
              })

              transitionHandler = (event) => {
                if (event.target !== aside || event.propertyName !== "height") {
                  return
                }
                aside.removeEventListener("transitionend", transitionHandler)
                transitionHandler = null
                finish(true)
              }
              aside.addEventListener("transitionend", transitionHandler)
            }

            const expand = (immediate) => {
              if (aside.dataset.asideState === "expanded" && !immediate) {
                return
              }
              clearAnimation()
              if (immediate) {
                finish(false)
                return
              }

              aside.classList.remove(collapsedClass)
              const targetHeight = aside.scrollHeight
              aside.classList.add(animatingClass)
              aside.style.height = "0px"
              aside.style.opacity = "0"
              aside.dataset.asideState = "animating"

              aside.offsetHeight

              queuedFrame = requestAnimationFrame(() => {
                queuedFrame = null
                aside.style.transition = `height ${collapseDuration}ms ${expandEasing}, opacity ${collapseDuration - 140}ms ease`
                aside.style.height = `${targetHeight}px`
                aside.style.opacity = ""
              })

              transitionHandler = (event) => {
                if (event.target !== aside || event.propertyName !== "height") {
                  return
                }
                aside.removeEventListener("transitionend", transitionHandler)
                transitionHandler = null
                finish(false)
              }
              aside.addEventListener("transitionend", transitionHandler)
            }

            const setAside = (minimized, immediate) => {
              if (minimized) {
                collapse(immediate)
              } else {
                expand(immediate)
              }
            }

            const header = document.querySelector("header.navheader")
            const initialMinimized = !!(header && header.classList.contains("minimized"))
            setAside(initialMinimized, true)

            document.addEventListener("pinokio:header-state", (event) => {
              if (!event || !event.detail) {
                return
              }
              const { minimized, phase } = event.detail
              if (phase === "init") {
                setAside(!!minimized, true)
                return
              }
              if (phase === "start") {
                setAside(!!minimized, false)
                return
              }
              if (phase === "settled") {
                clearAnimation()
                finish(!!minimized)
              }
            })
          })()
    </script>
    <script src="/tab-idle-notifier.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        if (window.__TAURI__) {
          const { event, window: tauriWindow, process: tauriProcess } = window.__TAURI__;

          event.listen('close-requested', async () => {
            if (typeof Swal === 'undefined') {
              if (confirm("Exit Application? OK to Quit, Cancel to Minimize.")) {
                await tauriProcess.exit(0);
              } else {
                await tauriWindow.appWindow.hide();
              }
              return;
            }

            const isDark = document.body.classList.contains('dark');
            try {
              const result = await Swal.fire({
                title: 'Exit Application?',
                text: "Do you really want to quit or minimize to tray?",
                icon: 'question',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'Quit',
                denyButtonText: 'Minimize to Tray',
                cancelButtonText: 'Cancel',
                background: isDark ? '#1F2937' : '#FFFFFF',
                color: isDark ? '#FFFFFF' : '#000000',
                reverseButtons: true
              });
              if (result.isConfirmed) {
                await tauriProcess.exit(0);
              } else if (result.isDenied) {
                await tauriWindow.appWindow.hide();
              }
            } catch (e) {
              console.error("[Pinokio] Swal Error:", e);
              if (confirm("Exit Application?")) {
                await tauriProcess.exit(0);
              }
            }
          });
        }
      });
    </script>

</body>

</html>