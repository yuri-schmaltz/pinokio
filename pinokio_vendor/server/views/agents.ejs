<html>

<head>
  <title>Pinokio Agents</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="/xterm.min.css" rel="stylesheet" />
  <link href="/css/fontawesome.min.css" rel="stylesheet">
  <link href="/css/solid.min.css" rel="stylesheet">
  <link href="/css/regular.min.css" rel="stylesheet">
  <link href="/css/brands.min.css" rel="stylesheet">
  <link href="/markdown.css" rel="stylesheet" />
  <link href="/noty.css" rel="stylesheet" />
  <link href="/urldropdown.css" rel="stylesheet" />
  <link href="/style.css" rel="stylesheet" />
  <% if (agent==="electron" ) { %>
    <link href="/electron.css" rel="stylesheet" />
    <% } %>
      <style>
        body.plugin-page main {
          display: flex;
        }

        body.plugin-page aside {
          width: 200px;
          display: block;
          flex-shrink: 0;
        }

        body.plugin-page aside .tab {
          display: flex;
          align-items: center;
          gap: 5px;
          color: inherit;
          text-decoration: none;
          padding: 10px;
          font-size: 12px;
          opacity: 0.5;
          border-left: 10px solid transparent;
          transition: color 0.2s ease, opacity 0.2s ease;
        }

        body.plugin-page aside .tab.selected {
          font-weight: 600;
          opacity: 1;
        }

        body.plugin-page aside .tab i {
          text-align: center;
        }

        body.plugin-page .plugin-container {
          flex: 1;
          padding: 30px 40px;
          box-sizing: border-box;
        }

        body.plugin-page .btn-tab {
          display: flex;
          align-items: center;
          gap: 5px;
        }

        body.plugin-page .btn-tab .btn {
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .plugin-container h1 {
          display: flex;
          align-items: center;
          gap: 10px;
          margin: 0 0 20px;
        }

        /*
.plugin-container h1 i {
  color: rgba(127, 91, 243, 0.9);
}
*/
        .plugin-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
          gap: 14px;
        }

        .plugin-category-layout {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 24px;
        }

        .plugin-category {
          display: flex;
          flex-direction: column;
        }

        .plugin-category-header {
          display: flex;
          flex-direction: column;
          gap: 4px;
          margin-bottom: 12px;
        }

        .plugin-category-title {
          font-size: 30px;
          font-weight: 700;
          margin: 0;
        }

        .plugin-category-subtitle {
          font-size: 12px;
          opacity: 0.6;
          text-transform: uppercase;
          letter-spacing: 0.08em;
        }

        .plugin-card {
          display: flex;
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
          padding: 12px;
          border-radius: 10px;
          background: rgba(0, 0, 0, 0.03);
          cursor: default;
          transition: background 0.15s ease;
          text-decoration: none;
          color: inherit;
          min-height: 68px;
        }

        .plugin-card:hover,
        .plugin-card:focus-within {
          background: rgba(0, 0, 0, 0.08);
        }

        body.dark .plugin-card {
          background: rgba(255, 255, 255, 0.05);
          color: white;
        }

        body.dark .plugin-card:hover,
        body.dark .plugin-card:focus-within {
          background: rgba(255, 255, 255, 0.12);
        }

        .plugin-card img,
        .plugin-card .plugin-icon {
          width: 44px;
          height: 44px;
          border-radius: 8px;
          object-fit: cover;
          flex-shrink: 0;
          background: white;
        }

        body.dark .plugin-card img,
        body.dark .plugin-card .plugin-icon {
          background: rgba(255, 255, 255, 0.08);
        }

        .plugin-card .plugin-icon {
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          color: rgba(0, 0, 0, 0.65);
        }

        body.dark .plugin-card .plugin-icon {
          color: rgba(255, 255, 255, 0.85);
        }

        .plugin-card .plugin-details {
          display: flex;
          flex-direction: column;
          gap: 4px;
          flex: 1;
        }

        .plugin-card .plugin-top {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .plugin-card .plugin-footer {
          display: flex;
          justify-content: flex-end;
        }

        .plugin-card h2 {
          margin: 0;
          font-size: 15px;
          font-weight: 600;
        }

        .plugin-card .subtitle {
          font-size: 12px;
          opacity: 0.65;
        }

        body.dark .plugin-card .subtitle {
          opacity: 0.75;
        }

        .plugin-card .plugin-info {
          background: none;
          border: none;
          color: rgba(0, 0, 0, 0.55);
          padding: 6px;
          border-radius: 18px;
          cursor: pointer;
          transition: background 0.15s ease, color 0.15s ease;
        }

        body.dark .plugin-card .plugin-info {
          color: rgba(255, 255, 255, 0.7);
        }

        .plugin-card .plugin-info:hover,
        .plugin-card .plugin-info:focus-visible {
          background: rgba(0, 0, 0, 0.08);
          color: rgba(0, 0, 0, 0.9);
        }

        body.dark .plugin-card .plugin-info:hover,
        body.dark .plugin-card .plugin-info:focus-visible {
          background: rgba(255, 255, 255, 0.18);
          color: rgba(255, 255, 255, 0.95);
        }

        .plugin-card .plugin-actions {
          margin-left: auto;
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          justify-content: flex-end;
        }

        .plugin-card .plugin-action-button {
          padding: 8px 12px;
          border-radius: 8px;
          border: 1px solid rgba(0, 0, 0, 0.08);
          background: white;
          color: rgba(0, 0, 0, 0.8);
          cursor: pointer;
          font-weight: 600;
          transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
        }

        body.dark .plugin-card .plugin-action-button {
          background: rgba(255, 255, 255, 0.08);
          border-color: rgba(255, 255, 255, 0.16);
          color: white;
        }

        .plugin-card .plugin-action-button:hover,
        .plugin-card .plugin-action-button:focus-visible {
          background: rgba(127, 91, 243, 0.12);
          border-color: rgba(127, 91, 243, 0.45);
          color: rgba(0, 0, 0, 0.9);
          outline: none;
        }

        body.dark .plugin-card .plugin-action-button:hover,
        body.dark .plugin-card .plugin-action-button:focus-visible {
          color: white;
          background: rgba(127, 91, 243, 0.25);
          border-color: rgba(127, 91, 243, 0.65);
        }

        .plugin-card .plugin-action-button:active {
          transform: translateY(1px);
        }

        :root {
          --pinokio-modal-bg: #ffffff;
          --pinokio-modal-text: #0f172a;
          --pinokio-modal-icon-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(59, 130, 246, 0.03));
          --pinokio-modal-icon-color: #2563eb;
          --pinokio-modal-subtitle: rgba(71, 85, 105, 0.75);
          --pinokio-modal-body-bg: rgba(241, 245, 249, 0.9);
        }

        body.dark {
          --pinokio-modal-bg: #0f172a;
          --pinokio-modal-text: #e2e8f0;
          --pinokio-modal-icon-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.05));
          --pinokio-modal-icon-color: #60a5fa;
          --pinokio-modal-subtitle: rgba(148, 163, 184, 0.85);
          --pinokio-modal-body-bg: rgba(15, 23, 42, 0.6);
        }

        .pinokio-modern-modal.swal2-popup {
          padding: 0 !important;
          border-radius: 20px !important;
          background: var(--pinokio-modal-bg) !important;
          box-shadow: 0 32px 80px rgba(15, 23, 42, 0.25);
        }

        body.dark .pinokio-modern-modal.swal2-popup {
          box-shadow: 0 40px 120px rgba(2, 8, 23, 0.7);
        }

        .pinokio-modern-html {
          padding: 0 !important;
        }

        .pinokio-modern-close {
          color: rgba(71, 85, 105, 0.65) !important;
          top: 12px !important;
          right: 12px !important;
        }

        body.dark .pinokio-modern-close {
          color: rgba(226, 232, 240, 0.6) !important;
        }

        .pinokio-modern-close:hover {
          background: rgba(148, 163, 184, 0.18) !important;
          color: #0f172a !important;
        }

        body.dark .pinokio-modern-close:hover {
          background: rgba(148, 163, 184, 0.12) !important;
          color: #f8fafc !important;
        }

        .pinokio-modal-surface {
          background: var(--pinokio-modal-bg);
          color: var(--pinokio-modal-text);
          border-radius: 20px;
          overflow: hidden;
        }

        .pinokio-modal-header {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 22px 24px 10px;
        }

        .pinokio-modal-icon {
          width: 48px;
          height: 48px;
          border-radius: 14px;
          background: var(--pinokio-modal-icon-bg);
          color: var(--pinokio-modal-icon-color);
          display: grid;
          place-items: center;
          font-size: 22px;
        }

        .pinokio-modal-heading {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .pinokio-modal-title {
          font-size: 20px;
          font-weight: 700;
          color: var(--pinokio-modal-text);
        }

        .pinokio-modal-subtitle {
          font-size: 13px;
          color: var(--pinokio-modal-subtitle);
        }

        .pinokio-modal-body {
          padding: 14px 24px 12px;
          background: var(--pinokio-modal-body-bg);
        }

        .pinokio-modal-body--iframe {
          padding: 14px 24px 12px;
        }

        .pinokio-modal-body--iframe iframe {
          width: 100%;
          height: 440px;
          border: none;
          border-radius: 12px;
          background: inherit;
        }

        .pinokio-modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 10px;
          padding: 0 24px 18px;
          background: var(--pinokio-modal-bg);
        }

        .pinokio-modal-footer--publish {
          align-items: center;
        }

        .pinokio-publish-close-btn,
        .pinokio-modal-secondary-btn {
          border: none;
          border-radius: 10px;
          padding: 9px 14px;
          font-weight: 600;
          cursor: pointer;
          background: rgba(0, 0, 0, 0.08);
          color: var(--pinokio-modal-text);
        }

        body.dark .pinokio-publish-close-btn,
        body.dark .pinokio-modal-secondary-btn {
          background: rgba(255, 255, 255, 0.12);
          color: var(--pinokio-modal-text);
        }

        .pinokio-publish-close-btn:hover,
        .pinokio-modal-secondary-btn:hover {
          background: rgba(127, 91, 243, 0.18);
        }

        body.dark .pinokio-publish-close-btn:hover,
        body.dark .pinokio-modal-secondary-btn:hover {
          background: rgba(127, 91, 243, 0.25);
        }

        .plugin-card .disclosure-indicator {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 18px;
          color: rgba(0, 0, 0, 0.35);
          pointer-events: none;
          transition: transform 0.15s ease, color 0.15s ease;
        }

        .plugin-card:hover .disclosure-indicator,
        .plugin-card:focus-within .disclosure-indicator {
          transform: translateX(2px);
          color: rgba(0, 0, 0, 0.65);
        }

        body.dark .plugin-card .disclosure-indicator {
          color: rgba(255, 255, 255, 0.4);
        }

        body.dark .plugin-card:hover .disclosure-indicator,
        body.dark .plugin-card:focus-within .disclosure-indicator {
          color: rgba(255, 255, 255, 0.85);
        }

        .plugin-empty {
          padding: 35px;
          border-radius: 12px;
          border: 1px dashed rgba(0, 0, 0, 0.12);
          background: rgba(0, 0, 0, 0.02);
          text-align: center;
        }

        .plugin-empty.plugin-empty-category {
          padding: 20px;
        }

        body.dark .plugin-empty {
          border-color: rgba(255, 255, 255, 0.16);
          background: rgba(255, 255, 255, 0.04);
        }

        .plugin-empty p {
          margin: 0 0 12px;
        }

        .plugin-empty code {
          font-weight: 600;
        }

        .plugin-modal-overlay {
          z-index: 900;
        }

        .plugin-modal-overlay .url-modal-content {
          max-width: 520px;
        }

        .plugin-modal-overlay .plugin-modal-dropdown {
          max-height: 360px;
          overflow-y: auto;
          margin-top: 14px;
          position: static;
          display: block;
          border: 1px solid rgba(0, 0, 0, 0.08);
          border-radius: 10px;
          background: inherit;
          top: auto;
          left: auto;
          right: auto;
        }

        .plugin-modal-overlay .plugin-modal-dropdown .url-dropdown-item {
          border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .plugin-modal-overlay .plugin-modal-dropdown .url-dropdown-item:last-child {
          border-bottom: none;
        }

        body.dark .plugin-modal-overlay .url-modal-content {
          background: rgba(25, 26, 27, 0.98);
        }

        body.dark .plugin-modal-overlay .plugin-modal-dropdown {
          border-color: rgba(255, 255, 255, 0.15);
          background: inherit;
        }

        body.dark .plugin-modal-overlay .plugin-modal-dropdown .url-dropdown-item {
          border-bottom-color: rgba(255, 255, 255, 0.12);
        }

        .plugin-option {
          display: flex;
          flex-direction: row;
          gap: 10px;
          align-items: center;
        }

        .plugin-option .option-icon {
          width: 26px;
          height: 26px;
          border-radius: 6px;
          background: rgba(0, 0, 0, 0.08);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          flex-shrink: 0;
        }

        .plugin-option img.option-icon {
          object-fit: cover;
          background: white;
        }

        body.dark .plugin-option .option-icon {
          background: rgba(255, 255, 255, 0.12);
        }

        .plugin-option .option-body {
          display: flex;
          flex-direction: column;
        }

        .plugin-option .option-name {
          font-weight: 600;
        }

        .plugin-option .option-path {
          font-size: 12px;
          opacity: 0.7;
        }

        .plugin-option .option-description {
          font-size: 12px;
          opacity: 0.62;
          margin-top: 2px;
        }

        .plugin-option.selected {
          border: 1px solid rgba(127, 91, 243, 0.6);
          background: rgba(127, 91, 243, 0.08);
        }

        body.dark .plugin-option.selected {
          border-color: rgba(127, 91, 243, 0.8);
          background: rgba(127, 91, 243, 0.18);
        }

        .plugin-option:hover {
          background: rgba(0, 0, 0, 0.04);
        }

        body.dark .plugin-option:hover {
          background: rgba(255, 255, 255, 0.08);
        }

        .plugin-modal-overlay .url-modal-input {
          margin-top: 18px;
        }

        @media (max-width: 800px) {
          body.plugin-page .plugin-container {
            padding: 20px;
          }

          .plugin-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          }
        }

        @media (max-width: 900px) {
          .plugin-category-layout {
            grid-template-columns: 1fr;
          }
        }

        @media (max-width: 600px) {

          /*
  body.plugin-page main {
    flex-direction: column;
  }
  */
          body.plugin-page aside {
            width: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0px;
            padding: 0 10px;
            flex-direction: column;
          }

          body.plugin-page aside .btn-tab {
            flex-direction: column;
            padding: 10px 0;
          }

          body.plugin-page aside .tab {
            border-left: none;
            opacity: 1;
            flex-direction: column;
            padding: 10px;
            margin: 0;
          }

          body.plugin-page aside .caption {
            display: none;
          }

          body.plugin-page .btn-tab {
            width: 100%;
            justify-content: center;
            gap: 8px;
          }
        }

        .pinokio-install-modal.swal2-popup {
          padding: 30px;
          text-align: left;
        }

        .pinokio-install-modal .swal2-title {
          text-align: left;
          padding: 0;
          margin-bottom: 20px;
          font-size: 20px;
        }

        .pinokio-install-modal .swal2-input-label {
          text-align: left;
          justify-content: flex-start;
          margin: 0 0 10px 0;
          font-size: 14px;
          font-weight: 600;
        }

        .pinokio-install-modal .swal2-input {
          margin: 0 0 20px 0;
          height: 44px;
          font-size: 14px;
        }

        .pinokio-install-modal .swal2-actions {
          justify-content: flex-end;
          margin: 0;
        }
      </style>
      <% const serializedPlugins=pluginMenu.map((plugin)=> {
        const hrefValue = plugin.href || ''
        let pluginPath = plugin.src || ''
        const extraParams = []
        if (hrefValue) {
        try {
        const parsed = new URL(hrefValue.startsWith('http') ? hrefValue : `http://localhost${hrefValue}`)
        if (!pluginPath) {
        pluginPath = parsed.pathname.replace(/^\/run/, '') || ''
        }
        parsed.searchParams.forEach((value, key) => {
        if (key === 'cwd') {
        return
        }
        extraParams.push([key, value])
        })
        } catch (err) {
        console.warn('Failed to parse plugin href for serialization', hrefValue, err)
        }
        }
        if (pluginPath && !pluginPath.startsWith('/')) {
        pluginPath = `/${pluginPath}`
        }
        return {
        title: plugin.title || plugin.text || plugin.name || 'Plugin',
        description: plugin.description || '',
        href: hrefValue,
        link: plugin.link || '',
        image: plugin.image || null,
        icon: plugin.icon || null,
        pluginPath,
        extraParams,
        hasInstall: Array.isArray(plugin.install)
        }
        }) %>
        <script src="/ui_service.js"></script>
</head>

<body class='<%=theme%> plugin-page' data-agent="<%=agent%>">
  <header class='navheader grabbable'>
    <h1>
      <span class="sr-only">Agents</span>
      <a class='home' href="/home" aria-label="Pinokio Home"><img class='icon' src="/pinokio-black.png"
          alt="Pinokio"></a>
      <button class='btn2' id='minimize-header' data-tippy-content="fullscreen" title='fullscreen'
        aria-label="Toggle Fullscreen">
        <div><i class="fa-solid fa-expand"></i></div>
      </button>
      <button class='btn2' id='back' data-tippy-content="back" aria-label="Go Back">
        <div><i class="fa-solid fa-chevron-left"></i></div>
      </button>
      <button class='btn2' id='forward' data-tippy-content="forward" aria-label="Go Forward">
        <div><i class="fa-solid fa-chevron-right"></i></div>
      </button>
      <button class='btn2' id='refresh-page' data-tippy-content="refresh" aria-label="Refresh Page">
        <div><i class="fa-solid fa-rotate-right"></i></div>
      </button>
      <button class='btn2' id='screenshot' data-tippy-content="screen capture" aria-label="Capture Screenshot"><i
          class="fa-solid fa-camera"></i></button>
      <button class='btn2' id='inspector' data-tippy-content="X-ray mode" aria-label="Inspect Element"><i
          class="fa-solid fa-eye"></i></button>
      <div class='flexible'></div>
      <a class='btn2' href="/columns" data-tippy-content="split into 2 columns" aria-label="Split Columns">
        <div><i class="fa-solid fa-table-columns"></i></div>
      </a>
      <a class='btn2' href="/rows" data-tippy-content="split into 2 rows" aria-label="Split Rows">
        <div><i class="fa-solid fa-table-columns fa-rotate-270"></i></div>
      </a>
      <button class='btn2' id='new-window' data-tippy-content="open a new window" title='open a new window'
        data-agent="<%=agent%>" aria-label="Open New Window">
        <div><i class="fa-solid fa-plus"></i></div>
      </button>
      <button class='btn2 hidden' id='close-window' data-tippy-content='close this section' aria-label="Close Window">
        <div><i class="fa-solid fa-xmark"></i></div>
      </button>
    </h1>
  </header>
  <main class='plugin-main fade-in'>
    <div class='plugin-container container'>
      <h1 style="display: flex; align-items: center;">
        <div><i class="fa-solid fa-robot"></i>Agents</div>
        <button class="btn" onclick="installAgent(event)"
          style="margin-left: auto; display: flex; align-items: center; gap: 5px;">
          <i class="fa-solid fa-download"></i> Install
        </button>
      </h1>
      <% const pluginCategories=pluginMenu.reduce((acc, pluginItem, index)=> {
        const runs = Array.isArray(pluginItem.run) ? pluginItem.run : []
        const hasExec = runs.some((step) => step && step.method === 'exec')
        const hasShellRun = runs.some((step) => step && step.method === 'shell.run')
        const hasAppLaunch = runs.some((step) => step && step.method === 'app.launch')
        if (hasExec) {
        acc.ide.push({ pluginItem, index })
        } else if (hasAppLaunch) {
        acc.ide.push({ pluginItem, index })
        } else if (hasShellRun) {
        acc.cli.push({ pluginItem, index })
        } else {
        acc.cli.push({ pluginItem, index })
        }
        return acc
        }, { ide: [], cli: [] }) %>
        <% if (pluginMenu.length===0) { %>
          <div class='plugin-empty'>
            <p>No agents found. Clone or add agent definitions under <code>~/pinokio/plugin</code> to see them listed
              here.</p>
            <a class='btn' href="/home?mode=download"><i class="fa-solid fa-download"></i> Download Agents</a>
          </div>
          <% } else { %>
            <div class='plugin-category-layout'>
              <% [ { key: 'ide' , title: 'IDE' , subtitle: 'Launch externally' }, { key: 'cli' , title: 'CLI' ,
                subtitle: 'Launch in Pinokio' } ].forEach(({ key, title, subtitle })=> {
                const items = pluginCategories[key] || []
                %>
                <section class='plugin-category' aria-label="<%=title%> agents">
                  <div class='plugin-category-header'>
                    <h2 class='plugin-category-title'>
                      <%=title%>
                    </h2>
                    <div class='plugin-category-subtitle'>
                      <%=subtitle%>
                    </div>
                  </div>
                  <% if (items.length) { %>
                    <div class='plugin-grid'>
                      <% items.forEach(({ pluginItem, index })=> { %>
                        <div class='plugin-card item-card-hover' data-plugin-index="<%=index%>">
                          <div class="plugin-top">
                            <% if (pluginItem.image) { %>
                              <img src="<%=pluginItem.image%>"
                                alt="<%=pluginItem.title || pluginItem.text || 'Plugin'%> icon">
                              <% } else if (pluginItem.icon) { %>
                                <div class='plugin-icon'><i class="<%=pluginItem.icon%>"></i></div>
                                <% } else { %>
                                  <div class='plugin-icon'><i class="fa-solid fa-robot"></i></div>
                                  <% } %>
                                    <div class='plugin-details'>
                                      <h2>
                                        <%=pluginItem.title || pluginItem.text || pluginItem.name || 'Plugin' %>
                                      </h2>
                                      <% if (pluginItem.description) { %>
                                        <div class='subtitle'>
                                          <%=pluginItem.description%>
                                        </div>
                                        <% } %>
                                    </div>
                          </div>
                          <div class="plugin-footer">
                            <div class="plugin-actions">
                              <button type="button" class="plugin-action-button" data-action="open">Open in</button>
                              <% if (Array.isArray(pluginItem.install)) { %>
                                <button type="button" class="plugin-action-button"
                                  data-plugin-action="install">Install</button>
                                <% } %>
                                  <% if (Array.isArray(pluginItem.uninstall)) { %>
                                    <button type="button" class="plugin-action-button"
                                      data-plugin-action="uninstall">Uninstall</button>
                                    <% } %>
                                      <% if (Array.isArray(pluginItem.update)) { %>
                                        <button type="button" class="plugin-action-button"
                                          data-plugin-action="update">Update</button>
                                        <% } %>
                            </div>
                          </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                      <div class='plugin-empty plugin-empty-category'>
                        <p>No <%=title%> agents available.</p>
                      </div>
                      <% } %>
                </section>
                <% }) %>
            </div>
            <% } %>
    </div>
    <aside>
      <div class='btn-tab'>
        <button type='button' class='btn' id='create-launcher-button'><i class="fa-solid fa-plus"></i>
          <div class='caption'>Create</div>
        </button>
        <a class='btn' id='explore' href="/home?mode=explore"><i class="fa-solid fa-globe"></i>
          <div class='caption'>Discover</div>
        </a>
      </div>
      <a href="/home" class='tab'><i class='fas fa-laptop-code'></i>
        <div class='caption'>This machine</div>
      </a>
      <a href="/network" class='tab'><i class="fa-solid fa-wifi"></i>
        <div class='caption'>Local network</div>
      </a>
      <% if (list.length> 0) { %>
        <% let brands={ win32: "windows" , darwin: "apple" , linux: "Linux" } %>
          <% list.forEach(({ host, name, platform })=> { %>
            <a href="/net/<%=name%>" class='submenu tab'><i class="fa-brands fa-<%=brands[platform]%>"></i>
              <div class='caption'>
                <%=name%> (<%=current_host===host ? 'this machine' : host%>)
              </div>
            </a>
            <% }) %>
              <% } %>
                <a href="/connect" class='tab'><i class="fa-solid fa-plug"></i>
                  <div class='caption'>Login</div>
                </a>
                <a class='tab' href="<%=portal%>" target="_blank"><i class="fa-solid fa-question"></i>
                  <div class='caption'>Help</div>
                </a>
                <a class='tab' id='genlog' href="/logs"><i class="fa-solid fa-laptop-code"></i>
                  <div class='caption'>Logs</div>
                </a>
                <a class='tab' href="/checkpoints"><i class="fa-solid fa-clock-rotate-left"></i>
                  <div class='caption'>Checkpoints</div>
                </a>
                <a class='tab' href="/screenshots"><i class="fa-solid fa-camera"></i>
                  <div class='caption'>Screenshots</div>
                </a>
                <a class='tab' href="/tools"><i class="fa-solid fa-toolbox"></i>
                  <div class='caption'>Installed Tools</div>
                </a>
                <a class='tab selected' href="/agents"><i class="fa-solid fa-robot"></i>
                  <div class='caption'>Agents</div>
                </a>
                <a class='tab' href="/home?mode=settings"><i class="fa-solid fa-gear"></i>
                  <div class='caption'>Settings</div>
                </a>
                <%- include('partials/peer_access_points', { peer_access_points, peer_url, peer_qr }) %>
    </aside>
  </main>
  <script type="application/json" id="plugin-data"><%- JSON.stringify(serializedPlugins) %></script>
  <script type="application/json" id="plugin-app-data"><%- JSON.stringify(apps) %></script>
  <script src="/popper.min.js"></script>
  <script src="/tippy-bundle.umd.min.js"></script>
  <script src="/hotkeys.min.js"></script>
  <script src="/sweetalert2.js"></script>
  <script src="/noty.js"></script>
  <script src="/notyq.js"></script>
  <script src="/Socket.js"></script>
  <script src="/common.js"></script>
  <script src="/urldropdown.js"></script>
  <script>
    (function () {
      const pluginDataEl = document.getElementById('plugin-data')
      const appDataEl = document.getElementById('plugin-app-data')
      let plugins = []
      let apps = []
      try {
        plugins = pluginDataEl ? JSON.parse(pluginDataEl.textContent) : []
      } catch (error) {
        console.error('Failed to parse plugin data', error)
      }
      try {
        apps = appDataEl ? JSON.parse(appDataEl.textContent) : []
      } catch (error) {
        console.error('Failed to parse app data', error)
      }

      function escapeHtml(value) {
        const div = document.createElement('div')
        div.textContent = value || ''
        return div.innerHTML
      }

      function createPluginModal(appList) {
        const overlay = document.createElement('div')
        overlay.id = 'plugin-modal-overlay'
        overlay.className = 'modal-overlay url-modal-overlay plugin-modal-overlay'

        overlay.innerHTML = `
      <div class="url-modal-content" role="dialog" aria-modal="true" aria-labelledby="plugin-modal-title" aria-describedby="plugin-modal-description">
        <button type="button" class="url-modal-close" aria-label="Close">&times;</button>
        <h3 id="plugin-modal-title">Run Plugin</h3>
        <p class="url-modal-description" id="plugin-modal-description">Choose a project to open the agent from.</p>
        <input type="search" class="url-modal-input" placeholder="Filter projects" autocomplete="off" />
        <div class="url-dropdown plugin-modal-dropdown"></div>
        <div class="url-modal-actions single">
          <button type="button" class="url-modal-button cancel">Close</button>
        </div>
      </div>
    `

        document.body.appendChild(overlay)

        const content = overlay.querySelector('.url-modal-content')
        const closeButton = overlay.querySelector('.url-modal-close')
        const cancelButton = overlay.querySelector('.url-modal-button.cancel')
        const titleEl = overlay.querySelector('#plugin-modal-title')
        const descriptionEl = overlay.querySelector('#plugin-modal-description')
        const inputEl = overlay.querySelector('.url-modal-input')
        const dropdownEl = overlay.querySelector('.plugin-modal-dropdown')

        const state = {
          apps: Array.isArray(appList) ? appList : [],
          plugin: null,
          selectedIndex: -1,
          selectedElement: null,
          visibleIndices: []
        }

        function clearSelection() {
          if (state.selectedElement) {
            state.selectedElement.classList.remove('selected')
          }
          state.selectedElement = null
          state.selectedIndex = -1
        }

        function ensureVisible(element) {
          if (!element) return
          element.scrollIntoView({ block: 'nearest' })
        }

        function select(index, element, { autoLaunch = false } = {}) {
          if (state.selectedElement && state.selectedElement !== element) {
            state.selectedElement.classList.remove('selected')
          }
          state.selectedElement = element || null
          state.selectedIndex = typeof index === 'number' ? index : -1
          if (state.selectedElement) {
            state.selectedElement.classList.add('selected')
            if (autoLaunch) {
              confirm()
            }
          }
        }

        function buildOption(app, index) {
          const option = document.createElement('div')
          option.className = 'url-dropdown-item plugin-option'
          option.setAttribute('data-app-index', index)
          option.tabIndex = 0
          const iconHtml = app.icon
            ? `<img class="option-icon" src="${escapeHtml(app.icon)}" alt="${escapeHtml(app.title || app.name || 'App')} icon">`
            : '<div class="option-icon"><i class="fa-solid fa-folder"></i></div>'
          const description = app.description ? `<div class="option-description">${escapeHtml(app.description)}</div>` : ''
          const pathLabel = app.displayPath || app.cwd || ''
          option.innerHTML = `
        ${iconHtml}
        <div class="option-body">
          <div class="option-name">${escapeHtml(app.title || app.name || 'Project')}</div>
          <div class="option-path">${escapeHtml(pathLabel)}</div>
          ${description}
        </div>
      `
          return option
        }

        function renderList(query) {
          const term = (query || '').toLowerCase().trim()
          dropdownEl.innerHTML = ''
          state.visibleIndices = []
          clearSelection()

          const matches = []
          for (let i = 0; i < state.apps.length; i++) {
            const app = state.apps[i]
            const searchable = [app.title, app.name, app.description, app.displayPath, app.cwd]
              .filter(Boolean)
              .join(' ')
              .toLowerCase()
            if (!term || searchable.includes(term)) {
              matches.push({ app, index: i })
            }
          }

          if (matches.length === 0) {
            dropdownEl.innerHTML = '<div class="url-dropdown-empty">No projects found</div>'
            return
          }

          const fragment = document.createDocumentFragment()
          matches.forEach(({ app, index }) => {
            const option = buildOption(app, index)
            state.visibleIndices.push(index)
            option.addEventListener('click', () => {
              select(index, option, { autoLaunch: true })
            })
            option.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault()
                select(index, option, { autoLaunch: true })
              } else if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                event.preventDefault()
                navigate(event.key === 'ArrowDown' ? 1 : -1)
              }
            })
            fragment.appendChild(option)
          })
          dropdownEl.appendChild(fragment)
        }

        function navigate(delta) {
          if (state.visibleIndices.length === 0) return
          const currentPos = state.visibleIndices.indexOf(state.selectedIndex)
          let nextPos
          if (currentPos === -1) {
            nextPos = delta > 0 ? 0 : state.visibleIndices.length - 1
          } else {
            nextPos = currentPos + delta
            if (nextPos < 0) nextPos = 0
            if (nextPos >= state.visibleIndices.length) nextPos = state.visibleIndices.length - 1
          }
          const nextIndex = state.visibleIndices[nextPos]
          const element = dropdownEl.querySelector(`[data-app-index="${nextIndex}"]`)
          if (element) {
            select(nextIndex, element, { autoLaunch: false })
            element.focus()
            ensureVisible(element)
          }
        }

        function closeModal() {
          overlay.classList.remove('is-visible')
          document.removeEventListener('keydown', handleKeydown, true)
          setTimeout(() => {
            dropdownEl.innerHTML = ''
            inputEl.value = ''
            clearSelection()
            dropdownEl.style.display = 'none'
          }, 150)
        }

        function confirm() {
          if (state.selectedIndex === -1) {
            return
          }
          const plugin = state.plugin
          const app = state.apps[state.selectedIndex]
          if (!plugin || !plugin.pluginPath) {
            closeModal()
            alert('This plugin is missing a launch target.')
            return
          }
          if (!app) {
            closeModal()
            alert('Select a project to continue.')
            return
          }
          const queryPairs = []
          const pushPair = (key, value, { rawValue = false } = {}) => {
            if (value === undefined || value === null) {
              return
            }
            const encodedKey = encodeURIComponent(key)
            const encodedValue = rawValue ? String(value) : encodeURIComponent(String(value))
            queryPairs.push(`${encodedKey}=${encodedValue}`)
          }
          pushPair('plugin', plugin.pluginPath, { rawValue: true })
          if (Array.isArray(plugin.extraParams)) {
            plugin.extraParams.forEach(([key, value]) => {
              pushPair(key, value)
            })
          }
          const queryString = queryPairs.join('&')
          const target = queryPairs.length > 0 ? `/p/${app.name}/dev?${queryString}` : `/p/${app.name}/dev`
          overlay.classList.remove('is-visible')
          document.removeEventListener('keydown', handleKeydown, true)
          location.href = target
        }

        function handleKeydown(event) {
          if (!overlay.classList.contains('is-visible')) return
          if (event.key === 'Escape') {
            event.preventDefault()
            closeModal()
          } else if (event.key === 'ArrowDown') {
            event.preventDefault()
            navigate(1)
          } else if (event.key === 'ArrowUp') {
            event.preventDefault()
            navigate(-1)
          } else if (event.key === 'Enter' && document.activeElement === inputEl) {
            event.preventDefault()
            if (state.visibleIndices.length === 1 && state.selectedIndex === -1) {
              const nextIndex = state.visibleIndices[0]
              const element = dropdownEl.querySelector(`[data-app-index="${nextIndex}"]`)
              select(nextIndex, element, { autoLaunch: true })
            } else if (state.selectedIndex !== -1) {
              confirm()
            }
          }
        }

        closeButton.addEventListener('click', (event) => {
          event.preventDefault()
          closeModal()
        })
        cancelButton.addEventListener('click', (event) => {
          event.preventDefault()
          closeModal()
        })
        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) {
            closeModal()
          }
        })
        inputEl.addEventListener('input', (event) => {
          renderList(event.target.value)
        })

        function openModal(plugin) {
          state.plugin = plugin
          const title = plugin && plugin.title ? `Run ${plugin.title}` : 'Run Plugin'
          titleEl.textContent = title
          if (state.apps.length === 0) {
            descriptionEl.textContent = 'No projects found under ~/pinokio/api. Create or download a project to continue.'
          } else {
            descriptionEl.textContent = 'Choose a project to open the agent from.'
          }
          renderList('')
          dropdownEl.style.display = 'block'
          overlay.classList.add('is-visible')
          document.addEventListener('keydown', handleKeydown, true)
          requestAnimationFrame(() => {
            inputEl.focus()
            inputEl.select()
          })
        }

        return {
          open: openModal,
          close: closeModal,
          setApps(newApps) {
            state.apps = Array.isArray(newApps) ? newApps : []
          }
        }
      }

      function initUrlFeatures() {
        if (typeof initUrlDropdown === 'function') {
          initUrlDropdown({ clearBehavior: 'empty' })
        }
      }

      const modal = createPluginModal(apps)

      const ACTION_LABELS = {
        install: 'Install',
        uninstall: 'Uninstall',
        update: 'Update'
      }
      const ACTION_ICONS = {
        install: 'fa-solid fa-download',
        uninstall: 'fa-solid fa-trash-can',
        update: 'fa-solid fa-rotate-right'
      }

      function buildActionUrl(plugin, actionType) {
        if (!plugin || !plugin.pluginPath) return null
        const normalizedPath = plugin.pluginPath.startsWith('/') ? plugin.pluginPath.slice(1) : plugin.pluginPath
        if (!normalizedPath) return null
        const encodedPath = normalizedPath.split('/').map((segment) => encodeURIComponent(segment)).join('/')
        const ts = Date.now()
        return `/action/${encodeURIComponent(actionType)}/${encodedPath}?ts=${ts}`
      }

      function showActionModal(actionType, plugin) {
        const targetUrl = buildActionUrl(plugin, actionType)
        if (!targetUrl) {
          alert('This action is missing a target script.')
          return
        }
        const pluginTitle = plugin && (plugin.title || plugin.text || plugin.name) ? (plugin.title || plugin.text || plugin.name) : 'Plugin'
        const title = `${ACTION_LABELS[actionType] || 'Run'} ${escapeHtml(pluginTitle)}`
        const subtitle = plugin && plugin.description ? escapeHtml(plugin.description) : ''
        const iconClass = ACTION_ICONS[actionType] || 'fa-solid fa-terminal'
        const modalHtml = `
      <div class="pinokio-modal-surface">
        <div class="pinokio-modal-header">
          <div class="pinokio-modal-icon"><i class="${iconClass}"></i></div>
          <div class="pinokio-modal-heading">
            <div class="pinokio-modal-title">${title}</div>
            <div class="pinokio-modal-subtitle">${subtitle}</div>
          </div>
        </div>
        <div class="pinokio-modal-body pinokio-modal-body--iframe">
          <iframe src="${targetUrl}"></iframe>
        </div>
        <div class="pinokio-modal-footer pinokio-modal-footer--publish" data-publish-footer>
          <button type="button" class="pinokio-publish-close-btn" data-publish-close>Close</button>
        </div>
      </div>
    `

        Swal.fire({
          html: modalHtml,
          customClass: {
            popup: 'pinokio-modern-modal',
            htmlContainer: 'pinokio-modern-html',
            closeButton: 'pinokio-modern-close'
          },
          backdrop: 'rgba(9,11,15,0.65)',
          width: 'min(760px, 90vw)',
          showConfirmButton: false,
          showCloseButton: true,
          buttonsStyling: false,
          focusConfirm: false,
          didOpen: (popup) => {
            const iframe = popup.querySelector('iframe')
            const closeBtn = popup.querySelector('[data-publish-close]')
            if (iframe) {
              iframe.dataset.forceVisible = 'true'
              iframe.classList.remove('hidden')
              iframe.removeAttribute('hidden')
            }
            if (closeBtn) {
              closeBtn.addEventListener('click', () => {
                Swal.close()
              })
            }
          }
        })
      }

      function normalizePluginPath(value) {
        if (typeof value !== 'string') return ''
        return value.replace(/\\/g, '/').replace(/^\/+/, '').replace(/\/+$/, '')
      }

      function findPluginByPath(targetPath) {
        if (!targetPath) return null
        const normalizedTarget = normalizePluginPath(targetPath)
        const targetWithFile = normalizedTarget.endsWith('pinokio.js')
          ? normalizedTarget
          : `${normalizedTarget}/pinokio.js`
        return plugins.find((plugin) => {
          const pluginPath = normalizePluginPath(plugin.pluginPath || '')
          if (!pluginPath) return false
          return pluginPath === targetWithFile || pluginPath === `/${targetWithFile}`
        }) || null
      }

      function autoActivateFromQuery() {
        const params = new URLSearchParams(window.location.search)
        const targetPath = params.get('path')
        if (!targetPath) {
          return
        }
        const plugin = findPluginByPath(targetPath)
        if (!plugin) {
          return
        }
        if (plugin.hasInstall) {
          showActionModal('install', plugin)
        } else {
          modal.open(plugin)
        }
      }

      function attachHandlers() {
        const cards = document.querySelectorAll('.plugin-card')
        if (!cards.length) return
        cards.forEach((card) => {
          const indexAttr = card.getAttribute('data-plugin-index')
          const index = parseInt(indexAttr, 10)
          if (Number.isNaN(index) || !plugins[index]) {
            return
          }
          const plugin = plugins[index]
          const infoButton = card.querySelector('.plugin-info')
          if (infoButton) {
            infoButton.addEventListener('click', (event) => {
              event.preventDefault()
              event.stopPropagation()
              const link = infoButton.getAttribute('data-link')
              if (link) {
                window.open(link, '_blank', 'noopener,noreferrer')
              }
            })
          }
          const openButton = card.querySelector('[data-action="open"]')
          const open = (event) => {
            if (event) {
              event.preventDefault()
            }
            if (!apps.length) {
              alert('No projects found under ~/pinokio/api.')
              return
            }
            modal.open(plugin)
          }
          if (openButton) {
            openButton.addEventListener('click', open)
          }
          const actionButtons = card.querySelectorAll('[data-plugin-action]')
          actionButtons.forEach((button) => {
            const actionType = button.getAttribute('data-plugin-action')
            if (!actionType) return
            button.addEventListener('click', (event) => {
              event.preventDefault()
              showActionModal(actionType, plugin)
            })
          })
        })
      }

      document.addEventListener('DOMContentLoaded', () => {
        initUrlFeatures()
        attachHandlers()
        autoActivateFromQuery()
      })
    })()
  </script>

  <script>
    const installAgentModal = (() => {
      let overlay
      let inputEl
      let errorEl
      let formEl

      function ensureStyles() {
        if (document.getElementById('install-agent-styles')) return
        const style = document.createElement('style')
        style.id = 'install-agent-styles'
        style.textContent = `
        .install-agent-overlay {
          position: fixed;
          inset: 0;
          display: none;
          align-items: center;
          justify-content: center;
          padding: 18px;
          background: rgba(8, 12, 20, 0.55);
          backdrop-filter: blur(4px);
          z-index: 2200;
        }
        .install-agent-overlay.is-visible {
          display: flex;
        }
        .install-agent-dialog {
          width: min(540px, 100%);
          background: #ffffff;
          color: #0f172a;
          border-radius: 16px;
          padding: 22px 22px 18px;
          box-shadow: 0 20px 70px rgba(0, 0, 0, 0.22);
          border: 1px solid rgba(15, 23, 42, 0.06);
        }
        body.dark .install-agent-dialog {
          background: #0b1221;
          color: #e5e7eb;
          border-color: rgba(255, 255, 255, 0.08);
          box-shadow: 0 20px 70px rgba(0, 0, 0, 0.55);
        }
        .install-agent-header {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          margin-bottom: 16px;
        }
        .install-agent-icon {
          width: 44px;
          height: 44px;
          border-radius: 12px;
          background: linear-gradient(135deg, #22c55e, #0ea5e9);
          color: #0b1221;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
          box-shadow: 0 12px 30px rgba(14, 165, 233, 0.25);
        }
        .install-agent-heading {
          display: flex;
          flex-direction: column;
          gap: 4px;
          flex: 1;
          min-width: 0;
        }
        .install-agent-title {
          font-size: 18px;
          font-weight: 700;
          margin: 0;
        }
        .install-agent-subtitle {
          margin: 0;
          opacity: 0.72;
          font-size: 13px;
        }
        .install-agent-close {
          background: none;
          border: none;
          color: inherit;
          opacity: 0.6;
          cursor: pointer;
          padding: 6px;
          border-radius: 8px;
          transition: opacity 0.15s ease, background 0.15s ease;
        }
        .install-agent-close:hover,
        .install-agent-close:focus-visible {
          opacity: 1;
          background: rgba(15, 23, 42, 0.07);
        }
        body.dark .install-agent-close:hover,
        body.dark .install-agent-close:focus-visible {
          background: rgba(255, 255, 255, 0.08);
        }
        .install-agent-body {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-top: 4px;
        }
        .install-agent-label {
          font-weight: 600;
          font-size: 13px;
        }
        .install-agent-body input {
          width: 100%;
          padding: 12px 14px;
          border-radius: 10px;
          border: 1px solid rgba(15, 23, 42, 0.12);
          background: #f8fafc;
          color: #0f172a;
          font-size: 14px;
          transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .install-agent-body input:focus-visible {
          outline: none;
          border-color: #0ea5e9;
          box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.18);
        }
        body.dark .install-agent-body input {
          background: #111827;
          border-color: rgba(255, 255, 255, 0.08);
          color: #e5e7eb;
        }
        body.dark .install-agent-body input:focus-visible {
          border-color: #38bdf8;
          box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.18);
        }
        .install-agent-hint {
          font-size: 12px;
          opacity: 0.65;
        }
        .install-agent-error {
          color: #ef4444;
          font-size: 12px;
          min-height: 16px;
        }
        body.dark .install-agent-error {
          color: #f87171;
        }
        .install-agent-actions {
          display: flex;
          justify-content: flex-end;
          gap: 8px;
          margin-top: 6px;
        }
        .install-agent-button {
          border: none;
          border-radius: 10px;
          padding: 10px 14px;
          font-weight: 600;
          font-size: 14px;
          cursor: pointer;
          transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        }
        .install-agent-button.primary {
          background: linear-gradient(135deg, #0ea5e9, #22c55e);
          color: #0b1221;
          box-shadow: 0 12px 30px rgba(14, 165, 233, 0.22);
        }
        .install-agent-button.primary:hover {
          transform: translateY(-1px);
        }
        .install-agent-button.ghost {
          background: transparent;
          color: inherit;
          border: 1px solid rgba(15, 23, 42, 0.12);
        }
        body.dark .install-agent-button.ghost {
          border-color: rgba(255, 255, 255, 0.12);
        }
        .install-agent-button:focus-visible {
          outline: none;
          box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25);
        }
      `
        document.head.appendChild(style)
      }

      function handleKeydown(event) {
        if (event.key === 'Escape') {
          event.preventDefault()
          close()
        }
      }

      function showError(message) {
        if (!errorEl) return
        errorEl.textContent = message || ''
      }

      function close() {
        if (!overlay) return
        overlay.classList.remove('is-visible')
        if (formEl) formEl.reset()
        showError('')
        document.removeEventListener('keydown', handleKeydown, true)
      }

      function handleSubmit() {
        if (!inputEl) return
        const value = (inputEl.value || '').trim()
        if (!value) {
          showError('Please enter a Git URL to continue.')
          inputEl.focus()
          return
        }
        try {
          new URL(value)
        } catch (err) {
          showError('That URL does not look valid.')
          inputEl.focus()
          return
        }
        close()
        window.location.href = `/?mode=download&uri=${encodeURIComponent(value)}&path=plugin`
      }

      function createModal() {
        ensureStyles()
        overlay = document.createElement('div')
        overlay.className = 'install-agent-overlay'
        overlay.innerHTML = `
        <div class="install-agent-dialog" role="dialog" aria-modal="true" aria-labelledby="install-agent-title">
          <div class="install-agent-header">
            <div class="install-agent-icon"><i class="fa-solid fa-plug"></i></div>
            <div class="install-agent-heading">
              <div class="install-agent-title" id="install-agent-title">Install Agent</div>
              <p class="install-agent-subtitle">Add an agent directly from a Git repository URL.</p>
            </div>
            <button class="install-agent-close" type="button" data-install-close aria-label="Close install dialog">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <form class="install-agent-body" novalidate>
            <label class="install-agent-label" for="install-agent-url">Git URL</label>
            <input id="install-agent-url" type="url" name="agentUrl" placeholder="https://github.com/user/repo.git" autocomplete="off" required />
            <div class="install-agent-hint">The agent will be downloaded into <code>~/pinokio/plugin</code>.</div>
            <div class="install-agent-error" data-install-error></div>
            <div class="install-agent-actions">
              <button class="install-agent-button ghost" type="button" data-install-cancel>Cancel</button>
              <button class="install-agent-button primary" type="submit">Install</button>
            </div>
          </form>
        </div>
      `
        document.body.appendChild(overlay)
        inputEl = overlay.querySelector('#install-agent-url')
        errorEl = overlay.querySelector('[data-install-error]')
        formEl = overlay.querySelector('form')
        const closeButtons = overlay.querySelectorAll('[data-install-close], [data-install-cancel]')
        closeButtons.forEach((button) => {
          button.addEventListener('click', close)
        })
        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) {
            close()
          }
        })
        formEl.addEventListener('submit', (event) => {
          event.preventDefault()
          handleSubmit()
        })
        inputEl.addEventListener('input', () => {
          showError('')
        })
      }

      function open() {
        if (!overlay) createModal()
        overlay.classList.add('is-visible')
        document.addEventListener('keydown', handleKeydown, true)
        requestAnimationFrame(() => {
          if (inputEl) {
            inputEl.focus()
            inputEl.select()
          }
        })
      }

      return {
        open
      }
    })()

    function installAgent(e) {
      if (e) {
        e.preventDefault()
        e.stopPropagation()
      }
      installAgentModal.open()
    }
  </script>
  <script src="/opener.js"></script>
</body>

</html>